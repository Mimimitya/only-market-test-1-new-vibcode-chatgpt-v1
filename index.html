
<!doctype html>
<html lang="ru" data-theme="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>OnlyMarket</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#050812;
      --panel: rgba(255,255,255,.06);
      --panel2: rgba(255,255,255,.08);
      --border: rgba(255,255,255,.10);
      --fg: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.60);
      --muted2: rgba(255,255,255,.42);
      --accent:#3b82f6;
      --accent2:#8b5cf6;
      --good:#34d399;
      --warn:#fbbf24;
      --bad:#fb7185;
      --shadow: 0 18px 60px rgba(0,0,0,.55);
      --r:18px;
      --r2:24px;
      --max:1240px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
      background:
        radial-gradient(1200px 600px at 20% 0%, rgba(59,130,246,.22), transparent 60%),
        radial-gradient(900px 500px at 90% 20%, rgba(139,92,246,.16), transparent 55%),
        radial-gradient(900px 500px at 40% 120%, rgba(52,211,153,.10), transparent 60%),
        var(--bg);
      color:var(--fg);
      overflow-x:hidden;
    }
    a{color:inherit;text-decoration:none}
    button,input,select,textarea{font:inherit;color:inherit;background:transparent;border:none;outline:none}
    .wrap{min-height:100%;display:flex;justify-content:center;padding:22px 16px 60px}
    .shell{width:100%;max-width:var(--max);display:grid;grid-template-columns:290px 1fr;gap:16px;align-items:start}
    @media (max-width:980px){.shell{grid-template-columns:1fr}}

    .side{
      position:sticky;top:16px;
      border-radius:var(--r2);
      background:linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.04));
      border:1px solid var(--border);
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    @media (max-width:980px){.side{position:relative;top:0}}
    .brand{
      padding:18px 18px 14px;
      display:flex;gap:12px;align-items:center;
      border-bottom:1px solid var(--border);
      background:rgba(0,0,0,.10);
    }
    .logo{
      width:40px;height:40px;border-radius:14px;
      background:linear-gradient(135deg, rgba(59,130,246,.95), rgba(139,92,246,.92));
      box-shadow:0 16px 40px rgba(59,130,246,.25);
      position:relative;flex:0 0 auto;
    }
    .logo:after{
      content:"";position:absolute;inset:9px;border-radius:12px;
      background:rgba(0,0,0,.22);
      border:1px solid rgba(255,255,255,.25);
    }
    .brand h1{margin:0;font-size:14px;letter-spacing:.3px}
    .brand p{margin:4px 0 0;font-size:12px;color:var(--muted)}
    .nav{padding:10px;display:flex;flex-direction:column;gap:6px}
    .nav a{
      display:flex;align-items:center;gap:10px;
      padding:12px 12px;border-radius:14px;
      color:rgba(255,255,255,.82);
      border:1px solid transparent;
      transition:.15s ease;
    }
    .nav a:hover{background:rgba(255,255,255,.06);border-color:rgba(255,255,255,.08)}
    .nav a.active{
      background:linear-gradient(180deg, rgba(59,130,246,.18), rgba(139,92,246,.12));
      border-color:rgba(59,130,246,.25);
      color:rgba(255,255,255,.95);
    }
    .dot{width:9px;height:9px;border-radius:99px;background:rgba(255,255,255,.22)}
    .active .dot{
      background:linear-gradient(135deg, rgba(59,130,246,1), rgba(139,92,246,1));
      box-shadow:0 0 0 4px rgba(59,130,246,.18);
    }
    .sideFooter{
      padding:12px 14px 14px;border-top:1px solid var(--border);
      display:flex;gap:10px;align-items:center;justify-content:space-between;
      background:rgba(0,0,0,.08);
    }
    .pill{
      padding:8px 10px;border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.05);
      font-size:12px;color:var(--muted);
      max-width:180px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;
    }

    .content{
      border-radius:var(--r2);
      border:1px solid var(--border);
      background:linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.03));
      box-shadow:var(--shadow);
      overflow:hidden;
      min-height:640px;
    }
    .topbar{
      padding:18px 18px 14px;
      display:flex;align-items:center;justify-content:space-between;gap:12px;
      border-bottom:1px solid var(--border);
      background:rgba(0,0,0,.10);
    }
    .topbar h2{margin:0;font-size:16px;letter-spacing:.2px}
    .topbar .sub{margin-top:6px;font-size:12px;color:var(--muted)}
    .main{padding:18px}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:14px}
    @media (max-width:920px){.grid2{grid-template-columns:1fr}}
    .card{
      border-radius:var(--r);
      border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.05);
      padding:14px;
    }
    .card h3{margin:0;font-size:14px;color:rgba(255,255,255,.90)}
    .card p{margin:8px 0 0;color:var(--muted);font-size:12.5px;line-height:1.5}
    .muted{color:var(--muted)}
    .mono{font-family:var(--mono)}
    .btn{
      cursor:pointer;display:inline-flex;align-items:center;justify-content:center;gap:10px;
      padding:10px 12px;border-radius:14px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.06);
      transition:.15s ease;user-select:none;white-space:nowrap;
    }
    .btn:hover{background:rgba(255,255,255,.09);border-color:rgba(255,255,255,.18)}
    .btn.primary{
      background:linear-gradient(135deg, rgba(59,130,246,.95), rgba(139,92,246,.92));
      border-color:rgba(59,130,246,.35);
      box-shadow:0 16px 40px rgba(59,130,246,.20);
    }
    .btn.primary:hover{filter:brightness(1.05)}
    .btn.danger{background:rgba(251,113,133,.14);border-color:rgba(251,113,133,.35)}
    .btn.ghost{background:rgba(255,255,255,.03)}
    .hidden{display:none !important}
    .actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}

    .kpis{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
    .kpi{
      padding:10px 12px;border-radius:14px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(0,0,0,.12);
      min-width:160px;
    }
    .kpi .label{font-size:11px;color:var(--muted)}
    .kpi .value{margin-top:6px;font-size:18px;font-weight:800;letter-spacing:.2px}
    .kpi .value small{font-size:12px;font-weight:700;color:var(--muted)}

    .field{display:flex;flex-direction:column;gap:6px;margin-top:12px}
    .field label{font-size:12px;color:var(--muted)}
    .input,.select,.textarea{
      padding:12px 12px;border-radius:14px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(0,0,0,.14);
    }
    .textarea{min-height:88px;resize:vertical}
    .input:focus,.select:focus,.textarea:focus{border-color:rgba(59,130,246,.55);box-shadow:0 0 0 6px rgba(59,130,246,.14)}

    table{
      width:100%;border-collapse:collapse;overflow:hidden;
      border-radius:16px;border:1px solid rgba(255,255,255,.10);
    }
    th,td{
      text-align:left;padding:12px 12px;font-size:12.5px;
      border-bottom:1px solid rgba(255,255,255,.08);
      vertical-align:top;
    }
    th{color:rgba(255,255,255,.72);font-weight:700;background:rgba(0,0,0,.16)}
    tr:hover td{background:rgba(255,255,255,.04)}

    .badge{
      display:inline-flex;align-items:center;
      padding:4px 8px;border-radius:999px;font-size:11px;
      border:1px solid rgba(255,255,255,.14);
      color:rgba(255,255,255,.78);
      background:rgba(255,255,255,.06);
      white-space:nowrap;
    }
    .badge.good{border-color:rgba(52,211,153,.35);background:rgba(52,211,153,.12)}
    .badge.bad{border-color:rgba(251,113,133,.35);background:rgba(251,113,133,.12)}
    .badge.warn{border-color:rgba(251,191,36,.35);background:rgba(251,191,36,.12)}

    .backdrop{
      position:fixed;inset:0;background:rgba(0,0,0,.60);
      backdrop-filter:blur(10px);
      display:none;align-items:center;justify-content:center;padding:18px;z-index:50;
    }
    .backdrop.show{display:flex}
    .modal{
      width:100%;max-width:900px;border-radius:22px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(10,12,20,.92);
      box-shadow:0 30px 120px rgba(0,0,0,.7);
      overflow:hidden;animation:pop .16s ease;
    }
    @keyframes pop{from{transform:translateY(6px) scale(.99);opacity:.7}to{transform:translateY(0) scale(1);opacity:1}}
    .modalHead{
      padding:16px 16px 12px;display:flex;align-items:center;justify-content:space-between;gap:10px;
      border-bottom:1px solid rgba(255,255,255,.10);
      background:rgba(0,0,0,.10);
    }
    .modalTitle{font-weight:800;letter-spacing:.2px}
    .modalBody{padding:16px}
    .iconBtn{
      cursor:pointer;width:38px;height:38px;border-radius:14px;
      border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.06);
      display:flex;align-items:center;justify-content:center;transition:.15s ease;
    }
    .iconBtn:hover{background:rgba(255,255,255,.10)}
    .x{width:14px;height:14px;border-right:2px solid rgba(255,255,255,.70);border-bottom:2px solid rgba(255,255,255,.70);transform:rotate(45deg);margin-left:2px}

    .payGrid{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:10px}
    @media (max-width:740px){.payGrid{grid-template-columns:1fr}}
    .payOpt{
      cursor:pointer;border-radius:18px;border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.05);padding:14px;
      display:flex;gap:12px;align-items:center;justify-content:space-between;transition:.15s ease;
    }
    .payOpt:hover{background:rgba(255,255,255,.08);border-color:rgba(255,255,255,.20)}
    .payOpt.active{border-color:rgba(59,130,246,.55);box-shadow:0 0 0 6px rgba(59,130,246,.14)}
    .payLeft{display:flex;gap:12px;align-items:center}
    .payLogo{
      width:42px;height:42px;border-radius:14px;border:1px solid rgba(255,255,255,.12);
      background:rgba(0,0,0,.15);display:flex;align-items:center;justify-content:center;overflow:hidden;
    }
    .payLogo svg{width:22px;height:22px;opacity:.9}
    .payMeta .name{font-weight:800}
    .payMeta .desc{font-size:12px;color:var(--muted);margin-top:4px}

    .chatBox{border-radius:18px;border:1px solid rgba(255,255,255,.10);background:rgba(0,0,0,.14);overflow:hidden}
    .chatLog{padding:12px;max-height:340px;overflow:auto;display:flex;flex-direction:column;gap:10px}
    .msg{display:flex;flex-direction:column;gap:6px;max-width:88%}
    .msg.me{align-self:flex-end}
    .bubble{
      border-radius:16px;padding:10px 12px;border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.06);line-height:1.35;font-size:13px;white-space:pre-wrap;word-break:break-word;
    }
    .msg.me .bubble{
      background:linear-gradient(135deg, rgba(59,130,246,.22), rgba(139,92,246,.16));
      border-color:rgba(59,130,246,.22);
    }
    .msgMeta{font-size:11px;color:var(--muted2);display:flex;gap:8px;align-items:center}
    .chatSend{display:flex;gap:10px;padding:12px;border-top:1px solid rgba(255,255,255,.08);background:rgba(0,0,0,.10);align-items:flex-end}
    .chatSend textarea{flex:1;min-height:44px;max-height:120px;resize:vertical}

    .toastWrap{position:fixed;left:50%;bottom:18px;transform:translateX(-50%);z-index:100;display:flex;flex-direction:column;gap:10px;pointer-events:none}
    .toast{
      pointer-events:auto;border-radius:16px;border:1px solid rgba(255,255,255,.14);
      background:rgba(10,12,20,.92);padding:12px 12px;box-shadow:0 20px 80px rgba(0,0,0,.7);
      min-width:280px;max-width:560px;animation:toast .18s ease;
    }
    @keyframes toast{from{transform:translateY(6px);opacity:.65}to{transform:translateY(0);opacity:1}}
    .toast .t{font-weight:800}
    .toast .m{margin-top:4px;color:var(--muted);font-size:12.5px;line-height:1.4}
    .toast .mini{margin-top:8px;display:flex;justify-content:flex-end;gap:10px}
    .mini .link{pointer-events:auto;cursor:pointer;color:rgba(255,255,255,.88);font-size:12px;text-decoration:underline;text-decoration-color:rgba(255,255,255,.25);text-underline-offset:3px}
  </style>
</head>
<body>
<div class="wrap">
  <div class="shell">
    <aside class="side">
      <div class="brand">
        <div class="logo"></div>
        <div>
          <h1>OnlyMarket</h1>
          <p id="sideSub">Маркетплейс • сделки • чат • кошелёк</p>
        </div>
      </div>
      <nav class="nav" id="nav">
        <a href="#/home" data-route="home"><span class="dot"></span><span>Главная</span></a>
        <a href="#/deals" data-route="deals" class="hidden" id="navDeals"><span class="dot"></span><span>Сделки</span></a>
        <a href="#/profile" data-route="profile" class="hidden" id="navProfile"><span class="dot"></span><span>Кошелёк</span></a>
        <a href="#/admin" data-route="admin" class="hidden" id="navAdmin"><span class="dot"></span><span>Админка</span></a>
        <a href="#/auth" data-route="auth" id="navAuth"><span class="dot"></span><span>Войти</span></a>
      </nav>
      <div class="sideFooter">
        <span class="pill" id="authPill">Гость</span>
        <button class="btn danger hidden" id="logoutBtn">Выйти</button>
      </div>
    </aside>

    <main class="content">
      <div class="topbar">
        <div>
          <h2 id="title">Главная</h2>
          <div class="sub" id="subtitle">Сделки, чат и кошелёк — всё в одном.</div>
        </div>
        <div style="display:flex;gap:10px;align-items:center;">
          <button class="btn" id="refreshBtn">Обновить</button>
          <button class="btn primary hidden" id="topupBtnTop">Пополнить</button>
          <button class="btn primary hidden" id="newDealBtnTop">Новая сделка</button>
        </div>
      </div>

      <div class="main">
        <section id="view-home">
          <div class="grid2">
            <div class="card">
              <h3>Быстрый обзор</h3>
              <div class="kpis" id="homeKpis"></div>
              <div class="actions" id="homeActions">
                <a class="btn primary" href="#/auth" id="homeLoginBtn">Войти</a>
                <a class="btn hidden" href="#/deals" id="homeDealsBtn">Открыть сделки</a>
                <a class="btn hidden" href="#/profile" id="homeWalletBtn">Открыть кошелёк</a>
              </div>
              <p class="muted" id="homeHint" style="margin-top:10px;">Войдите, чтобы видеть сделки и баланс.</p>
            </div>

            <div class="card">
              <h3>Как работает сделка</h3>
              <p>
                1) Создаёте сделку и указываете пользователя и сумму.<br>
                2) Покупатель вносит деньги в сделку (из кошелька).<br>
                3) Продавец отмечает доставку товара.<br>
                4) Покупатель подтверждает — деньги переходят продавцу.
              </p>
              <div class="actions">
                <button class="btn primary hidden" id="homeNewDealBtn">Создать сделку</button>
              </div>
            </div>
          </div>
        </section>

        <section id="view-auth" class="hidden">
          <div class="grid2">
            <div class="card">
              <h3>Вход</h3>
              <div class="field">
                <label>Email или username</label>
                <input class="input" id="loginId" placeholder="email или username" autocomplete="username">
              </div>
              <div class="field">
                <label>Пароль</label>
                <input class="input" id="loginPw" type="password" placeholder="••••••••" autocomplete="current-password">
              </div>
              <div class="actions">
                <button class="btn primary" id="loginBtn">Войти</button>
                <button class="btn ghost" id="demoBtn">Демо</button>
              </div>
              <p class="muted" style="margin-top:10px;">Демо логин для первого запуска: <span class="mono">admin@onlymarket.local</span> / <span class="mono">admin12345</span></p>
            </div>
            <div class="card">
              <h3>Регистрация</h3>
              <div class="field">
                <label>Email</label>
                <input class="input" id="regEmail" placeholder="you@mail.com" autocomplete="email">
              </div>
              <div class="field">
                <label>Username</label>
                <input class="input" id="regUser" placeholder="nickname" autocomplete="username">
              </div>
              <div class="field">
                <label>Пароль</label>
                <input class="input" id="regPw" type="password" placeholder="минимум 8 символов" autocomplete="new-password">
              </div>
              <div class="actions">
                <button class="btn primary" id="regBtn">Создать аккаунт</button>
              </div>
            </div>
          </div>
        </section>

        <section id="view-deals" class="hidden">
          <div class="card">
            <h3>Сделки</h3>
            <p class="muted">Клик по сделке → детали + чат + действия.</p>
            <div class="actions">
              <button class="btn primary" id="newDealBtn">Новая сделка</button>
              <button class="btn" id="refreshDealsBtn">Обновить</button>
            </div>

            <div style="margin-top:12px; overflow:auto;">
              <table>
                <thead>
                  <tr>
                    <th style="width:170px;">ID</th>
                    <th>Название</th>
                    <th style="width:160px;">Сумма</th>
                    <th style="width:140px;">Статус</th>
                    <th style="width:220px;">Участники</th>
                    <th style="width:190px;">Обновлено</th>
                  </tr>
                </thead>
                <tbody id="dealsTbody"></tbody>
              </table>
            </div>
          </div>
        </section>

        <section id="view-profile" class="hidden">
          <div class="card">
            <h3>Кошелёк</h3>
            <div class="kpis" id="balanceKpis"></div>
            <div class="actions">
              <button class="btn primary" id="topupBtn2">Пополнить</button>
              <button class="btn" id="withdrawBtn">Вывести</button>
              <button class="btn" id="logsBtn">Логи</button>
            </div>
          </div>

          <div style="height:12px"></div>

          <div class="grid2">
            <div class="card">
              <h3>Смена пароля</h3>
              <div class="field">
                <label>Текущий пароль</label>
                <input class="input" id="oldPw" type="password" placeholder="••••••••" autocomplete="current-password">
              </div>
              <div class="field">
                <label>Новый пароль</label>
                <input class="input" id="newPw" type="password" placeholder="минимум 8 символов" autocomplete="new-password">
              </div>
              <div class="actions">
                <button class="btn primary" id="changePwBtn">Сменить</button>
              </div>
            </div>

            <div class="card">
              <h3>Последние события</h3>
              <p class="muted">10 последних действий (вход, сделки, операции кошелька).</p>
              <div id="recentLogs"></div>
            </div>
          </div>
        </section>

        <section id="view-admin" class="hidden">
          <div class="card">
            <h3>Пользователи</h3>
            <p class="muted">Клик → профиль пользователя (балансы, логи, сделки).</p>
            <div class="field">
              <label>Поиск</label>
              <input class="input" id="userSearch" placeholder="email / username / id">
            </div>
            <div style="margin-top:12px; overflow:auto;">
              <table>
                <thead>
                  <tr>
                    <th style="width:260px;">Пользователь</th>
                    <th style="width:140px;">Роль</th>
                    <th style="width:140px;">Статус</th>
                    <th>Создан</th>
                  </tr>
                </thead>
                <tbody id="usersTbody"></tbody>
              </table>
            </div>
          </div>

          <div style="height:12px"></div>

          <div class="card">
            <h3>Глобальные логи</h3>
            <p class="muted">События системы (только для админов). Клик → детали.</p>
            <div id="adminLogs"></div>
          </div>
        </section>
      </div>
    </main>
  </div>
</div>

<div class="backdrop" id="topupModal">
  <div class="modal">
    <div class="modalHead">
      <div class="modalTitle">Пополнение</div>
      <button class="iconBtn" data-close="topupModal"><span class="x"></span></button>
    </div>
    <div class="modalBody">
      <div class="grid2">
        <div class="card">
          <h3>Сумма</h3>
          <div class="field">
            <label>Сумма</label>
            <input class="input" id="topupAmount" placeholder="Напр. 10" inputmode="decimal">
          </div>
          <div class="field">
            <label>Валюта</label>
            <select class="select" id="topupCurrency">
              <option value="EUR">EUR</option>
              <option value="USD">USD</option>
              <option value="RUB">RUB</option>
            </select>
          </div>
        </div>
        <div class="card">
          <h3>Способ оплаты</h3>
          <div class="payGrid" id="payGrid">
            <div class="payOpt active" data-kind="crypto">
              <div class="payLeft">
                <div class="payLogo" aria-hidden="true">
                  <svg viewBox="0 0 24 24" fill="none"><path d="M12 2l7.5 4.5v11L12 22l-7.5-4.5v-11L12 2z" stroke="currentColor" stroke-width="1.6"/><path d="M9.5 10.2c0-1.2.9-2.1 2.3-2.1h1.2c1.4 0 2.3.9 2.3 2.1 0 1.2-.9 2.1-2.3 2.1h-1.2c-1.4 0-2.3.9-2.3 2.1 0 1.2.9 2.1 2.3 2.1h1.2c1.4 0 2.3-.9 2.3-2.1" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/></svg>
                </div>
                <div class="payMeta">
                  <div class="name">Крипта</div>
                  <div class="desc">Оплата криптовалютой</div>
                </div>
              </div>
              <span class="badge">CRYPTO</span>
            </div>

            <div class="payOpt" data-kind="sbp">
              <div class="payLeft">
                <div class="payLogo" aria-hidden="true">
                  <svg viewBox="0 0 24 24" fill="none"><path d="M7 7h10v10H7V7z" stroke="currentColor" stroke-width="1.6"/><path d="M9 9h6v6H9V9z" stroke="currentColor" stroke-width="1.6"/><path d="M5 12h2M17 12h2" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/></svg>
                </div>
                <div class="payMeta">
                  <div class="name">СБП</div>
                  <div class="desc">Перевод по QR (RUB)</div>
                </div>
              </div>
              <span class="badge">RUB</span>
            </div>

            <div class="payOpt" data-kind="card" style="grid-column: 1 / -1;">
              <div class="payLeft">
                <div class="payLogo" aria-hidden="true">
                  <svg viewBox="0 0 24 24" fill="none"><path d="M4 7.5h16v9H4v-9z" stroke="currentColor" stroke-width="1.6"/><path d="M4 10h16" stroke="currentColor" stroke-width="1.6"/><path d="M7 14h4" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/></svg>
                </div>
                <div class="payMeta">
                  <div class="name">Карта</div>
                  <div class="desc">Оплата банковской картой</div>
                </div>
              </div>
              <span class="badge">CARD</span>
            </div>
          </div>

          <div class="actions">
            <button class="btn primary" id="createTopupBtn">Создать счёт</button>
            <button class="btn" data-close="topupModal">Отмена</button>
          </div>
        </div>
      </div>

      <div class="card hidden" id="invoiceCard" style="margin-top:12px;">
        <h3>Счёт создан</h3>
        <p id="invoiceText" class="muted"></p>
        <div class="actions">
          <a class="btn primary" id="payLink" target="_blank" rel="noopener">Перейти к оплате</a>
          <button class="btn" id="checkInvoiceBtn">Проверить статус</button>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="backdrop" id="withdrawModal">
  <div class="modal">
    <div class="modalHead">
      <div class="modalTitle">Вывод</div>
      <button class="iconBtn" data-close="withdrawModal"><span class="x"></span></button>
    </div>
    <div class="modalBody">
      <div class="grid2">
        <div class="card">
          <h3>Сумма</h3>
          <div class="field">
            <label>Валюта</label>
            <select class="select" id="withdrawCurrency">
              <option value="EUR">EUR</option>
              <option value="USD">USD</option>
              <option value="RUB">RUB</option>
            </select>
          </div>
          <div class="field">
            <label>Сумма</label>
            <input class="input" id="withdrawAmount" placeholder="например 10" inputmode="decimal">
          </div>
        </div>
        <div class="card">
          <h3>Куда</h3>
          <div class="field">
            <label>Реквизиты / адрес</label>
            <input class="input" id="withdrawDest" placeholder="карта / кошелёк / реквизиты">
          </div>
          <div class="field">
            <label>Комментарий (опционально)</label>
            <input class="input" id="withdrawNote" placeholder="например: вывод на карту">
          </div>
          <div class="actions">
            <button class="btn primary" id="createWithdrawBtn">Создать заявку</button>
            <button class="btn" data-close="withdrawModal">Отмена</button>
          </div>
          <p class="muted" style="margin-top:10px;">В шаблоне вывод создаётся со статусом <span class="mono">pending</span>.</p>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="backdrop" id="newDealModal">
  <div class="modal">
    <div class="modalHead">
      <div class="modalTitle">Новая сделка</div>
      <button class="iconBtn" data-close="newDealModal"><span class="x"></span></button>
    </div>
    <div class="modalBody">
      <div class="grid2">
        <div class="card">
          <h3>Параметры</h3>
          <div class="field">
            <label>Тип</label>
            <select class="select" id="dealType">
              <option value="buy">Я покупаю</option>
              <option value="sell">Я продаю</option>
            </select>
          </div>
          <div class="field">
            <label>Пользователь (email или username)</label>
            <input class="input" id="dealCounterparty" placeholder="username или email">
          </div>
          <div class="field">
            <label>Название / что покупаем</label>
            <input class="input" id="dealTitle" placeholder="например: 1000 gold, skin, аккаунт...">
          </div>
        </div>
        <div class="card">
          <h3>Сумма</h3>
          <div class="field">
            <label>Валюта</label>
            <select class="select" id="dealCurrency">
              <option value="USD">USD</option>
              <option value="EUR">EUR</option>
              <option value="RUB">RUB</option>
            </select>
          </div>
          <div class="field">
            <label>Сумма</label>
            <input class="input" id="dealAmount" placeholder="например 10" inputmode="decimal">
          </div>
          <div class="field">
            <label>Комментарий (опционально)</label>
            <textarea class="textarea" id="dealNote" placeholder="детали: сроки, описание и т.д."></textarea>
          </div>
        </div>
      </div>
      <div class="actions">
        <button class="btn primary" id="createDealBtn">Создать</button>
        <button class="btn" data-close="newDealModal">Отмена</button>
      </div>
    </div>
  </div>
</div>

<div class="backdrop" id="dealModal">
  <div class="modal">
    <div class="modalHead">
      <div class="modalTitle" id="dealModalTitle">Сделка</div>
      <button class="iconBtn" data-close="dealModal"><span class="x"></span></button>
    </div>
    <div class="modalBody" id="dealModalBody"></div>
  </div>
</div>

<div class="backdrop" id="logsModal">
  <div class="modal">
    <div class="modalHead">
      <div class="modalTitle">Логи</div>
      <button class="iconBtn" data-close="logsModal"><span class="x"></span></button>
    </div>
    <div class="modalBody">
      <div id="logsTable"></div>
    </div>
  </div>
</div>

<div class="backdrop" id="logDetailModal">
  <div class="modal">
    <div class="modalHead">
      <div class="modalTitle">Детали</div>
      <button class="iconBtn" data-close="logDetailModal"><span class="x"></span></button>
    </div>
    <div class="modalBody">
      <div class="card">
        <h3 id="logDetailTitle">…</h3>
        <p class="muted" id="logDetailMeta">…</p>
        <pre class="mono" id="logDetailJson" style="white-space:pre-wrap;word-break:break-word;margin:12px 0 0;color:rgba(255,255,255,.86);"></pre>
      </div>
    </div>
  </div>
</div>

<div class="backdrop" id="adminUserModal">
  <div class="modal">
    <div class="modalHead">
      <div class="modalTitle" id="adminUserTitle">Профиль пользователя</div>
      <button class="iconBtn" data-close="adminUserModal"><span class="x"></span></button>
    </div>
    <div class="modalBody">
      <div id="adminUserBody"></div>
    </div>
  </div>
</div>

<div class="toastWrap" id="toastWrap"></div>

<script>
  const $ = (q, el=document) => el.querySelector(q);
  const $$ = (q, el=document) => Array.from(el.querySelectorAll(q));

  function fmtTs(ts){
    const d = new Date(ts);
    return d.toLocaleString(undefined, { year:'numeric', month:'2-digit', day:'2-digit', hour:'2-digit', minute:'2-digit', second:'2-digit' });
  }
  function money(n){
    const x = Number(n || 0);
    return x.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
  }
  function escapeHtml(s){
    return String(s ?? "").replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
  }
  function toast(title, msg, actions=[]){
    const wrap = $("#toastWrap");
    const el = document.createElement("div");
    el.className = "toast";
    el.innerHTML = `
      <div class="t">${escapeHtml(title)}</div>
      <div class="m">${escapeHtml(msg)}</div>
      <div class="mini"></div>
    `;
    const mini = $(".mini", el);
    actions.forEach(a => {
      const b = document.createElement("span");
      b.className = "link";
      b.textContent = a.label;
      b.onclick = () => { try{ a.onClick?.(); } finally { el.remove(); } };
      mini.appendChild(b);
    });
    wrap.appendChild(el);
    setTimeout(() => el.remove(), 6500);
  }

  async function api(path, {method="GET", body, headers={}} = {}){
    const res = await fetch(path, {
      method,
      headers: { "Content-Type":"application/json", ...headers },
      credentials: "include",
      body: body ? JSON.stringify(body) : undefined
    });
    const ct = res.headers.get("content-type") || "";
    const data = ct.includes("application/json") ? await res.json().catch(() => ({})) : await res.text().catch(()=> "");
    if(!res.ok){
      const msg = (data && data.error) ? data.error : (typeof data === "string" ? data : "Request failed");
      throw new Error(msg);
    }
    return data;
  }

  const state = { me:null, balances:null, deals:[], invoice:null, payKind:"crypto", adminUsers:[] };

  const routes = ["home","auth","profile","deals","admin"];
  function setRoute(route){ if(!routes.includes(route)) route="home"; location.hash = "#/" + route; }
  function getRoute(){ const m = (location.hash || "").match(/^#\\/([a-z]+)/i); return m ? m[1] : "home"; }
  function renderRoute(){
    const r = getRoute();
    $("#title").textContent =
      r === "home" ? "Главная" :
      r === "auth" ? "Войти" :
      r === "deals" ? "Сделки" :
      r === "profile" ? "Кошелёк" : "Админка";
    $("#subtitle").textContent =
      r === "home" ? "Сделки, чат и кошелёк — всё в одном." :
      r === "auth" ? "Вход / регистрация" :
      r === "deals" ? "Список сделок и чат по каждой сделке" :
      r === "profile" ? "Баланс, пополнение, вывод и безопасность" :
      "Пользователи и системные логи";

    $$("#nav a").forEach(a => a.classList.toggle("active", a.dataset.route === r));
    $("#view-home").classList.toggle("hidden", r !== "home");
    $("#view-auth").classList.toggle("hidden", r !== "auth");
    $("#view-deals").classList.toggle("hidden", r !== "deals");
    $("#view-profile").classList.toggle("hidden", r !== "profile");
    $("#view-admin").classList.toggle("hidden", r !== "admin");

    if((r === "profile" || r === "deals") && !state.me) setRoute("auth");
    if(r === "admin" && !(state.me && state.me.role === "admin")) setRoute("home");
  }
  window.addEventListener("hashchange", renderRoute);

  function openModal(id){ $("#"+id).classList.add("show"); }
  function closeModal(id){ $("#"+id).classList.remove("show"); }
  $$(".backdrop").forEach(b => b.addEventListener("click", (e) => { if(e.target === b) b.classList.remove("show"); }));
  $$("[data-close]").forEach(btn => btn.addEventListener("click", () => closeModal(btn.dataset.close)));

  async function refreshHomeKpis(){
    const box = $("#homeKpis");
    box.innerHTML = "";
    if(!state.me){
      box.innerHTML = `
        <div class="kpi"><div class="label">Статус</div><div class="value">Гость <small>•</small></div></div>
        <div class="kpi"><div class="label">Сделок</div><div class="value">— <small>•</small></div></div>
      `;
      return;
    }
    const dealsCount = (state.deals || []).length;
    box.innerHTML = `
      <div class="kpi"><div class="label">Аккаунт</div><div class="value">${escapeHtml(state.me.username)} <small>${escapeHtml(state.me.role)}</small></div></div>
      <div class="kpi"><div class="label">Сделок</div><div class="value">${dealsCount} <small>всего</small></div></div>
    `;
  }

  async function refreshMe(){
    try{ state.me = await api("/api/me"); }catch{ state.me = null; }
    const authed = !!state.me;

    $("#authPill").textContent = authed ? (state.me.username + (state.me.role === "admin" ? " • admin" : "")) : "Гость";
    $("#logoutBtn").classList.toggle("hidden", !authed);

    $("#navAuth").classList.toggle("hidden", authed);
    $("#navDeals").classList.toggle("hidden", !authed);
    $("#navProfile").classList.toggle("hidden", !authed);
    $("#navAdmin").classList.toggle("hidden", !(authed && state.me.role === "admin"));

    $("#topupBtnTop").classList.toggle("hidden", !authed);
    $("#newDealBtnTop").classList.toggle("hidden", !authed);

    $("#homeLoginBtn").classList.toggle("hidden", authed);
    $("#homeDealsBtn").classList.toggle("hidden", !authed);
    $("#homeWalletBtn").classList.toggle("hidden", !authed);
    $("#homeNewDealBtn").classList.toggle("hidden", !authed);
    $("#homeHint").textContent = authed ? "Откройте сделки или кошелёк." : "Войдите, чтобы видеть сделки и баланс.";

    if(authed){
      await loadDeals().catch(()=>{});
      await loadBalances().catch(()=>{});
      await loadRecentLogs().catch(()=>{});
      if(state.me.role === "admin"){
        await loadUsers().catch(()=>{});
        await loadAdminLogs().catch(()=>{});
      }
    }else{
      state.balances = null;
      state.deals = [];
      $("#balanceKpis").innerHTML = "";
      $("#dealsTbody").innerHTML = "";
      $("#recentLogs").innerHTML = "";
      $("#usersTbody").innerHTML = "";
      $("#adminLogs").innerHTML = "";
    }
    await refreshHomeKpis();
    renderRoute();
  }

  $("#refreshBtn").addEventListener("click", refreshMe);

  $("#loginBtn").addEventListener("click", async () => {
    try{
      const emailOrUsername = $("#loginId").value.trim();
      const password = $("#loginPw").value;
      if(!emailOrUsername || !password) return toast("Ошибка", "Заполни логин и пароль");
      await api("/api/auth/login", { method:"POST", body:{ emailOrUsername, password }});
      toast("Готово", "Ты вошёл");
      setRoute("deals");
      await refreshMe();
    }catch(e){ toast("Не получилось", e.message); }
  });

  $("#regBtn").addEventListener("click", async () => {
    try{
      const email = $("#regEmail").value.trim();
      const username = $("#regUser").value.trim();
      const password = $("#regPw").value;
      if(!email || !username || !password) return toast("Ошибка", "Заполни email, username и пароль");
      await api("/api/auth/register", { method:"POST", body:{ email, username, password }});
      toast("Аккаунт создан", "Ты зарегистрирован и вошёл");
      setRoute("deals");
      await refreshMe();
    }catch(e){ toast("Не получилось", e.message); }
  });

  $("#demoBtn").addEventListener("click", () => {
    $("#loginId").value = "admin@onlymarket.local";
    $("#loginPw").value = "admin12345";
    toast("Демо", "Если база пустая — демо-админ создаётся автоматически. Нажми “Войти”.");
  });

  $("#logoutBtn").addEventListener("click", async () => {
    try{
      await api("/api/auth/logout", { method:"POST" });
      toast("Ок", "Ты вышел");
      setRoute("home");
      await refreshMe();
    }catch(e){ toast("Ошибка", e.message); }
  });

  async function loadBalances(){
    const bal = await api("/api/wallet/balances");
    state.balances = bal.balances || {};
    const kpis = $("#balanceKpis");
    kpis.innerHTML = "";
    const entries = Object.entries(state.balances);
    if(!entries.length){
      kpis.innerHTML = `<div class="kpi"><div class="label">Баланс</div><div class="value">0.00 <small>USD</small></div></div>`;
      return;
    }
    entries.forEach(([cur, val]) => {
      const div = document.createElement("div");
      div.className = "kpi";
      div.innerHTML = `<div class="label">${escapeHtml(cur)}</div><div class="value">${money(val)} <small>${escapeHtml(cur)}</small></div>`;
      kpis.appendChild(div);
    });
  }

  function resetTopup(){
    $("#invoiceCard").classList.add("hidden");
    state.invoice = null;
    $("#topupAmount").value = "";
    state.payKind = "crypto";
    $$("#payGrid .payOpt").forEach(el => el.classList.toggle("active", el.dataset.kind === "crypto"));
  }

  $("#topupBtnTop").addEventListener("click", () => { resetTopup(); openModal("topupModal"); });
  $("#topupBtn2").addEventListener("click", () => $("#topupBtnTop").click());

  $$("#payGrid .payOpt").forEach(el => {
    el.addEventListener("click", () => {
      state.payKind = el.dataset.kind;
      $$("#payGrid .payOpt").forEach(x => x.classList.toggle("active", x === el));
      if(state.payKind === "sbp") $("#topupCurrency").value = "RUB";
    });
  });

  function mapPay(kind){
    if(kind === "crypto") return { provider:"cryptobot", method:"crypto" };
    if(kind === "sbp") return { provider:"platega", method:"sbp" };
    return { provider:"platega", method:"card" };
  }

  $("#createTopupBtn").addEventListener("click", async () => {
    try{
      const amount = Number(String($("#topupAmount").value).replace(",", "."));
      const currency = $("#topupCurrency").value;
      if(!(amount > 0)) return toast("Ошибка", "Сумма должна быть больше 0");
      if(state.payKind === "sbp" && currency !== "RUB") return toast("Ошибка", "СБП работает только с RUB");

      const pm = mapPay(state.payKind);
      const inv = await api("/api/wallet/topup/create", { method:"POST", body: { amount, currency, ...pm }});
      state.invoice = inv;

      $("#invoiceText").textContent = `ID: ${inv.id} • ${money(inv.amount)} ${inv.currency}`;
      $("#payLink").href = inv.payUrl;
      $("#invoiceCard").classList.remove("hidden");
      toast("Счёт создан", "Открой оплату, затем нажми “Проверить статус”.");
    }catch(e){ toast("Ошибка", e.message); }
  });

  $("#checkInvoiceBtn").addEventListener("click", async () => {
    try{
      if(!state.invoice) return;
      const st = await api("/api/wallet/topup/status?id=" + encodeURIComponent(state.invoice.id));
      if(st.status === "paid"){
        toast("Оплачено", "Баланс обновлён");
        closeModal("topupModal");
        await loadBalances();
        await loadRecentLogs();
      }else{
        toast("Пока не оплачено", "Статус: " + st.status);
      }
    }catch(e){ toast("Ошибка", e.message); }
  });

  $("#withdrawBtn").addEventListener("click", () => {
    $("#withdrawAmount").value = "";
    $("#withdrawDest").value = "";
    $("#withdrawNote").value = "";
    openModal("withdrawModal");
  });

  $("#createWithdrawBtn").addEventListener("click", async () => {
    try{
      const currency = $("#withdrawCurrency").value;
      const amount = Number(String($("#withdrawAmount").value).replace(",", "."));
      const destination = ($("#withdrawDest").value || "").trim();
      const note = ($("#withdrawNote").value || "").trim();
      if(!(amount > 0)) return toast("Ошибка", "Некорректная сумма");
      if(!destination) return toast("Ошибка", "Укажи реквизиты");
      const r = await api("/api/wallet/withdraw", { method:"POST", body:{ currency, amount, destination, note }});
      toast("Заявка создана", "Статус: " + r.status + " • ID: " + r.id);
      closeModal("withdrawModal");
      await loadBalances();
      await loadRecentLogs();
    }catch(e){ toast("Ошибка", e.message); }
  });

  async function loadRecentLogs(){
    const res = await api("/api/logs/me?limit=10");
    const box = $("#recentLogs");
    const items = res.items || [];
    if(!items.length){ box.innerHTML = `<p class="muted">Пока пусто.</p>`; return; }
    const table = document.createElement("table");
    table.innerHTML = `<thead><tr><th style="width:190px;">Время</th><th style="width:220px;">Тип</th><th>Описание</th></tr></thead><tbody></tbody>`;
    const tb = table.querySelector("tbody");
    items.forEach(it => {
      const tr = document.createElement("tr");
      tr.style.cursor="pointer";
      tr.innerHTML = `<td class="mono">${escapeHtml(fmtTs(it.ts))}</td><td><span class="badge">${escapeHtml(it.type)}</span></td><td class="muted">${escapeHtml(it.summary || "")}</td>`;
      tr.addEventListener("click", () => showLogDetail(it));
      tb.appendChild(tr);
    });
    box.innerHTML = "";
    box.appendChild(table);
  }

  $("#logsBtn").addEventListener("click", async () => {
    try{
      const res = await api("/api/logs/me?limit=250");
      renderLogsModal(res.items || []);
      openModal("logsModal");
    }catch(e){ toast("Ошибка", e.message); }
  });

  function renderLogsModal(items){
    const box = $("#logsTable");
    if(!items.length){ box.innerHTML = `<p class="muted">Пока пусто.</p>`; return; }
    const table = document.createElement("table");
    table.innerHTML = `<thead><tr><th style="width:190px;">Время</th><th style="width:220px;">Тип</th><th>Детали</th></tr></thead><tbody></tbody>`;
    const tb = table.querySelector("tbody");
    items.forEach(it => {
      const tr = document.createElement("tr");
      tr.style.cursor="pointer";
      tr.innerHTML = `<td class="mono">${escapeHtml(fmtTs(it.ts))}</td><td><span class="badge">${escapeHtml(it.type)}</span></td><td class="muted">${escapeHtml(it.summary || "")}</td>`;
      tr.addEventListener("click", () => showLogDetail(it));
      tb.appendChild(tr);
    });
    box.innerHTML = "";
    box.appendChild(table);
  }

  function showLogDetail(it){
    $("#logDetailTitle").textContent = it.type;
    $("#logDetailMeta").textContent = `${fmtTs(it.ts)} • actor: ${it.actorId || "-"} • target: ${it.targetUserId || "-"}`;
    $("#logDetailJson").textContent = JSON.stringify(it, null, 2);
    openModal("logDetailModal");
  }

  $("#changePwBtn").addEventListener("click", async () => {
    try{
      const oldPassword = $("#oldPw").value;
      const newPassword = $("#newPw").value;
      if(!oldPassword || !newPassword) return toast("Ошибка", "Заполни оба поля");
      await api("/api/security/change-password", { method:"POST", body:{ oldPassword, newPassword }});
      $("#oldPw").value = "";
      $("#newPw").value = "";
      toast("Готово", "Пароль обновлён");
      await loadRecentLogs();
    }catch(e){ toast("Ошибка", e.message); }
  });

  async function loadDeals(){
    const res = await api("/api/deals");
    state.deals = res.items || [];
    renderDealsTable();
    await refreshHomeKpis();
  }

  function statusBadge(st){
    const s = String(st || "created");
    if(s === "created") return `<span class="badge">created</span>`;
    if(s === "funded") return `<span class="badge warn">funded</span>`;
    if(s === "delivered") return `<span class="badge warn">delivered</span>`;
    if(s === "completed") return `<span class="badge good">completed</span>`;
    if(s === "canceled") return `<span class="badge bad">canceled</span>`;
    if(s === "disputed") return `<span class="badge bad">disputed</span>`;
    return `<span class="badge">${escapeHtml(s)}</span>`;
  }

  function renderDealsTable(){
    const tb = $("#dealsTbody");
    tb.innerHTML = "";
    const items = state.deals || [];
    if(!items.length){
      const tr = document.createElement("tr");
      tr.innerHTML = `<td colspan="6" class="muted">Сделок пока нет.</td>`;
      tb.appendChild(tr);
      return;
    }
    items.forEach(d => {
      const tr = document.createElement("tr");
      tr.style.cursor="pointer";
      tr.innerHTML = `
        <td class="mono">${escapeHtml(d.id)}</td>
        <td><div style="font-weight:800">${escapeHtml(d.title || "Сделка")}</div><div class="muted" style="margin-top:4px;">${escapeHtml(d.note || "")}</div></td>
        <td class="mono">${money(d.amount)} ${escapeHtml(d.currency)}</td>
        <td>${statusBadge(d.status)}</td>
        <td class="muted">${escapeHtml(d.buyerUsername)} ↔ ${escapeHtml(d.sellerUsername)}</td>
        <td class="mono muted">${escapeHtml(fmtTs(d.updatedAt))}</td>
      `;
      tr.addEventListener("click", () => openDeal(d.id));
      tb.appendChild(tr);
    });
  }

  $("#refreshDealsBtn").addEventListener("click", async () => {
    try{ await loadDeals(); toast("Ок", "Сделки обновлены"); }catch(e){ toast("Ошибка", e.message); }
  });

  function openNewDeal(){
    $("#dealType").value = "buy";
    $("#dealCounterparty").value = "";
    $("#dealTitle").value = "";
    $("#dealCurrency").value = "USD";
    $("#dealAmount").value = "";
    $("#dealNote").value = "";
    openModal("newDealModal");
  }
  $("#newDealBtn").addEventListener("click", openNewDeal);
  $("#newDealBtnTop").addEventListener("click", openNewDeal);
  $("#homeNewDealBtn").addEventListener("click", openNewDeal);

  $("#createDealBtn").addEventListener("click", async () => {
    try{
      const type = $("#dealType").value;
      const counterparty = $("#dealCounterparty").value.trim();
      const title = $("#dealTitle").value.trim();
      const currency = $("#dealCurrency").value;
      const amount = Number(String($("#dealAmount").value).replace(",", "."));
      const note = $("#dealNote").value.trim();
      if(!counterparty) return toast("Ошибка", "Укажи пользователя");
      if(!title) return toast("Ошибка", "Укажи название");
      if(!(amount > 0)) return toast("Ошибка", "Некорректная сумма");
      await api("/api/deals", { method:"POST", body:{ type, counterparty, title, currency, amount, note }});
      closeModal("newDealModal");
      toast("Сделка создана", "Открой и продолжай");
      await loadDeals();
      setRoute("deals");
    }catch(e){ toast("Ошибка", e.message); }
  });

  async function openDeal(id){
    try{
      const deal = await api("/api/deals/" + encodeURIComponent(id));
      renderDealModal(deal);
      openModal("dealModal");
      await refreshDealMessages(id);
    }catch(e){ toast("Ошибка", e.message); }
  }

  function renderDealModal(data){
    const d = data.deal;
    $("#dealModalTitle").textContent = `Сделка • ${d.id}`;
    const meId = state.me?.id;
    const isBuyer = meId === d.buyerId;
    const isSeller = meId === d.sellerId;

    const canFund = isBuyer && d.status === "created";
    const canMarkDelivered = isSeller && d.status === "funded";
    const canConfirm = isBuyer && d.status === "delivered";
    const canCancel = (isBuyer || isSeller) && d.status === "created";
    const canDispute = (isBuyer || isSeller) && (d.status === "funded" || d.status === "delivered");

    const esc = d.escrow || { amount: 0, currency: d.currency, funded: false };

    const body = document.createElement("div");
    body.innerHTML = `
      <div class="grid2">
        <div class="card">
          <h3>Детали</h3>
          <p class="muted">
            <span class="badge">${escapeHtml(d.status)}</span>
            <span class="mono" style="margin-left:8px;">${escapeHtml(fmtTs(d.createdAt))}</span>
          </p>
          <div style="height:10px"></div>
          <div class="kpis">
            <div class="kpi"><div class="label">Сумма</div><div class="value">${money(d.amount)} <small>${escapeHtml(d.currency)}</small></div></div>
            <div class="kpi"><div class="label">Эскроу</div><div class="value">${money(esc.amount || 0)} <small>${escapeHtml(esc.currency || d.currency)}</small></div></div>
          </div>
          <p style="margin-top:10px;"><b>${escapeHtml(d.title)}</b></p>
          ${d.note ? `<p class="muted">${escapeHtml(d.note)}</p>` : `<p class="muted">Без комментариев.</p>`}
          <p class="muted" style="margin-top:10px;">
            Покупатель: <b>${escapeHtml(d.buyerUsername)}</b><br>
            Продавец: <b>${escapeHtml(d.sellerUsername)}</b>
          </p>

          <div class="actions">
            <button class="btn primary ${canFund ? "" : "hidden"}" id="dealFundBtn">Внести деньги в сделку</button>
            <button class="btn primary ${canMarkDelivered ? "" : "hidden"}" id="dealDeliverBtn">Отметить доставку</button>
            <button class="btn primary ${canConfirm ? "" : "hidden"}" id="dealConfirmBtn">Подтвердить получение</button>

            <button class="btn danger ${canDispute ? "" : "hidden"}" id="dealDisputeBtn">Открыть спор</button>
            <button class="btn danger ${canCancel ? "" : "hidden"}" id="dealCancelBtn">Отменить</button>
          </div>

          <p class="muted" style="margin-top:10px;">
            Внести деньги можно только из кошелька. Если денег не хватает — пополни.
          </p>
        </div>

        <div class="card">
          <h3>Чат по сделке</h3>
          <p class="muted">Все сообщения сохраняются.</p>

          <div class="chatBox" style="margin-top:10px;">
            <div class="chatLog" id="chatLog"></div>
            <div class="chatSend">
              <textarea class="textarea" id="chatText" placeholder="Сообщение..."></textarea>
              <button class="btn primary" id="chatSendBtn">Отправить</button>
            </div>
          </div>

          <div class="actions">
            <button class="btn" id="chatRefreshBtn">Обновить чат</button>
          </div>
        </div>
      </div>
    `;

    $("#dealModalBody").innerHTML = "";
    $("#dealModalBody").appendChild(body);

    const wire = (btnId, fn) => { const el = $("#"+btnId); if(el) el.onclick = fn; };

    wire("dealFundBtn", async () => {
      try{
        await api(`/api/deals/${encodeURIComponent(d.id)}/fund`, { method:"POST" });
        toast("Готово", "Деньги внесены в сделку");
        await loadBalances();
        await loadDeals();
        await openDeal(d.id);
      }catch(e){
        toast("Ошибка", e.message, [{ label:"Пополнить", onClick:()=> $("#topupBtnTop").click() }]);
      }
    });

    wire("dealDeliverBtn", async () => {
      try{
        await api(`/api/deals/${encodeURIComponent(d.id)}/mark-delivered`, { method:"POST" });
        toast("Ок", "Доставка отмечена");
        await loadDeals();
        await openDeal(d.id);
      }catch(e){ toast("Ошибка", e.message); }
    });

    wire("dealConfirmBtn", async () => {
      try{
        await api(`/api/deals/${encodeURIComponent(d.id)}/confirm`, { method:"POST" });
        toast("Завершено", "Сделка закрыта, деньги переведены");
        await loadBalances();
        await loadDeals();
        await openDeal(d.id);
      }catch(e){ toast("Ошибка", e.message); }
    });

    wire("dealCancelBtn", async () => {
      try{
        await api(`/api/deals/${encodeURIComponent(d.id)}/cancel`, { method:"POST" });
        toast("Ок", "Сделка отменена");
        await loadDeals();
        await openDeal(d.id);
      }catch(e){ toast("Ошибка", e.message); }
    });

    wire("dealDisputeBtn", async () => {
      try{
        await api(`/api/deals/${encodeURIComponent(d.id)}/dispute`, { method:"POST" });
        toast("Спор", "Спор открыт");
        await loadDeals();
        await openDeal(d.id);
      }catch(e){ toast("Ошибка", e.message); }
    });

    wire("chatSendBtn", async () => {
      const text = ($("#chatText").value || "").trim();
      if(!text) return;
      $("#chatText").value = "";
      try{
        await api(`/api/deals/${encodeURIComponent(d.id)}/messages`, { method:"POST", body:{ text }});
        await refreshDealMessages(d.id);
      }catch(e){ toast("Ошибка", e.message); }
    });

    wire("chatRefreshBtn", async () => refreshDealMessages(d.id));
  }

  async function refreshDealMessages(dealId){
    const res = await api(`/api/deals/${encodeURIComponent(dealId)}/messages?limit=120`);
    const items = res.items || [];
    const box = $("#chatLog");
    if(!box) return;
    box.innerHTML = "";
    if(!items.length){ box.innerHTML = `<p class="muted">Сообщений нет.</p>`; return; }
    items.reverse().forEach(m => {
      const isMe = state.me && m.userId === state.me.id;
      const div = document.createElement("div");
      div.className = "msg " + (isMe ? "me" : "");
      div.innerHTML = `
        <div class="bubble">${escapeHtml(m.text)}</div>
        <div class="msgMeta">
          <span>${escapeHtml(m.username || "user")}</span>
          <span class="mono">${escapeHtml(fmtTs(m.ts))}</span>
        </div>
      `;
      box.appendChild(div);
    });
    box.scrollTop = box.scrollHeight;
  }

  async function loadUsers(){
    const res = await api("/api/admin/users");
    state.adminUsers = res.items || [];
    renderUsers();
  }
  function renderUsers(){
    const q = ($("#userSearch").value || "").trim().toLowerCase();
    const items = (state.adminUsers || []).filter(u => {
      if(!q) return true;
      return [u.id,u.email,u.username].some(x => String(x||"").toLowerCase().includes(q));
    });
    const tb = $("#usersTbody");
    tb.innerHTML = "";
    items.forEach(u => {
      const tr = document.createElement("tr");
      tr.style.cursor="pointer";
      const st = u.isBanned ? `<span class="badge bad">banned</span>` : `<span class="badge good">active</span>`;
      tr.innerHTML = `
        <td>
          <div style="font-weight:800;">${escapeHtml(u.username)}</div>
          <div class="muted mono" style="margin-top:4px;">${escapeHtml(u.email)} • ${escapeHtml(u.id)}</div>
        </td>
        <td><span class="badge">${escapeHtml(u.role)}</span></td>
        <td>${st}</td>
        <td class="mono">${escapeHtml(fmtTs(u.createdAt))}</td>
      `;
      tr.addEventListener("click", () => openAdminUser(u.id));
      tb.appendChild(tr);
    });
    if(!items.length){
      const tr = document.createElement("tr");
      tr.innerHTML = `<td colspan="4" class="muted">Ничего не найдено.</td>`;
      tb.appendChild(tr);
    }
  }
  $("#userSearch").addEventListener("input", renderUsers);

  async function openAdminUser(userId){
    const prof = await api("/api/admin/users/" + encodeURIComponent(userId));
    const logs = await api("/api/admin/users/" + encodeURIComponent(userId) + "/logs?limit=200");
    const deals = await api("/api/admin/users/" + encodeURIComponent(userId) + "/deals?limit=200");

    $("#adminUserTitle").textContent = `Профиль: ${prof.user.username}`;
    const balances = prof.balances || {};
    const balHtml = Object.entries(balances).map(([k,v]) => `
      <div class="kpi"><div class="label">${escapeHtml(k)}</div><div class="value">${money(v)} <small>${escapeHtml(k)}</small></div></div>
    `).join("") || `<p class="muted">Баланс пуст.</p>`;

    const isBanned = !!prof.user.isBanned;

    const body = document.createElement("div");
    body.innerHTML = `
      <div class="card">
        <h3>Данные</h3>
        <p class="muted mono">id: ${escapeHtml(prof.user.id)}<br>email: ${escapeHtml(prof.user.email)}<br>created: ${escapeHtml(fmtTs(prof.user.createdAt))}</p>
        <div class="actions">
          <button class="btn ${isBanned ? "" : "danger"}" id="banToggleBtn">${isBanned ? "Разбанить" : "Забанить"}</button>
          <button class="btn" id="makeUserBtn">Роль: user</button>
          <button class="btn" id="makeAdminBtn">Роль: admin</button>
        </div>
      </div>

      <div style="height:12px"></div>

      <div class="card">
        <h3>Балансы</h3>
        <div class="kpis">${balHtml}</div>
        <div class="grid2" style="margin-top:12px;">
          <div>
            <div class="field">
              <label>Валюта</label>
              <select class="select" id="adjCur">
                <option value="EUR">EUR</option>
                <option value="USD">USD</option>
                <option value="RUB">RUB</option>
              </select>
            </div>
          </div>
          <div>
            <div class="field">
              <label>Сумма (delta)</label>
              <input class="input" id="adjDelta" placeholder="например 10 или -5" inputmode="decimal">
            </div>
          </div>
        </div>
        <div class="field">
          <label>Причина</label>
          <input class="input" id="adjReason" placeholder="коротко: компенсация / корректировка / …">
        </div>
        <div class="actions">
          <button class="btn primary" id="adjBtn">Применить</button>
        </div>
      </div>

      <div style="height:12px"></div>

      <div class="card">
        <h3>Сделки пользователя</h3>
        <p class="muted">Клик → открыть сделку.</p>
        <div id="adminUserDeals"></div>
      </div>

      <div style="height:12px"></div>

      <div class="card">
        <h3>Логи пользователя</h3>
        <p class="muted">Клик → детали.</p>
        <div id="adminUserLogs"></div>
      </div>
    `;

    $("#adminUserBody").innerHTML = "";
    $("#adminUserBody").appendChild(body);

    const dItems = deals.items || [];
    const dBox = $("#adminUserDeals");
    if(!dItems.length){
      dBox.innerHTML = `<p class="muted">Пусто.</p>`;
    }else{
      const t = document.createElement("table");
      t.innerHTML = `<thead><tr><th style="width:170px;">ID</th><th>Название</th><th style="width:150px;">Сумма</th><th style="width:140px;">Статус</th><th style="width:190px;">Обновлено</th></tr></thead><tbody></tbody>`;
      const tb = t.querySelector("tbody");
      dItems.forEach(d => {
        const tr = document.createElement("tr");
        tr.style.cursor = "pointer";
        tr.innerHTML = `
          <td class="mono">${escapeHtml(d.id)}</td>
          <td><div style="font-weight:800;">${escapeHtml(d.title)}</div><div class="muted" style="margin-top:4px;">${escapeHtml(d.note || "")}</div></td>
          <td class="mono">${money(d.amount)} ${escapeHtml(d.currency)}</td>
          <td>${statusBadge(d.status)}</td>
          <td class="mono muted">${escapeHtml(fmtTs(d.updatedAt))}</td>
        `;
        tr.addEventListener("click", () => openDeal(d.id));
        tb.appendChild(tr);
      });
      dBox.innerHTML = "";
      dBox.appendChild(t);
    }

    const lItems = logs.items || [];
    const lBox = $("#adminUserLogs");
    if(!lItems.length){
      lBox.innerHTML = `<p class="muted">Пусто.</p>`;
    }else{
      const t = document.createElement("table");
      t.innerHTML = `<thead><tr><th style="width:190px;">Время</th><th style="width:220px;">Тип</th><th>Описание</th></tr></thead><tbody></tbody>`;
      const tb = t.querySelector("tbody");
      lItems.forEach(it => {
        const tr = document.createElement("tr");
        tr.style.cursor="pointer";
        tr.innerHTML = `<td class="mono">${escapeHtml(fmtTs(it.ts))}</td><td><span class="badge">${escapeHtml(it.type)}</span></td><td class="muted">${escapeHtml(it.summary || "")}</td>`;
        tr.addEventListener("click", () => showLogDetail(it));
        tb.appendChild(tr);
      });
      lBox.innerHTML = "";
      lBox.appendChild(t);
    }

    $("#banToggleBtn").onclick = async () => {
      await api("/api/admin/users/" + encodeURIComponent(userId) + "/ban", { method:"POST", body:{ isBanned: !isBanned }});
      toast("Готово", (!isBanned ? "Пользователь забанен" : "Пользователь разбанен"));
      await loadUsers(); await loadAdminLogs();
      await openAdminUser(userId);
    };
    $("#makeUserBtn").onclick = async () => {
      await api("/api/admin/users/" + encodeURIComponent(userId) + "/set-role", { method:"POST", body:{ role: "user" }});
      toast("Роль обновлена", "Теперь user");
      await loadUsers(); await loadAdminLogs();
      await openAdminUser(userId);
    };
    $("#makeAdminBtn").onclick = async () => {
      await api("/api/admin/users/" + encodeURIComponent(userId) + "/set-role", { method:"POST", body:{ role: "admin" }});
      toast("Роль обновлена", "Теперь admin");
      await loadUsers(); await loadAdminLogs();
      await openAdminUser(userId);
    };
    $("#adjBtn").onclick = async () => {
      const currency = $("#adjCur").value;
      const delta = Number(String($("#adjDelta").value).replace(",", "."));
      const reason = ($("#adjReason").value || "").trim();
      if(!(delta && Number.isFinite(delta))) return toast("Ошибка", "Укажи delta (например 10 или -5)");
      await api("/api/admin/users/" + encodeURIComponent(userId) + "/adjust-balance", { method:"POST", body:{ currency, delta, reason }});
      toast("Готово", "Баланс изменён");
      await loadUsers(); await loadAdminLogs();
      await openAdminUser(userId);
    };

    openModal("adminUserModal");
  }

  async function loadAdminLogs(){
    const res = await api("/api/admin/logs?limit=120");
    const items = res.items || [];
    const box = $("#adminLogs");
    if(!items.length){ box.innerHTML = `<p class="muted">Пусто.</p>`; return; }
    const t = document.createElement("table");
    t.innerHTML = `<thead><tr><th style="width:190px;">Время</th><th style="width:220px;">Тип</th><th style="width:220px;">Кто → кого</th><th>Описание</th></tr></thead><tbody></tbody>`;
    const tb = t.querySelector("tbody");
    items.forEach(it => {
      const tr = document.createElement("tr");
      tr.style.cursor="pointer";
      tr.innerHTML = `
        <td class="mono">${escapeHtml(fmtTs(it.ts))}</td>
        <td><span class="badge">${escapeHtml(it.type)}</span></td>
        <td class="mono muted">${escapeHtml(it.actorId || "-")} → ${escapeHtml(it.targetUserId || "-")}</td>
        <td class="muted">${escapeHtml(it.summary || "")}</td>
      `;
      tr.addEventListener("click", () => showLogDetail(it));
      tb.appendChild(tr);
    });
    box.innerHTML = "";
    box.appendChild(t);
  }

  (async function init(){
    if(!location.hash) setRoute("home");
    await refreshMe();
    renderRoute();
  })();
</script>
</body>
</html>


