
<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="color-scheme" content="dark light" />
  <title>Only Market ‚Äî V2</title>

  <style>
    /* ============================================================
       Only Market ‚Äî V2 (single-file HTML)
       - Default theme: DARK (toggle to LIGHT)
       - Modern gradients + glass UI
       - Hash router: #market #sell #deals #chat #wallet #profile
       - API wrapper with fallbacks + friendly errors
       ============================================================ */

    :root{
      --r-xl: 22px; --r-lg: 18px; --r-md: 14px; --r-sm: 12px;
      --t-fast: 160ms; --t-mid: 260ms;
      --blur: blur(14px);
      --border: 1px solid rgba(255,255,255,.10);
      --border2: 1px solid rgba(255,255,255,.08);
      --shadow1: 0 16px 46px rgba(0,0,0,.34);
      --shadow2: 0 10px 28px rgba(0,0,0,.24);
      --inset: inset 0 1px 0 rgba(255,255,255,.06);
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }

    :root[data-theme="dark"]{
      --bg0:#070814; --bg1:#090A18; --card: rgba(255,255,255,.06); --card2: rgba(255,255,255,.08);
      --txt1: rgba(255,255,255,.92); --txt2: rgba(255,255,255,.72); --txt3: rgba(255,255,255,.50);
      --inv: rgba(0,0,0,.92);
      --v:#7c3aed; --c:#06b6d4; --g:#22c55e; --w:#f59e0b; --e:#ef4444;
      --field: rgba(255,255,255,.06); --field2: rgba(255,255,255,.10);
      --chip: rgba(255,255,255,.08); --chip2: rgba(255,255,255,.14);
      --ring: rgba(124,58,237,.55);
      --overlay: rgba(0,0,0,.55);
    }

    :root[data-theme="light"]{
      --bg0:#f6f7ff; --bg1:#ffffff; --card: rgba(255,255,255,.72); --card2: rgba(255,255,255,.84);
      --txt1: rgba(15,23,42,.92); --txt2: rgba(15,23,42,.72); --txt3: rgba(15,23,42,.48);
      --inv: rgba(255,255,255,.96);
      --v:#6d28d9; --c:#0891b2; --g:#16a34a; --w:#b45309; --e:#dc2626;
      --field: rgba(15,23,42,.06); --field2: rgba(15,23,42,.10);
      --chip: rgba(15,23,42,.06); --chip2: rgba(15,23,42,.10);
      --ring: rgba(109,40,217,.40);
      --border: 1px solid rgba(15,23,42,.10);
      --border2: 1px solid rgba(15,23,42,.08);
      --shadow1: 0 18px 52px rgba(2,6,23,.12);
      --shadow2: 0 10px 28px rgba(2,6,23,.10);
      --inset: inset 0 1px 0 rgba(255,255,255,.64);
      --overlay: rgba(2,6,23,.45);
    }

    *{ box-sizing: border-box; }
    html,body{ height:100%; }
    body{
      margin:0; color:var(--txt1); background: var(--bg0);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial, "Apple Color Emoji","Segoe UI Emoji";
      overflow-x:hidden;
    }
    a{ color:inherit; text-decoration:none; }
    button,input,select,textarea{ font:inherit; color:inherit; }
    ::selection{ background: rgba(124,58,237,.24); }

    .bgfx{
      position: fixed; inset:-20vh -20vw; z-index:-1; pointer-events:none;
      background:
        radial-gradient(1200px 700px at 12% 14%, rgba(124,58,237,.42), transparent 55%),
        radial-gradient(900px 600px at 82% 22%, rgba(6,182,212,.30), transparent 56%),
        radial-gradient(900px 600px at 68% 88%, rgba(34,197,94,.20), transparent 58%),
        radial-gradient(1100px 800px at 20% 92%, rgba(245,158,11,.14), transparent 62%),
        linear-gradient(180deg, var(--bg0), var(--bg1) 44%, var(--bg0));
      filter: saturate(1.1) contrast(1.05);
      transform: translateZ(0);
    }

    .shell{ max-width: 1220px; margin: 0 auto; padding: 18px 16px 92px; }
    @media(min-width:920px){ .shell{ padding: 22px 18px 28px; } .grid{ display:grid; grid-template-columns: 290px 1fr; gap:18px; align-items:start; } }

    /* Topbar */
    .topbar{ position: sticky; top:0; z-index:40; padding: 14px 0 10px; backdrop-filter: var(--blur); -webkit-backdrop-filter: var(--blur); }
    .topbar-inner{
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      padding:12px; border-radius: var(--r-xl);
      background: linear-gradient(180deg, var(--card), rgba(255,255,255,.03));
      border: var(--border); box-shadow: var(--inset);
    }
    .brand{ display:flex; align-items:center; gap:10px; min-width: 180px; cursor:pointer; user-select:none; }
    .logo{
      width:36px; height:36px; border-radius:12px;
      background: radial-gradient(14px 14px at 30% 35%, rgba(255,255,255,.70), transparent 60%),
                  linear-gradient(135deg, var(--v), var(--c));
      box-shadow: 0 14px 35px rgba(124,58,237,.22);
      border: 1px solid rgba(255,255,255,.18);
    }
    .brand h1{ margin:0; font-size: 14px; line-height:1.1; font-weight: 850; letter-spacing:.2px; }
    .brand .sub{ margin:0; font-size:12px; color: var(--txt3); letter-spacing:.2px; }
    .top-actions{ display:flex; align-items:center; gap:8px; flex-wrap:wrap; justify-content:flex-end; }
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:10px 12px; border-radius:999px;
      background: var(--chip); border: var(--border2);
      cursor:pointer; user-select:none; white-space:nowrap;
      transition: transform var(--t-fast) ease, background var(--t-fast) ease;
    }
    .pill:hover{ transform: translateY(-1px); background: var(--chip2); }
    .pill:active{ transform: translateY(0) scale(.99); }
    .dot{ width:8px; height:8px; border-radius:99px; background: rgba(255,255,255,.26); }
    .dot.ok{ background: var(--g); }
    .dot.err{ background: var(--e); }
    .dot.warn{ background: var(--w); }

    .icon-btn{
      width:40px; height:40px; display:grid; place-items:center;
      border-radius:999px; border: var(--border2); background: var(--chip);
      cursor:pointer;
      transition: transform var(--t-fast) ease, background var(--t-fast) ease;
    }
    .icon-btn:hover{ transform: translateY(-1px); background: var(--chip2); }
    .icon-btn:active{ transform: translateY(0) scale(.99); }

    /* Nav */
    .nav{ display:none; }
    @media(min-width:920px){ .nav{ display:block; position: sticky; top: 92px; } }
    .nav-card{
      border-radius: var(--r-xl);
      background: linear-gradient(180deg, var(--card), rgba(255,255,255,.03));
      border: var(--border); box-shadow: var(--inset);
      padding: 12px;
    }
    .nav-title{ padding: 10px 10px 6px; font-size:12px; color: var(--txt3); letter-spacing: .18em; text-transform: uppercase; }
    .nav-item{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding: 11px 12px; border-radius: 14px;
      cursor:pointer; user-select:none;
      border: 1px solid transparent;
      transition: background var(--t-fast) ease, border-color var(--t-fast) ease;
    }
    .nav-item:hover{ background: var(--chip); }
    .nav-item.active{
      background: linear-gradient(135deg, rgba(124,58,237,.22), rgba(6,182,212,.14));
      border-color: rgba(124,58,237,.28);
    }
    .nav-left{ display:flex; align-items:center; gap:10px; min-width:0; }
    .nav-ico{
      width:28px; height:28px; border-radius:10px;
      display:grid; place-items:center;
      background: rgba(255,255,255,.06);
      border: var(--border2); flex: 0 0 auto;
    }
    .nav-label{ font-weight: 760; font-size:14px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
    .nav-hint{ font-size:12px; color: var(--txt3); flex: 0 0 auto; }

    /* Bottom nav */
    .bottomnav{
      position: fixed; left:0; right:0; bottom:0;
      padding: 10px 12px calc(10px + env(safe-area-inset-bottom));
      z-index:60; backdrop-filter: var(--blur); -webkit-backdrop-filter: var(--blur);
    }
    @media(min-width:920px){ .bottomnav{ display:none; } }
    .bottomnav-inner{
      max-width: 820px; margin:0 auto;
      border-radius: 22px;
      background: linear-gradient(180deg, var(--card2), rgba(255,255,255,.03));
      border: var(--border);
      box-shadow: var(--shadow2);
      display:grid; grid-template-columns: repeat(5, 1fr); gap: 6px; padding: 8px;
    }
    .bni{
      border-radius:16px; padding:10px 8px;
      display:grid; place-items:center; gap: 6px;
      cursor:pointer; user-select:none;
      border: 1px solid transparent;
      transition: background var(--t-fast) ease, transform var(--t-fast) ease, border-color var(--t-fast) ease;
      font-size: 11px; color: var(--txt2);
    }
    .bni:hover{ transform: translateY(-1px); background: var(--chip); }
    .bni.active{
      background: linear-gradient(135deg, rgba(124,58,237,.20), rgba(6,182,212,.12));
      border-color: rgba(124,58,237,.22);
      color: var(--txt1);
    }

    /* Content card */
    .content{ min-height: 65vh; }
    .card{
      border-radius: var(--r-xl);
      background: linear-gradient(180deg, var(--card), rgba(255,255,255,.03));
      border: var(--border);
      box-shadow: var(--inset);
      overflow:hidden;
    }
    .card-pad{ padding: 16px; }
    @media(min-width:920px){ .card-pad{ padding: 18px; } }

    .section-title{
      display:flex; align-items:flex-end; justify-content:space-between; gap:10px;
      padding: 14px 16px 12px;
      border-bottom: var(--border2);
      background: linear-gradient(180deg, rgba(255,255,255,.04), transparent);
    }
    .section-title h2{ margin:0; font-size: 18px; font-weight: 900; letter-spacing:.2px; }
    .section-title p{ margin:0; font-size: 12px; color: var(--txt3); }

    /* Controls */
    .row{ display:flex; gap: 10px; align-items:center; flex-wrap:wrap; }
    .grid2{ display:grid; gap: 12px; }
    @media(min-width:680px){ .grid2{ grid-template-columns: 1fr 1fr; } }
    .field{
      width:100%; padding:12px; border-radius: 14px;
      background: var(--field); border: var(--border2); outline:none;
      transition: box-shadow var(--t-fast) ease, border-color var(--t-fast) ease, background var(--t-fast) ease;
    }
    .field:focus{ border-color: rgba(124,58,237,.34); box-shadow: 0 0 0 5px var(--ring); background: var(--field2); }
    textarea.field{ min-height:110px; resize: vertical; }

    .btn{
      display:inline-flex; align-items:center; justify-content:center; gap:8px;
      padding: 11px 14px; border-radius: 14px;
      border:none; cursor:pointer; user-select:none;
      background: linear-gradient(135deg, var(--v), var(--c));
      color: var(--inv); font-weight: 850; letter-spacing:.15px;
      box-shadow: 0 16px 40px rgba(124,58,237,.18);
      transition: transform var(--t-fast) ease, filter var(--t-fast) ease;
      white-space:nowrap;
    }
    .btn:hover{ transform: translateY(-1px); filter: brightness(1.03) saturate(1.02); }
    .btn:active{ transform: translateY(0) scale(.99); }
    .btn:disabled{ opacity:.55; cursor:not-allowed; transform:none; }

    .btn-ghost{
      display:inline-flex; align-items:center; justify-content:center; gap:8px;
      padding: 11px 14px; border-radius: 14px;
      background: transparent; border: var(--border2);
      cursor:pointer; user-select:none;
      color: var(--txt1); font-weight: 780;
      transition: transform var(--t-fast) ease, background var(--t-fast) ease;
      white-space:nowrap;
    }
    .btn-ghost:hover{ transform: translateY(-1px); background: var(--chip); }
    .btn-ghost:active{ transform: translateY(0) scale(.99); }

    .btn-danger{
      background: linear-gradient(135deg, rgba(239,68,68,.98), rgba(245,158,11,.85));
      box-shadow: 0 16px 36px rgba(239,68,68,.12);
    }

    .hint{ font-size:12px; color: var(--txt3); line-height:1.45; }
    .muted{ color: var(--txt3); }
    .mono{ font-family: var(--mono); }

    /* Badges */
    .badge{
      display:inline-flex; align-items:center; gap:8px;
      padding: 7px 10px; border-radius: 999px;
      border: var(--border2); background: rgba(255,255,255,.05);
      font-size:12px; color: var(--txt2); white-space:nowrap;
    }
    .badge strong{ color: var(--txt1); font-weight: 900; }
    .badge .i{ width:8px; height:8px; border-radius:99px; background: rgba(255,255,255,.25); }
    .badge.ok .i{ background: var(--g); }
    .badge.warn .i{ background: var(--w); }
    .badge.err .i{ background: var(--e); }
    .badge.brand .i{ background: var(--c); }

    /* Market grid */
    .hero{
      padding: 18px 16px; border-bottom: var(--border2);
      background:
        radial-gradient(900px 420px at 10% -10%, rgba(124,58,237,.20), transparent 58%),
        radial-gradient(900px 420px at 90% -5%, rgba(6,182,212,.16), transparent 60%),
        linear-gradient(180deg, rgba(255,255,255,.04), transparent);
    }
    .hero h3{ margin:0; font-size: 20px; font-weight: 950; letter-spacing:.2px; }
    .hero p{ margin: 6px 0 0; color: var(--txt3); font-size: 13px; }

    .toolbar{ padding: 14px 16px; border-bottom: var(--border2); display:grid; gap:10px; }
    @media(min-width:680px){ .toolbar{ grid-template-columns: 1.2fr .8fr .8fr auto; align-items:center; } }

    .chips{ display:flex; gap:8px; flex-wrap:wrap; }
    .chip{
      padding: 8px 10px; border-radius: 999px;
      border: var(--border2); background: var(--chip);
      font-size: 12px; cursor:pointer; user-select:none;
      transition: background var(--t-fast) ease, transform var(--t-fast) ease;
      color: var(--txt2);
    }
    .chip:hover{ transform: translateY(-1px); background: var(--chip2); }
    .chip.active{
      background: linear-gradient(135deg, rgba(124,58,237,.22), rgba(6,182,212,.12));
      color: var(--txt1);
      border-color: rgba(124,58,237,.22);
    }

    .listgrid{ display:grid; grid-template-columns: repeat(2, 1fr); gap:12px; padding: 14px; }
    @media(min-width:680px){ .listgrid{ grid-template-columns: repeat(3, 1fr); } }
    @media(min-width:1040px){ .listgrid{ grid-template-columns: repeat(4, 1fr); } }

    .item{
      border-radius: 18px; overflow:hidden;
      border: var(--border2); background: rgba(255,255,255,.03);
      cursor:pointer;
      transition: transform var(--t-fast) ease, background var(--t-fast) ease, border-color var(--t-fast) ease;
      display:grid; grid-template-rows: 150px auto;
    }
    .item:hover{ transform: translateY(-2px); background: rgba(255,255,255,.05); border-color: rgba(124,58,237,.24); }
    .thumb{
      position:relative;
      background:
        radial-gradient(120px 80px at 20% 30%, rgba(255,255,255,.14), transparent 60%),
        linear-gradient(135deg, rgba(124,58,237,.28), rgba(6,182,212,.18)),
        rgba(255,255,255,.04);
    }
    .thumb img{ width:100%; height:100%; object-fit:cover; opacity:.95; }
    .vip{
      position:absolute; top:10px; left:10px;
      padding: 6px 10px; border-radius: 999px;
      background: rgba(0,0,0,.40);
      border: 1px solid rgba(255,255,255,.22);
      backdrop-filter: var(--blur); -webkit-backdrop-filter: var(--blur);
      font-size: 11px; color: rgba(255,255,255,.92);
      display:inline-flex; align-items:center; gap:6px;
    }
    :root[data-theme="light"] .vip{ background: rgba(255,255,255,.60); color: rgba(15,23,42,.92); border-color: rgba(15,23,42,.14); }
    .vip .star{ width:10px; height:10px; border-radius:99px; background: linear-gradient(135deg, var(--w), var(--c)); }
    .item-body{ padding: 10px 10px 12px; display:grid; gap: 6px; }
    .item-title{ font-size:13px; font-weight: 900; line-height:1.2; letter-spacing:.2px; max-height:2.4em; overflow:hidden; }
    .item-meta{ display:flex; align-items:center; justify-content:space-between; gap:10px; color: var(--txt3); font-size: 12px; }
    .price{ font-weight: 950; color: var(--txt1); letter-spacing:.2px; }

    /* Details */
    .details{ display:grid; gap:12px; padding: 14px; }
    @media(min-width:920px){ .details{ grid-template-columns: 1.05fr .95fr; align-items:start; } }
    .gallery{
      border-radius: var(--r-xl); overflow:hidden;
      border: var(--border); background: rgba(255,255,255,.03);
      min-height: 260px; display:grid; place-items:center; position:relative;
    }
    .gallery img{ width:100%; height:100%; object-fit:cover; }
    .details-card{ border-radius: var(--r-xl); border: var(--border); background: rgba(255,255,255,.03); box-shadow: var(--inset); overflow:hidden; }
    .details-head{
      padding: 14px 14px 10px; border-bottom: var(--border2);
      background: linear-gradient(180deg, rgba(255,255,255,.05), transparent);
    }
    .details-head h3{ margin:0; font-size:18px; font-weight: 950; letter-spacing:.2px; line-height:1.1; }
    .subline{ margin-top: 8px; display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap; }
    .details-body{ padding: 12px 14px 14px; display:grid; gap:12px; }
    .kv{ display:grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    .k{ border-radius: 16px; border: var(--border2); background: rgba(255,255,255,.03); padding: 12px; }
    .k .t{ font-size:12px; color: var(--txt3); }
    .k .v{ margin-top:6px; font-weight: 950; letter-spacing:.2px; }
    .sep{ height:1px; background: rgba(255,255,255,.08); }
    :root[data-theme="light"] .sep{ background: rgba(15,23,42,.08); }

    /* Table */
    .table{ width:100%; border-collapse: collapse; }
    .table th, .table td{ text-align:left; padding: 12px 14px; border-bottom: var(--border2); font-size: 13px; vertical-align: top; }
    .table th{ font-size:12px; color: var(--txt3); letter-spacing:.16em; text-transform: uppercase; }
    .table tr:hover td{ background: rgba(255,255,255,.03); }

    /* Chat */
    .chat{ display:grid; gap:12px; padding: 14px; }
    @media(min-width:920px){ .chat{ grid-template-columns: 340px 1fr; } }
    .chatlist, .chatbox{
      border-radius: var(--r-xl); border: var(--border); background: rgba(255,255,255,.03);
      overflow:hidden;
    }
    .headbar{
      padding: 12px 14px; border-bottom: var(--border2);
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      background: linear-gradient(180deg, rgba(255,255,255,.05), transparent);
    }
    .headbar h4{ margin:0; font-size: 14px; font-weight: 950; }
    .chatroom{ padding: 10px 12px; border-bottom: var(--border2); cursor:pointer; transition: background var(--t-fast) ease; }
    .chatroom:hover{ background: rgba(255,255,255,.04); }
    .chatroom.active{ background: rgba(124,58,237,.12); }
    .chatroom .t{ font-weight: 900; font-size: 13px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
    .chatroom .m{ margin-top: 6px; color: var(--txt3); font-size: 12px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
    .chatbox{ display:grid; grid-template-rows: auto 1fr auto; min-height: 56vh; }
    .chatbox .title{ font-weight: 950; font-size: 14px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
    .msgs{ padding: 12px; overflow:auto; display:flex; flex-direction:column; gap: 8px; scroll-behavior:smooth; }
    .msg{
      max-width: 84%; border-radius: 16px; padding: 10px 12px;
      border: var(--border2); background: rgba(255,255,255,.04); box-shadow: var(--inset);
    }
    .msg.me{ align-self:flex-end; background: linear-gradient(135deg, rgba(124,58,237,.18), rgba(6,182,212,.12)); border-color: rgba(124,58,237,.26); }
    .msg .meta{ font-size:11px; color: var(--txt3); display:flex; justify-content:space-between; gap:10px; margin-bottom: 6px; }
    .msg .text{ font-size: 13px; line-height:1.35; white-space:pre-wrap; word-break:break-word; }
    .sendbar{ padding: 10px; border-top: var(--border2); display:grid; grid-template-columns: 1fr auto; gap: 10px; align-items:center; background: linear-gradient(180deg, transparent, rgba(255,255,255,.03)); }

    /* Modal / toast */
    .overlay{ position: fixed; inset:0; background: var(--overlay); display:none; place-items:center; z-index: 90; padding: 16px; }
    .modal{
      width: min(560px, 100%); border-radius: 22px; border: var(--border);
      background: linear-gradient(180deg, var(--card2), rgba(255,255,255,.04));
      box-shadow: var(--shadow1); overflow:hidden;
      backdrop-filter: var(--blur); -webkit-backdrop-filter: var(--blur);
    }
    .modal .mhead{
      padding: 14px 16px; border-bottom: var(--border2);
      display:flex; align-items:center; justify-content:space-between; gap:12px;
    }
    .modal .mhead h3{ margin:0; font-size:15px; font-weight: 950; letter-spacing:.2px; }
    .modal .mbody{ padding: 14px 16px 16px; display:grid; gap: 12px; }
    .modal .mfoot{ padding: 12px 16px 16px; display:flex; gap: 10px; justify-content:flex-end; flex-wrap:wrap; }

    .toastwrap{ position: fixed; top: 14px; right: 14px; z-index: 120; display:grid; gap:10px; }
    .toast{
      width: min(380px, calc(100vw - 28px));
      border-radius: 18px; border: var(--border);
      background: linear-gradient(180deg, var(--card2), rgba(255,255,255,.03));
      box-shadow: var(--shadow2);
      padding: 12px;
      display:grid; gap: 6px;
      backdrop-filter: var(--blur); -webkit-backdrop-filter: var(--blur);
      animation: pop .22s ease-out;
    }
    @keyframes pop{ from{ transform: translateY(-8px); opacity:0; } to{ transform: translateY(0); opacity:1; } }
    .toast .t{ font-weight: 950; font-size: 13px; display:flex; gap:10px; align-items:center; }
    .toast .t .i{ width:10px; height:10px; border-radius:99px; background: rgba(255,255,255,.25); }
    .toast.ok .t .i{ background: var(--g); }
    .toast.err .t .i{ background: var(--e); }
    .toast.warn .t .i{ background: var(--w); }
    .toast .m{ color: var(--txt2); font-size: 12px; line-height: 1.35; }

    /* Skeleton */
    .sk{
      border-radius: 14px;
      background: linear-gradient(90deg, rgba(255,255,255,.05), rgba(255,255,255,.12), rgba(255,255,255,.05));
      background-size: 260% 100%;
      animation: shimmer 1.2s ease-in-out infinite;
    }
    :root[data-theme="light"] .sk{
      background: linear-gradient(90deg, rgba(15,23,42,.06), rgba(15,23,42,.12), rgba(15,23,42,.06));
      background-size: 260% 100%;
    }
    @keyframes shimmer{ 0%{ background-position: 0% 0; } 100%{ background-position: 260% 0; } }

    @media (prefers-reduced-motion: reduce){
      *{ transition:none !important; animation:none !important; scroll-behavior:auto !important; }
    }
  </style>
</head>

<body>
  <div class="bgfx" aria-hidden="true"></div>

  <!-- Topbar -->
  <div class="topbar">
    <div class="shell">
      <div class="topbar-inner">
        <div class="brand" id="brandHome" title="–ù–∞ –≥–ª–∞–≤–Ω—É—é">
          <div class="logo" aria-hidden="true"></div>
          <div>
            <h1>Only Market</h1>
            <p class="sub" id="subline">Marketplace ‚Ä¢ escrow ‚Ä¢ chat</p>
          </div>
        </div>

        <div class="top-actions">
          <div class="pill" id="healthPill" title="–°—Ç–∞—Ç—É—Å —Å–µ—Ä–≤–µ—Ä–∞">
            <span class="dot" id="healthDot"></span>
            <span id="healthText">–ü—Ä–æ–≤–µ—Ä—è–µ–º‚Ä¶</span>
          </div>
          <div class="pill" id="mePill" title="–ü—Ä–æ—Ñ–∏–ª—å">
            <span class="dot" style="background: var(--c);"></span>
            <span id="meText">–ì–æ—Å—Ç—å</span>
          </div>
          <button class="icon-btn" id="themeBtn" title="–°–º–µ–Ω–∏—Ç—å —Ç–µ–º—É">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
              <path d="M12 3v2" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
              <path d="M12 19v2" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
              <path d="M4.22 4.22l1.42 1.42" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
              <path d="M18.36 18.36l1.42 1.42" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
              <path d="M3 12h2" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
              <path d="M19 12h2" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
              <path d="M4.22 19.78l1.42-1.42" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
              <path d="M18.36 5.64l1.42-1.42" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
              <path d="M12 17a5 5 0 1 0 0-10a5 5 0 0 0 0 10Z" stroke="currentColor" stroke-width="2"/>
            </svg>
          </button>
          <button class="icon-btn" id="debugBtn" title="Debug API">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
              <path d="M10 3h4" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
              <path d="M12 3v4" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
              <path d="M6 8h12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
              <path d="M6 8v9a5 5 0 0 0 5 5h2a5 5 0 0 0 5-5V8" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>
              <path d="M9 12v4" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
              <path d="M15 12v4" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            </svg>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Main -->
  <div class="shell">
    <div class="grid">
      <aside class="nav">
        <div class="nav-card">
          <div class="nav-title">–ù–∞–≤–∏–≥–∞—Ü–∏—è</div>

          <div class="nav-item" data-route="market">
            <div class="nav-left">
              <div class="nav-ico" aria-hidden="true">üõçÔ∏è</div>
              <div class="nav-label">–ú–∞—Ä–∫–µ—Ç</div>
            </div>
            <div class="nav-hint" id="navCount">‚Äî</div>
          </div>

          <div class="nav-item" data-route="sell">
            <div class="nav-left">
              <div class="nav-ico" aria-hidden="true">‚ûï</div>
              <div class="nav-label">–ü—Ä–æ–¥–∞—Ç—å</div>
            </div>
            <div class="nav-hint">–ù–æ–≤—ã–π</div>
          </div>

          <div class="nav-item" data-route="deals">
            <div class="nav-left">
              <div class="nav-ico" aria-hidden="true">üßæ</div>
              <div class="nav-label">–°–¥–µ–ª–∫–∏</div>
            </div>
            <div class="nav-hint" id="navDeals">‚Äî</div>
          </div>

          <div class="nav-item" data-route="chat">
            <div class="nav-left">
              <div class="nav-ico" aria-hidden="true">üí¨</div>
              <div class="nav-label">–ß–∞—Ç—ã</div>
            </div>
            <div class="nav-hint" id="navChats">‚Äî</div>
          </div>

          <div class="nav-item" data-route="wallet">
            <div class="nav-left">
              <div class="nav-ico" aria-hidden="true">üëõ</div>
              <div class="nav-label">–ö–æ—à–µ–ª—ë–∫</div>
            </div>
            <div class="nav-hint" id="navBal">‚Äî</div>
          </div>

          <div class="nav-item" data-route="profile">
            <div class="nav-left">
              <div class="nav-ico" aria-hidden="true">üë§</div>
              <div class="nav-label">–ü—Ä–æ—Ñ–∏–ª—å</div>
            </div>
            <div class="nav-hint" id="navRole">‚Äî</div>
          </div>

          <div style="height:10px;"></div>
          <div class="hint" style="padding: 0 10px 10px;">
            <span class="badge brand"><span class="i"></span><strong>–≠—Å–∫—Ä–æ—É</strong></span>
            <div style="height:8px;"></div>
            –î–ª—è –æ–ø–ª–∞—Ç—ã –Ω—É–∂–Ω–∞ —Å—É–º–º–∞ –Ω–∞ <b>available</b>. –ü–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã –æ–Ω–∞ –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç –≤ <b>hold</b> –¥–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Å–¥–µ–ª–∫–∏.
          </div>
        </div>
      </aside>

      <main class="content">
        <div id="app" class="card"></div>
      </main>
    </div>
  </div>

  <!-- Bottom nav -->
  <nav class="bottomnav" aria-label="–ù–∞–≤–∏–≥–∞—Ü–∏—è">
    <div class="bottomnav-inner">
      <div class="bni" data-route="market">üõçÔ∏è –ú–∞—Ä–∫–µ—Ç</div>
      <div class="bni" data-route="sell">‚ûï –ü—Ä–æ–¥–∞—Ç—å</div>
      <div class="bni" data-route="deals">üßæ –°–¥–µ–ª–∫–∏</div>
      <div class="bni" data-route="chat">üí¨ –ß–∞—Ç—ã</div>
      <div class="bni" data-route="wallet">üëõ –ö–æ—à–µ–ª—ë–∫</div>
    </div>
  </nav>

  <div class="toastwrap" id="toasts" aria-live="polite" aria-atomic="true"></div>

  <div class="overlay" id="overlay" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal" role="document">
      <div class="mhead">
        <h3 id="modalTitle">–î–∏–∞–ª–æ–≥</h3>
        <button class="icon-btn" id="modalClose" title="–ó–∞–∫—Ä—ã—Ç—å">‚úï</button>
      </div>
      <div class="mbody" id="modalBody"></div>
      <div class="mfoot" id="modalFoot"></div>
    </div>
  </div>

  <script>
    /* ============================================================
       V2 UI script
       - Robust API wrapper (tries multiple endpoints if needed)
       - Hash-router + minimal state
       ============================================================ */

    const $ = (s, el=document) => el.querySelector(s);
    const $$ = (s, el=document) => Array.from(el.querySelectorAll(s));

    const LS = { theme: "om_theme_v2", pendingTopup: "om_pending_topup_v2" };

    const state = {
      route: "market",
      me: null,
      health: null,
      categories: [],
      listings: [],
      listingsCursor: null,
      listing: null,
      orders: [],
      wallet: null,
      walletHistory: [],
      inbox: [],
      activeRoom: null,
      roomMessages: [],
      sse: null,

      market: { q:"", categoryId:"", sort:"new", vipOnly:false }
    };

    // ---------- helpers ----------
    const fmtMoney = (n) => {
      const v = Number(n || 0);
      if(!Number.isFinite(v)) return "0";
      return v.toLocaleString("ru-RU", { maximumFractionDigits: 2 });
    };
    const fmtTs = (ts) => {
      if(!ts) return "";
      const d = new Date(ts);
      if(Number.isNaN(d.getTime())) return "";
      return d.toLocaleString("ru-RU", { dateStyle: "short", timeStyle: "short" });
    };
    const clamp = (n,a,b) => Math.max(a, Math.min(b, n));
    const escapeHtml = (str) => String(str ?? "")
      .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
      .replaceAll('"',"&quot;").replaceAll("'","&#039;");

    function toast(title, msg="", type="ok", ttl=3200){
      const wrap = $("#toasts");
      const t = document.createElement("div");
      t.className = "toast " + (type || "ok");
      t.innerHTML = \`
        <div class="t"><span class="i"></span><span>\${escapeHtml(title)}</span></div>
        \${msg ? \`<div class="m">\${escapeHtml(msg)}</div>\` : ""}
      \`;
      wrap.appendChild(t);
      setTimeout(()=>{ t.style.opacity="0"; t.style.transform="translateY(-6px)"; }, ttl-240);
      setTimeout(()=>t.remove(), ttl);
    }

    // ---------- Modal ----------
    const Modal = (() => {
      const overlay = $("#overlay");
      const titleEl = $("#modalTitle");
      const bodyEl = $("#modalBody");
      const footEl = $("#modalFoot");
      $("#modalClose").addEventListener("click", close);
      overlay.addEventListener("click", (e)=>{ if(e.target === overlay) close(); });

      function open({ title="–î–∏–∞–ª–æ–≥", body="", buttons=[] }){
        titleEl.textContent = title;
        bodyEl.innerHTML = body;
        footEl.innerHTML = "";
        buttons.forEach(b => {
          const btn = document.createElement("button");
          btn.className = b.kind === "primary" ? "btn" : (b.kind === "danger" ? "btn btn-danger" : "btn-ghost");
          btn.textContent = b.label || "OK";
          btn.addEventListener("click", async ()=>{
            try{ if(b.onClick) await b.onClick(); }
            finally{ if(b.autoClose !== false) close(); }
          });
          footEl.appendChild(btn);
        });
        overlay.style.display="grid";
        overlay.setAttribute("aria-hidden","false");
        document.body.style.overflow="hidden";
      }
      function close(){
        overlay.style.display="none";
        overlay.setAttribute("aria-hidden","true");
        document.body.style.overflow="";
      }
      async function confirm({ title="–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ", message="–í—ã —É–≤–µ—Ä–µ–Ω—ã?", confirmLabel="–î–∞", cancelLabel="–û—Ç–º–µ–Ω–∞", danger=false }){
        return new Promise((resolve)=>{
          open({
            title,
            body: \`<div>\${escapeHtml(message)}</div>\`,
            buttons: [
              { label: cancelLabel, kind:"ghost", onClick: ()=>resolve(false) },
              { label: confirmLabel, kind: danger ? "danger":"primary", onClick: ()=>resolve(true) }
            ]
          });
        });
      }
      return { open, close, confirm };
    })();

    // ---------- theme ----------
    function applyTheme(theme){
      const t = theme === "light" ? "light" : "dark";
      document.documentElement.dataset.theme = t;
      localStorage.setItem(LS.theme, t);
    }
    function initTheme(){
      const saved = localStorage.getItem(LS.theme);
      if(saved === "light" || saved === "dark") return applyTheme(saved);
      // requested default: dark
      applyTheme("dark");
    }

    // ---------- API wrapper ----------
    async function apiFetch(path, { method="GET", body=null, headers={} } = {}){
      const opts = { method, credentials: "include", headers: { ...headers } };
      if(body !== null){
        opts.headers["Content-Type"] = "application/json";
        opts.body = JSON.stringify(body);
      }
      let res;
      try{
        res = await fetch(path, opts);
      } catch(e){
        return { ok:false, status:0, error:"NETWORK", message: String(e?.message || "Network error") };
      }
      const ct = res.headers.get("content-type") || "";
      let data = null;
      if(ct.includes("application/json")){
        data = await res.json().catch(()=>null);
      } else {
        const txt = await res.text().catch(()=> "");
        data = txt ? { text: txt } : null;
      }
      if(!res.ok){
        return { ok:false, status:res.status, ...(data||{}), error: (data && data.error) ? data.error : "HTTP_"+res.status };
      }
      return { ok:true, status:res.status, ...(data||{}) };
    }

    async function API(pathOrPaths, opts){
      const paths = Array.isArray(pathOrPaths) ? pathOrPaths : [pathOrPaths];
      let last = null;
      for(const p of paths){
        const r = await apiFetch(p, opts);
        last = r;
        if(r.ok) return r;
        // try next only on 404-ish / not found / route mismatch
        const e = String(r.error || "");
        if(r.status === 404 || e === "NOT_FOUND" || e.startsWith("HTTP_404")) continue;
        // for other errors (401/500/validation) stop early
        return r;
      }
      return last || { ok:false, status:0, error:"NETWORK" };
    }

    function humanErr(r){
      const e = r?.error || "";
      const msg = r?.message || r?.text || "";
      const map = {
        UNAUTH: "–°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ –≤ –∞–∫–∫–∞—É–Ω—Ç",
        VALIDATION: "–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –≤–≤–µ–¥—ë–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ",
        EMAIL_EXISTS: "–≠—Ç–æ—Ç email —É–∂–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω",
        NICK_EXISTS: "–≠—Ç–æ—Ç –Ω–∏–∫ —É–∂–µ –∑–∞–Ω—è—Ç",
        FORBIDDEN: "–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø—Ä–∞–≤",
        NOT_FOUND: "–ù–µ –Ω–∞–π–¥–µ–Ω–æ",
        NO_FUNDS: "–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤ –Ω–∞ available",
        NETWORK: "–°–µ—Ä–≤–µ—Ä/—Å–µ—Ç—å –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã"
      };
      return map[e] || msg || e || ("HTTP " + (r?.status || "?"));
    }

    // ---------- router ----------
    function getRouteFromHash(){
      const h = (location.hash || "").replace("#","").trim();
      return h || "market";
    }
    function syncNav(){
      $$(".nav-item").forEach(el => el.classList.toggle("active", el.dataset.route === state.route));
      $$(".bni").forEach(el => el.classList.toggle("active", el.dataset.route === state.route));
    }
    function setRoute(r){
      const allowed = ["market","sell","deals","chat","wallet","profile"];
      state.route = allowed.includes(r) ? r : "market";
      location.hash = "#" + state.route;
      syncNav();
      render();
      prefetchForRoute(state.route);
    }

    window.addEventListener("hashchange", ()=>{
      state.route = getRouteFromHash();
      syncNav();
      render();
      prefetchForRoute(state.route);
    });

    // ---------- boot ----------
    async function boot(){
      initTheme();
      state.route = getRouteFromHash();
      syncNav();

      $("#themeBtn").addEventListener("click", ()=> applyTheme(document.documentElement.dataset.theme === "dark" ? "light":"dark"));
      $("#brandHome").addEventListener("click", ()=> setRoute("market"));
      $("#mePill").addEventListener("click", ()=> setRoute("profile"));
      $("#debugBtn").addEventListener("click", openDebug);

      $$(".nav-item").forEach(el => el.addEventListener("click", ()=> setRoute(el.dataset.route)));
      $$(".bni").forEach(el => el.addEventListener("click", ()=> setRoute(el.dataset.route)));

      render(); // optimistic

      await Promise.allSettled([ loadHealth(), loadMe(), loadCategories() ]);
      await prefetchForRoute(state.route);

      // small nudge if pending topup exists
      const p = getPendingTopup();
      if(p) toast("–û–∂–∏–¥–∞–µ—Ç –ø–ª–∞—Ç—ë–∂", "–û—Ç–∫—Ä–æ–π—Ç–µ ¬´–ö–æ—à–µ–ª—ë–∫¬ª ‚Üí ¬´–ü—Ä–æ–≤–µ—Ä–∏—Ç—å¬ª", "warn", 4200);
    }

    async function prefetchForRoute(route){
      if(route === "market" && state.listings.length === 0) return loadListings(true);
      if(route === "wallet") return loadWalletAll();
      if(route === "deals") return loadOrders();
      if(route === "chat") return loadInbox(true);
      return;
    }

    // ---------- loaders ----------
    async function loadHealth(){
      const r = await API(["/api/health","/health"]);
      state.health = r.ok ? r : { ok:false };
      const dot = $("#healthDot");
      const txt = $("#healthText");
      if(r.ok){
        dot.className = "dot ok";
        txt.textContent = "–û–Ω–ª–∞–π–Ω ‚Ä¢ v" + (r.v || r.version || "?");
      } else {
        dot.className = "dot err";
        txt.textContent = "–û—Ñ—Ñ–ª–∞–π–Ω";
      }
    }

    async function loadMe(){
      const r = await API(["/api/me","/me"]);
      state.me = r.ok ? (r.user || r.me || r) : null;
      $("#meText").textContent = state.me?.nickname ? state.me.nickname : "–ì–æ—Å—Ç—å";
      $("#navRole").textContent = state.me?.roles?.includes("admin") ? "Admin" : (state.me ? "User" : "Guest");
      return state.me;
    }

    async function loadCategories(){
      const r = await API(["/api/categories","/api/cats","/categories"]);
      state.categories = r.ok && Array.isArray(r.categories) ? r.categories : (r.ok && Array.isArray(r) ? r : []);
    }

    async function loadListings(reset=false){
      if(reset){ state.listings = []; state.listingsCursor = null; }
      const q = new URLSearchParams();
      if(state.market.q) q.set("q", state.market.q);
      if(state.market.categoryId) q.set("categoryId", state.market.categoryId);
      if(state.market.sort) q.set("sort", state.market.sort);
      if(state.market.vipOnly) q.set("vipOnly", "1");
      if(state.listingsCursor) q.set("cursor", state.listingsCursor);
      q.set("limit", "24");

      const r = await API([ "/api/listings?" + q.toString(), "/api/market/listings?" + q.toString() ]);
      if(!r.ok){ toast("–ú–∞—Ä–∫–µ—Ç –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω", humanErr(r), "err"); return; }

      const items = Array.isArray(r) ? r : (Array.isArray(r.items) ? r.items : (Array.isArray(r.listings) ? r.listings : []));
      state.listingsCursor = r.nextCursor || r.cursor || null;
      state.listings = reset ? items : state.listings.concat(items);

      $("#navCount").textContent = state.listings.length ? String(state.listings.length) : "‚Äî";
      if(state.route === "market") render();
    }

    async function loadListing(id){
      const r = await API([ "/api/listings/" + encodeURIComponent(id), "/api/market/listings/" + encodeURIComponent(id) ]);
      if(!r.ok){ toast("–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–∫—Ä—ã—Ç—å —Ç–æ–≤–∞—Ä", humanErr(r), "err"); return null; }
      state.listing = r.listing || r.item || r;
      return state.listing;
    }

    async function loadOrders(){
      const r = await API(["/api/orders","/api/deals"]);
      if(!r.ok){
        if(r.error === "UNAUTH" || r.status === 401) return;
        toast("–°–¥–µ–ª–∫–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã", humanErr(r), "err");
        return;
      }
      state.orders = Array.isArray(r.orders) ? r.orders : (Array.isArray(r) ? r : []);
      $("#navDeals").textContent = state.orders.length ? String(state.orders.length) : "‚Äî";
      if(state.route === "deals") render();
    }

    async function loadWallet(){
      const r = await API(["/api/wallet","/api/balance"]);
      if(!r.ok){
        if(r.error === "UNAUTH" || r.status === 401) return;
        toast("–ö–æ—à–µ–ª—ë–∫ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω", humanErr(r), "err");
        return;
      }
      state.wallet = { available: Number(r.available||0), hold: Number(r.hold||0) };
      $("#navBal").textContent = fmtMoney(state.wallet.available);
      return state.wallet;
    }

    async function loadWalletHistory(){
      const r = await API(["/api/wallet/history","/api/wallet/tx","/api/balance/history"]);
      if(!r.ok){ state.walletHistory = []; return; }
      state.walletHistory = Array.isArray(r.history) ? r.history : (Array.isArray(r) ? r : (Array.isArray(r.items) ? r.items : []));
      return state.walletHistory;
    }

    async function loadWalletAll(){
      await Promise.allSettled([loadWallet(), loadWalletHistory()]);
      if(state.route === "wallet") render();
    }

    async function loadInbox(alsoStartSSE=false){
      const r = await API(["/api/chat/inbox","/api/inbox"]);
      if(!r.ok){
        if(r.error === "UNAUTH" || r.status === 401) return;
        toast("–ß–∞—Ç—ã –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã", humanErr(r), "err");
        return;
      }
      state.inbox = Array.isArray(r.rooms) ? r.rooms : (Array.isArray(r) ? r : []);
      $("#navChats").textContent = state.inbox.length ? String(state.inbox.length) : "‚Äî";
      if(alsoStartSSE) startSSE();
      if(state.route === "chat") render();
    }

    async function loadRoom(roomId){
      // try a few known variants
      let r = await API([
        "/api/chat/room?room=" + encodeURIComponent(roomId),
        "/api/chat/messages?room=" + encodeURIComponent(roomId),
        "/api/chat/messages/" + encodeURIComponent(roomId)
      ]);
      if(!r.ok){ toast("–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–∫—Ä—ã—Ç—å —á–∞—Ç", humanErr(r), "err"); return; }
      state.activeRoom = roomId;
      state.roomMessages = Array.isArray(r.messages) ? r.messages : (Array.isArray(r) ? r : []);
      if(state.route === "chat") render();
      scrollChatToBottom();
    }

    function startSSE(){
      if(state.sse || !state.me) return;
      try{
        const es = new EventSource("/api/chat/stream", { withCredentials: true });
        state.sse = es;

        es.onmessage = (ev)=>{
          try{
            const msg = JSON.parse(ev.data);
            if(!msg || !msg.room || !msg.message) return;

            const r = state.inbox.find(x => x.room === msg.room);
            if(r){
              r.last = msg.message;
              r.updatedAt = Date.now();
            } else {
              state.inbox.unshift({ room: msg.room, title: msg.room, last: msg.message, updatedAt: Date.now() });
            }

            if(state.activeRoom === msg.room){
              state.roomMessages.push(msg.message);
              const msgs = $("#msgs");
              if(msgs) msgs.innerHTML = renderMessages(state.roomMessages);
              scrollChatToBottom(true);
            } else {
              toast("–ù–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ", (msg.message?.text || "").slice(0, 90), "ok", 2400);
              if(state.route === "chat") render();
            }
          }catch{}
        };

        es.onerror = ()=>{
          try{ es.close(); }catch{}
          state.sse = null;
          setTimeout(()=>{ if(state.route === "chat") startSSE(); }, 1600);
        };
      } catch(e){}
    }

    // ---------- actions ----------
    function requireLogin(){
      if(state.me) return true;
      toast("–ù—É–∂–µ–Ω –≤—Ö–æ–¥", "–ü—Ä–æ—Ñ–∏–ª—å ‚Üí –í–æ–π—Ç–∏", "warn");
      setRoute("profile");
      return false;
    }

    async function doLogin(email, password){
      const r = await API(["/api/auth/login","/api/login"], { method:"POST", body:{ email, password } });
      if(!r.ok){ toast("–í—Ö–æ–¥ –Ω–µ –≤—ã–ø–æ–ª–Ω–µ–Ω", humanErr(r), "err"); return false; }
      await loadMe();
      toast("–ì–æ—Ç–æ–≤–æ", "–í—ã –≤–æ—à–ª–∏", "ok");
      return true;
    }

    async function doRegister(email, password, nickname){
      const r = await API(["/api/auth/register","/api/register"], { method:"POST", body:{ email, password, nickname } });
      if(!r.ok){ toast("–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –Ω–µ —É–¥–∞–ª–∞—Å—å", humanErr(r), "err"); return false; }
      await loadMe();
      toast("–ì–æ—Ç–æ–≤–æ", "–ê–∫–∫–∞—É–Ω—Ç —Å–æ–∑–¥–∞–Ω", "ok");
      return true;
    }

    async function doLogout(){
      await API(["/api/auth/logout","/api/logout"], { method:"POST" });
      state.me = null;
      $("#meText").textContent = "–ì–æ—Å—Ç—å";
      $("#navRole").textContent = "Guest";
      toast("–í—ã—Ö–æ–¥", "–°–µ—Å—Å–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞", "ok");
      state.orders = []; state.wallet = null; state.walletHistory = [];
      state.inbox = []; state.activeRoom = null; state.roomMessages = [];
      if(state.sse){ try{ state.sse.close(); }catch{} state.sse = null; }
      render();
    }

    async function createListingFromForm(form){
      if(!requireLogin()) return false;
      const title = form.title.value.trim();
      const description = form.description.value.trim();
      const price = Number(form.price.value || 0);
      const categoryId = form.categoryId.value || "";
      const delivery = form.delivery.value || "manual";
      const stock = clamp(Number(form.stock.value || 1), 1, 9999);

      if(!title || !(price > 0) || !categoryId){
        toast("–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–ª—è", "–ù–∞–∑–≤–∞–Ω–∏–µ, —Ü–µ–Ω–∞, –∫–∞—Ç–µ–≥–æ—Ä–∏—è –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã", "warn");
        return false;
      }

      const body = { title, description, price, categoryId, delivery, stock };
      const r = await API(["/api/listings","/api/market/listings"], { method:"POST", body });
      if(!r.ok){ toast("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å —Ç–æ–≤–∞—Ä", humanErr(r), "err"); return false; }
      toast("–ì–æ—Ç–æ–≤–æ", "–¢–æ–≤–∞—Ä –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω", "ok");
      setRoute("market");
      await loadListings(true);
      return true;
    }

    async function createOrder(listingId){
      if(!requireLogin()) return null;
      const r = await API(["/api/orders","/api/deals"], { method:"POST", body:{ listingId } });
      if(!r.ok){ toast("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å —Å–¥–µ–ª–∫—É", humanErr(r), "err"); return null; }
      toast("–°–¥–µ–ª–∫–∞ —Å–æ–∑–¥–∞–Ω–∞", "–û—Ç–∫—Ä–æ–π—Ç–µ ¬´–°–¥–µ–ª–∫–∏¬ª –¥–ª—è –æ–ø–ª–∞—Ç—ã", "ok");
      await loadOrders();
      setRoute("deals");
      return r.order || r;
    }

    async function payOrder(orderId){
      if(!requireLogin()) return false;
      const r = await API([`/api/orders/${encodeURIComponent(orderId)}/pay`, `/api/deals/${encodeURIComponent(orderId)}/pay`], { method:"POST" });
      if(!r.ok){
        toast("–û–ø–ª–∞—Ç–∞ –Ω–µ –ø—Ä–æ—à–ª–∞", humanErr(r), "err");
        if(r.error === "NO_FUNDS"){ setRoute("wallet"); }
        return false;
      }
      toast("–û–ø–ª–∞—á–µ–Ω–æ", "–°—Ä–µ–¥—Å—Ç–≤–∞ –≤ hold (—ç—Å–∫—Ä–æ—É)", "ok");
      await Promise.allSettled([loadOrders(), loadWallet()]);
      return true;
    }

    async function sellerRequestComplete(orderId){
      if(!requireLogin()) return false;
      const ok = await Modal.confirm({
        title:"–í—ã–¥–∞–ª–∏ —Ç–æ–≤–∞—Ä?",
        message:"–≠—Ç–æ –ø–µ—Ä–µ–≤–µ–¥—ë—Ç —Å–¥–µ–ª–∫—É –≤ delivered. –ü–æ–∫—É–ø–∞—Ç–µ–ª—å —Å–º–æ–∂–µ—Ç –∑–∞–≤–µ—Ä—à–∏—Ç—å –∏ –≤—ã–ø—É—Å—Ç–∏—Ç—å —Å—Ä–µ–¥—Å—Ç–≤–∞.",
        confirmLabel:"–î–∞, –≤—ã–¥–∞–ª"
      });
      if(!ok) return false;
      const r = await API([`/api/orders/${encodeURIComponent(orderId)}/request-complete`, `/api/deals/${encodeURIComponent(orderId)}/request-complete`], { method:"POST" });
      if(!r.ok){ toast("–ù–µ —É–¥–∞–ª–æ—Å—å", humanErr(r), "err"); return false; }
      toast("–û–∫", "–û–∂–∏–¥–∞–µ–º –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –ø–æ–∫—É–ø–∞—Ç–µ–ª—è", "ok");
      await loadOrders();
      return true;
    }

    async function buyerConfirm(orderId){
      if(!requireLogin()) return false;
      const ok = await Modal.confirm({
        title:"–ó–∞–≤–µ—Ä—à–∏—Ç—å —Å–¥–µ–ª–∫—É?",
        message:"–°—Ä–µ–¥—Å—Ç–≤–∞ –≤—ã–π–¥—É—Ç –∏–∑ hold –∏ –∑–∞—á–∏—Å–ª—è—Ç—Å—è –ø—Ä–æ–¥–∞–≤—Ü—É (–º–∏–Ω—É—Å –∫–æ–º–∏—Å—Å–∏—è).",
        confirmLabel:"–ó–∞–≤–µ—Ä—à–∏—Ç—å"
      });
      if(!ok) return false;
      const r = await API([`/api/orders/${encodeURIComponent(orderId)}/confirm`, `/api/deals/${encodeURIComponent(orderId)}/confirm`], { method:"POST" });
      if(!r.ok){ toast("–ù–µ —É–¥–∞–ª–æ—Å—å", humanErr(r), "err"); return false; }
      toast("–ó–∞–≤–µ—Ä—à–µ–Ω–æ", "–°–¥–µ–ª–∫–∞ –∑–∞–∫—Ä—ã—Ç–∞", "ok");
      await Promise.allSettled([loadOrders(), loadWallet()]);
      return true;
    }

    async function openOrderChat(order){
      // common room format: "order:<id>"
      const room = order?.room || ("order:" + order.id);
      setRoute("chat");
      await loadInbox(true);
      await loadRoom(room);
    }

    async function sendChat(text){
      if(!requireLogin()) return;
      if(!state.activeRoom) return;
      const msg = String(text || "").trim();
      if(!msg) return;
      const r = await API(["/api/chat/send","/api/message/send"], { method:"POST", body:{ room: state.activeRoom, text: msg } });
      if(!r.ok){ toast("–ù–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ", humanErr(r), "err"); return; }
      // optimistic
      const m = r.message || { id:"tmp_"+Math.random().toString(16).slice(2), userId: state.me?.id, text: msg, ts: Date.now() };
      state.roomMessages.push(m);
      const msgs = $("#msgs");
      if(msgs) msgs.innerHTML = renderMessages(state.roomMessages);
      scrollChatToBottom(true);
    }

    async function walletDepositRequest(amount){
      if(!requireLogin()) return false;
      const r = await API(["/api/wallet/deposit-request","/api/deposit-request"], { method:"POST", body:{ amount: Number(amount) } });
      if(!r.ok){ toast("–ù–µ —É–¥–∞–ª–æ—Å—å", humanErr(r), "err"); return false; }
      toast("–ó–∞—è–≤–∫–∞ —Å–æ–∑–¥–∞–Ω–∞", "–ú–µ–Ω–µ–¥–∂–µ—Ä –æ–±—Ä–∞–±–æ—Ç–∞–µ—Ç –ø–æ–ø–æ–ª–Ω–µ–Ω–∏–µ", "ok");
      return true;
    }
    async function walletWithdrawRequest(amount){
      if(!requireLogin()) return false;
      const r = await API(["/api/wallet/withdraw-request","/api/withdraw-request"], { method:"POST", body:{ amount: Number(amount) } });
      if(!r.ok){ toast("–ù–µ —É–¥–∞–ª–æ—Å—å", humanErr(r), "err"); return false; }
      toast("–ó–∞—è–≤–∫–∞ —Å–æ–∑–¥–∞–Ω–∞", "–í—ã–≤–æ–¥ –ø–æ—Å—Ç–∞–≤–ª–µ–Ω –≤ –æ—á–µ—Ä–µ–¥—å", "ok");
      return true;
    }

    // payment providers (optional)
    async function payCreate(provider, amount){
      if(!requireLogin()) return null;

      const map = {
        rukassa: { create: ["/api/pay/rukassa/create","/api/pay/fk/create","/api/fk/create"], status: ["/api/pay/rukassa/status","/api/pay/fk/status","/api/fk/status"], key: "invoiceId", urlKey: "payUrl" },
        paradise:{ create: ["/api/pay/paradise/create"], status: ["/api/pay/paradise/status"], key: "uuid", urlKey: "redirect_url" },
        cryptobot:{ create: ["/api/pay/cryptobot/create"], status: ["/api/pay/cryptobot/status"], key: "invoiceId", urlKey: "pay_url" },
        stripe:{ create: ["/api/pay/stripe/create"], status: ["/api/pay/stripe/status"], key: "sessionId", urlKey: "url" },
      };

      const cfg = map[provider];
      if(!cfg) return null;

      const r = await API(cfg.create, { method:"POST", body:{ amount: Number(amount), currency:"RUB" } });
      if(!r.ok){ toast("–ü—Ä–æ–≤–∞–π–¥–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω", humanErr(r), "err"); return null; }

      // normalize
      const id = r[cfg.key] || r.id || r.invoiceId || r.uuid;
      const url = r[cfg.urlKey] || r.payUrl || r.url || r.redirect_url || r.pay_url;
      if(id && url){
        localStorage.setItem(LS.pendingTopup, JSON.stringify({ provider, id, url, createdAt: Date.now(), expiresAt: Date.now()+12*60*60*1000 }));
        window.open(url, "_blank", "noopener");
        toast("–°—á—ë—Ç –æ—Ç–∫—Ä—ã—Ç", "–ü–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã –Ω–∞–∂–º–∏—Ç–µ ¬´–ü—Ä–æ–≤–µ—Ä–∏—Ç—å¬ª", "ok", 4200);
      } else {
        toast("–°–æ–∑–¥–∞–Ω–æ", "–ù–æ –Ω–µ –ø–æ–ª—É—á–∏–ª–∏ —Å—Å—ã–ª–∫—É –æ–ø–ª–∞—Ç—ã. –ü—Ä–æ–≤–µ—Ä—å –æ—Ç–≤–µ—Ç –≤ Debug.", "warn", 5200);
      }
      return { id, url, raw: r };
    }

    async function payCheckPending(){
      if(!requireLogin()) return null;
      const p = getPendingTopup();
      if(!p) return toast("–ù–µ—Ç –æ–∂–∏–¥–∞–Ω–∏—è", "–°–æ–∑–¥–∞–π—Ç–µ —Å—á—ë—Ç –Ω–∞ –æ–ø–ª–∞—Ç—É", "warn");

      // provider-specific status call
      if(p.provider === "rukassa"){
        const r = await API("/api/pay/rukassa/status?invoiceId=" + encodeURIComponent(p.id));
        return handlePayStatus(r, p);
      }
      if(p.provider === "paradise"){
        const r = await API("/api/pay/paradise/status/" + encodeURIComponent(p.id));
        return handlePayStatus(r, p);
      }
      if(p.provider === "cryptobot"){
        const r = await API("/api/pay/cryptobot/status?invoiceId=" + encodeURIComponent(p.id));
        return handlePayStatus(r, p);
      }
      if(p.provider === "stripe"){
        const r = await API("/api/pay/stripe/status?sessionId=" + encodeURIComponent(p.id));
        return handlePayStatus(r, p);
      }
      toast("–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –ø—Ä–æ–≤–∞–π–¥–µ—Ä", p.provider, "err");
      return null;
    }

    async function handlePayStatus(r, p){
      if(!r.ok){ toast("–°—Ç–∞—Ç—É—Å –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω", humanErr(r), "err"); return null; }
      const st = r.status || r.state || r.payment_status || r.result;
      if(String(st).toLowerCase() === "paid" || String(st).toLowerCase() === "success"){
        toast("–û–ø–ª–∞—Ç–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∞", "–ë–∞–ª–∞–Ω—Å –ø–æ–ø–æ–ª–Ω–µ–Ω", "ok");
        localStorage.removeItem(LS.pendingTopup);
        await loadWalletAll();
        return r;
      }
      toast("–ü–æ–∫–∞ –Ω–µ –æ–ø–ª–∞—á–µ–Ω–æ", "–ï—Å–ª–∏ —Ç–æ–ª—å–∫–æ —á—Ç–æ –æ–ø–ª–∞—Ç–∏–ª–∏ ‚Äî –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —á–µ—Ä–µ–∑ 10‚Äì20 —Å–µ–∫—É–Ω–¥", "warn", 4200);
      return r;
    }

    function getPendingTopup(){
      try{
        const p = JSON.parse(localStorage.getItem(LS.pendingTopup) || "null");
        if(!p) return null;
        if(Date.now() > (p.expiresAt || 0)) return null;
        return p;
      } catch { return null; }
    }

    // ---------- render ----------
    function render(){
      const app = $("#app");
      if(!app) return;

      if(state.route === "market") return renderMarket();
      if(state.route === "sell") return renderSell();
      if(state.route === "deals") return renderDeals();
      if(state.route === "chat") return renderChat();
      if(state.route === "wallet") return renderWallet();
      if(state.route === "profile") return renderProfile();

      app.innerHTML = \`<div class="section-title"><h2>404</h2><p>–°—Ç—Ä–∞–Ω–∏—Ü–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞</p></div><div class="card-pad">‚Äî</div>\`;
    }

    // ----- Market -----
    function renderMarket(){
      const app = $("#app");

      const catOptions = ["<option value=''>–í—Å–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</option>"].concat(
        (state.categories || []).map(c => \`<option value="\${escapeHtml(c.id)}">\${escapeHtml(c.title || c.name || c.id)}</option>\`)
      ).join("");

      const chips = [
        { id:"new", label:"–°–Ω–∞—á–∞–ª–∞ –Ω–æ–≤—ã–µ" },
        { id:"cheap", label:"–î–µ—à–µ–≤–ª–µ" },
        { id:"exp", label:"–î–æ—Ä–æ–∂–µ" },
        { id:"vip", label:"VIP" },
      ];

      const cards = (state.listings || []).map(l => {
        const img = l.photoId ? ("/media/" + encodeURIComponent(l.photoId)) : "";
        const vip = !!l.vipUntil && (Number(l.vipUntil) > Date.now());
        return \`
          <div class="item" data-id="\${escapeHtml(l.id)}" role="button" tabindex="0">
            <div class="thumb">
              \${img ? \`<img src="\${escapeHtml(img)}" alt="">\` : ""}
              \${vip ? \`<div class="vip"><span class="star"></span>VIP</div>\` : ""}
            </div>
            <div class="item-body">
              <div class="item-title">\${escapeHtml(l.title || "–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è")}</div>
              <div class="item-meta">
                <div class="price">\${fmtMoney(l.price)} ‚ÇΩ</div>
                <div>\${escapeHtml(String(l.categoryTitle || l.category || "").slice(0,16))}</div>
              </div>
            </div>
          </div>
        \`;
      }).join("") || \`
        <div style="padding:16px;">
          <span class="badge warn"><span class="i"></span><strong>–ü—É—Å—Ç–æ</strong></span>
          <div style="height:10px;"></div>
          <div class="hint">–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –ø–æ–∏—Å–∫/–∫–∞—Ç–µ–≥–æ—Ä–∏—é. –ò–ª–∏ —Å–æ–∑–¥–∞–π—Ç–µ –ø–µ—Ä–≤—ã–π —Ç–æ–≤–∞—Ä.</div>
        </div>
      \`;

      app.innerHTML = \`
        <div class="hero">
          <h3>–ú–∞—Ä–∫–µ—Ç</h3>
          <p>–°–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å: –±—ã—Å—Ç—Ä—ã–π –ø–æ–∏—Å–∫, —ç—Å–∫—Ä–æ—É-—Å–¥–µ–ª–∫–∏, —á–∞—Ç—ã –∏ –∫–æ—à–µ–ª—ë–∫.</p>
        </div>

        <div class="toolbar">
          <input class="field" id="m_q" placeholder="–ü–æ–∏—Å–∫: –∞–∫–∫–∞—É–Ω—Ç, —É—Å–ª—É–≥–∞, –ø–æ–¥–ø–∏—Å–∫–∞‚Ä¶" value="\${escapeHtml(state.market.q)}">
          <select class="field" id="m_cat">\${catOptions}</select>
          <div class="chips" id="m_chips">
            \${chips.map(x => \`<div class="chip \${(state.market.vipOnly && x.id==="vip") || (!state.market.vipOnly && state.market.sort===x.id) ? "active":""}" data-sort="\${x.id}">\${escapeHtml(x.label)}</div>\`).join("")}
          </div>
          <button class="btn" id="m_reload">–û–±–Ω–æ–≤–∏—Ç—å</button>
        </div>

        <div class="listgrid" id="m_grid">\${state.listings.length ? cards : skeletonGrid()}</div>

        <div class="card-pad" style="border-top: var(--border2); display:flex; gap:10px; justify-content: space-between; align-items:center; flex-wrap: wrap;">
          <div class="hint">–ü–æ–∫–∞–∑–∞–Ω–æ: <b>\${state.listings.length}</b>\${state.listingsCursor ? " ‚Ä¢ –µ—Å—Ç—å –µ—â—ë" : ""}</div>
          <div class="row">
            <button class="btn-ghost" id="m_more" \${state.listingsCursor ? "" : "disabled"}>–ü–æ–∫–∞–∑–∞—Ç—å –µ—â—ë</button>
            <button class="btn" id="m_sell">–î–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä</button>
          </div>
        </div>
      \`;

      $("#m_cat").value = state.market.categoryId || "";
      $("#m_cat").addEventListener("change", async (e)=>{ state.market.categoryId = e.target.value; await loadListings(true); });

      const q = $("#m_q");
      let qt = null;
      q.addEventListener("input", ()=>{
        clearTimeout(qt);
        qt = setTimeout(async ()=>{
          state.market.q = q.value.trim();
          await loadListings(true);
        }, 320);
      });

      $$("#m_chips .chip").forEach(el => el.addEventListener("click", async ()=>{
        const sort = el.dataset.sort;
        state.market.vipOnly = (sort === "vip");
        if(!state.market.vipOnly) state.market.sort = sort;
        await loadListings(true);
        render();
      }));

      $("#m_reload").addEventListener("click", ()=> loadListings(true));
      $("#m_more").addEventListener("click", ()=> loadListings(false));
      $("#m_sell").addEventListener("click", ()=> setRoute("sell"));

      $$("#m_grid .item").forEach(el => {
        const id = el.dataset.id;
        el.addEventListener("click", ()=> openListing(id));
        el.addEventListener("keydown", (e)=>{ if(e.key==="Enter") openListing(id); });
      });

      if(state.listings.length === 0) loadListings(true);
    }

    function skeletonGrid(){
      return Array.from({length: 8}).map(()=>\`
        <div class="item" style="cursor: default;">
          <div class="thumb sk"></div>
          <div class="item-body">
            <div class="sk" style="height:14px;border-radius:10px;"></div>
            <div class="row" style="justify-content: space-between;">
              <div class="sk" style="height:12px;width:88px;border-radius:10px;"></div>
              <div class="sk" style="height:12px;width:64px;border-radius:10px;"></div>
            </div>
          </div>
        </div>\`).join("");
    }

    async function openListing(id){
      await loadListing(id);
      renderListingDetails();
    }

    function renderListingDetails(){
      const app = $("#app");
      const l = state.listing;
      if(!l){
        app.innerHTML = \`<div class="section-title"><h2>–¢–æ–≤–∞—Ä</h2><p>–ù–µ –Ω–∞–π–¥–µ–Ω</p></div><div class="card-pad">‚Äî</div>\`;
        return;
      }
      const img = l.photoId ? ("/media/" + encodeURIComponent(l.photoId)) : "";
      const delivery = l.delivery || "manual";
      const vip = !!l.vipUntil && (Number(l.vipUntil) > Date.now());

      app.innerHTML = \`
        <div class="section-title">
          <div><h2>–¢–æ–≤–∞—Ä</h2><p>–ü–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏ –∏ –ø–æ–∫—É–ø–∫–∞</p></div>
          <div class="row">
            <button class="btn-ghost" id="d_back">‚Üê –ù–∞–∑–∞–¥</button>
            <button class="btn" id="d_buy">–ö—É–ø–∏—Ç—å</button>
          </div>
        </div>

        <div class="details">
          <div class="gallery">
            \${img ? \`<img src="\${escapeHtml(img)}" alt="">\` : \`<div class="hint">–ù–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è</div>\`}
            \${vip ? \`<div class="vip" style="top:12px;left:12px;"><span class="star"></span>VIP</div>\` : ""}
          </div>

          <div class="details-card">
            <div class="details-head">
              <h3>\${escapeHtml(l.title || "–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è")}</h3>
              <div class="subline">
                <span class="badge brand"><span class="i"></span><strong>\${fmtMoney(l.price)} ‚ÇΩ</strong></span>
                <span class="badge \${delivery==="auto" ? "ok":"warn"}"><span class="i"></span><strong>\${escapeHtml(delivery.toUpperCase())}</strong>&nbsp;<span class="muted">delivery</span></span>
              </div>
            </div>
            <div class="details-body">
              <div class="kv">
                <div class="k"><div class="t">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</div><div class="v">\${escapeHtml(l.categoryTitle || l.categoryId || "‚Äî")}</div></div>
                <div class="k"><div class="t">–û—Å—Ç–∞—Ç–æ–∫</div><div class="v">\${escapeHtml(String(l.stock ?? "‚Äî"))}</div></div>
              </div>

              <div class="sep"></div>

              <div>
                <div class="hint" style="margin-bottom:6px;">–û–ø–∏—Å–∞–Ω–∏–µ</div>
                <div style="white-space: pre-wrap; line-height: 1.45;">\${escapeHtml(l.description || "‚Äî")}</div>
              </div>

              <div class="sep"></div>

              <div class="row" style="justify-content: space-between;">
                <div class="hint">–°–æ–∑–¥–∞–Ω–æ: <b>\${escapeHtml(fmtTs(l.createdAt))}</b></div>
                <div class="row">
                  <button class="btn-ghost" id="d_chat">–ß–∞—Ç</button>
                  <button class="btn" id="d_buy2">–ö—É–ø–∏—Ç—å —Å–µ–π—á–∞—Å</button>
                </div>
              </div>

              <div class="hint">
                –ü–æ—Å–ª–µ –ø–æ–∫—É–ø–∫–∏ —Å–æ–∑–¥–∞—Å—Ç—Å—è —Å–¥–µ–ª–∫–∞. –û–ø–ª–∞—Ç–∞ –ø–µ—Ä–µ–≤–æ–¥–∏—Ç —Å—É–º–º—É –≤ <b>hold</b> (—ç—Å–∫—Ä–æ—É). –ü–æ—Å–ª–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è ‚Äî –¥–µ–Ω—å–≥–∏ —É–π–¥—É—Ç –ø—Ä–æ–¥–∞–≤—Ü—É.
              </div>
            </div>
          </div>
        </div>\`;

      $("#d_back").addEventListener("click", ()=>{ state.listing=null; renderMarket(); });
      $("#d_buy").addEventListener("click", ()=> createOrder(l.id));
      $("#d_buy2").addEventListener("click", ()=> createOrder(l.id));

      $("#d_chat").addEventListener("click", async ()=>{
        if(!requireLogin()) return;
        await loadOrders();
        const ord = state.orders.find(o => o.listingId === l.id && (o.buyerId === state.me.id || o.sellerId === state.me.id));
        if(ord) return openOrderChat(ord);
        toast("–ß–∞—Ç –≤ —Å–¥–µ–ª–∫–µ", "–ß–∞—Ç —Å–æ–∑–¥–∞—ë—Ç—Å—è –≤ —Å–¥–µ–ª–∫–µ. –°–æ–∑–¥–∞–π—Ç–µ —Å–¥–µ–ª–∫—É (–ö—É–ø–∏—Ç—å).", "warn", 4200);
      });
    }

    // ----- Sell -----
    function renderSell(){
      const app = $("#app");
      const catOptions = ["<option value=''>–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é</option>"].concat(
        (state.categories || []).map(c => \`<option value="\${escapeHtml(c.id)}">\${escapeHtml(c.title || c.name || c.id)}</option>\`)
      ).join("");

      app.innerHTML = \`
        <div class="section-title">
          <div><h2>–ü—Ä–æ–¥–∞—Ç—å</h2><p>–°–æ–∑–¥–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞</p></div>
          <div class="row">
            <button class="btn-ghost" id="s_toMarket">‚Üê –ú–∞—Ä–∫–µ—Ç</button>
            <button class="btn" id="s_publish">–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å</button>
          </div>
        </div>

        <div class="card-pad">
          \${state.me ? "" : \`<span class="badge warn"><span class="i"></span><strong>–í—ã –Ω–µ –≤–æ—à–ª–∏</strong>&nbsp;<span class="muted">‚Äî –ø—É–±–ª–∏–∫–∞—Ü–∏—è –ø–æ—Ç—Ä–µ–±—É–µ—Ç –≤—Ö–æ–¥–∞</span></span><div style="height:12px;"></div>\`}

          <form id="sellForm" class="grid2" autocomplete="off">
            <div>
              <div class="hint" style="margin-bottom:6px;">–ù–∞–∑–≤–∞–Ω–∏–µ</div>
              <input class="field" name="title" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: Netflix Premium 1 month" maxlength="80" required>
            </div>
            <div>
              <div class="hint" style="margin-bottom:6px;">–¶–µ–Ω–∞ (‚ÇΩ)</div>
              <input class="field" name="price" type="number" min="1" step="1" placeholder="499" required>
            </div>

            <div>
              <div class="hint" style="margin-bottom:6px;">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</div>
              <select class="field" name="categoryId" required>\${catOptions}</select>
            </div>

            <div>
              <div class="hint" style="margin-bottom:6px;">Delivery</div>
              <select class="field" name="delivery">
                <option value="manual">manual ‚Äî –≤—ã–¥–∞—á–∞ –≤—Ä—É—á–Ω—É—é</option>
                <option value="auto">auto ‚Äî –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –≤—ã–¥–∞—á–∞</option>
              </select>
            </div>

            <div>
              <div class="hint" style="margin-bottom:6px;">–û—Å—Ç–∞—Ç–æ–∫ (stock)</div>
              <input class="field" name="stock" type="number" min="1" step="1" value="1">
            </div>

            <div style="grid-column: 1 / -1;">
              <div class="hint" style="margin-bottom:6px;">–û–ø–∏—Å–∞–Ω–∏–µ</div>
              <textarea class="field" name="description" placeholder="–ß—Ç–æ –∏–º–µ–Ω–Ω–æ –ø—Ä–æ–¥–∞—ë—Ç–µ, —Å—Ä–æ–∫–∏, —É—Å–ª–æ–≤–∏—è, –∫–∞–∫ –≤—ã–¥–∞—ë—Ç–µ‚Ä¶"></textarea>
              <div class="hint" style="margin-top:8px;">–°–æ–≤–µ—Ç: –∫–æ—Ä–æ—Ç–∫–∏–π –∑–∞–≥–æ–ª–æ–≤–æ–∫ + —á—ë—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ ‚Üí –≤—ã—à–µ –∫–æ–Ω–≤–µ—Ä—Å–∏—è.</div>
            </div>

            <div style="grid-column: 1 / -1;">
              <div class="row" style="justify-content: flex-end;">
                <button type="button" class="btn" id="s_publish2">–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å</button>
              </div>
            </div>
          </form>
        </div>\`;

      $("#s_toMarket").addEventListener("click", ()=> setRoute("market"));
      const form = $("#sellForm");
      const publish = ()=> createListingFromForm(form);
      $("#s_publish").addEventListener("click", publish);
      $("#s_publish2").addEventListener("click", publish);
    }

    // ----- Deals -----
    function statusBadge(st){
      const s = String(st || "pending");
      if(s === "pending") return \`<span class="badge warn"><span class="i"></span><strong>pending</strong></span>\`;
      if(s === "paid") return \`<span class="badge brand"><span class="i"></span><strong>paid</strong></span>\`;
      if(s === "delivered") return \`<span class="badge brand"><span class="i"></span><strong>delivered</strong></span>\`;
      if(s === "completed") return \`<span class="badge ok"><span class="i"></span><strong>completed</strong></span>\`;
      if(s === "refunded") return \`<span class="badge"><span class="i"></span><strong>refunded</strong></span>\`;
      return \`<span class="badge"><span class="i"></span><strong>\${escapeHtml(s)}</strong></span>\`;
    }

    function renderDeals(){
      const app = $("#app");
      if(!state.me){
        app.innerHTML = \`
          <div class="section-title"><h2>–°–¥–µ–ª–∫–∏</h2><p>–ù—É–∂–µ–Ω –≤—Ö–æ–¥</p></div>
          <div class="card-pad">
            <span class="badge warn"><span class="i"></span><strong>–í–æ–π–¥–∏—Ç–µ</strong>&nbsp;<span class="muted">—á—Ç–æ–±—ã –≤–∏–¥–µ—Ç—å –ø–æ–∫—É–ø–∫–∏ –∏ –ø—Ä–æ–¥–∞–∂–∏</span></span>
            <div style="height:10px;"></div>
            <button class="btn" id="goLogin">–û—Ç–∫—Ä—ã—Ç—å –ø—Ä–æ—Ñ–∏–ª—å</button>
          </div>\`;
        $("#goLogin").addEventListener("click", ()=> setRoute("profile"));
        return;
      }

      const rows = (state.orders || []).slice().sort((a,b)=>(b.updatedAt||0)-(a.updatedAt||0)).map(o=>{
        const isBuyer = o.buyerId === state.me.id;
        const isSeller = o.sellerId === state.me.id;
        const st = o.status || "pending";

        const actions = [];
        if(st === "pending" && isBuyer) actions.push(btnAct("–û–ø–ª–∞—Ç–∏—Ç—å","pay",o.id,true));
        if(st === "paid" && isSeller) actions.push(btnAct("–í—ã–¥–∞–ª —Ç–æ–≤–∞—Ä","deliver",o.id,true));
        if(st === "delivered" && isBuyer) actions.push(btnAct("–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å","confirm",o.id,true));
        actions.push(btnAct("–ß–∞—Ç","chat",o.id,false));

        return \`
          <tr>
            <td><span class="mono">\${escapeHtml(o.id)}</span><div class="hint">\${escapeHtml(fmtTs(o.createdAt))}</div></td>
            <td><strong>\${escapeHtml(o.listingTitle || o.title || o.listingId || "‚Äî")}</strong><div class="hint">\${escapeHtml(isBuyer ? "–ü–æ–∫—É–ø–∫–∞" : (isSeller ? "–ü—Ä–æ–¥–∞–∂–∞" : "‚Äî"))}</div></td>
            <td><strong>\${fmtMoney(o.price)} ‚ÇΩ</strong></td>
            <td>\${statusBadge(st)}<div class="hint">\${escapeHtml(fmtTs(o.updatedAt))}</div></td>
            <td><div class="row" style="gap:8px; flex-wrap:wrap;">\${actions.join("")}</div></td>
          </tr>\`;
      }).join("") || \`
        <tr><td colspan="5" style="padding:16px;">
          <span class="badge warn"><span class="i"></span><strong>–°–¥–µ–ª–æ–∫ –Ω–µ—Ç</strong></span>
          <div style="height:10px;"></div>
          <div class="hint">–ö—É–ø–∏—Ç–µ —á—Ç–æ-–Ω–∏–±—É–¥—å –≤ –ú–∞—Ä–∫–µ—Ç–µ –∏–ª–∏ —Å–æ–∑–¥–∞–π—Ç–µ —Ç–æ–≤–∞—Ä.</div>
        </td></tr>\`;

      app.innerHTML = \`
        <div class="section-title">
          <div><h2>–°–¥–µ–ª–∫–∏</h2><p>–û–ø–ª–∞—Ç–∞ ‚Üí hold ‚Üí –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ</p></div>
          <div class="row">
            <button class="btn-ghost" id="d_reload">–û–±–Ω–æ–≤–∏—Ç—å</button>
            <button class="btn" id="d_wallet">–ö–æ—à–µ–ª—ë–∫</button>
          </div>
        </div>

        <div style="padding:0;">
          <table class="table">
            <thead><tr><th>ID</th><th>–¢–æ–≤–∞—Ä</th><th>–°—É–º–º–∞</th><th>–°—Ç–∞—Ç—É—Å</th><th>–î–µ–π—Å—Ç–≤–∏—è</th></tr></thead>
            <tbody id="dealsBody">\${rows}</tbody>
          </table>
        </div>

        <div class="card-pad">
          <div class="row" style="justify-content: space-between;">
            <div class="hint">–ï—Å–ª–∏ –ø—Ä–∏ –æ–ø–ª–∞—Ç–µ –æ—à–∏–±–∫–∞ <b>NO_FUNDS</b> ‚Äî –ø–æ–ø–æ–ª–Ω–∏—Ç–µ <b>available</b> –≤ –∫–æ—à–µ–ª—å–∫–µ.</div>
            <button class="btn" id="d_market">–ú–∞—Ä–∫–µ—Ç</button>
          </div>
        </div>\`;

      $("#d_reload").addEventListener("click", async ()=>{ await loadOrders(); render(); });
      $("#d_wallet").addEventListener("click", ()=> setRoute("wallet"));
      $("#d_market").addEventListener("click", ()=> setRoute("market"));

      $$("#dealsBody [data-act]").forEach(el => el.addEventListener("click", async ()=>{
        const act = el.dataset.act;
        const id = el.dataset.id;
        const o = state.orders.find(x => x.id === id);
        if(!o) return;

        if(act==="pay") await payOrder(id);
        if(act==="deliver") await sellerRequestComplete(id);
        if(act==="confirm") await buyerConfirm(id);
        if(act==="chat") await openOrderChat(o);

        await loadOrders();
        render();
      }));
    }

    function btnAct(label, act, id, primary){
      return \`<button class="\${primary ? "btn":"btn-ghost"}" data-act="\${act}" data-id="\${escapeHtml(id)}">\${escapeHtml(label)}</button>\`;
    }

    // ----- Chat -----
    function renderMessages(messages){
      if(!messages || messages.length === 0){
        return \`<div class="hint" style="padding:10px;">–ü–æ–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π –Ω–µ—Ç.</div>\`;
      }
      return messages.slice(-300).map(m=>{
        const me = (m.userId && state.me && m.userId === state.me.id);
        const who = me ? "–í—ã" : (m.userNickname || m.userId || "System");
        const ts = fmtTs(m.ts || m.createdAt || Date.now());
        const text = m.text || m.body || m.message || "";
        return \`
          <div class="msg \${me ? "me":""}">
            <div class="meta"><span>\${escapeHtml(who)}</span><span>\${escapeHtml(ts)}</span></div>
            <div class="text">\${escapeHtml(text)}</div>
          </div>\`;
      }).join("");
    }
    function scrollChatToBottom(smooth=false){
      const msgs = $("#msgs");
      if(!msgs) return;
      msgs.scrollTo({ top: msgs.scrollHeight, behavior: smooth ? "smooth":"auto" });
    }

    function renderChat(){
      const app = $("#app");
      if(!state.me){
        app.innerHTML = \`
          <div class="section-title"><h2>–ß–∞—Ç—ã</h2><p>–ù—É–∂–µ–Ω –≤—Ö–æ–¥</p></div>
          <div class="card-pad">
            <span class="badge warn"><span class="i"></span><strong>–í–æ–π–¥–∏—Ç–µ</strong>&nbsp;<span class="muted">—á—Ç–æ–±—ã –æ–±—â–∞—Ç—å—Å—è –≤ —Å–¥–µ–ª–∫–∞—Ö</span></span>
            <div style="height:10px;"></div>
            <button class="btn" id="goLogin">–û—Ç–∫—Ä—ã—Ç—å –ø—Ä–æ—Ñ–∏–ª—å</button>
          </div>\`;
        $("#goLogin").addEventListener("click", ()=> setRoute("profile"));
        return;
      }

      const rooms = (state.inbox || []).slice().sort((a,b)=>(b.updatedAt||0)-(a.updatedAt||0)).map(r=>{
        const title = r.title || r.room || "room";
        const last = r.last?.text || r.last?.body || r.last || "";
        const active = state.activeRoom === r.room;
        return \`
          <div class="chatroom \${active ? "active":""}" data-room="\${escapeHtml(r.room)}">
            <div class="t">\${escapeHtml(title)}</div>
            <div class="m">\${escapeHtml(String(last).slice(0,80) || "‚Äî")}</div>
          </div>\`;
      }).join("") || \`
        <div style="padding:16px;">
          <span class="badge warn"><span class="i"></span><strong>–ß–∞—Ç–æ–≤ –Ω–µ—Ç</strong></span>
          <div style="height:10px;"></div>
          <div class="hint">–ß–∞—Ç—ã —Å–æ–∑–¥–∞—é—Ç—Å—è –≤–Ω—É—Ç—Ä–∏ —Å–¥–µ–ª–æ–∫. –û—Ç–∫—Ä–æ–π—Ç–µ ¬´–°–¥–µ–ª–∫–∏¬ª ‚Üí ¬´–ß–∞—Ç¬ª.</div>
        </div>\`;

      app.innerHTML = \`
        <div class="section-title">
          <div><h2>–ß–∞—Ç—ã</h2><p>–û–±–Ω–æ–≤–ª–µ–Ω–∏—è –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏ (SSE)</p></div>
          <div class="row">
            <button class="btn-ghost" id="c_reload">–û–±–Ω–æ–≤–∏—Ç—å</button>
            <button class="btn" id="c_deals">–°–¥–µ–ª–∫–∏</button>
          </div>
        </div>

        <div class="chat">
          <div class="chatlist">
            <div class="headbar">
              <h4>–ö–æ–º–Ω–∞—Ç—ã</h4>
              <button class="btn-ghost" id="c_new">+ –∏–∑ —Å–¥–µ–ª–∫–∏</button>
            </div>
            <div id="rooms">\${rooms}</div>
          </div>

          <div class="chatbox">
            <div class="headbar">
              <div class="title">\${escapeHtml(state.activeRoom || "–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç")}</div>
              <button class="btn-ghost" id="c_close">–°–∫—Ä—ã—Ç—å</button>
            </div>
            <div class="msgs" id="msgs">\${renderMessages(state.roomMessages)}</div>
            <div class="sendbar">
              <input class="field" id="c_text" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ‚Ä¶" \${state.activeRoom ? "" : "disabled"}>
              <button class="btn" id="c_send" \${state.activeRoom ? "" : "disabled"}>–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
            </div>
          </div>
        </div>\`;

      $("#c_reload").addEventListener("click", ()=> loadInbox(true));
      $("#c_deals").addEventListener("click", ()=> setRoute("deals"));
      $("#c_new").addEventListener("click", ()=> setRoute("deals"));
      $("#c_close").addEventListener("click", ()=>{ state.activeRoom=null; state.roomMessages=[]; render(); });

      $$("#rooms .chatroom").forEach(el => el.addEventListener("click", async ()=>{
        const room = el.dataset.room;
        await loadRoom(room);
        startSSE();
      }));

      $("#c_send").addEventListener("click", async ()=>{
        const t = $("#c_text");
        await sendChat(t.value);
        t.value = ""; t.focus();
      });
      $("#c_text").addEventListener("keydown", async (e)=>{
        if(e.key === "Enter" && !e.shiftKey){
          e.preventDefault();
          const t = $("#c_text");
          await sendChat(t.value);
          t.value = "";
        }
      });

      if(state.inbox.length === 0) loadInbox(true);
      startSSE();
      scrollChatToBottom();
    }

    // ----- Wallet -----
    function renderWallet(){
      const app = $("#app");
      if(!state.me){
        app.innerHTML = \`
          <div class="section-title"><h2>–ö–æ—à–µ–ª—ë–∫</h2><p>–ù—É–∂–µ–Ω –≤—Ö–æ–¥</p></div>
          <div class="card-pad">
            <span class="badge warn"><span class="i"></span><strong>–í–æ–π–¥–∏—Ç–µ</strong>&nbsp;<span class="muted">—á—Ç–æ–±—ã –ø–æ–ø–æ–ª–Ω—è—Ç—å –∏ –ø–ª–∞—Ç–∏—Ç—å</span></span>
            <div style="height:10px;"></div>
            <button class="btn" id="goLogin">–û—Ç–∫—Ä—ã—Ç—å –ø—Ä–æ—Ñ–∏–ª—å</button>
          </div>\`;
        $("#goLogin").addEventListener("click", ()=> setRoute("profile"));
        return;
      }

      const w = state.wallet || { available:0, hold:0 };
      const pending = getPendingTopup();

      const hist = (state.walletHistory || []).slice().reverse().slice(0, 30).map(h => \`
        <tr>
          <td>\${escapeHtml(h.type || "‚Äî")}</td>
          <td><strong>\${fmtMoney(h.amount)} \${escapeHtml(h.currency || "RUB")}</strong><div class="hint">\${escapeHtml(h.provider || "")}</div></td>
          <td class="hint">\${escapeHtml(fmtTs(h.ts || h.createdAt))}</td>
        </tr>\`).join("") || \`<tr><td colspan="3" style="padding:16px;"><div class="hint">–ò—Å—Ç–æ—Ä–∏—è –ø–æ–∫–∞ –ø—É—Å—Ç–∞—è.</div></td></tr>\`;

      app.innerHTML = \`
        <div class="section-title">
          <div><h2>–ö–æ—à–µ–ª—ë–∫</h2><p>–ë–∞–ª–∞–Ω—Å –∏ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è</p></div>
          <div class="row">
            <button class="btn-ghost" id="w_reload">–û–±–Ω–æ–≤–∏—Ç—å</button>
            <button class="btn" id="w_deals">–°–¥–µ–ª–∫–∏</button>
          </div>
        </div>

        <div class="card-pad">
          <div class="row" style="gap:12px; flex-wrap:wrap;">
            <span class="badge brand"><span class="i"></span><strong>available</strong>&nbsp;\${fmtMoney(w.available)} ‚ÇΩ</span>
            <span class="badge"><span class="i"></span><strong>hold</strong>&nbsp;\${fmtMoney(w.hold)} ‚ÇΩ</span>
            <div class="hint" style="margin-left:auto;">–î–ª—è –æ–ø–ª–∞—Ç—ã –Ω—É–∂–Ω–∞ —Å—É–º–º–∞ –Ω–∞ <b>available</b>.</div>
          </div>

          \${pending ? \`
            <div style="height:12px;"></div>
            <span class="badge warn"><span class="i"></span><strong>–û–∂–∏–¥–∞–µ—Ç –ø–ª–∞—Ç—ë–∂</strong>&nbsp;<span class="muted mono">\${escapeHtml(pending.id)}</span></span>
            <div style="height:10px;"></div>
            <div class="row">
              <button class="btn-ghost" id="w_openPay">–û—Ç–∫—Ä—ã—Ç—å –æ–ø–ª–∞—Ç—É</button>
              <button class="btn" id="w_checkPay">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å</button>
              <button class="btn-ghost" id="w_dropPay">–°–±—Ä–æ—Å–∏—Ç—å</button>
            </div>\` : ""}

          <div style="height:14px;"></div>

          <div class="grid2">
            <div class="card" style="overflow:hidden;">
              <div class="section-title" style="position:unset;">
                <div><h2 style="font-size:16px;">–ü–æ–ø–æ–ª–Ω–∏—Ç—å</h2><p>–ê–≤—Ç–æ –∏–ª–∏ –∑–∞—è–≤–∫–∞</p></div>
              </div>
              <div class="card-pad">
                <div class="grid2">
                  <div>
                    <div class="hint" style="margin-bottom:6px;">–°—É–º–º–∞ (‚ÇΩ)</div>
                    <input class="field" id="w_topupAmt" type="number" min="1" step="1" value="500">
                  </div>
                  <div>
                    <div class="hint" style="margin-bottom:6px;">–°–ø–æ—Å–æ–±</div>
                    <select class="field" id="w_method">
                      <option value="rukassa">RuKassa (FK) ‚Äî –∞–≤—Ç–æ</option>
                      <option value="paradise">Paradise ‚Äî –∞–≤—Ç–æ</option>
                      <option value="cryptobot">CryptoBot ‚Äî –∞–≤—Ç–æ</option>
                      <option value="stripe">Stripe ‚Äî –∞–≤—Ç–æ</option>
                      <option value="request">–ó–∞—è–≤–∫–∞ –º–µ–Ω–µ–¥–∂–µ—Ä—É ‚Äî –≤—Ä—É—á–Ω—É—é</option>
                    </select>
                  </div>
                </div>
                <div style="height:10px;"></div>
                <div class="row">
                  <button class="btn" id="w_topup">–ù–∞—á–∞—Ç—å</button>
                  <button class="btn-ghost" id="w_help">–ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç</button>
                </div>
                <div style="height:10px;"></div>
                <div class="hint">
                  –ï—Å–ª–∏ –ø—Ä–æ–≤–∞–π–¥–µ—Ä –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ ‚Äî –±—É–¥–µ—Ç –æ—à–∏–±–∫–∞. –û—Ç–∫—Ä–æ–π—Ç–µ <b>Debug</b> (–∏–∫–æ–Ω–∫–∞ –∫–æ–ª–±—ã) –∏ –ø–æ—Å–º–æ—Ç—Ä–∏—Ç–µ –æ—Ç–≤–µ—Ç.
                </div>
              </div>
            </div>

            <div class="card" style="overflow:hidden;">
              <div class="section-title" style="position:unset;">
                <div><h2 style="font-size:16px;">–í—ã–≤–µ—Å—Ç–∏</h2><p>–ó–∞—è–≤–∫–∞</p></div>
              </div>
              <div class="card-pad">
                <div>
                  <div class="hint" style="margin-bottom:6px;">–°—É–º–º–∞ (‚ÇΩ)</div>
                  <input class="field" id="w_withAmt" type="number" min="1" step="1" value="500">
                </div>
                <div style="height:10px;"></div>
                <button class="btn btn-danger" id="w_with">–°–æ–∑–¥–∞—Ç—å –∑–∞—è–≤–∫—É</button>
                <div style="height:10px;"></div>
                <div class="hint">–í—ã–≤–æ–¥ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è –≤—Ä—É—á–Ω—É—é. –ö–æ–º–∏—Å—Å–∏–∏/–ª–∏–º–∏—Ç—ã –∑–∞–≤–∏—Å—è—Ç –æ—Ç –ø—Ä–∞–≤–∏–ª —Å–µ—Ä–≤–∏—Å–∞.</div>
              </div>
            </div>
          </div>

          <div style="height:14px;"></div>

          <div class="card" style="overflow:hidden;">
            <div class="section-title" style="position:unset;">
              <div><h2 style="font-size:16px;">–ò—Å—Ç–æ—Ä–∏—è</h2><p>–ü–æ—Å–ª–µ–¥–Ω–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏</p></div>
            </div>
            <div style="padding:0;">
              <table class="table">
                <thead><tr><th>–¢–∏–ø</th><th>–°—É–º–º–∞</th><th>–î–∞—Ç–∞</th></tr></thead>
                <tbody>\${hist}</tbody>
              </table>
            </div>
          </div>
        </div>\`;

      $("#w_reload").addEventListener("click", async ()=>{ await loadWalletAll(); render(); });
      $("#w_deals").addEventListener("click", ()=> setRoute("deals"));

      if(pending){
        $("#w_openPay").addEventListener("click", ()=> window.open(pending.url, "_blank", "noopener"));
        $("#w_checkPay").addEventListener("click", ()=> payCheckPending());
        $("#w_dropPay").addEventListener("click", async ()=>{
          const ok = await Modal.confirm({ title:"–°–±—Ä–æ—Å–∏—Ç—å –æ–∂–∏–¥–∞–Ω–∏–µ?", message:"–≠—Ç–æ –Ω–µ –æ—Ç–º–µ–Ω—è–µ—Ç –ø–ª–∞—Ç—ë–∂ —É –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞. –ü—Ä–æ—Å—Ç–æ —É–±–µ—Ä—ë—Ç –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ.", confirmLabel:"–°–±—Ä–æ—Å–∏—Ç—å", danger:true });
          if(!ok) return;
          localStorage.removeItem(LS.pendingTopup);
          toast("–°–±—Ä–æ—à–µ–Ω–æ", "–û–∂–∏–¥–∞—é—â–∏–π –ø–ª–∞—Ç—ë–∂ —É–¥–∞–ª—ë–Ω", "ok");
          render();
        });
      }

      $("#w_help").addEventListener("click", ()=>{
        Modal.open({
          title:"–ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—à–µ–ª—ë–∫",
          body: \`
            <div class="hint">–ö–æ—Ä–æ—Ç–∫–æ:</div>
            <ul style="margin:6px 0 0; padding-left:18px; line-height:1.55;">
              <li><b>available</b> ‚Äî –¥–æ—Å—Ç—É–ø–Ω–æ –¥–ª—è –æ–ø–ª–∞—Ç—ã.</li>
              <li><b>hold</b> ‚Äî –≤ —ç—Å–∫—Ä–æ—É (–ø–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã —Å–¥–µ–ª–∫–∏).</li>
              <li>–ü–æ–∫—É–ø–∞—Ç–µ–ª—å –æ–ø–ª–∞—á–∏–≤–∞–µ—Ç ‚Üí —Å—É–º–º–∞ —É—Ö–æ–¥–∏—Ç –≤ <b>hold</b>.</li>
              <li>–ü–æ—Å–ª–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è ‚Äî –¥–µ–Ω—å–≥–∏ –≤—ã—Ö–æ–¥—è—Ç –∏–∑ hold –∏ –∑–∞—á–∏—Å–ª—è—é—Ç—Å—è –ø—Ä–æ–¥–∞–≤—Ü—É.</li>
            </ul>\`,
          buttons:[{ label:"–ü–æ–Ω—è—Ç–Ω–æ", kind:"primary" }]
        });
      });

      $("#w_topup").addEventListener("click", async ()=>{
        const amt = Number($("#w_topupAmt").value || 0);
        const method = $("#w_method").value;
        if(!(amt > 0)) return toast("–ù–µ–≤–µ—Ä–Ω–∞—è —Å—É–º–º–∞", "–£–∫–∞–∂–∏—Ç–µ —Å—É–º–º—É > 0", "warn");
        if(method === "request"){
          await walletDepositRequest(amt);
        } else {
          await payCreate(method, amt);
        }
        await loadWalletAll();
        render();
      });

      $("#w_with").addEventListener("click", async ()=>{
        const amt = Number($("#w_withAmt").value || 0);
        if(!(amt > 0)) return toast("–ù–µ–≤–µ—Ä–Ω–∞—è —Å—É–º–º–∞", "–£–∫–∞–∂–∏—Ç–µ —Å—É–º–º—É > 0", "warn");
        await walletWithdrawRequest(amt);
      });

      if(!state.wallet) loadWalletAll();
    }

    // ----- Profile -----
    function renderProfile(){
      const app = $("#app");
      const theme = document.documentElement.dataset.theme || "dark";

      if(!state.me){
        app.innerHTML = \`
          <div class="section-title">
            <div><h2>–ü—Ä–æ—Ñ–∏–ª—å</h2><p>–í—Ö–æ–¥ –∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</p></div>
            <div class="row">
              <button class="btn-ghost" id="p_theme">–¢–µ–º–∞: \${escapeHtml(theme)}</button>
              <button class="btn" id="p_market">–ú–∞—Ä–∫–µ—Ç</button>
            </div>
          </div>

          <div class="card-pad">
            <div class="grid2">
              <div class="card" style="overflow:hidden;">
                <div class="section-title" style="position:unset;">
                  <div><h2 style="font-size:16px;">–í–æ–π—Ç–∏</h2><p>email + –ø–∞—Ä–æ–ª—å</p></div>
                </div>
                <div class="card-pad">
                  <div class="grid2">
                    <div>
                      <div class="hint" style="margin-bottom:6px;">Email</div>
                      <input class="field" id="l_email" placeholder="you@mail.com">
                    </div>
                    <div>
                      <div class="hint" style="margin-bottom:6px;">–ü–∞—Ä–æ–ª—å</div>
                      <input class="field" id="l_pass" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                    </div>
                  </div>
                  <div style="height:10px;"></div>
                  <button class="btn" id="l_go">–í–æ–π—Ç–∏</button>
                </div>
              </div>

              <div class="card" style="overflow:hidden;">
                <div class="section-title" style="position:unset;">
                  <div><h2 style="font-size:16px;">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h2><p>–±—ã—Å—Ç—Ä–æ</p></div>
                </div>
                <div class="card-pad">
                  <div class="grid2">
                    <div>
                      <div class="hint" style="margin-bottom:6px;">–ù–∏–∫</div>
                      <input class="field" id="r_nick" placeholder="nickname">
                    </div>
                    <div>
                      <div class="hint" style="margin-bottom:6px;">Email</div>
                      <input class="field" id="r_email" placeholder="you@mail.com">
                    </div>
                    <div style="grid-column: 1 / -1;">
                      <div class="hint" style="margin-bottom:6px;">–ü–∞—Ä–æ–ª—å</div>
                      <input class="field" id="r_pass" type="password" placeholder="–º–∏–Ω–∏–º—É–º 6 —Å–∏–º–≤–æ–ª–æ–≤">
                    </div>
                  </div>
                  <div style="height:10px;"></div>
                  <button class="btn" id="r_go">–°–æ–∑–¥–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç</button>
                </div>
              </div>
            </div>

            <div style="height:12px;"></div>
            <div class="hint">–ï—Å–ª–∏ —á—Ç–æ-—Ç–æ ‚Äú–Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç‚Äù ‚Äî —á–∞—â–µ –≤—Å–µ–≥–æ —ç–Ω–¥–ø–æ–∏–Ω—Ç –Ω–∞ –±—ç–∫–µ –Ω–∞–∑—ã–≤–∞–µ—Ç—Å—è –∏–Ω–∞—á–µ. –ù–∞–∂–º–∏—Ç–µ <b>Debug</b> (–∏–∫–æ–Ω–∫–∞ –∫–æ–ª–±—ã) –∏ –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –æ—Ç–≤–µ—Ç—ã API.</div>
          </div>\`;

        $("#p_theme").addEventListener("click", ()=> applyTheme(theme === "dark" ? "light":"dark"));
        $("#p_market").addEventListener("click", ()=> setRoute("market"));

        $("#l_go").addEventListener("click", async ()=>{
          const email = $("#l_email").value.trim();
          const pass = $("#l_pass").value;
          if(!email || !pass) return toast("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –ø–æ–ª—è", "Email –∏ –ø–∞—Ä–æ–ª—å", "warn");
          const ok = await doLogin(email, pass);
          if(ok){
            await Promise.allSettled([loadWallet(), loadOrders()]);
            setRoute("market");
          }
        });

        $("#r_go").addEventListener("click", async ()=>{
          const nick = $("#r_nick").value.trim();
          const email = $("#r_email").value.trim();
          const pass = $("#r_pass").value;
          if(!nick || !email || !pass) return toast("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –ø–æ–ª—è", "–ù–∏–∫, email, –ø–∞—Ä–æ–ª—å", "warn");
          if(pass.length < 6) return toast("–°–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∏–π –ø–∞—Ä–æ–ª—å", "–ú–∏–Ω–∏–º—É–º 6 —Å–∏–º–≤–æ–ª–æ–≤", "warn");
          const ok = await doRegister(email, pass, nick);
          if(ok){
            await Promise.allSettled([loadWallet(), loadOrders()]);
            setRoute("market");
          }
        });

        return;
      }

      // logged in
      app.innerHTML = \`
        <div class="section-title">
          <div><h2>–ü—Ä–æ—Ñ–∏–ª—å</h2><p>–ê–∫–∫–∞—É–Ω—Ç –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</p></div>
          <div class="row">
            <button class="btn-ghost" id="p_theme">–¢–µ–º–∞: \${escapeHtml(theme)}</button>
            <button class="btn btn-danger" id="p_logout">–í—ã–π—Ç–∏</button>
          </div>
        </div>

        <div class="card-pad">
          <div class="row" style="justify-content: space-between; flex-wrap: wrap;">
            <div>
              <span class="badge brand"><span class="i"></span><strong>\${escapeHtml(state.me.nickname || "User")}</strong></span>
              <div style="height:10px;"></div>
              <div class="hint">Email: <b>\${escapeHtml(state.me.email || "‚Äî")}</b></div>
              <div class="hint">ID: <span class="mono">\${escapeHtml(state.me.id || "‚Äî")}</span></div>
              <div class="hint">Roles: <span class="mono">\${escapeHtml((state.me.roles || ["user"]).join(","))}</span></div>
            </div>
            <div class="row">
              <button class="btn" id="p_wallet">–ö–æ—à–µ–ª—ë–∫</button>
              <button class="btn-ghost" id="p_deals">–°–¥–µ–ª–∫–∏</button>
              <button class="btn-ghost" id="p_chat">–ß–∞—Ç—ã</button>
            </div>
          </div>

          <div style="height:14px;"></div>

          <div class="card" style="overflow:hidden;">
            <div class="section-title" style="position:unset;">
              <div><h2 style="font-size:16px;">–ë—ã—Å—Ç—Ä—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏</h2><p>–¥–ª—è –¥–µ–±–∞–≥–∞</p></div>
            </div>
            <div class="card-pad">
              <div class="row" style="justify-content: space-between; flex-wrap:wrap;">
                <div class="hint">–°–µ—Ä–≤–µ—Ä: <b>\${escapeHtml(state.health?.v || state.health?.version || "‚Äî")}</b></div>
                <div class="row">
                  <button class="btn-ghost" id="p_health">–û–±–Ω–æ–≤–∏—Ç—å health</button>
                  <button class="btn-ghost" id="p_me">–ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å me</button>
                  <button class="btn" id="p_debug">Debug API</button>
                </div>
              </div>
              <div style="height:10px;"></div>
              <div class="hint">–ï—Å–ª–∏ API –Ω–µ —Å–æ–≤–ø–∞–¥–∞–µ—Ç ‚Äî —ç—Ç–æ –≤–∏–¥–Ω–æ –≤ Debug (404 / NOT_FOUND).</div>
            </div>
          </div>
        </div>\`;

      $("#p_theme").addEventListener("click", ()=> applyTheme(theme === "dark" ? "light":"dark"));
      $("#p_logout").addEventListener("click", doLogout);
      $("#p_wallet").addEventListener("click", ()=> setRoute("wallet"));
      $("#p_deals").addEventListener("click", ()=> setRoute("deals"));
      $("#p_chat").addEventListener("click", ()=> setRoute("chat"));
      $("#p_health").addEventListener("click", loadHealth);
      $("#p_me").addEventListener("click", loadMe);
      $("#p_debug").addEventListener("click", openDebug);
    }

    // ---------- Debug ----------
    function openDebug(){
      const routes = [
        { name:"health", path:"/api/health" },
        { name:"me", path:"/api/me" },
        { name:"categories", path:"/api/categories" },
        { name:"listings", path:"/api/listings?limit=3" },
        { name:"orders", path:"/api/orders" },
        { name:"wallet", path:"/api/wallet" },
        { name:"inbox", path:"/api/chat/inbox" },
      ];
      Modal.open({
        title: "Debug API",
        body: \`
          <div class="hint">–ù–∞–∂–∏–º–∞–π—Ç–µ, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å —Å—ã—Ä–æ–π –æ—Ç–≤–µ—Ç (—É–¥–æ–±–Ω–æ –ª–æ–≤–∏—Ç—å –Ω–µ—Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ —ç–Ω–¥–ø–æ–∏–Ω—Ç–æ–≤).</div>
          <div style="height:10px;"></div>
          <div class="row" style="gap:8px; flex-wrap:wrap;">
            \${routes.map(r => \`<button class="btn-ghost" data-dbg="\${escapeHtml(r.path)}">\${escapeHtml(r.name)}</button>\`).join("")}
          </div>
          <div style="height:12px;"></div>
          <textarea class="field mono" id="dbgOut" style="min-height:220px;" placeholder="–û—Ç–≤–µ—Ç –ø–æ—è–≤–∏—Ç—Å—è –∑–¥–µ—Å—å‚Ä¶"></textarea>
        \`,
        buttons: [
          { label:"–ó–∞–∫—Ä—ã—Ç—å", kind:"ghost" },
        ]
      });
      $("[data-dbg]")?.scrollIntoView?.({block:"nearest"});

      $$("[data-dbg]").forEach(btn=>{
        btn.addEventListener("click", async ()=>{
          const path = btn.getAttribute("data-dbg");
          const out = $("#dbgOut");
          out.value = "Loading " + path + " ‚Ä¶";
          const r = await apiFetch(path, { method:"GET" });
          out.value = JSON.stringify(r, null, 2);
        });
      });
    }

    // ---------- final init ----------
    boot();

    // keep SSE alive while chats open
    setInterval(()=>{ if(state.route === "chat" && state.me) startSSE(); }, 2500);
  </script>
</body>
</html>
