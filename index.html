
<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<title>Only Market</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
/* ==========================================================================
   Only Market ‚Äî Full Redesign 2025 (v2)
   Vibe: clean marketplace like modern competitors (layout clarity, big spacing)
   Brand: purple ‚Üî blue gradients
   Themes: light/dark + system
   ========================================================================== */

/* ---- Design tokens ---- */
:root{
  --bg0:#f6f7ff;
  --bg1:#ffffff;
  --panel: rgba(255,255,255,.82);
  --panelSolid:#ffffff;
  --text:#0b1220;
  --muted: rgba(11,18,32,.62);
  --muted2: rgba(11,18,32,.46);
  --border: rgba(16,24,40,.10);
  --border2: rgba(16,24,40,.16);
  --shadow: 0 10px 32px rgba(17,24,39,.06);
  --shadow2: 0 22px 70px rgba(17,24,39,.12);
  --r14:14px; --r18:18px; --r22:22px; --r26:26px;

  --violet:#7c3aed;
  --indigo:#4f46e5;
  --blue:#2563eb;
  --cyan:#22d3ee;

  --accent: var(--violet);
  --accent2: var(--blue);

  --danger:#ef4444;
  --ok:#10b981;
  --warn:#f59e0b;

  --glass: blur(14px);
  --focus: 0 0 0 4px rgba(124,58,237,.22);

  --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial, "Apple Color Emoji","Segoe UI Emoji";
  --tap:44px;
}

:root[data-theme="dark"]{
  --bg0:#070a14;
  --bg1:#0b1020;
  --panel: rgba(14,18,35,.76);
  --panelSolid:#0f1730;
  --text:#e7eaf2;
  --muted: rgba(231,234,242,.68);
  --muted2: rgba(231,234,242,.48);
  --border: rgba(231,234,242,.10);
  --border2: rgba(231,234,242,.14);
  --shadow: 0 18px 70px rgba(0,0,0,.35);
  --shadow2: 0 24px 110px rgba(0,0,0,.55);

  --accent:#a78bfa;
  --accent2:#60a5fa;
  --focus: 0 0 0 4px rgba(96,165,250,.22);
}

/* ---- Base ---- */
*{ box-sizing:border-box }
html,body{ height:100% }
body{
  margin:0;
  font-family: var(--font);
  color: var(--text);
  background: linear-gradient(180deg, var(--bg0), var(--bg1));
  overflow-x:hidden;
}

a{ color:inherit; text-decoration:none }
:focus{ outline:none }
:focus-visible{ box-shadow: var(--focus); border-radius: 12px }

/* Background FX (soft) */
.om-bg{
  position:fixed; inset:-40px; z-index:-2; pointer-events:none;
  background:
    radial-gradient(760px 420px at 12% 8%, rgba(124,58,237,.18), transparent 60%),
    radial-gradient(760px 420px at 85% 10%, rgba(37,99,235,.14), transparent 60%),
    radial-gradient(900px 520px at 38% 88%, rgba(34,211,238,.10), transparent 60%);
  filter:saturate(1.06);
}
:root[data-theme="dark"] .om-bg{
  background:
    radial-gradient(920px 520px at 12% 8%, rgba(167,139,250,.14), transparent 60%),
    radial-gradient(920px 520px at 85% 10%, rgba(96,165,250,.12), transparent 60%),
    radial-gradient(1120px 640px at 38% 88%, rgba(34,211,238,.08), transparent 60%);
}
.om-grain{
  position:fixed; inset:0; z-index:-1; pointer-events:none;
  opacity:.06;
  background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='240' height='240'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.82' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='240' height='240' filter='url(%23n)' opacity='.7'/%3E%3C/svg%3E");
}
:root[data-theme="dark"] .om-grain{ opacity:.08 }

/* ---- Containers ---- */
.wrap{ max-width: 1260px; margin: 14px auto; padding: 0 16px 96px }
.main{ min-height: 70vh }
h2,h3{ margin: 0 0 10px }
p{ margin: 6px 0 0 }
.muted{ color: var(--muted) }

/* ---- Header (clean) ---- */
header{
  position: sticky;
  top: 0;
  z-index: 100;
  display:flex;
  align-items:center;
  gap: 12px;
  padding: 10px 14px;
  background: rgba(255,255,255,.72);
  backdrop-filter: var(--glass);
  border-bottom: 1px solid var(--border);
}
:root[data-theme="dark"] header{ background: rgba(10,14,28,.68) }

.logo{
  display:flex; align-items:center; gap:10px;
  font-weight: 950;
  letter-spacing:.2px;
  cursor:pointer;
  user-select:none;
}
.logo-badge{
  width: 40px; height: 40px; border-radius: 14px;
  display:grid; place-items:center;
  color:#fff;
  background: linear-gradient(135deg, var(--accent), var(--accent2));
  box-shadow: 0 12px 30px rgba(124,58,237,.18);
}
.logo small{ display:block; font-weight:800; color:var(--muted); font-size:12px; margin-top:2px }

.h-search{
  flex:1;
  height: 44px;
  max-width: 640px;
  display:flex;
  align-items:center;
  gap: 10px;
  padding: 0 12px;
  border: 1px solid var(--border);
  border-radius: 999px;
  background: rgba(255,255,255,.70);
  backdrop-filter: var(--glass);
  box-shadow: 0 6px 20px rgba(17,24,39,.04);
}
:root[data-theme="dark"] .h-search{ background: rgba(15,23,48,.62) }
.h-search svg{ width:18px; height:18px; opacity:.55 }
.h-search input{
  border:none; outline:none; background:transparent;
  height: 42px; width:100%;
  font-size: 14px; color: var(--text);
}
.h-search .x{
  width:34px; height:34px; border:none; border-radius: 12px;
  background:transparent; cursor:pointer; color: var(--muted);
}
.h-search .x:hover{ background: rgba(124,58,237,.10); color: var(--text) }

.topnav{ display:flex; gap: 8px; align-items:center }
.topnav .tab{
  height: 40px;
  display:flex; align-items:center;
  padding: 0 12px;
  border-radius: 999px;
  cursor:pointer;
  font-weight: 850;
  font-size: 13px;
  color: var(--muted);
  transition: .14s ease;
}
.topnav .tab:hover{ color: var(--text); background: rgba(124,58,237,.10) }
.topnav .tab.active{
  color:#fff;
  background: linear-gradient(135deg, var(--accent), var(--accent2));
  box-shadow: 0 12px 28px rgba(124,58,237,.16);
}

.userbar{ margin-left:auto; display:flex; align-items:center; gap: 10px }

/* Small, not ‚Äúgiant‚Äù icons */
.icon-btn{
  width: 38px; height: 38px;
  border-radius: 14px;
  border: 1px solid var(--border);
  background: rgba(255,255,255,.60);
  backdrop-filter: var(--glass);
  cursor:pointer;
  display:grid; place-items:center;
  font-weight: 950;
  transition: .12s ease;
}
:root[data-theme="dark"] .icon-btn{ background: rgba(15,23,48,.60) }
.icon-btn:hover{ background: rgba(124,58,237,.12) }

/* Buttons */
.btn, .btn-ghost{
  height: 40px;
  border-radius: 14px;
  padding: 0 14px;
  font-weight: 900;
  cursor:pointer;
  border: 1px solid transparent;
  display:inline-flex; align-items:center; justify-content:center;
  gap: 8px;
  transition: transform .12s ease, filter .12s ease, background .12s ease, border-color .12s ease;
}
.btn{
  color:#fff;
  background: linear-gradient(135deg, var(--accent), var(--accent2));
  box-shadow: 0 10px 24px rgba(124,58,237,.14);
}
.btn:hover{ transform: translateY(-1px); filter: brightness(1.02) }
.btn:active{ transform: translateY(0px) scale(.99) }

.btn-ghost{
  color: var(--text);
  background: rgba(255,255,255,.60);
  border-color: var(--border);
  backdrop-filter: var(--glass);
}
:root[data-theme="dark"] .btn-ghost{ background: rgba(15,23,48,.60) }
.btn-ghost:hover{ background: rgba(124,58,237,.10); border-color: var(--border2) }

/* Inputs */
input,textarea,select{
  width:100%;
  font-family: var(--font);
  border-radius: 14px;
  border: 1px solid var(--border);
  background: rgba(255,255,255,.70);
  backdrop-filter: var(--glass);
  padding: 12px 12px;
  color: var(--text);
  transition: border-color .12s ease, box-shadow .12s ease;
}
:root[data-theme="dark"] input,
:root[data-theme="dark"] textarea,
:root[data-theme="dark"] select{ background: rgba(15,23,48,.62) }
input:focus,textarea:focus,select:focus{ box-shadow: var(--focus); border-color: rgba(124,58,237,.25) }
textarea{ resize: vertical }

/* Cards / Grid */
.grid{ display:grid; grid-template-columns: repeat(auto-fill, minmax(240px, 1fr)); gap: 14px }
.card{
  border-radius: var(--r26);
  background: var(--panel);
  backdrop-filter: var(--glass);
  border: 1px solid var(--border);
  box-shadow: var(--shadow);
  padding: 12px;
  transition: transform .14s ease, box-shadow .14s ease, border-color .14s ease;
}
.card:hover{ transform: translateY(-2px); box-shadow: var(--shadow2); border-color: rgba(124,58,237,.18) }

.media{
  width:100%;
  height: 172px;
  object-fit: cover;
  border-radius: var(--r22);
  border: 1px solid var(--border);
  cursor:pointer;
  background: linear-gradient(135deg, rgba(124,58,237,.08), rgba(37,99,235,.08));
}

/* Catalog item */
.card-item .body{ padding-top: 10px; display:flex; flex-direction:column; gap:6px }
.card-item .price{
  font-weight: 950;
  font-size: 18px;
  display:flex; gap: 8px; align-items:center; flex-wrap:wrap;
}
.card-item .title{ font-weight: 950; font-size: 14px; line-height: 1.25 }
.card-item .meta{ display:flex; gap: 8px; align-items:center; color: var(--muted); font-size: 12px }
.card-item .meta img{ border: 1px solid var(--border) }
.discount{
  font-size: 12px;
  font-weight: 950;
  padding: 4px 8px;
  border-radius: 999px;
  border: 1px solid rgba(124,58,237,.22);
  background: rgba(124,58,237,.10);
}
.badge{
  display:inline-flex; align-items:center; gap:6px;
  padding: 5px 10px;
  border-radius: 999px;
  font-size: 12px;
  font-weight: 950;
  border: 1px solid rgba(124,58,237,.18);
  background: rgba(124,58,237,.10);
}
.badge.ok{ border-color: rgba(16,185,129,.25); background: rgba(16,185,129,.12) }
.badge.warn{ border-color: rgba(245,158,11,.25); background: rgba(245,158,11,.12) }
.badge.danger{ border-color: rgba(239,68,68,.25); background: rgba(239,68,68,.12) }

/* Rows */
.row{ display:flex; gap: 10px; align-items:center }
.row-right{ justify-content:flex-end }
.row-split{ display:flex; gap: 12px }
.row-split > *{ flex: 1 }

/* Chips */
.chips{ display:flex; gap: 10px; overflow:auto; padding: 8px 2px; -webkit-overflow-scrolling:touch; scrollbar-width: thin; }
.chip{
  height: 38px;
  display:inline-flex; align-items:center;
  padding: 0 12px;
  border-radius: 999px;
  border: 1px solid var(--border);
  background: rgba(255,255,255,.60);
  backdrop-filter: var(--glass);
  cursor:pointer;
  font-weight: 900;
  color: var(--muted);
  white-space:nowrap;
  transition: .12s ease;
}
:root[data-theme="dark"] .chip{ background: rgba(15,23,48,.60) }
.chip:hover{ color: var(--text); border-color: var(--border2) }
.chip.active{
  color:#fff;
  border-color: transparent;
  background: linear-gradient(135deg, var(--accent), var(--accent2));
  box-shadow: 0 10px 22px rgba(124,58,237,.14);
}

/* Wizard */
.wizard{ display:flex; gap: 14px; flex-wrap:wrap }
.wizard-steps{
  width: 270px;
  flex: 0 0 270px;
  position: sticky;
  top: 74px;
  height: fit-content;
  padding: 10px;
  border-radius: var(--r26);
  border: 1px solid var(--border);
  background: rgba(255,255,255,.60);
  backdrop-filter: var(--glass);
  box-shadow: var(--shadow);
}
:root[data-theme="dark"] .wizard-steps{ background: rgba(15,23,48,.55) }
.wizard-steps .st{
  padding: 10px 10px;
  border-radius: 18px;
  cursor:pointer;
  font-weight: 950;
  color: var(--muted);
  border: 1px solid transparent;
  transition:.12s ease;
}
.wizard-steps .st:hover{ color: var(--text); background: rgba(124,58,237,.08) }
.wizard-steps .st.active{
  color: var(--text);
  background: rgba(124,58,237,.12);
  border-color: rgba(124,58,237,.18);
}
/* Hide legacy step2 in steps list (subcategory now in step1) */
.wizard-steps .st[data-step="2"]{ display:none }

.wizard-pane{
  flex: 1; min-width: 280px;
  border-radius: var(--r26);
  border: 1px solid var(--border);
  background: var(--panel);
  backdrop-filter: var(--glass);
  box-shadow: var(--shadow);
  padding: 14px;
}

/* Combined category/subcategory UI */
.wiz-cat-grid{ display:grid; grid-template-columns: 1fr 1fr; gap: 12px }
.wiz-col{
  border-radius: var(--r22);
  border: 1px solid var(--border);
  background: rgba(255,255,255,.55);
  padding: 10px;
}
:root[data-theme="dark"] .wiz-col{ background: rgba(11,16,32,.62) }
.wiz-col h4{ margin: 0 0 10px; font-size: 13px; color: var(--muted); font-weight: 950 }
.wiz-list{ display:grid; grid-template-columns: 1fr; gap: 8px }
.wiz-pick{
  padding: 10px;
  border-radius: 18px;
  border: 1px solid transparent;
  cursor:pointer;
  background: rgba(255,255,255,.62);
  transition:.12s ease;
  font-weight: 950;
}
:root[data-theme="dark"] .wiz-pick{ background: rgba(15,23,48,.62) }
.wiz-pick:hover{ background: rgba(124,58,237,.10); border-color: rgba(124,58,237,.18) }
.wiz-pick.active{ background: rgba(124,58,237,.14); border-color: rgba(124,58,237,.24) }

/* Chat (scrolling frames) */
.chatWrap{ display:grid; grid-template-columns: 340px 1fr; gap: 14px }
.chatList, .chatView{
  border-radius: var(--r26);
  border: 1px solid var(--border);
  background: rgba(255,255,255,.60);
  backdrop-filter: var(--glass);
  box-shadow: var(--shadow);
}
:root[data-theme="dark"] .chatList,
:root[data-theme="dark"] .chatView{ background: rgba(15,23,48,.55) }
.chatList{ height: 660px; overflow:auto; padding: 10px }
.chatItem{
  padding: 10px;
  margin: 8px 0;
  border-radius: 20px;
  border: 1px solid var(--border);
  background: rgba(255,255,255,.72);
  display:flex; gap: 10px; align-items:center;
  cursor:pointer;
  transition:.12s ease;
}
:root[data-theme="dark"] .chatItem{ background: rgba(15,23,48,.62) }
.chatItem:hover{ border-color: rgba(124,58,237,.22); transform: translateY(-1px) }
.chatItem .avatar{
  width: 40px; height: 40px; border-radius: 999px;
  display:grid; place-items:center;
  background: linear-gradient(135deg, rgba(124,58,237,.18), rgba(37,99,235,.14));
  font-weight: 950;
}
.chatItem .title{ font-weight: 950 }
.chatItem .prev{ font-size: 12px; color: var(--muted) }

.chatView{ height: 660px; display:flex; flex-direction:column; gap: 10px; padding: 12px }
.chatBox{
  flex:1; overflow:auto;
  border-radius: 20px;
  border: 1px solid var(--border);
  background: rgba(255,255,255,.55);
  padding: 12px;
}
:root[data-theme="dark"] .chatBox{ background: rgba(11,16,32,.62) }
.chatLine{ margin: 8px 0; line-height: 1.35 }
.chatLine.mine{ font-weight: 950 }
.dealBtns{ display:flex; flex-wrap:wrap; gap: 8px; margin-top: 10px }

/* Auth/Profile layout (separate, clean) */
.auth-shell{
  display:grid;
  grid-template-columns: 380px 1fr;
  gap: 14px;
  align-items:start;
}
.auth-forms{
  position: sticky;
  top: 74px;
  height: fit-content;
}
/* When logged in: hide auth forms to avoid ‚Äúlogin inside profile‚Äù mess */
body.logged-in #authForms{ display:none }
body:not(.logged-in) #profileShell{ opacity: .88 }
body:not(.logged-in) #profileShell .card{ filter: saturate(.98) }

/* Profile avatar */
.me-avatar{
  width: 48px; height: 48px;
  border-radius: 999px;
  border: 1px solid var(--border);
  object-fit:cover;
}

/* Modals (fix transparency) */
.modal{
  position: fixed;
  inset: 0;
  display: none;
  align-items: center;
  justify-content: center;
  padding: 18px;
  background: rgba(0,0,0,.56);
  z-index: 1000;
}
/* legacy modal content class from old HTML */
.modal-content{
  width: min(720px, 96vw);
  max-height: 86vh;
  overflow:auto;
  border-radius: 26px;
  background: var(--panelSolid);
  border: 1px solid var(--border2);
  box-shadow: var(--shadow2);
  padding: 16px;
}
:root[data-theme="dark"] .modal-content{
  background: var(--panelSolid);
  border-color: rgba(231,234,242,.14);
}

/* Mobile tabs (fix giant icons) */
.m-tabs{
  position: fixed;
  left: 0; right: 0; bottom: 0;
  z-index: 120;
  display:none;
  grid-template-columns: repeat(6, 1fr);
  background: rgba(255,255,255,.80);
  backdrop-filter: blur(14px);
  border-top: 1px solid var(--border);
}
:root[data-theme="dark"] .m-tabs{ background: rgba(10,14,28,.72) }
.m-tab{
  display:flex; flex-direction:column; align-items:center; justify-content:center;
  gap: 6px;
  padding: 10px 6px;
  color: var(--muted);
  font-weight: 900;
  font-size: 11px;
}
.m-tab svg{ width: 18px; height: 18px }
.m-tab.active{ color: var(--text) }

/* Responsive */
@media (max-width: 1020px){
  .topnav{ display:none }
  .auth-shell{ grid-template-columns: 1fr }
  .auth-forms{ position: relative; top: 0 }
}
@media (max-width: 880px){
  .wrap{ padding: 0 12px 92px }
  .grid{ grid-template-columns: repeat(2, 1fr) }
  .media{ height: 148px }
  .chatWrap{ grid-template-columns: 1fr }
  .chatList, .chatView{ height: calc(100vh - 210px) }
  .m-tabs{ display:grid }
  body{ padding-bottom: 74px }
  .wiz-cat-grid{ grid-template-columns: 1fr }
}
@media (max-width: 420px){
  .grid{ gap: 10px }
}

/* Reduced motion */
@media (prefers-reduced-motion: reduce){
  *{ animation:none !important; transition:none !important; scroll-behavior:auto !important }
}
/* === Auth/Profile visibility rules (hard) ===
   - Logged OUT: show only login/register (no profile blocks)
   - Logged IN: show only profile blocks (no login/register)
*/
body:not(.logged-in) #profileShell{ display:none !important; }
body:not(.logged-in) #profileOnly{ display:none !important; }
body.logged-in #authForms{ display:none !important; }
body.logged-in #authOnly{ display:none !important; }
</style>

<style>
/* --- MOBILE ONLY --- */
@media (max-width: 820px){
  /* —É–±–∏—Ä–∞–µ–º –æ–ø–∏—Å–∞–Ω–∏—è –≤ –º–∏–Ω–∏-–∫–∞—Ä—Ç–æ—á–∫–∞—Ö —Ç–æ–≤–∞—Ä–æ–≤ */
  .product-card .desc, .product .desc, .card .desc { display:none !important; }

  /* —á–∞—Ç: –ø—Ä—è—á–µ–º –∫–Ω–æ–ø–∫—É –û—Ç–ø—Ä–∞–≤–∏—Ç—å, –æ—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –∑–∞–≥—Ä—É–∑–∫—É —Ñ–∞–π–ª–æ–≤ */
  .chat-send-btn { display:none !important; }
  /* –¥–µ–ª–∞–µ–º –∫–Ω–æ–ø–∫—É —Ñ–∞–π–ª–æ–≤ –∫—Ä—É–≥–ª–æ–π —Å–æ —Å–∫—Ä–µ–ø–∫–æ–π */
  .chat-files-btn{
    min-width:44px; width:44px; height:44px; border-radius:12px;
    display:inline-flex; align-items:center; justify-content:center;
    position:relative; overflow:hidden;
  }
  .chat-files-btn *{ opacity:0; } /* —Å–∫—Ä—ã—Ç—å —Ç–µ–∫—Å—Ç/–ª–µ–π–±–ª –≤–Ω—É—Ç—Ä–∏ */
  .chat-files-btn::after{ content:"üìé"; position:absolute; inset:0; display:flex;
    align-items:center; justify-content:center; font-size:20px; }

  /* –∫–æ–º–ø–∞–∫—Ç–Ω—ã–µ –ø–ª–∞—à–∫–∏/–∫–Ω–æ–ø–∫–∏ –∫–∞–∫ –≤ —Ä–µ—Ñ–µ—Ä–µ–Ω—Å–µ */
  .chip{display:inline-flex;align-items:center;gap:10px;padding:14px 18px;border-radius:18px;
        background:#f1ecff}
  .chip-btn{border-radius:18px;padding:12px 18px;background:#6f40ff;color:#fff;font-weight:700}
  .chip-btn.secondary{background:#eef0f5;color:#111;}

  /* –∫–∞—Ä—Ç–æ—á–∫–∏ –∫–∞—Ç–∞–ª–æ–≥–∞ ‚Äî –∞–∫–∫—É—Ä–∞—Ç–Ω—ã–µ ‚Äú–ø–ª–∏—Ç–∫–∏‚Äù */
  .mini-grid{display:grid;grid-template-columns:1fr 1fr;gap:14px}
  .mini-card{background:#fff;border-radius:18px;padding:14px;box-shadow:0 2px 10px rgba(0,0,0,.06)}
  .mini-card .title{font-weight:800;line-height:1.1;font-size:20px;
     display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden}
  .mini-card .price{position:absolute;right:10px;top:10px;background:#eadcff;padding:8px 12px;
     border-radius:999px;font-weight:800}
  .mini-card .seller{display:flex;gap:10px;align-items:center;margin-top:10px}
  .mini-card .seller img{width:28px;height:28px;border-radius:50%}

  /* –Ω–æ–≤—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –º–æ–±–∏–ª—å–Ω–æ–≥–æ –ø—Ä–æ—Ñ–∏–ª—è */
  #mobileProfile{padding:14px 16px 24px}
  #mobileProfile .card{background:#fff;border-radius:22px;padding:18px 16px;
    box-shadow:0 2px 14px rgba(0,0,0,.06);margin-bottom:14px}
  #mobileProfile .top{display:flex;align-items:center;gap:14px}
  #mobileProfile .top .avatar{width:56px;height:56px;border-radius:50%;background:#eee;overflow:hidden}
  #mobileProfile .top .avatar img{width:100%;height:100%;object-fit:cover}
  #mobileProfile .gear{margin-left:auto;width:38px;height:38px;border-radius:12px;
      display:flex;align-items:center;justify-content:center;background:#f4f6fb}
  #mobileProfile .balance{display:flex;align-items:baseline;gap:10px}
  #mobileProfile .balance .v{font-size:28px;font-weight:900}
  #mobileProfile .actions{display:flex;gap:10px;margin-top:10px}
  #mobileProfile .actions .btn{flex:1;padding:14px 0;border-radius:14px;text-align:center;
      font-weight:800}
  #mobileProfile .btn.primary{background:#6f40ff;color:#fff}
  #mobileProfile .btn.secondary{background:#eef0f5}
  #mobileProfile .section-title{font-weight:900;font-size:22px;margin-bottom:8px}

  /* –º–æ–¥–∞–ª–∫–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫ */
  #mpSheet{position:fixed;inset:0;background:rgba(0,0,0,.4);display:none;z-index:9999}
  #mpSheet .sheet{position:absolute;left:0;right:0;bottom:0;background:#fff;border-radius:22px 22px 0 0;
     padding:20px 16px 28px}
  #mpSheet .line{display:flex;justify-content:space-between;align-items:center;padding:14px 6px}
}
/* –Ω–µ–±–æ–ª—å—à–æ–π —Ñ–∏–∫—Å: —É–±–∏—Ä–∞–µ–º ‚Äú–Ω–∞—Å–ª–æ–µ–Ω–∏–µ‚Äù —Å—Ç–∞—Ä–æ–≥–æ –ø—Ä–æ—Ñ–∏–ª—è, –∫–æ–≥–¥–∞ –∞–∫—Ç–∏–≤–µ–Ω –Ω–æ–≤—ã–π */
body.m-profile [data-profile-root] { display:none !important; }
</style>

<style>
/* –∫–æ–º–ø–∞–∫—Ç–Ω–∞—è –º–æ–±–∏–ª—å–Ω–∞—è —Å–µ—Ç–∫–∞ */
@media (max-width: 860px){
  .cards,#cards { display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
  .card-item{ background:#fff; border:1px solid var(--border); border-radius:16px; overflow:hidden; }
  .card-item .media{ width:100%; aspect-ratio:4/3; object-fit:cover; display:block; }
  .card-item .body{ padding:10px; }
  .card-item .title{ font-size:14px; font-weight:700; line-height:1.25;
    display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden; min-height:34px; }
  .card-item .price{ font-size:16px; font-weight:800; color:#ef4444; }
}

/* —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–µ –º–æ–¥–∞–ª–∫–∏ */
.modal{ position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,.45); z-index:4000; padding:16px; }
.modal .sheet{ background:#fff; color:var(--text); border-radius:16px; padding:16px; max-width:640px; width:100%; }
:root[data-theme="dark"] .modal .sheet{ background:var(--card); color:var(--text); }
</style>
<!-- ===== PROFILE CLEAN RESTORE ===== -->
<style>
:root {
  --bg: #fafafa;
  --text: #111;
  --muted: #6b7280;
  --border: #e5e7eb;
  --card: #fff;
  --brand: #7c3aed;
  --brand-hover: #6d28d9;
  --brand-press: #5b21b6;
  --text-on-brand: #fff;
}

body {
  background: var(--bg);
  color: var(--text);
  font-family: system-ui, sans-serif;
}

.card {
  background: var(--card);
  color: var(--text);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 16px;
  box-shadow: 0 2px 10px rgba(0,0,0,.05);
}

.row { display:flex; align-items:center; }
.muted { color: var(--muted); }

.btn, .btn-ghost {
  border: none;
  cursor: pointer;
  font-weight: 600;
  padding: 8px 14px;
  border-radius: 8px;
  transition: background .2s;
}
.btn {
  background: var(--brand);
  color: var(--text-on-brand);
}
.btn:hover { background: var(--brand-hover); }
.btn:active { background: var(--brand-press); }

.btn-ghost {
  background: #f2f2f2;
  color: var(--text);
}
.btn-ghost:hover { background: #e5e5e5; }

.chip {
  border: 1px solid var(--border);
  border-radius: 20px;
  padding: 6px 12px;
  cursor: pointer;
  user-select:none;
}
.chip input { margin-right:6px; }

.me-avatar {
  width:64px; height:64px; border-radius:50%; object-fit:cover;
  border:2px solid var(--border);
}

.grid {
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:16px;
  margin-top:16px;
}
@media(max-width:700px){ .grid{grid-template-columns:1fr;} }

.agree-row{
  display:flex;
  align-items:flex-start;
  gap:8px;
  font-size:12px;
  color:var(--muted);
  margin:8px 0 0;
}
.agree-row input[type="checkbox"]{
  margin-top:2px;
}


</style>
</head>
<!-- Mobile Tabs -->
<nav id="mobileTabs" class="m-tabs" aria-label="–ù–∞–≤–∏–≥–∞—Ü–∏—è">
  <a href="#" class="m-tab active" data-tab="catalog" aria-label="–ö–∞—Ç–∞–ª–æ–≥">
    <svg viewBox="0 0 24 24" fill="currentColor"><path d="M3 4h18v2H3zM3 10h18v2H3zM3 16h18v2H3z"/></svg>
    <span>–ü–æ–∏—Å–∫</span>
  </a>
  <a href="#" class="m-tab" data-tab="sell" aria-label="–ü—Ä–æ–¥–∞—Ç—å">
    <svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 5v14m-7-7h14" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
    <span>–ü—Ä–æ–¥–∞—Ç—å</span>
  </a>
  <a href="#" class="m-tab" data-tab="orders" aria-label="–°–¥–µ–ª–∫–∏">
    <svg viewBox="0 0 24 24" fill="currentColor"><path d="M7 7h14v2H7zM7 11h14v2H7zM7 15h10v2H7zM3 7h2v2H3zM3 11h2v2H3zM3 15h2v2H3z"/></svg>
    <span>–°–¥–µ–ª–∫–∏</span>
  </a>
  <a href="#" class="m-tab" data-tab="chat" aria-label="–ß–∞—Ç—ã">
    <svg viewBox="0 0 24 24" fill="currentColor"><path d="M4 4h16v12H7l-3 3V4z"/></svg>
    <span>–ß–∞—Ç—ã</span>
  </a>
  <a href="#" class="m-tab" data-tab="admin" aria-label="–ê–¥–º–∏–Ω">
    <svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 2l4 4-4 4-4-4 4-4zm8 10v10H4V12h16z"/></svg>
    <span>–ê–¥–º–∏–Ω</span>
  </a>
  <a href="#" class="m-tab" data-tab="auth" aria-label="–ü—Ä–æ—Ñ–∏–ª—å">
    <svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 12a4 4 0 100-8 4 4 0 000 8zm0 2c-4.4 0-8 2-8 4.5V22h16v-3.5C20 16 16.4 14 12 14z"/></svg>
    <span>–ü—Ä–æ—Ñ–∏–ª—å</span>
  </a>
</nav>

<!-- Mobile Profile: full rebuild (v1) -->
<!-- OM mobile UX pack v2: profile, cards, chat -->

<body>
<div class="om-bg"></div>
<div class="om-grain"></div>

<header>
  <div class="logo" onclick="openTab('catalog')" title="–ù–∞ –≥–ª–∞–≤–Ω—É—é">
    <div class="logo-badge">OM</div>
    <div>
      Only Market
      <small>–±—ã—Å—Ç—Ä–æ ¬∑ –ø–æ–Ω—è—Ç–Ω–æ ¬∑ –±–µ–∑–æ–ø–∞—Å–Ω–æ</small>
    </div>
  </div>

  <div class="h-search" role="search" aria-label="–ü–æ–∏—Å–∫">
    <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
      <path d="M21 21l-4.3-4.3m1.8-5.2a7 7 0 11-14 0 7 7 0 0114 0z" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
    </svg>
    <input id="headerSearch" placeholder="–ü–æ–∏—Å–∫: —Ç–æ–≤–∞—Ä—ã ¬∑ ID ¬∑ –ø—Ä–æ–¥–∞–≤—Ü—ã‚Ä¶" autocomplete="off" />
    <button class="x" type="button" aria-label="–û—á–∏—Å—Ç–∏—Ç—å" onclick="(function(){var i=document.getElementById('headerSearch'); if(i){i.value=''; i.dispatchEvent(new Event('input')); i.focus();}})()">‚úï</button>
  </div>

  <div class="topnav" id="topnav" aria-label="–ù–∞–≤–∏–≥–∞—Ü–∏—è">
    <div class="tab active" id="tabCatalog" onclick="openTab('catalog')">–ö–∞—Ç–∞–ª–æ–≥</div>
    <div class="tab" id="tabSell" onclick="openTab('sell')">–ü—Ä–æ–¥–∞—Ç—å</div>
    <div class="tab" id="tabOrders" onclick="openTab('orders')">–°–¥–µ–ª–∫–∏</div>
    <div class="tab" id="tabChat" onclick="openTab('chat')">–ß–∞—Ç—ã</div>
    <div class="tab" id="tabAdmin" style="display:none" onclick="openTab('admin')">–ê–¥–º–∏–Ω</div>
    <div class="tab" id="tabAuth" onclick="openTab('auth')">–ü—Ä–æ—Ñ–∏–ª—å</div>
  </div>

  <div class="userbar">
    <button class="icon-btn" type="button" id="themeBtn" title="–¢–µ–º–∞">‚óê</button>
    <button class="icon-btn" type="button" onclick="openSettings()" title="–ù–∞—Å—Ç—Ä–æ–π–∫–∏">‚öô</button>

    <span id="userInfo" class="muted">–ì–æ—Å—Ç—å</span>
    <button class="btn" id="loginBtn" onclick="goAuth()">–í–æ–π—Ç–∏</button>
    <button class="btn" id="logoutBtn" style="display:none" onclick="logout()">–í—ã–π—Ç–∏</button>
  </div>
</header>

<div class="wrap">
 <main class="main">
 <!-- Catalog -->
 <section id="screen-catalog">
 <div class="row" style="margin-bottom:10px">
 <input id="search" placeholder="–ü–æ–∏—Å–∫‚Ä¶">
 <button class="btn" onclick="loadCatalog()">–û–±–Ω–æ–≤–∏—Ç—å</button>

 </div>
 <div id="catChips" class="chips"></div>

 <div id="cards" class="grid"></div>
 </section>

 <!-- Sell (Wizard) -->
 <section id="screen-sell" style="display:none">
 <div class="wizard">
 <aside class="wizard-steps">
 <div class="st active" data-step="1" onclick="wizGo(1)">1. –ö–∞—Ç–µ–≥–æ—Ä–∏—è</div>
 <div class="st" data-step="2" onclick="wizGo(2)">2. –ü–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏—è</div>
 <div class="st" data-step="3" onclick="wizGo(3)">3. –ù–∞–∑–≤–∞–Ω–∏–µ/–æ–ø–∏—Å–∞–Ω–∏–µ/—Ñ–æ—Ç–æ</div>
 <div class="st" data-step="4" onclick="wizGo(4)">4. –î–∞–Ω–Ω—ã–µ —Ç–æ–≤–∞—Ä–∞</div>
 <div class="st" data-step="5" onclick="wizGo(5)">5. VIP-—Å—Ç–∞—Ç—É—Å</div>
 <div class="st" data-step="6" onclick="wizGo(6)">6. –ü—É–±–ª–∏–∫–∞—Ü–∏—è</div>
 </aside>
 <div class="wizard-pane">
 <!-- step 1 -->
 <div id="wiz1">
 <h3>–®–∞–≥ 1: –ö–∞—Ç–µ–≥–æ—Ä–∏—è –∏ –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏—è (–≤ –æ–¥–Ω–æ–º –º–µ—Å—Ç–µ)</h3>
 <div class="muted">–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏—é —Å–ª–µ–≤–∞, –ø–æ—Ç–æ–º –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏—é —Å–ø—Ä–∞–≤–∞.</div>
 <div class="wiz-cat-grid" style="margin-top:12px">
   <div class="wiz-col">
     <h4>–ö–∞—Ç–µ–≥–æ—Ä–∏–∏</h4>
     <div id="wizCats" class="wiz-list"></div>
   </div>
   <div class="wiz-col">
     <h4>–ü–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏–∏</h4>
     <div id="wizSubs" class="wiz-list"><div class="muted">–í—ã–±–µ—Ä–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏—é</div></div>
   </div>
 </div>
</div>
 <!-- step 2 -->
 <div id="wiz2" style="display:none">
 <h3>–ü–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏—è</h3>
 <div class="muted">–ü–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏—è –≤—ã–±–∏—Ä–∞–µ—Ç—Å—è –Ω–∞ —à–∞–≥–µ 1.</div>
 <div class="row row-right" style="margin-top:10px">
  <button class="btn-ghost" onclick="wizBack()">–ù–∞–∑–∞–¥</button>
  <button class="btn" onclick="wizGo(3)">–î–∞–ª–µ–µ</button>
 </div>
</div>
<!-- step 3 -->
 <div id="wiz3" style="display:none">
 <h3>–®–∞–≥ 3: –ù–∞–∑–≤–∞–Ω–∏–µ, –æ–ø–∏—Å–∞–Ω–∏–µ –∏ —Ñ–æ—Ç–æ</h3>
 <input id="sellTitle" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ">
 <textarea id="sellDesc" rows="3" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ"></textarea>
 <div class="row-split">
 <input id="sellPrice" type="number" step="0.01" placeholder="–¶–µ–Ω–∞, RUB">
 <input id="sellImage" type="file" accept="image/*">
 </div>
 <div id="imgInfo" class="muted">JPEG/PNG ‚Äî –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∂–º—ë–º –¥–æ ‚â§ 50KB</div>
 <div class="row row-right" style="margin-top:10px">
 <button class="btn-ghost" onclick="wizBack()">–ù–∞–∑–∞–¥</button>
 <button class="btn" onclick="wizNext()">–î–∞–ª–µ–µ</button>
 </div>
 </div>
 <!-- step 4 -->
<div id="wiz4" style="display:none">
 <h3>–®–∞–≥ 4: –î–∞–Ω–Ω—ã–µ —Ç–æ–≤–∞—Ä–∞</h3>

<!--  <input id="sellData1" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –∫–ª—é—á/–ª–æ–≥–∏–Ω/—Å—Å—ã–ª–∫–∞... (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)"> -->
 <textarea id="sellData2" rows="3" placeholder="–î–æ–ø. —Å–≤–µ–¥–µ–Ω–∏—è –¥–ª—è –ø–æ–∫—É–ø–∞—Ç–µ–ª—è (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)"></textarea>

 <!-- –¢–∏–ø –∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ -->
 <div class="row" style="gap:10px; margin-top:10px">
 <div style="flex:1">
 <label class="muted">–¢–∏–ø —Ç–æ–≤–∞—Ä–∞</label>
 <select id="sellType">
 <option value="single">–û–¥–Ω–æ—Ä–∞–∑–æ–≤—ã–π (1 –ø—Ä–æ–¥–∞–∂–∞)</option>
 <option value="multi">–ú–Ω–æ–≥–æ—Ä–∞–∑–æ–≤—ã–π (–±–µ–∑ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π)</option>
 <option value="stock">–ü–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É</option>
 </select>
 </div>
 <div style="flex:1">
 <label class="muted">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ (–¥–ª—è ¬´–ø–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É¬ª)</label>
 <input id="sellStock" type="number" min="0" step="1" placeholder="–ù–∞–ø—Ä. 10">
 </div>
 </div>

 <div class="row row-right" style="margin-top:10px">
 <button class="btn-ghost" onclick="wizBack()">–ù–∞–∑–∞–¥</button>
 <button class="btn" onclick="wizNext()">–î–∞–ª–µ–µ</button>
 </div>
<!-- –í—ã–¥–∞—á–∞ —Ç–æ–≤–∞—Ä–∞ (–¥–æ–±–∞–≤–ª—è–µ–º –æ–¥–∏–Ω —Ä–∞–∑ –≤ wiz4) -->
<div class="row" style="gap:10px; margin-top:10px">
 <div class="card" style="flex:1">
 <h4>–í—ã–¥–∞—á–∞ —Ç–æ–≤–∞—Ä–∞</h4>
 <label><input type="radio" name="deliveryType" value="manual" checked> –†—É—á–Ω–∞—è –≤—ã–¥–∞—á–∞</label><br>
 <label><input type="radio" name="deliveryType" value="auto"> –ê–≤—Ç–æ–≤—ã–¥–∞—á–∞ (—Å –º–æ–¥–µ—Ä–∞—Ü–∏–µ–π)</label>
 <div class="muted" style="margin-top:6px">
      –ü—Ä–∏ –∞–≤—Ç–æ–≤—ã–¥–∞—á–µ –ø–æ–∫—É–ø–∞—Ç–µ–ª—å —Å—Ä–∞–∑—É –ø–æ–ª—É—á–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –ø–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã.
      –¢–æ–≤–∞—Ä –ø—É–±–ª–∏–∫—É–µ—Ç—Å—è —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º ¬´–Ω–∞ –º–æ–¥–µ—Ä–∞—Ü–∏–∏¬ª –¥–æ –æ–¥–æ–±—Ä–µ–Ω–∏—è –∞–¥–º–∏–Ω–æ–º.
 </div>
 </div>
 <div class="card" style="flex:1">
 <h4>–î–∞–Ω–Ω—ã–µ –¥–ª—è –∞–≤—Ç–æ–≤—ã–¥–∞—á–∏</h4>
 <textarea id="autoPayload" rows="4" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –∫–ª—é—á/–ª–æ–≥–∏–Ω:–ø–∞—Ä–æ–ª—å/—Å—Å—ã–ª–∫–∞ ‚Äî —Ç–æ, —á—Ç–æ –ø–æ–∫—É–ø–∞—Ç–µ–ª—å –¥–æ–ª–∂–µ–Ω –ø–æ–ª—É—á–∏—Ç—å —Å—Ä–∞–∑—É"></textarea>
 </div>
</div>

</div>

 <!-- step 5 -->
 <div id="wiz5" style="display:none">
 <h3>–®–∞–≥ 5: VIP-—Å—Ç–∞—Ç—É—Å</h3>
 <p class="muted">VIP –∑–∞ <b>15 ‚ÇΩ</b> (—Å–ø–∏—à–µ—Ç—Å—è —Å –±–∞–ª–∞–Ω—Å–∞) –ø–æ–¥–Ω–∏–º–∞–µ—Ç —Ç–æ–≤–∞—Ä –Ω–∞ –ø–µ—Ä–≤–æ–µ –º–µ—Å—Ç–æ –≤ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏.</p>
 <div class="row">
 <label><input type="checkbox" id="vipFlag"> –•–æ—á—É VIP-—Ä–∞–∑–º–µ—â–µ–Ω–∏–µ</label>
 </div>
 <div class="row row-right" style="margin-top:10px">
 <button class="btn-ghost" onclick="wizBack()">–ù–∞–∑–∞–¥</button>
 <button class="btn" onclick="wizNext()">–î–∞–ª–µ–µ</button>
 </div>
 </div>
 <!-- step 6 -->
 <div id="wiz6" style="display:none">
 <h3>–®–∞–≥ 6: –ü—É–±–ª–∏–∫–∞—Ü–∏—è</h3>
 <p class="muted">–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –≤—Å—ë –∏ –æ–ø—É–±–ª–∏–∫—É–π—Ç–µ.</p>
 <div id="publishPreview" class="card" style="margin-bottom:10px"></div>
 <div class="row row-right">
 <button class="btn-ghost" onclick="wizBack()">–ù–∞–∑–∞–¥</button>
 <button class="btn" onclick="createListing()">–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å</button>
 </div>
 </div>
 </div>
 </div>
 </section>

 <!-- Orders -->
<section id="screen-orders" style="display:none">
 <div class="card">
 <h3>–ú–æ–∏ —Å–¥–µ–ª–∫–∏</h3>
 <div class="row" style="gap:8px;margin-bottom:8px">
 <input id="ordersSearch" placeholder="–ü–æ–∏—Å–∫ –ø–æ ID, –Ω–∞–∑–≤–∞–Ω–∏—é, –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é‚Ä¶">
 <button class="btn" onclick="loadOrders()">–ù–∞–π—Ç–∏</button>
 </div>
 <div id="ordersBox" class="muted">–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</div>
 </div>
</section>

 <!-- Chat -->
 <section id="screen-chat" style="display:none">
 <div class="chatWrap">
 <div class="chatList">
 <div class="row" style="gap:6px;padding:6px">
 <button class="btn" onclick="loadInbox()">–û–±–Ω–æ–≤–∏—Ç—å</button>
 <button class="btn" onclick="openRoom('global')">–û–±—â–∏–π</button>
 <button class="btn" onclick="openSupport()">–ü–æ–¥–¥–µ—Ä–∂–∫–∞</button>
 </div>
 <div id="chatListBox"></div>
 </div>
 <div class="chatView">
 <div class="row" style="justify-content:space-between">
 <div><b id="roomTitle">–ö–æ–º–Ω–∞—Ç–∞ –Ω–µ –≤—ã–±—Ä–∞–Ω–∞</b></div>
 <div id="dealActions" class="dealBtns"></div>
 </div>
 <div id="chatBox" class="chatBox"></div>
 <div class="row chat-tools" style="margin-top:6px">
 <input id="chatInput" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ">
 <input type="file" id="chatFile" accept="image/*" multiple style="max-width:220px">
 <button class="btn" onclick="sendChat()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
 <button class="btn-ghost" onclick="report()">–°–æ–æ–±—â–∏—Ç—å –∞–¥–º–∏–Ω–∞–º</button>
 <small id="chatPhotoHint">–§–æ—Ç–æ: –¥–æ 5 –Ω–∞ —Å–¥–µ–ª–∫—É, ‚â§ 30KB –∫–∞–∂–¥–æ–µ</small>
 </div>
 <div id="supportTasks" style="display:none;margin-top:8px" class="muted"></div>
 </div>
 </div>
 </section>

 <!-- Admin -->
 <section id="screen-admin" style="display:none">
 <div class="grid" style="grid-template-columns:1fr 1fr">
 <div class="card">
 <h3>–ö–æ–º–∏—Å—Å–∏—è</h3>
 <div class="row">
 <input id="feeInput" type="number" step="0.1" placeholder="8 (–≤ %)"><button class="btn" onclick="saveFee()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
 </div>
 <div id="feeView" class="muted">–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</div>
 </div>

 <div class="card">
 <h3>–ö–∞—Ç–µ–≥–æ—Ä–∏–∏</h3>
 <div class="row"><input id="catTitle" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ"><button class="btn" onclick="catAdd()">–î–æ–±–∞–≤–∏—Ç—å</button></div>
 <div class="row" style="gap:6px;margin-top:6px">
 <input id="catParent" placeholder="parentId (–Ω–µ–æ–±—è–∑.)">
 <input id="catOrder" type="number" step="1" placeholder="order">
 </div>
 <div id="catsAdmin" class="muted" style="margin-top:8px"></div>
 </div>

 <div class="card">
 <h3>–†–æ–ª–∏ / –ë–∞–Ω</h3>
 <input id="roleUserId" placeholder="userId (u_xxx)">
 <div class="row">
 <select id="roleAction">
 <option value="add:admin">–í—ã–¥–∞—Ç—å ADMIN</option>
 <option value="remove:admin">–°–Ω—è—Ç—å ADMIN</option>
 <option value="add:support">–í—ã–¥–∞—Ç—å SUPPORT</option>
 <option value="remove:support">–°–Ω—è—Ç—å SUPPORT</option>
 <option value="add:verified">–í—ã–¥–∞—Ç—å VERIFIED</option>
 <option value="remove:verified">–°–Ω—è—Ç—å VERIFIED</option>
 </select>
 </div>
 <div class="row">
 <button class="btn" onclick="applyRole()">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
 <button class="btn-ghost" onclick="banUser()">BAN</button>
 <button class="btn-ghost" onclick="unbanUser()">UNBAN</button>
 </div>
 </div>

 <div class="card">
 <h3>–ë–∞–ª–∞–Ω—Å (–Ω–∞—á–∏—Å–ª–∏—Ç—å/—Å–ø–∏—Å–∞—Ç—å)</h3>
 <input id="balUserId" placeholder="userId (u_xxx)">
 <input id="balAmount" type="number" step="0.01" placeholder="–°—É–º–º–∞ (+/-)">
 <input id="balReason" placeholder="–ü—Ä–∏—á–∏–Ω–∞">
 <button class="btn" onclick="adjustBalance()">–ü—Ä–æ–≤–µ—Å—Ç–∏</button>
 <div class="muted" id="balResult"></div>
 </div>

 <div class="card" id="supportDesk" style="grid-column:1/2;display:none">
 <h3>–ó–∞–¥–∞—á–∏ –ø–æ–¥–¥–µ—Ä–∂–∫–∏</h3>
 <div class="row" style="gap:6px"><button class="btn" onclick="loadTasks()">–û–±–Ω–æ–≤–∏—Ç—å</button></div>
 <div id="tasksBox" class="muted"></div>
 </div>

 <div class="card" style="grid-column:2/3">
 <h3>–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Å–¥–µ–ª–∫–µ –ø–æ ID</h3>
 <div class="row-split">
 <input id="adminDealId" placeholder="o_xxx">
 <select id="adminDealRole">
 <option value="buyer">–ö–∞–∫ –ø–æ–∫—É–ø–∞—Ç–µ–ª—å</option>
 <option value="seller">–ö–∞–∫ –ø—Ä–æ–¥–∞–≤–µ—Ü</option>
 </select>
 </div>
 <div class="row" style="margin-top:8px">
 <button class="btn" onclick="adminJoinDeal()">–û—Ç–∫—Ä—ã—Ç—å —á–∞—Ç —Å–¥–µ–ª–∫–∏</button>
 <button class="btn-ghost" onclick="adminPayDeal()">–û–ø–ª–∞—Ç–∏—Ç—å</button>
 <button class="btn-ghost" onclick="adminRefundDeal()">–û—Ñ–æ—Ä–º–∏—Ç—å –≤–æ–∑–≤—Ä–∞—Ç</button>
 </div>
 <div class="muted" id="adminDealHint">* –î–ª—è –æ–ø–ª–∞—Ç—ã/–≤–æ–∑–≤—Ä–∞—Ç–∞ –Ω—É–∂–Ω—ã –ø—Ä–∞–≤–∞ –∏ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω—ã–π –±–∞–ª–∞–Ω—Å.</div>
 </div>
<div class="card" style="margin-top:10px">
 <h3>–ú–æ–¥–µ—Ä–∞—Ü–∏—è –∞–≤—Ç–æ—Ç–æ–≤–∞—Ä–æ–≤</h3>
 <div id="modQueueBox" class="muted">–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</div>
</div>

 <div class="card" style="grid-column:1/3">
 <h3>–ó–≤—É–∫ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π</h3>
 <div class="row">
 <input id="soundUrl" placeholder="URL –∞—É–¥–∏–æ (mp3/ogg)">
 <button class="btn" onclick="saveNotifySound()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
 </div>
 <div class="muted">–ü—Ä–∏ —Å–∏—Å—Ç–µ–º–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏—è—Ö –∑–≤—É–∫ –±—É–¥–µ—Ç –≤–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç—å—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.</div>
 </div>

 </div>
 </section>



 <!-- Auth / Profile -->
<section id="screen-auth" style="display:none">

 <!-- –í—Ö–æ–¥ -->
 <div id="loginBox" class="card">
 <h3>–í—Ö–æ–¥</h3>
 <input id="loginEmail" type="email" placeholder="you@example.com">
 <input id="loginPass" type="password" placeholder="–ü–∞—Ä–æ–ª—å">
 <button class="btn" onclick="login()">–í–æ–π—Ç–∏</button>
 <div class="muted" style="margin-top:10px">–ò–ª–∏ –≤–æ–π–¥–∏—Ç–µ —á–µ—Ä–µ–∑</div>
 <div id="g_id_onload"
 data-client_id="–¢–í–û–ô_GOOGLE_CLIENT_ID"
 data-callback="onGoogleCredential"
 data-auto_prompt="false"></div>
 <div class="g_id_signin"
 data-type="standard"
 data-size="large"
 data-theme="outline"
 data-text="continue_with"
 data-shape="rectangular"
 data-logo_alignment="left"></div>

 <div class="muted" style="margin-top:10px">
      –ù–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞?
 <a href="#" onclick="showRegister()">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Ç–µ—Å—å</a>
 </div>
 </div>

 <!-- –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è -->
<div id="registerBox" class="card" style="display:none">
 <h3>–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h3>
 <input id="regEmail" type="email" placeholder="you@example.com">
 <input id="regPass" type="password" placeholder="–ü–∞—Ä–æ–ª—å">
 <input id="regNick" placeholder="–ù–∏–∫–Ω–µ–π–º">

 <label class="agree-row">
 <input type="checkbox" id="regAgree">
 <span>
      –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É—è—Å—å, —è —Å–æ–≥–ª–∞—à–∞—é—Å—å —Å —É—Å–ª–æ–≤–∏—è–º–∏
 <a href="/public-offer.html" target="_blank">–ü—É–±–ª–∏—á–Ω–æ–π –æ—Ñ–µ—Ä—Ç—ã</a>
      –∏ –¥–∞—é —Å–æ–≥–ª–∞—Å–∏–µ –Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫—É –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö.
 </span>
 </label>

 <button class="btn" onclick="register()">–°–æ–∑–¥–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç</button>
 <div class="muted" style="margin-top:10px">
      –£–∂–µ –µ—Å—Ç—å –∞–∫–∫–∞—É–Ω—Ç?
 <a href="#" onclick="showLogin()">–í–æ–π–¥–∏—Ç–µ</a>
 </div>
 </div>

<div class="grid">
 <!-- –ü—Ä–æ—Ñ–∏–ª—å -->
 <div class="card">
 <h3>–ü—Ä–æ—Ñ–∏–ª—å</h3>
 <div class="row" style="align-items:center; gap:10px; margin-bottom:8px">
 <img id="meAvatar" class="me-avatar"
 src="https://i.ibb.co/Y4HVSvPV/Group-1-2.png" alt="">
 <input id="meAvatarFile" type="file" accept="image/*" style="max-width:220px">
 <button class="btn-ghost" onclick="uploadAvatar()">–ò–∑–º–µ–Ω–∏—Ç—å</button>
 </div>
 <div id="meBox" class="muted">–í–æ–π–¥–∏—Ç–µ, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –ø—Ä–æ—Ñ–∏–ª—å</div>

 <div id="tgBox" class="sellerCard" style="margin-top:10px">
 <div class="sellerName">–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤ Telegram</div>
 <div id="tgStatus" class="muted">‚Äî</div>
 <div id="tgCode" class="badge" style="display:none; margin-top:6px"></div>

 <div class="row" style="gap:8px; margin-top:8px">
 <button class="btn" onclick="tgRequestCode()">–ü–æ–ª—É—á–∏—Ç—å –∫–æ–¥</button>
 <button class="btn-ghost" onclick="tgToggle()">–í–∫–ª/–í—ã–∫–ª —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</button>
 </div>
 <div class="muted" style="margin-top:6px">
        –û—Ç–∫—Ä–æ–π—Ç–µ –Ω–∞—à–µ–≥–æ –±–æ—Ç–∞ –≤ Telegram (@onlymarket_marketplace_bot)
        –∏ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –µ–º—É —ç—Ç–æ—Ç –∫–æ–¥. –ü–æ—Å–ª–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –≤–∫–ª—é—á–∏—Ç–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è.
 </div>
 </div>

 <div id="reviewsBox" class="muted" style="margin-top:8px"></div>
 </div>

 <!-- –ë–∞–ª–∞–Ω—Å -->
 <div class="card">
 <h3>–ë–∞–ª–∞–Ω—Å</h3>
 <div id="walletBox" class="muted">‚Äî</div>
 <div class="row" style="margin-top:8px; gap:8px;">
<button class="btn" onclick="openParadiseTopup()">–ü–æ–ø–æ–ª–Ω–∏—Ç—å</button>

 <button class="btn-ghost" onclick="withdrawReq()">–í—ã–≤–µ—Å—Ç–∏</button>
 </div>
 </div>

 <!-- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ -->

 <!-- –ú–æ–∏ —Ç–æ–≤–∞—Ä—ã -->
 <div class="card" style="grid-column:1/3">
 <h3>–ú–æ–∏ —Ç–æ–≤–∞—Ä—ã</h3>
 <div id="myListingsBox" class="muted">–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</div>
 </div>
</div>
<!-- ===== END PROFILE CLEAN RESTORE ===== -->
</div>
<!-- Bottom nav -->
<div class="bottom-nav">
 <div class="tabs">
 <div class="tab" onclick="openTab('catalog')">–ö–∞—Ç–∞–ª–æ–≥</div>
 <div class="tab" onclick="openTab('sell')">–ü—Ä–æ–¥–∞—Ç—å</div>
 <div class="tab" onclick="openTab('orders')">–°–¥–µ–ª–∫–∏</div>
 <div class="tab" onclick="openTab('chat')">–ß–∞—Ç—ã</div>
 <div class="tab" id="bnAdmin" style="display:none" onclick="openTab('admin')">–ê–¥–º–∏–Ω</div>
 <div class="tab" onclick="openTab('auth')">–ê–∫–∫–∞—É–Ω—Ç</div>
 </div>
</div>

<!-- Pay Wait Modal -->
<div id="payModal" class="modal" aria-hidden="true" style="display:none">
 <div class="sheet" style="max-width:520px;text-align:center">
 <h2 style="margin:0 0 6px">–í –æ–∂–∏–¥–∞–Ω–∏–∏ –æ–ø–ª–∞—Ç—ã</h2>
 <p class="muted">–°—Ç—Ä–∞–Ω–∏—Ü–∞ –æ–ø–ª–∞—Ç—ã –æ—Ç–∫—Ä—ã–ª–∞—Å—å –≤ –Ω–æ–≤–æ–º –æ–∫–Ω–µ. –ó–∞–≤–µ—Ä—à–∏ –æ–ø–ª–∞—Ç—É –∏ –Ω–∞–∂–º–∏ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ.</p>
 <div class="row" style="justify-content:center;margin-top:10px">
 <button class="btn" id="payIPaidBtn" onclick="rkIPaid()" disabled>–Ø –æ–ø–ª–∞—Ç–∏–ª (15—Å)</button>
 <button class="btn-ghost" onclick="closePayModal()">–û—Ç–º–µ–Ω–∞</button>
 </div>
 <div id="rkStatusModal" class="muted" style="margin-top:6px"></div>
 </div>
</div>



<!-- Bottom nav -->
<div class="bottom-nav">
 <div class="tabs">
 <div class="tab" onclick="openTab('catalog')">–ö–∞—Ç–∞–ª–æ–≥</div>
 <div class="tab" onclick="openTab('sell')">–ü—Ä–æ–¥–∞—Ç—å</div>
 <div class="tab" onclick="openTab('orders')">–°–¥–µ–ª–∫–∏</div>
 <div class="tab" onclick="openTab('chat')">–ß–∞—Ç—ã</div>
 <div class="tab" id="bnAdmin" style="display:none" onclick="openTab('admin')">–ê–¥–º–∏–Ω</div>
 <div class="tab" onclick="openTab('auth')">–ê–∫–∫–∞—É–Ω—Ç</div>
 </div>
</div>

<!-- Modal —Ç–æ–≤–∞—Ä–∞ -->
<div id="tgMigrateModal" class="modal" aria-hidden="true">
 <div class="sheet" style="max-width:620px">
 <div class="row" style="align-items:center; gap:12px">
 <img src="https://i.ibb.co/B5DCDMQk/telegram-256.png" alt="Telegram" style="width:48px;height:48px">
 <h2 style="margin:0">–ü–µ—Ä–µ–µ–∑–∂–∞–µ–º –≤ Telegram</h2>
 </div>
 <p class="muted" style="margin-top:6px; white-space:pre-wrap">
–ú—ã –ø–æ–ª–Ω–æ—Å—Ç—å—é –æ—Ç–∫–∞–∑–∞–ª–∏—Å—å –æ—Ç e-mail –∫–æ–¥–æ–≤ –≤—Ö–æ–¥–∞ –∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π.
–¢–µ–ø–µ—Ä—å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –≤—Ö–æ–¥–∞ –∏ –≤—Å–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø—Ä–∏—Ö–æ–¥—è—Ç –≤ Telegram.

–ß—Ç–æ–±—ã –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è Only Market:
1) –ù–∞–∂–º–∏—Ç–µ ¬´–ü–æ–ª—É—á–∏—Ç—å –∫–æ–¥ –ø—Ä–∏–≤—è–∑–∫–∏¬ª.
2) –û—Ç–∫—Ä–æ–π—Ç–µ –Ω–∞—à–µ–≥–æ –±–æ—Ç–∞ –≤ Telegram –∏ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –µ–º—É —ç—Ç–æ—Ç –∫–æ–¥.
3) –í–µ—Ä–Ω–∏—Ç–µ—Å—å —Å—é–¥–∞ –∏ –Ω–∞–∂–º–∏—Ç–µ ¬´–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å¬ª, –ø–æ—Å–ª–µ —á–µ–≥–æ –º—ã –ø—Ä–∏—à–ª—ë–º –∫–æ–¥ –¥–ª—è –≤—Ö–æ–¥–∞ –≤ Telegram.
 </p>

 <div class="card" style="margin:10px 0">
 <div id="tgMigrateCode" class="badge">–ö–æ–¥: ‚Äî</div>
 <div class="muted" id="tgMigrateBot">@onlymarket_marketplace_bot</div>
 </div>

 <div class="row" style="gap:8px">
 <button class="btn" onclick="tgGetLinkCode()">–ü–æ–ª—É—á–∏—Ç—å –∫–æ–¥ –ø—Ä–∏–≤—è–∑–∫–∏</button>
 <button class="btn-ghost" onclick="tgMigrateContinue()">–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å</button>
 <button class="btn-ghost" onclick="closeTgMigrate()">–ó–∞–∫—Ä—ã—Ç—å</button>
 </div>
 </div>
</div>

<!-- Toasts + Confirm -->
<div id="toastRoot" class="toast-wrap"></div>
<div id="confirmRoot" class="modal confirm" aria-hidden="true">
 <div class="panel">
 <h3 id="confirmTitle">–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ</h3>
 <p id="confirmText">–í—ã —É–≤–µ—Ä–µ–Ω—ã?</p>
 <div id="promptSlot" style="display:none;margin-bottom:10px">
 <input id="promptInput" placeholder="">
 </div>
 <div class="actions">
 <button class="btn-ghost" id="btnCancel">–û—Ç–º–µ–Ω–∞</button>
 <button class="btn" id="btnOk">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å</button>
 </div>
 </div>
</div>
<!-- Reviews Modal -->
<div id="reviewsModal" class="modal" aria-hidden="true">
 <div class="sheet" style="max-width:720px">
 <div class="row" style="justify-content:space-between;align-items:center">
 <h3 id="rvTitle">–û—Ç–∑—ã–≤—ã</h3>
 <button class="btn" onclick="closeReviewsModal()">–ó–∞–∫—Ä—ã—Ç—å</button>
 </div>
 <div id="rvList"></div>
 <div id="rvPager"></div>
 </div>
</div>

<!-- Listing modal -->
<!-- Modal —Ç–æ–≤–∞—Ä–∞ -->
<div id="itemModal" class="modal" aria-hidden="true">
 <div class="sheet">
 <div class="row" style="justify-content:space-between">
 <h3 id="mTitle"></h3>
 <button class="btn" onclick="closeModal()">–ó–∞–∫—Ä—ã—Ç—å</button>
 </div>
 <div class="row" style="gap:16px; align-items:flex-start;flex-wrap:wrap">
 <img id="mImg" class="media" style="max-width:360px;height:220px">
 <div style="flex:1;min-width:260px">
 <div id="mPrice" class="badge"></div>
 <p id="mDesc" style="white-space:pre-wrap"></p>
 <div class="row" style="gap:8px">
 <button class="btn" id="mBuyBtn">–ö—É–ø–∏—Ç—å</button>
 <button class="btn-ghost" onclick="shareItem()">–ü–æ–¥–µ–ª–∏—Ç—å—Å—è</button>
 </div>
 <div class="share" id="mShare"></div>

 <div class="sellerCard" id="sellerCard" style="display:none">
 <div class="sellerName" id="sellerName"></div>
 <div class="stars" id="sellerStats">‚Äî</div>
 <div class="row" style="margin-top:6px">
 <button class="btn-ghost" id="dmSellerBtn">–ù–∞–ø–∏—Å–∞—Ç—å –ø—Ä–æ–¥–∞–≤—Ü—É</button>
 <button class="btn-ghost" id="viewSellerReviews">–û—Ç–∑—ã–≤—ã</button>
 </div>
 </div>
 </div>
 </div>
 </div>
</div>

<footer>
 <div>¬© Only Market ‚Ä¢ –í–æ–ø—Ä–æ—Å—ã ‚Äî –≤ —Ä–∞–∑–¥–µ–ª–µ ¬´–ü–æ–¥–¥–µ—Ä–∂–∫–∞¬ª.</div>
 <div>–ü—É–±–ª–∏—á–Ω–∞—è –æ—Ñ–µ—Ä—Ç–∞: <a href="https://docs.google.com/document/d/1u_x_tNmrSOI_j-PrRBCuZOLsJ-aYeEbvzrWLXcjAAH4/edit?usp=sharing" target="_blank" rel="noopener">—á–∏—Ç–∞—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç</a></div>
</footer>

<!-- Deposit modal -->
<div id="paradiseTopupModal" class="modal" style="display:none;">
 <div class="modal-content">
 <h2>–ü–æ–ø–æ–ª–Ω–∏—Ç—å –±–∞–ª–∞–Ω—Å</h2>

 <label>–°—É–º–º–∞ (‚ÇΩ)</label>
 <input id="ppAmount" type="number" min="50" step="10" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä, 500">

 <label style="margin-top:10px;">–°–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã</label>
 <select id="ppMethod">
 <option value="">–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏</option>
 <option value="sbp-card">–°–ë–ü ‚Üí –∫–∞—Ä—Ç–∞</option>
 <option value="sbp">–°–ë–ü</option>
 <option value="card">–ö–∞—Ä—Ç–∞</option>
 </select>

 <div id="ppStatus" class="muted" style="margin-top:10px;"></div>

 <div style="margin-top:12px; display:flex; gap:8px;">
 <button class="btn" onclick="ppCreate()">–û–ø–ª–∞—Ç–∏—Ç—å</button>
 <button class="btn-ghost" onclick="closeParadiseTopup()">–ó–∞–∫—Ä—ã—Ç—å</button>
 </div>
 </div>
</div>
<script>
  function openParadiseTopup() {
    const modal = document.getElementById('paradiseTopupModal');
    if (!modal) return;
    modal.style.display = 'flex';
    document.body.style.overflow = 'hidden';
  }

  function closeParadiseTopup() {
    const modal = document.getElementById('paradiseTopupModal');
    if (!modal) return;
    modal.style.display = 'none';
    document.body.style.overflow = '';
  }
</script>

<div class="modal" id="settingsModal" aria-hidden="true">
 <div class="sheet" style="max-width:520px">
 <div class="row" style="justify-content:space-between;align-items:center">
 <h3>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h3>
 <button class="icon-btn" onclick="closeSettings()">‚úï</button>
 </div>

 <!-- –°—é–¥–∞ –ø–µ—Ä–µ–Ω–æ—Å–∏—à—å —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —Å—Ç–∞—Ä–æ–π –∫–∞—Ä—Ç–æ—á–∫–∏ –ù–∞—Å—Ç—Ä–æ–π–∫–∏ -->
 <!-- —Ç–µ–º–∞, –∑–≤—É–∫ –∏ —Ç.–ø. -->
<script src="https://accounts.google.com/gsi/client" async defer></script>

 </div>
</div>

<script>
// ===== Deposit: –º—É–ª—å—Ç–∏-–ø—Ä–æ–≤–∞–π–¥–µ—Ä–Ω—ã–π –µ–¥–∏–Ω—ã–π UX =====
(function(){
  const M = {
    modal:  document.getElementById('depositModal'),
    providers: document.querySelectorAll('.dep-p'),
    amount: document.getElementById('depAmount'),
    curr:   document.getElementById('depCurrency'),
    hint:   document.getElementById('depHint'),
    status: document.getElementById('depStatus'),
    create: document.getElementById('depCreate'),
    close:  document.getElementById('depClose'),
    paid:   document.getElementById('depIPaid'),
  };
  const state = { provider:'rukassa', invoiceId:null, cooldown:0, t:null };

  const HINTS = {
    rukassa: '–ë–∞–Ω–∫–æ–≤—Å–∫–∏–µ –∫–∞—Ä—Ç—ã / –±—ã—Å—Ç—Ä—ã–µ –º–µ—Ç–æ–¥—ã. –ö–æ–º–∏—Å—Å–∏—è –ø–æ —Ç–∞—Ä–∏—Ñ—É RuKassa.',
    yookassa:'–ö–∞—Ä—Ç—ã/–°–ü–ë. –ö–æ–º–∏—Å—Å–∏—è –ø–æ —Ç–∞—Ä–∏—Ñ—É YooKassa.',
    crypto:  'USDT/ETH/BTC –ø–æ —Ç–µ–∫—É—â–µ–º—É –∫—É—Ä—Å—É. –ö–æ–º–∏—Å—Å–∏—è —Å–µ—Ç–∏ –æ–ø–ª–∞—á–∏–≤–∞–µ—Ç—Å—è –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª–µ–º.'
  };
  function pickProvider(p){
    state.provider = p;
    M.providers.forEach(b=>b.classList.toggle('active', b.dataset.p===p));
    M.hint.textContent = HINTS[p] || '';
  }
  M.providers.forEach(b=> b.addEventListener('click', ()=> pickProvider(b.dataset.p)));
  pickProvider('rukassa');

  function open(){ M.modal.style.display='flex'; M.modal.setAttribute('aria-hidden','false'); }
  function close(){
    M.modal.style.display='none'; M.modal.setAttribute('aria-hidden','true');
    M.status.textContent=''; M.hint.textContent=HINTS[state.provider]||'';
    state.invoiceId=null; M.paid.disabled=true; if(state.t) clearInterval(state.t);
  }
  M.close.addEventListener('click', close);
  M.modal.addEventListener('click', e=>{ if(e.target===M.modal) close(); });

  // –ø—É–±–ª–∏—á–Ω–∞—è —Ç–æ—á–∫–∞ –≤—Ö–æ–¥–∞
  window.depositReq = open;

  M.create.addEventListener('click', async ()=>{
    const amount = Number(M.amount.value||0);
    const currency = M.curr.value || 'RUB';
    if(!amount){ notify('–£–∫–∞–∂–∏ —Å—É–º–º—É',{type:'error'}); return; }

    try{
      // –µ–¥–∏–Ω—ã–π –∫–æ–Ω—Ç—Ä–∞–∫—Ç: /api/pay/:provider/create
      const r = await API(`/api/pay/${encodeURIComponent(state.provider)}/create`, {
        method:'POST',
        body: JSON.stringify({ amount, currency })
      });
      if(r?.error) throw new Error(r.message || r.error);

      state.invoiceId = r.invoiceId || r.id;
      M.status.textContent = `–°—á—ë—Ç: ${state.invoiceId} ‚Ä¢ –û—Ç–∫—Ä—ã–ª —Å—Å—ã–ª–∫—É –æ–ø–ª–∞—Ç—ã –≤ –Ω–æ–≤–æ–π –≤–∫–ª–∞–¥–∫–µ`;
      if(r.payUrl) window.open(r.payUrl, '_blank', 'noopener');

      startCooldown(15);
    }catch(err){
      notify(err.message || '–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Å—á—ë—Ç–∞', {type:'error'});
    }
  });

  function startCooldown(s){
    state.cooldown = s; M.paid.disabled = true; syncBtn();
    clearInterval(state.t);
    state.t = setInterval(()=>{
      state.cooldown--;
      if(state.cooldown<=0){ clearInterval(state.t); M.paid.disabled=false; }
      syncBtn();
    }, 1000);
  }
  function syncBtn(){
    M.paid.textContent = state.cooldown>0 ? `–Ø –æ–ø–ª–∞—Ç–∏–ª (${state.cooldown}s)` : '–Ø –æ–ø–ª–∞—Ç–∏–ª';
  }

  M.paid.addEventListener('click', async ()=>{
    if(!state.invoiceId) return notify('–°–Ω–∞—á–∞–ª–∞ —Å–æ–∑–¥–∞–π—Ç–µ —Å—á—ë—Ç',{type:'error'});
    try{
      // –µ–¥–∏–Ω—ã–π –∫–æ–Ω—Ç—Ä–∞–∫—Ç: /api/pay/:provider/status?invoiceId=...
      const r = await API(`/api/pay/${encodeURIComponent(state.provider)}/status?invoiceId=`+encodeURIComponent(state.invoiceId));
      if(r?.error) throw new Error(r.message || r.error);
      M.status.textContent = `–°—Ç–∞—Ç—É—Å: ${r.status||'unknown'}`;
      if((r.status||'').toLowerCase().includes('paid') || (r.status||'')==='success'){
        notify('–û–ø–ª–∞—Ç–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∞',{type:'success'}); close(); loadWallet?.();
      }
    }catch(err){
      notify(err.message || '–û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ —Å—Ç–∞—Ç—É—Å–∞', {type:'error'});
    }
  });
})();

</script>
<!-- ===== ONLY MARKET MAIN CLEAN ===== -->
<style>
:root{
  --bg:#f8f9ff; --card:#ffffff; --text:#0f172a; --muted:#6b7280; --border:#e9edf5;
  --brand:#7b6cff; --brand-hover:#6a5cf2; --brand-press:#5a4ce0; --text-on-brand:#ffffff;
  --radius:18px; --shadow:0 10px 28px rgba(123,108,255,.12);
}
:root[data-theme="dark"]{
  --bg:#0b1020; --card:#0f172a; --text:#e5e7eb; --muted:#9ca3af; --border:#1f2937;
  --brand:#9b8cff; --brand-hover:#8b7cff; --brand-press:#7b6cff; --text-on-brand:#0b1020;
}
body{ background:var(--bg); color:var(--text); }
.card, .modal .sheet{ background:var(--card); color:var(--text); border:1px solid var(--border); border-radius:var(--radius); box-shadow:var(--shadow); }
.btn{ background:var(--brand); color:var(--text-on-brand); border:none; border-radius:calc(var(--radius) - 6px); padding:10px 16px; font-weight:700; }
.btn:hover{ background:var(--brand-hover); }
.btn-ghost{ background:#f4f6ff; color:var(--brand); border:1px solid var(--border); border-radius:calc(var(--radius) - 6px); }
input,textarea,select{ border:1px solid var(--border); border-radius:calc(var(--radius) - 8px); padding:10px 12px; background:#fff; }
.media{ border-radius:calc(var(--radius) - 6px); }
.modal{ z-index:5000; }

</style>


<!-- ===== END MAIN CLEAN ===== -->



<!-- PART 1/2: —Å–∫—Ä–∏–ø—Ç—ã –Ω–∞—á–∞–ª–æ -->
<script>
/* ===== helpers/API ===== */
const S = s => document.querySelector(s);
const CUR_SYMBOL = '‚ÇΩ';
const fmtCur = (x)=> (Number(x)||0).toFixed(2) + ' ' + CUR_SYMBOL;



const API = async (p, opt = {}) => {
  const RU = (code)=>({
    'UNAUTH':'–ù—É–∂–Ω–æ –≤–æ–π—Ç–∏',
    'FORBIDDEN':'–ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞',
    'BANNED':'–ê–∫–∫–∞—É–Ω—Ç –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω',
    'VALIDATION':'–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –≤–≤–µ–¥—ë–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ',
    'BAD_STATUS':'–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Å—Ç–∞—Ç—É—Å',
    'BAD_CODE':'–ù–µ–≤–µ—Ä–Ω—ã–π –∫–æ–¥',
    'BAD_CHALLENGE':'–°–µ—Å—Å–∏—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞',
    'EXPIRED':'–ö–æ–¥ –∏—Å—Ç—ë–∫',
    'LISTING_NOT_FOUND':'–¢–æ–≤–∞—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω',
    'OWN_LISTING':'–ù–µ–ª—å–∑—è –∫—É–ø–∏—Ç—å —Å–≤–æ–π —Ç–æ–≤–∞—Ä',
    'UNAVAILABLE_SINGLE':'–¢–æ–≤–∞—Ä —É–∂–µ –∫—É–ø–ª–µ–Ω/–Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω',
    'OUT_OF_STOCK':'–¢–æ–≤–∞—Ä–∞ –Ω–µ—Ç –≤ –Ω–∞–ª–∏—á–∏–∏',
    'INSUFFICIENT_FUNDS':'–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤',
    'ESCROW_MISMATCH':'–ù–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ —ç—Å–∫—Ä–æ—É',
    'BAD_IMAGE_FORMAT':'–ù–µ–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–π —Ñ–æ—Ä–º–∞—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è',
    'IMAGE_TOO_LARGE':'–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–µ',
    'NO_TG_LINK':'–°–Ω–∞—á–∞–ª–∞ –ø—Ä–∏–≤—è–∂–∏—Ç–µ Telegram',
    'OFFLINE':'–ù–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º'
  })[code] || (typeof code==='string' && code.startsWith('HTTP') ? '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: '+code : '–û—à–∏–±–∫–∞');

  try {
    const r = await fetch(p, {
      headers: { "Content-Type": "application/json", ...(opt.headers || {}) },
      credentials: "include",
      ...opt,
    });
    const ct = r.headers.get("content-type") || "";
    const data = ct.includes("application/json") ? await r.json() : await r.text();

    if (!r.ok) {
      const code = (data && data.error) ? data.error : `HTTP ${r.status}`;
      return { error: code, message: RU(code) };
    }
    return data;
  } catch (e) {
    return { error: "OFFLINE", message: RU("OFFLINE") };
  }
};
function openSettings(){
  const m = document.getElementById('settingsModal');
  if(!m) return;
  m.style.display = 'flex';
  m.setAttribute('aria-hidden','false');
}
function closeSettings(){
  const m = document.getElementById('settingsModal');
  if(!m) return;
  m.style.display = 'none';
  m.setAttribute('aria-hidden','true');
}

function openRukassa(){
  const box = document.getElementById('rukassaBox');
  if(box) box.style.display = '';
}
function escapeHtml(s) {
  return String(s).replace(/[&<>"]/g, m => ({ "&":"&amp;", "<":"&lt;", ">":"&gt;", '"':"&quot;" }[m]));
}
let tgCachedCode = null;
function isSuperNick(nick){ return String(nick||'').toLowerCase() === 'mimimitya'; }
function setActiveMobileTab(){
  // –ø—É—Å—Ç–æ, –ø—Ä–æ—Å—Ç–æ —á—Ç–æ–±—ã –Ω–µ –±—ã–ª–æ –æ—à–∏–±–∫–∏
}
async function tgRequestCode(){
  const r = await API('/api/telegram/request-code',{method:'POST'});
  if(r?.ok){
    notify('–ö–æ–¥ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω',{type:'info'});
    if(r.code){
      tgCachedCode = r.code;  // —Å–æ—Ö—Ä–∞–Ω—è–µ–º –∫–æ–¥ –ª–æ–∫–∞–ª—å–Ω–æ
    }
    renderTgBox();
  }else{
    notify(r?.error||'–û—à–∏–±–∫–∞',{title:'–û—à–∏–±–∫–∞',type:'error'});
  }
}
function openReviews(sellerId){ renderReviews(sellerId); S('#reviewsModal').style.display='flex'; S('#reviewsModal').setAttribute('aria-hidden','false'); }
function closeReviews(){ S('#reviewsModal').style.display='none'; S('#reviewsModal').setAttribute('aria-hidden','true'); }
function normalizeArr(x){ if(Array.isArray(x)) return x; if(x && typeof x==='object') return Object.values(x); return []; }
function pluralRu(n, forms){ n = Math.abs(n)%100; const n1=n%10; if(n>10 && n<20) return forms[2]; if(n1>1 && n1<5) return forms[1]; if(n1==1) return forms[0]; return forms[2]; }

async function prefetchListingsForReviews(list){
  const ids = [...new Set(list.map(r=>r.item?.listingId).filter(Boolean))];
  for(const id of ids){
    if(RV.liveCache.has(id)) continue;
    try{
      const l = await API('/api/listings/'+encodeURIComponent(id));
      if(!l?.error) RV.liveCache.set(id, l);
    }catch{}
  }
}

async function viewSellerReviews(sellerId){
  const raw  = await API('/api/reviews?sellerId='+encodeURIComponent(sellerId));
  RV.list    = normalizeArr(raw);
  RV.page    = 1;
  await prefetchListingsForReviews(RV.list);
  document.getElementById('rvTitle').textContent = '–û—Ç–∑—ã–≤—ã –ø—Ä–æ–¥–∞–≤—Ü–∞';
  renderReviewsPage();
  openReviewsModal();
}

function openReviewsModal(){ const m=S('#reviewsModal'); m.style.display='flex'; m.setAttribute('aria-hidden','false'); }
function closeReviewsModal(){ const m=S('#reviewsModal'); m.style.display='none'; m.setAttribute('aria-hidden','true'); }

function rvPrev(){ if(RV.page>1){ RV.page--; renderReviewsPage(); } }
function rvNext(){ const pages=Math.max(1, Math.ceil(RV.list.length/RV.perPage)); if(RV.page<pages){ RV.page++; renderReviewsPage(); } }

let RV = { list: [], page: 1, perPage: 5, liveCache: new Map() };

function renderReviewsPage(){
  const start = (RV.page-1)*RV.perPage;
  const pageItems = RV.list.slice(start, start+RV.perPage);
  const box = S('#rvList');

  box.innerHTML = pageItems.length
    ? pageItems.map(r=>reviewCardHTML(r)).join('')
    : '<div class="muted">–ù–µ—Ç –æ—Ç–∑—ã–≤–æ–≤</div>';

  const total = RV.list.length;
  const pages = Math.max(1, Math.ceil(total / RV.perPage));
  S('#rvPager').innerHTML = `
    <div class="row" style="gap:6px">
      <button class="btn-ghost" ${RV.page<=1?'disabled':''} onclick="rvPrev()">‚Üê –ù–∞–∑–∞–¥</button>
      <button class="btn-ghost" ${RV.page>=pages?'disabled':''} onclick="rvNext()">–í–ø–µ—Ä—ë–¥ ‚Üí</button>
    </div>
    <div class="muted">–°—Ç—Ä–∞–Ω–∏—Ü–∞ ${RV.page} –∏–∑ ${pages} ‚Ä¢ ${total} –æ—Ç–∑—ã–≤${pluralRu(total,['','–∞','–æ–≤'])}</div>
  `;
}
async function onGoogleCredential(resp){
  try{
    const r = await fetch('/api/auth/google',{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      credentials:'include',
      body:JSON.stringify({ credential: resp.credential })
    });
    const j = await r.json();
    if(!r.ok || j.error){
      return notify(j.error || '–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞ —á–µ—Ä–µ–∑ Google',{type:'error', title:'Google'});
    }
    // —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —é–∑–µ—Ä–∞ –≤ –≥–ª–æ–±–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∏ –æ–±–Ω–æ–≤–∏—Ç—å UI
    window.__me = j.user;
    await refreshMe?.();
    openTab('catalog');
    initHome?.();
    notify('–í—ã —É—Å–ø–µ—à–Ω–æ –≤–æ—à–ª–∏ —á–µ—Ä–µ–∑ Google',{type:'success'});
  }catch(e){
    console.error(e);
    notify('–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞ —á–µ—Ä–µ–∑ Google',{type:'error'});
  }
}

async function renderReviews(sellerId){
  const list = await API('/api/reviews?sellerId='+encodeURIComponent(sellerId));
  const me = window.__me?.id;
  S('#reviewsList').innerHTML = (list||[]).map(rv=>{
    const stars = '‚òÖ'.repeat(Math.max(1,Math.min(5,rv.rating||0)));
    const buyerAva = rv.buyer?.avatar || "https://i.ibb.co/Y4HVSvPV/Group-1-2.png";
    const itemCard = rv.item ? `
      <div class="card" style="margin-top:6px">
        <div class="row" style="gap:8px;align-items:center">
          <img src="${rv.item.image||'https://via.placeholder.com/80x60'}" style="width:80px;height:60px;object-fit:cover;border-radius:8px;border:1px solid var(--border)">
          <div>
            <div><b>${escapeHtml(rv.item.title)}</b></div>
            <div class="muted">${(rv.item.price||0).toFixed(2)} RUB</div>
          </div>
        </div>
      </div>` : '';

    const replyBlock = rv.reply
      ? `<div class="card" style="margin-top:6px;background:#f9fafb">
           <div class="muted" style="font-size:12px;margin-bottom:4px">–û—Ç–≤–µ—Ç –ø—Ä–æ–¥–∞–≤—Ü–∞:</div>
           ${escapeHtml(rv.reply.text||'')}
         </div>`
      : (me===sellerId ? `
         <div class="row" style="gap:6px;margin-top:6px">
           <input id="reply_${rv.id}" placeholder="–û—Ç–≤–µ—Ç –ø—Ä–æ–¥–∞–≤—Ü–∞‚Ä¶ (–æ–¥–∏–Ω —Ä–∞–∑)">
           <button class="btn" onclick="sendReply('${rv.id}')">–û—Ç–≤–µ—Ç–∏—Ç—å</button>
         </div>` : '');

    return `
      <div class="card" style="margin:8px 0">
        <div class="row" style="gap:8px;align-items:center">
          <img src="${buyerAva}" style="width:28px;height:28px;border-radius:50%;object-fit:cover;border:1px solid var(--border)">
          <div><b>${escapeHtml(rv.buyer?.nickname||rv.buyer?.id||'–ü–æ–∫—É–ø–∞—Ç–µ–ª—å')}</b></div>
          <div class="stars" style="margin-left:auto">${stars}</div>
        </div>
        <div style="margin-top:6px;white-space:pre-wrap">${escapeHtml(rv.text||'')}</div>
        ${itemCard}
        ${replyBlock}
      </div>`;
  }).join('') || '<div class="muted">–ù–µ—Ç –æ—Ç–∑—ã–≤–æ–≤</div>';
}

async function sendReply(id){
  const inp = S('#reply_'+id);
  if(!inp || !inp.value.trim()) return notify('–í–≤–µ–¥–∏—Ç–µ –æ—Ç–≤–µ—Ç',{type:'error'});
  const r = await API('/api/reviews/'+encodeURIComponent(id)+'/reply',{method:'POST',body:JSON.stringify({text:inp.value.trim()})});
  if(r?.error) return notify(r.error,{type:'error',title:'–û—Ç–≤–µ—Ç'});
  notify('–û—Ç–≤–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω',{type:'success'});
  // –ø–µ—Ä–µ—Ä–∏—Å—É–µ–º –ø–æ sellerId –∏–∑ –ø–µ—Ä–≤–æ–≥–æ —ç–ª–µ–º–µ–Ω—Ç–∞
  const firstSellerId = (window.__me?.id);
  // –ø—Ä–æ—â–µ: –æ–±–Ω–æ–≤–∏–º –º–æ–¥–∞–ª —Ü–µ–ª–∏–∫–æ–º ‚Äî —É –Ω–∞—Å sellerId –µ—Å—Ç—å –≤ URL? –Ω–µ—Ç ‚Äî —Å–æ—Ö—Ä–∞–Ω–∏–º
  const listBox = S('#reviewsList'); // –≥—Ä—É–±–æ, –Ω–æ –±—ã—Å—Ç—Ä–æ
  // –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏–º –±–∞–∑–æ–≤–æ ‚Äî –∫–Ω–æ–ø–∫–∏ ¬´–û—Ç–∑—ã–≤—ã¬ª –≤—ã–∑—ã–≤–∞—é—Ç—Å—è —Å sellerId:
  // –¥–æ–±–∞–≤—å –≤ ¬´–∫–∞—Ä—Ç–æ—á–∫—É –ø—Ä–æ–¥–∞–≤—Ü–∞¬ª openReviews(u.id)
}

async function tgToggle(){
  try{
    // –ø—Ä–æ—Å—Ç–æ–π —Ç—É–º–±–ª–µ—Ä: –µ—Å–ª–∏ –≤–∫–ª—é—á—ë–Ω ‚Äî –≤—ã–∫–ª—é—á–∏–º, –µ—Å–ª–∏ –≤—ã–∫–ª—é—á–µ–Ω ‚Äî –≤–∫–ª—é—á–∏–º
    const ns = await API('/api/notify/settings');
    const enable = !ns.telegram.enabled;
    const r = await API('/api/notify/toggle',{method:'POST',body:JSON.stringify({telegram: {enabled: enable}})});
    if(r?.ok){
      notify(enable?'–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤–∫–ª—é—á–µ–Ω—ã':'–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤—ã–∫–ª—é—á–µ–Ω—ã',{type:'info'});
      await refreshMe();
    }else{
      notify(r?.error||'–û—à–∏–±–∫–∞',{title:'–û—à–∏–±–∫–∞',type:'error'});
    }
  }catch(e){ notify('–û—à–∏–±–∫–∞',{title:'–û—à–∏–±–∫–∞',type:'error'}); }
}

function notify(msg, {title="", type="info", timeout=2500} = {}){
  const root = document.getElementById('toastRoot');
  if(!root) return alert(msg);
  const el = document.createElement('div');
  el.className = 'toast ' + (type||'info');
  el.innerHTML = `<div class="t-title">${escapeHtml(title||'–°–æ–æ–±—â–µ–Ω–∏–µ')}</div>
                  <div class="t-msg">${escapeHtml(String(msg||''))}</div>`;
  root.appendChild(el);
  setTimeout(()=>{ el.remove(); }, timeout);
}
function showRegister(){
  document.getElementById('loginBox').style.display = 'none';
  document.getElementById('registerBox').style.display = 'block';
}

function showLogin(){
  document.getElementById('registerBox').style.display = 'none';
  document.getElementById('loginBox').style.display = 'block';
}

// –º–æ–¥–∞–ª—å–Ω–æ–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ/–ø—Ä–æ–º–ø—Ç –æ—Å–Ω–æ–≤–∞–Ω–æ –Ω–∞ —Ç–≤–æ–µ–π —Ä–∞–∑–º–µ—Ç–∫–µ #confirmRoot
function confirmBox({title='–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ', text='–í—ã —É–≤–µ—Ä–µ–Ω—ã?', okText='–û–∫', cancelText='–û—Ç–º–µ–Ω–∞', prompt=false, placeholder='' }={}){
  return new Promise(res=>{
    const m = document.getElementById('confirmRoot');
    m.classList.add('show');
    m.querySelector('#confirmTitle').textContent = title;
    m.querySelector('#confirmText').textContent = text;
    const slot = document.getElementById('promptSlot');
    const inp = document.getElementById('promptInput');
    slot.style.display = prompt ? '' : 'none';
    inp.value = '';
    inp.placeholder = placeholder||'';
    const btnOk = document.getElementById('btnOk');
    const btnCancel = document.getElementById('btnCancel');
    btnOk.textContent = okText; btnCancel.textContent = cancelText;
    const done = (ok)=>{ 
      m.classList.remove('show'); 
      res({ok, value: inp.value}); 
      btnOk.onclick = btnCancel.onclick = null;
    };
    btnOk.onclick = ()=>done(true);
    btnCancel.onclick = ()=>done(false);
  });
}


function cardHTML(l){
  const img = l.image || 'https://via.placeholder.com/400x260?text=No+image';
  const seller = (userCache && userCache.get && userCache.get(l.sellerId)) || {};
  const ava = seller.avatar || 'https://i.ibb.co/Y4HVSvPV/Group-1-2.png';
  const nick = seller.nickname || '';
  const stars = (l.ratingCount>0) ? `‚≠êÔ∏è‚≠êÔ∏è‚≠êÔ∏è‚≠êÔ∏è‚≠êÔ∏è` : ''; // –≤—Å—Ç–∞–≤—å —Ä–µ–∞–ª—å–Ω—É—é –æ—Ç—Ä–∏—Å–æ–≤–∫—É –∑–≤—ë–∑–¥
  const discount = l.oldPrice && l.oldPrice>l.price ? `<span class="badge-discount">-${Math.round(100 - (l.price/l.oldPrice*100))}%</span>` : '';
  return `
  <div class="card card-item">
    <img class="media" src="${img}" alt="" onclick="openItem('${l.id}')">
    <div class="body">
      <div class="price">${(l.price||0).toFixed(0)} ‚ÇΩ ${discount}</div>
      <div class="title">${escapeHtml(l.title||'')}</div>
      <div class="meta">
        <img src="${ava}" style="width:18px;height:18px;border-radius:50%">
        <span>${escapeHtml(nick)}</span>
        <span class="stars">${stars}</span>
        ${l.ratingCount?`<span>¬∑ ${l.ratingCount}</span>`:''}
      </div>
      <div class="row" style="gap:8px">
        <button class="btn" onclick="openItem('${l.id}')">–ü–æ–¥—Ä–æ–±–Ω–µ–µ</button>
        <button class="btn" onclick="buy('${l.id}')">–ö—É–ø–∏—Ç—å</button>
      </div>
    </div>
  </div>`;
}

function setTheme(theme){
  // theme: 'light' | 'dark' | 'system'
  let t = theme;
  if(theme==='system'){
    t = window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
  }
  document.documentElement.setAttribute('data-theme', t==='dark' ? 'dark' : 'light');
  localStorage.setItem('theme', theme); // —Ö—Ä–∞–Ω–∏–º –∏–º–µ–Ω–Ω–æ –≤—ã–±–æ—Ä –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
}
function initThemeFromStorage(){
  const saved = localStorage.getItem('theme') || 'light'; // –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –±–µ–ª–∞—è
  setTheme(saved);
  // –≤—ã—Å—Ç–∞–≤–∏–º —Ä–∞–¥–∏–æ–∫–Ω–æ–ø–∫–∏ –≤ "–ù–∞—Å—Ç—Ä–æ–π–∫–∞—Ö"
  const el = document.querySelector(`input[name="themeOpt"][value="${saved}"]`) || document.querySelector(`input[name="themeOpt"][value="light"]`);
  if(el) el.checked = true;
}
function bindThemeRadios(){
  document.querySelectorAll('input[name="themeOpt"]').forEach(r=>{
    r.addEventListener('change', (e)=> setTheme(e.target.value));
  });
}
// Chat BG
function applyChatBg(){
  const url = (document.getElementById('chatBgUrl').value||'').trim();
  if(!url){ clearChatBg(); return; }
  document.documentElement.style.setProperty('--chat-bg', `url("${url}")`);
  localStorage.setItem('chatBg', url);
  notify('–§–æ–Ω —á–∞—Ç–∞ –ø—Ä–∏–º–µ–Ω—ë–Ω',{type:'info'});
}
function clearChatBg(){
  document.documentElement.style.removeProperty('--chat-bg');
  localStorage.removeItem('chatBg');
  document.getElementById('chatBgUrl').value = '';
  notify('–§–æ–Ω —á–∞—Ç–∞ —Å–±—Ä–æ—à–µ–Ω',{type:'info'});
}
function initChatBg(){
  const url = localStorage.getItem('chatBg') || '';
  if(url){
    document.documentElement.style.setProperty('--chat-bg', `url("${url}")`);
    const input = document.getElementById('chatBgUrl'); if(input) input.value = url;
  }
}

// –°—Ç–∞—Ä—Ç—É–µ–º
document.addEventListener('DOMContentLoaded', ()=>{
  initThemeFromStorage();   // –±–µ–ª–∞—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
  bindThemeRadios();
  initChatBg();
});


// --- Auth API bindings ---
let __tgChallengeId = null; // –¥–ª—è –ª–æ–≥–∏–Ω–∞ (–ø–æ—Å–ª–µ –ø—Ä–∏–≤—è–∑–∫–∏)
let __pendingLoginEmail = null;
let __pendingLoginPass = null;
let __lastLinkCode = null;

function openTgMigrate(){ S('#tgMigrateModal').style.display='flex'; S('#tgMigrateModal').setAttribute('aria-hidden','false'); }
function closeTgMigrate(){ S('#tgMigrateModal').style.display='none'; S('#tgMigrateModal').setAttribute('aria-hidden','true'); }

async function tgGetLinkCode(){
  // –ú–æ–∂–Ω–æ –∑–∞–ø—Ä–æ—Å–∏—Ç—å —Å –±—ç–∫–∞ –≤–º–µ—Å—Ç–µ —Å /login –æ—Ç–≤–µ—Ç–æ–º; –Ω–æ –¥–∞–¥–∏–º –∫–Ω–æ–ø–∫—É –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è/–ø–æ–≤—Ç–æ—Ä–∞:
  const r = await API('/api/telegram/request-code',{method:'POST'});
  if(r?.ok && r.code){
    __lastLinkCode = r.code;
    S('#tgMigrateCode').textContent = '–ö–æ–¥: ' + r.code;
    notify('–ö–æ–¥ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω',{type:'info'});
  } else {
    notify(r?.error||'–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∫–æ–¥–∞',{type:'error'});
  }
}

async function tgMigrateContinue(){
  // –ü—Ä–æ–≤–µ—Ä–∏–º, —á—Ç–æ TG —É–∂–µ –ø—Ä–∏–≤—è–∑–∞–Ω
  const ns = await API('/api/notify/settings');
  if(!ns?.telegram?.linked){
    notify('–°–Ω–∞—á–∞–ª–∞ –ø—Ä–∏—à–ª–∏—Ç–µ –∫–æ–¥ –±–æ—Ç—É –≤ Telegram, –∑–∞—Ç–µ–º –Ω–∞–∂–º–∏—Ç–µ ¬´–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å¬ª.',{type:'error'});
    return;
  }
  // –¢–µ–ø–µ—Ä—å –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ–º —É –±—ç–∫–∞ –ª–æ–≥–∏–Ω-—á–µ–ª–ª–µ–Ω–¥–∂ –∏ –æ—Ç–ø—Ä–∞–≤–∫—É –∫–æ–¥–∞ –≤ TG
  const r = await API('/api/auth/login', { method:'POST', body: JSON.stringify({ email: __pendingLoginEmail, password: __pendingLoginPass })});
  if(r?.requiresTgCode && r?.challengeId){
    __tgChallengeId = r.challengeId;
    const ask = await confirmBox({title:'–ö–æ–¥ –∏–∑ Telegram', text:'–í–≤–µ–¥–∏—Ç–µ 6-–∑–Ω–∞—á–Ω—ã–π –∫–æ–¥, –∫–æ—Ç–æ—Ä—ã–π –º—ã –ø—Ä–∏—Å–ª–∞–ª–∏ –≤ Telegram', prompt:true, okText:'–í–æ–π—Ç–∏', placeholder:'123456'});
    if(!ask.ok) return;
    const v = await API('/api/auth/tg-verify', { method:'POST', body: JSON.stringify({ challengeId: __tgChallengeId, code: ask.value.trim() })});
    if(v?.error) return notify(v.error,{title:'–í—Ö–æ–¥',type:'error'});
    closeTgMigrate();
    notify('–í—Ö–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω',{type:'success'}); await refreshMe(); openTab('catalog'); initHome();
  } else if(r?.requireTgLink){
    // –µ—â—ë –Ω–µ –ø—Ä–∏–≤—è–∑–∞–Ω? —Å–æ–æ–±—â–∏–º
    notify('–ï—â—ë –Ω–µ –≤–∏–¥–∏–º –ø—Ä–∏–≤—è–∑–∫—É Telegram. –û—Ç–ø—Ä–∞–≤—å—Ç–µ –∫–æ–¥ –±–æ—Ç—É –∏ –ø–æ–≤—Ç–æ—Ä–∏—Ç–µ.',{type:'error'});
  } else if(r?.error){
    notify(r.error,{type:'error'});
  }
}

async function login(){
  const email = S('#loginEmail').value.trim();
  const password = S('#loginPass').value.trim();
  __pendingLoginEmail = email;
  __pendingLoginPass  = password;

  const r = await API('/api/auth/login', { method:'POST', body: JSON.stringify({ email, password })});

  // 1) –¢—Ä–µ–±—É–µ—Ç—Å—è –ø—Ä–∏–≤—è–∑–∫–∞ TG ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª –º–∏–≥—Ä–∞—Ü–∏–∏
  if(r?.requireTgLink){
    // –≤—Å—Ç–∞–≤–∏–º –¥–∞–Ω–Ω—ã–µ
    S('#tgMigrateCode').textContent = '–ö–æ–¥: ' + (r.linkCode || '‚Äî');
    S('#tgMigrateBot').textContent  = r.tgBot ? r.tgBot : '@onlymarket_marketplace_bot';
    __lastLinkCode = r.linkCode || null;
    openTgMigrate();
    return;
  }

  // 2) TG –ø—Ä–∏–≤—è–∑–∞–Ω ‚Äî –ø—Ä–∏—à–ª—ë–º –∫–æ–¥ –≤—Ö–æ–¥–∞ –≤ TG –∏ –ø–æ–ø—Ä–æ—Å–∏–º –≤–≤–µ—Å—Ç–∏
  if(r?.requiresTgCode && r?.challengeId){
    __tgChallengeId = r.challengeId;
    const ask = await confirmBox({title:'–ö–æ–¥ –∏–∑ Telegram', text:'–í–≤–µ–¥–∏—Ç–µ 6-–∑–Ω–∞—á–Ω—ã–π –∫–æ–¥, –∫–æ—Ç–æ—Ä—ã–π –º—ã –ø—Ä–∏—Å–ª–∞–ª–∏ –≤ Telegram', prompt:true, okText:'–í–æ–π—Ç–∏', placeholder:'123456'});
    if(!ask.ok) return;
    const v = await API('/api/auth/tg-verify', { method:'POST', body: JSON.stringify({ challengeId: __tgChallengeId, code: ask.value.trim() })});
    if(v?.error) return notify(v.error,{title:'–í—Ö–æ–¥',type:'error'});
    notify('–í—Ö–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω',{type:'success'}); await refreshMe(); openTab('catalog'); initHome();
    return;
  }

  // 3) –ù–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π ‚Äî —É—Å–ø–µ—à–Ω—ã–π –≤—Ö–æ–¥ –±–µ–∑ —á–µ–ª–µ–Ω–¥–∂–∞ (–Ω–µ –¥–æ–ª–∂–Ω–æ —Å–ª—É—á–∞—Ç—å—Å—è)
  if(r?.user && r?.token){
    notify('–í—Ö–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω',{type:'success'}); await refreshMe(); openTab('catalog'); initHome();
    return;
  }

  // 4) –û—à–∏–±–∫–∞
  notify(r?.error || '–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞',{title:'–í—Ö–æ–¥',type:'error'});
}

// –ì–ª–æ–±–∞–ª—å–Ω–æ:
window.__tg_last_code = null;

// –í renderTgBox() ‚Äî –î–û —Ñ–∏–Ω–∞–ª—å–Ω–æ–≥–æ box.style.display = '';
function renderTgBox(){
  const box = document.getElementById('tgBox');
  if(!box || !window.__me){ box.style.display='none'; return; }

  API('/api/notify/settings').then(ns=>{
    const tg = ns?.telegram || {};
    const st = document.getElementById('tgStatus');
    const codeEl = document.getElementById('tgCode');

    if(tg.linked){
      st.textContent = `–ü—Ä–∏–≤—è–∑–∞–Ω–æ${tg.username ? ' –∫ @'+tg.username : ''}. –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è: ${tg.enabled ? '–≤–∫–ª—é—á–µ–Ω—ã' : '–≤—ã–∫–ª—é—á–µ–Ω—ã'}.`;
      codeEl.style.display = 'none';
      tgCachedCode = null; // –æ—á–∏—â–∞–µ–º ‚Äî –±–æ–ª—å—à–µ –Ω–µ –Ω—É–∂–µ–Ω
    } else {
      st.textContent = '–ù–µ –ø—Ä–∏–≤—è–∑–∞–Ω–æ. –ù–∞–∂–º–∏—Ç–µ ¬´–ü–æ–ª—É—á–∏—Ç—å –∫–æ–¥¬ª –∏ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –µ–≥–æ –±–æ—Ç—É.';
      const code = tg.lastCode || tgCachedCode;
      if(code){
        codeEl.style.display = '';
        codeEl.textContent = '–ö–æ–¥: ' + code;
      } else {
        codeEl.style.display = 'none';
      }
    }

    box.style.display = '';
  });
}


async function register(){
  const email    = S('#regEmail').value.trim();
  const password = S('#regPass').value.trim();
  const nickname = S('#regNick').value.trim();
  const agreeEl  = document.getElementById('regAgree');

  if(!agreeEl.checked){
    return notify('–ü–æ—Å—Ç–∞–≤—å—Ç–µ –≥–∞–ª–æ—á–∫—É –æ —Å–æ–≥–ª–∞—Å–∏–∏ —Å —É—Å–ª–æ–≤–∏—è–º–∏',{type:'error', title:'–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è'});
  }

  const r = await API('/api/auth/register',{
    method:'POST',
    body:JSON.stringify({ email, password, nickname })
  });
  if(r?.requiresEmailCode && r?.emailChallengeId){
    const ask=await confirmBox({title:'–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ email', text:`–ú—ã –æ—Ç–ø—Ä–∞–≤–∏–ª–∏ –∫–æ–¥ –Ω–∞ ${email}. –í–≤–µ–¥–∏—Ç–µ –µ–≥–æ –Ω–∏–∂–µ:`, prompt:true, okText:'–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å', placeholder:'123456'});
    if(!ask.ok) return;
    const v=await API('/api/auth/email-verify',{method:'POST',body:JSON.stringify({challengeId:r.emailChallengeId, code:ask.value.trim()})});
    if(v?.error) return notify(v.error,{title:'Email',type:'error'});
    notify('–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∞',{type:'success'}); await refreshMe(); openTab('catalog'); initHome(); return;
  }
  if(r?.error) return notify(r.error,{title:'–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è',type:'error'});
  // (–æ–±—ã—á–Ω–æ —Å—é–¥–∞ –Ω–µ –ø–æ–ø–∞–¥—ë–º)
  notify('–ê–∫–∫–∞—É–Ω—Ç —Å–æ–∑–¥–∞–Ω',{type:'success'}); await refreshMe(); openTab('catalog'); initHome();
}

// –î–û–ë–ê–í–¨ —Ä—è–¥–æ–º —Å refreshMe() (–≤ –æ—Å–Ω–æ–≤–Ω–æ–π —á–∞—Å—Ç–∏ —Å–∫—Ä–∏–ø—Ç–∞)
function renderProfile(){
  const box = document.getElementById('meBox');
  const me = window.__me;
  if(!box) return;
  if(!me){
    box.textContent = '–í–æ–π–¥–∏—Ç–µ, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –ø—Ä–æ—Ñ–∏–ª—å';
    return;
  }
  box.innerHTML = `
    <div><b>${escapeHtml(me.nickname||'')}</b> ${me.verified ? '‚úîÔ∏è' : ''}</div>
    <div class="muted">${escapeHtml(me.email||'')}</div>
    <div class="muted">ID: ${escapeHtml(me.id||'')}</div>
    <div class="muted">–†–æ–ª–∏: ${(me.roles||[]).join(', ') || '‚Äî'}</div>
  `;
  if(me.avatar) { const img=document.getElementById('meAvatar'); if(img) img.src=me.avatar; }
}

async function refreshMe(){
  try{
    const r = await API('/api/me');
    window.__me = r?.user || null;
    // userbar
    const info = document.getElementById('userInfo');
    const btnIn  = document.getElementById('loginBtn');
    const btnOut = document.getElementById('logoutBtn');
    if(window.__me){
      info.textContent = window.__me.nickname || window.__me.email || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
      btnIn.style.display = 'none';
      btnOut.style.display = '';
    }else{
      info.textContent = '–ì–æ—Å—Ç—å';
      btnIn.style.display = '';
      btnOut.style.display = 'none';
    }
    // –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å –≤–∫–ª–∞–¥–∫—É –ê–¥–º–∏–Ω
    const isAdmin = !!(window.__me && ((window.__me.roles||[]).includes('admin')||(window.__me.roles||[]).includes('support')||isSuperNick(window.__me.nickname)));
    const t = document.getElementById('tabAdmin');
    const bn = document.getElementById('bnAdmin');
    if(t) t.style.display  = isAdmin ? '' : 'none';
    if(bn) bn.style.display = isAdmin ? '' : 'none';

    // –ø—Ä–æ—Ñ–∏–ª—å–Ω—ã–µ –±–ª–æ–∫–∏
 renderProfile();
renderTgBox();
    loadWallet();
    loadMyReviews();
    loadMyListings();

  }catch(e){}
}
function reviewCardHTML(r){
  const date  = new Date(r.ts||Date.now()).toLocaleString();
  const stars = '‚òÖ'.repeat(r.rating) + '‚òÜ'.repeat(5-r.rating);
  const snap  = r.item || {};
  const live  = snap.listingId ? RV.liveCache.get(snap.listingId) : null;

  const title = (live?.title ?? snap.title ?? '–¢–æ–≤–∞—Ä');
  const price = (typeof live?.price === 'number' ? live.price : (snap.price ?? 0));
  const image = (live?.image || snap.image || null);

  const itemHtml = `
    <div class="card" style="margin-top:6px">
      <div class="row" style="gap:8px; align-items:center">
        ${image?`<img src="${image}" style="width:64px;height:48px;object-fit:cover;border-radius:8px;border:1px solid var(--border)">`:''}
        <div style="min-width:0">
          <div><b>${escapeHtml(title)}</b></div>
          <div class="muted">${(Number(price)||0).toFixed(2)} EUR</div>
        </div>
        ${snap.listingId ? `<div class="row-right" style="margin-left:auto"><button class="btn-ghost" onclick="openItem('${snap.listingId}')">–û—Ç–∫—Ä—ã—Ç—å</button></div>` : ''}
      </div>
    </div>`;

  const canReply = window.__me && window.__me.id === r.sellerId;
  const replyBlock = r.reply ? `
    <div class="card" style="background:#fafaff; border-color:#e9e5ff; margin-top:6px">
      <div class="muted" style="font-size:12px">–û—Ç–≤–µ—Ç –ø—Ä–æ–¥–∞–≤—Ü–∞ ‚Ä¢ ${new Date(r.reply.ts).toLocaleString()}</div>
      <div style="white-space:pre-wrap">${escapeHtml(r.reply.text||'')}</div>
    </div>`
  : (canReply ? `
      <div class="row row-right" style="margin-top:6px">
        <button class="btn-ghost" onclick="replyReviewPrompt('${r.id}')">–û—Ç–≤–µ—Ç–∏—Ç—å</button>
      </div>` : '');

  return `
    <div class="card" style="margin:8px 0">
      <div><b>${stars}</b> <span class="muted" style="margin-left:6px">${date}</span></div>
      <div style="white-space:pre-wrap; margin-top:4px">${escapeHtml(r.text||'')}</div>
      ${itemHtml}
      ${replyBlock}
    </div>`;
}

async function replyReviewPrompt(id){
  const r = await confirmBox({title:'–û—Ç–≤–µ—Ç –Ω–∞ –æ—Ç–∑—ã–≤', text:'–í–∞—à –æ—Ç–≤–µ—Ç', prompt:true, okText:'–û—Ç–ø—Ä–∞–≤–∏—Ç—å', placeholder:'–°–ø–∞—Å–∏–±–æ –∑–∞ –ø–æ–∫—É–ø–∫—É!'});
  if(!r.ok || !r.value.trim()) return;
  const resp = await API('/api/reviews/'+encodeURIComponent(id)+'/reply',{method:'POST', body: JSON.stringify({ text: r.value.trim() })});
  if(resp?.error) return notify(resp.error,{title:'–û—Ç–≤–µ—Ç –Ω–∞ –æ—Ç–∑—ã–≤', type:'error'});
  notify('–û—Ç–≤–µ—Ç –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω',{type:'success'});
  // –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∫–∞ —Ç–µ–∫—É—â–µ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã:
  const idx = RV.list.findIndex(x => x.id === id);
  if(idx>=0){ RV.list[idx] = resp.review; }
  renderReviewsPage();
}


function notify(msg, {title="", type="info", timeout=2500} = {}){
  const root = document.getElementById('toastRoot');
  if(!root){ console.log(title||'INFO', msg); return; }
  const el = document.createElement('div');
  el.className = 'toast ' + (type||'info');
  el.innerHTML = `<div class="t-title">${(title||'–°–æ–æ–±—â–µ–Ω–∏–µ')}</div>
                  <div class="t-msg">${String(msg||'')}</div>`;
  root.appendChild(el);
  setTimeout(()=>el.remove(), timeout);
}
function confirmBox({title='–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ', text='–í—ã —É–≤–µ—Ä–µ–Ω—ã?', okText='–û–∫', cancelText='–û—Ç–º–µ–Ω–∞', prompt=false, placeholder='' }={}){
  return new Promise(res=>{
    const m = document.getElementById('confirmRoot');
    m.classList.add('show');
    m.querySelector('#confirmTitle').textContent = title;
    m.querySelector('#confirmText').textContent = text;
    const slot = document.getElementById('promptSlot');
    const inp = document.getElementById('promptInput');
    slot.style.display = prompt ? '' : 'none'; inp.value=''; inp.placeholder=placeholder||'';
    const ok = document.getElementById('btnOk'), cancel = document.getElementById('btnCancel');
    ok.textContent = okText; cancel.textContent = cancelText;
    const done=(yes)=>{ m.classList.remove('show'); ok.onclick=cancel.onclick=null; res({ok:yes, value:inp.value}); };
    ok.onclick = ()=>done(true); cancel.onclick = ()=>done(false);
  });
}
function goAuth(){ openTab('auth'); }
async function refreshMe(){
  const r = await API('/api/me');
  window.__me = r?.user || null;
  const info = document.getElementById('userInfo');
  const btnIn  = document.getElementById('loginBtn');
  const btnOut = document.getElementById('logoutBtn');
  if(window.__me){ info.textContent = window.__me.nickname || window.__me.email || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å'; btnIn.style.display='none'; btnOut.style.display=''; }
  else { info.textContent='–ì–æ—Å—Ç—å'; btnIn.style.display=''; btnOut.style.display='none'; }
  const isAdmin = !!(window.__me && ((window.__me.roles||[]).includes('admin')||(window.__me.roles||[]).includes('support')||isSuperNick(window.__me.nickname)));
  const t = document.getElementById('tabAdmin'); const bn = document.getElementById('bnAdmin');
  if(t) t.style.display = isAdmin ? '' : 'none';
  if(bn) bn.style.display = isAdmin ? '' : 'none';
  loadWallet?.(); loadMyReviews?.(); loadMyListings?.();
}


/* ===== small utils ===== */
const V_BADGE = 'https://cdn-icons-png.flaticon.com/512/11708/11708440.png';
const userCache = new Map(); // id -> {id,nickname,verified,stats}
async function lookupUsers(ids){
  const uniq=[...new Set(ids.filter(Boolean))];
  const miss = uniq.filter(id=>!userCache.has(id));
  if(miss.length){
    const r = await API('/api/users/lookup?ids='+encodeURIComponent(miss.join(',')));
    (r||[]).forEach(u=>userCache.set(u.id, u));
  }
  return uniq.map(id=>userCache.get(id)||{id,nickname:id,verified:false});
}
function nickHtml(u){
  const v = u.verified ? `<img class="v-badge" alt="v" src="${V_BADGE}">` : '';
  return `<span>${escapeHtml(u.nickname||u.id)}</span> ${v}`;
}

async function poll2FA(id){
  const until = Date.now()+5*60*1000; // 5 –º–∏–Ω—É—Ç
  while(Date.now()<until){
    const s = await API('/api/auth/2fa/status?challengeId='+encodeURIComponent(id));
    if(s?.ok){
      notify('–í—Ö–æ–¥ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥—ë–Ω',{type:'success'});
      await refreshMe(); openTab('catalog'); initHome();
      return;
    }
    if(s?.error==='DENIED'){ notify('–í—Ö–æ–¥ –æ—Ç–∫–ª–æ–Ω—ë–Ω',{title:'2FA',type:'error'}); return; }
    if(s?.error==='EXPIRED'){ notify('–ö–æ–¥ 2FA –∏—Å—Ç—ë–∫',{title:'2FA',type:'error'}); return; }
    await new Promise(r=>setTimeout(r,3000));
  }
  notify('2FA: –≤—Ä–µ–º—è –∏—Å—Ç–µ–∫–ª–æ',{title:'2FA',type:'error'});
}

async function logout(){ await API('/api/auth/logout',{method:'POST'}); notify('–í—ã –≤—ã—à–ª–∏',{title:'–ì–æ—Ç–æ–≤–æ'}); await refreshMe(); openTab('catalog'); }





/* ===== tabs ===== */
let currentTab='catalog';
function openTab(id){
  currentTab=id;
  ['catalog','sell','orders','chat','admin','auth'].forEach(x=>{
    const el=S('#screen-'+x); if(el) el.style.display = (x===id)?'':'none';
    const t=S('#tab'+x[0].toUpperCase()+x.slice(1)); if(t) t.classList.toggle('active', x===id);
  });
  if(id==='catalog'){ loadCategories(); loadCatalog(); }
  if(id==='sell'){ loadCategories(true); wizGo(1); }
  if(id==='orders'){ loadOrders(); }
if(id === 'chat'){
    loadInbox();

    const rid = getCurrentRoomId();

    if (!rid) {
        currentRoom = { id: 'global', type: 'global' };
        openRoom('global');
    } else {
        openRoom(rid);
    }
}

  if(id==='admin'){ loadCategories(); loadFee(); loadTasks(); renderCatsAdmin(); }
  if(id==='admin'){ loadCategories(); loadFee(); loadTasks(); renderCatsAdmin(); loadModQueue(); }
if(id==='auth'){ renderProfile(); }
}
function goAuth(){ openTab('auth'); }

/* ===== top Catalog dropdown ===== */
let ALL_CATS=[]; let __cat=null; let __subcat=null;
function toggleCatalogDD(){ const p=S('#ddPanel'); p.classList.toggle('show'); if(p.classList.contains('show')) renderCatDD(); }
function renderCatDD(){
  const top = ALL_CATS.filter(c=>!c.parentId).sort((a,b)=>(a.order||0)-(b.order||0));
  S('#ddCats').innerHTML = top.map(c=>`<li onclick="pickCat('${c.id}')">${escapeHtml(c.title)}</li>`).join('') || '<li class="muted">–ù–µ—Ç –∫–∞—Ç–µ–≥–æ—Ä–∏–π</li>';
  if(__cat){
    const subs = ALL_CATS.filter(s=>s.parentId===__cat).sort((a,b)=>(a.order||0)-(b.order||0));
    S('#ddSubs').innerHTML = subs.map(s=>`<li onclick="pickSub('${s.id}')">${escapeHtml(s.title)}</li>`).join('') || '<li class="muted">–ù–µ—Ç –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏–π</li>';
  } else { S('#ddSubs').innerHTML='<li class="muted">–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é</li>'; }
}
function renderCatChips(){
  const wrap = S('#catChips'); if(!wrap) return;
  const top = ALL_CATS.filter(c=>!c.parentId).sort((a,b)=>(a.order||0)-(b.order||0));
  const cur = window.__cat || null;
  wrap.innerHTML = [
    `<div class="chip ${!cur?'active':''}" onclick="clearCat()">–í—Å–µ</div>`,
    ...top.map(c=>`<div class="chip ${cur===c.id?'active':''}" onclick="pickCat('${c.id}')">${escapeHtml(c.title)}</div>`)
  ].join('');
}
function clearCat(){ window.__cat=null; window.__subcat=null; renderCatChips(); loadCatalog(); }
function renderSubChips(){
  const wrap = S('#subChips'); const crumbs = S('#catCrumbs');
  if(!wrap || !crumbs) return;

  const catId = window.__cat || null;
  if(!catId){
    wrap.innerHTML = '';
    crumbs.textContent = '–í—Å–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏';
    return;
  }
  const cat = ALL_CATS.find(c=>c.id===catId);
  const subs = ALL_CATS.filter(s=>s.parentId===catId).sort((a,b)=>(a.order||0)-(b.order||0));
  wrap.innerHTML = subs.map(s=>`<div class="chip ${window.__subcat===s.id?'active':''}" onclick="pickSub('${s.id}')">${escapeHtml(s.title)}</div>`).join('') || '<div class="muted">–ù–µ—Ç –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏–π</div>';
  crumbs.textContent = `–ö–∞—Ç–µ–≥–æ—Ä–∏—è: ${cat ? cat.title : catId}${window.__subcat ? ' ‚Üí ' + (ALL_CATS.find(x=>x.id===window.__subcat)?.title||window.__subcat) : ''}`;
}

// —Ä–∞—Å—à–∏—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ:
const __pickCat = pickCat;
pickCat = function(id){ __pickCat(id); renderSubChips(); };
const __pickSub = pickSub;
pickSub = function(id){ __pickSub(id); renderSubChips(); };

// –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–π
const __loadCategories = loadCategories;
loadCategories = async function(fillWizard){
  await __loadCategories(fillWizard);
  renderCatChips();
  renderSubChips();
};
function getCurrentRoomId() {
    if (!currentRoom) return null;
    return currentRoom.id || currentRoom.room || currentRoom.chat || null;
}

// –±—ã—Å—Ç—Ä—ã–π —Ñ–∏–ª—å—Ç—Ä –ø–æ –ø–æ–∏—Å–∫—É: –∏—â–µ—Ç –∏ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
(function patchSearch(){
  const search = S('#search');
  if(!search) return;
  const _handler = async ()=>{
    const q=(search.value||'').trim().toLowerCase();
    if(!q){ loadCatalog(); return; }
    // –µ—Å–ª–∏ —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å –∫–∞—Ç–µ–≥–æ—Ä–∏–µ–π ‚Äî –ø—Ä–∏–º–µ–Ω–∏–º
    const cat = ALL_CATS.find(c=>(c.title||'').toLowerCase()===q);
    if(cat){ window.__cat = cat.parentId ? cat.parentId : cat.id; window.__subcat = cat.parentId ? cat.id : null; renderCatChips(); renderSubChips(); }
    loadCatalog();
  };
  search.removeEventListener?.('input', _handler);
  search.addEventListener('input', _handler);
})();
function pickCat(id){ __cat=id; __subcat=null; renderCatDD(); filterByCat(id); S('#ddPanel').classList.remove('show'); }
function pickSub(id){ __subcat=id; filterByCat(id); S('#ddPanel').classList.remove('show'); }

/* ===== categories ===== */
async function loadCategories(fillWizard){
  let cats=await API('/api/categories'); if(!Array.isArray(cats)) cats=[];
  ALL_CATS=cats;
  renderCatDD();
  if(fillWizard){
    const top = cats.filter(c=>!c.parentId).sort((a,b)=>(a.order||0)-(b.order||0));
    S('#wizCats').innerHTML = top.map(c=>`
      <div class="card" onclick="wizPickCat('${c.id}')"><b>${escapeHtml(c.title)}</b></div>
    `).join('') || '<div class="muted">–ù–µ—Ç –∫–∞—Ç–µ–≥–æ—Ä–∏–π</div>';
  }
}
function filterByCat(id){ window.__cat=id; loadCatalog(); }

// --- Mobile tabs binding ---
(function(){
  const tabs = document.querySelectorAll('#mobileTabs .m-tab');
  if(!tabs.length) return;

  function setActiveMobileTab(k){
    tabs.forEach(a => a.classList.toggle('active', a.dataset.tab===k));
  }

  // –ø–µ—Ä–µ—Ö–≤–∞—Ç openTab —á—Ç–æ–±—ã –ø–æ–¥—Å–≤–µ—á–∏–≤–∞—Ç—å –∞–∫—Ç–∏–≤–Ω—É—é
  const _openTab = window.openTab;
  window.openTab = function(k, ...rest){
    _openTab && _openTab(k, ...rest);
    // —Å–∫—Ä–æ–ª–ª –∫ –Ω–∞—á–∞–ª—É –¥–ª—è –æ—â—É—â–µ–Ω–∏—è ¬´—ç–∫—Ä–∞–Ω–∞¬ª
    if (window.matchMedia('(max-width: 860px)').matches) window.scrollTo({top:0, behavior:'smooth'});
  };

  tabs.forEach(a=>{
    a.addEventListener('click', (e)=>{
      e.preventDefault();
      const k=a.dataset.tab;
      if(typeof window.openTab==='function') openTab(k);
    });
  });

  // —Å—Ç–∞—Ä—Ç–æ–≤–∞—è –ø–æ–¥—Å–≤–µ—Ç–∫–∞
  setActiveMobileTab((window.__activeTab)||'catalog');
})();

/* ===== catalog + item modal ===== */
/* ===== catalog + item modal ===== */
let __items = [];

async function loadCatalog(){
  const qEl = S('#search');
  const q   = (qEl ? qEl.value : '').toLowerCase().trim();
  const cat = window.__cat || null;

  // 1. –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ —Å —É—á—ë—Ç–æ–º –¥–≤—É—Ö —Ñ–æ—Ä–º–∞—Ç–æ–≤:
  //    - —Å—Ç–∞—Ä—ã–π: [ ... ]
  //    - –Ω–æ–≤—ã–π: { items:[...], nextCursor:... }
  const resp = await API('/api/listings?limit=50');

  let arr;
  if (Array.isArray(resp)) {
    arr = resp;
  } else if (resp && Array.isArray(resp.items)) {
    arr = resp.items;
  } else {
    arr = [];
  }

  __items = arr.slice(); // –∫–æ–ø–∏—è –º–∞—Å—Å–∏–≤–∞

  // 2. –§–∏–ª—å—Ç—Ä –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
  if (cat){
    __items = __items.filter(x =>
      x.categoryId === cat ||
      ALL_CATS.some(s => s.id === x.categoryId && s.parentId === cat)
    );
  }

  // 3. –§–∏–ª—å—Ç—Ä –ø–æ –ø–æ–∏—Å–∫—É
  if (q){
    __items = __items.filter(x => {
      const catTitle = (ALL_CATS.find(c=>c.id===x.categoryId)?.title || '').toLowerCase();
      return (x.id || '').toLowerCase().includes(q)
          || (x.title || '').toLowerCase().includes(q)
          || (x.description || '').toLowerCase().includes(q)
          || catTitle.includes(q);
    });
  }

  // 4. –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞: VIP –≤—ã—à–µ, –ø–æ—Ç–æ–º –ø–æ updatedAt/createdAt
  __items.sort((a,b)=>{
    const av = !!(a.extra && a.extra.vip);
    const bv = !!(b.extra && b.extra.vip);
    if (av !== bv) return bv - av;
    return (b.updatedAt || b.createdAt || 0) - (a.updatedAt || a.createdAt || 0);
  });

  // 5. –†–µ–Ω–¥–µ—Ä –∫–∞—Ä—Ç–æ—á–µ–∫
  const cardsBox = document.getElementById('cards');
  if (cardsBox){
    cardsBox.innerHTML = __items.length
      ? __items.map(cardHTML).join('')
      : '<div class="muted">–ü—É—Å—Ç–æ</div>';
  }

  // 6. –ü–æ–¥–≥—Ä—É–∂–∞–µ–º –∏–Ω—Ñ—É –æ –ø—Ä–æ–¥–∞–≤—Ü–∞—Ö
  const sellerIds = __items.map(x=>x.sellerId).filter(Boolean);
  await lookupUsers(sellerIds);
}

// –ø–æ–∏—Å–∫
S('#search').addEventListener('input', ()=>loadCatalog());

function cardHTML(l){
  const img = l.image || 'https://via.placeholder.com/600x400?text=No+image';
  const seller = (userCache && userCache.get && userCache.get(l.sellerId)) || {};
  const ava = seller.avatar || 'https://i.ibb.co/Y4HVSvPV/Group-1-2.png';
  const nick = seller.nickname || '';
  const stars = (l.ratingCount > 0) ? '‚≠êÔ∏è‚≠êÔ∏è‚≠êÔ∏è‚≠êÔ∏è‚≠êÔ∏è' : '';
  const discount = (l.oldPrice && l.oldPrice > l.price)
    ? `<span class="badge-discount">-${Math.round(100 - (l.price / l.oldPrice * 100))}%</span>`
    : '';

  return `
    <div class="card card-item" data-id="${l.id}">
      <div class="card-media">
        <img
          class="media"
          src="${img}"
          alt="${escapeHtml(l.title || '')}"
          loading="lazy"
          style="width:100%;height:220px;object-fit:cover;border-radius:12px;"
        >
      </div>
      <div class="body">
        <div class="price">
          ${(l.price || 0).toFixed(0)} ‚ÇΩ
          ${discount}
        </div>
        <div class="title">
          ${escapeHtml(l.title || '')}
        </div>
        <div class="meta">
          <img
            src="${ava}"
            style="width:18px;height:18px;border-radius:50%;object-fit:cover;"
          >
          <span>${escapeHtml(nick)}</span>
          <span class="stars">${stars}</span>
          ${l.ratingCount ? `<span>¬∑ ${l.ratingCount}</span>` : ''}
        </div>
      </div>
    </div>
  `;
}

async function openItem(id){
  if(!id) return;

  const item = await API('/api/listings/'+encodeURIComponent(id));
  if(item?.error === 'FORBIDDEN'){
    notify('–¢–æ–≤–∞—Ä –µ—â—ë –Ω–∞ –º–æ–¥–µ—Ä–∞—Ü–∏–∏',{title:'–ù–µ–¥–æ—Å—Ç—É–ø–Ω–æ',type:'info'});
    return;
  }
  if(item?.error){
    notify(item.message || item.error || '–û—à–∏–±–∫–∞',{title:'–û—à–∏–±–∫–∞',type:'error'});
    return;
  }

  // –ë–µ—Ä—ë–º –ü–û–°–õ–ï–î–ù–Æ–Æ –º–æ–¥–∞–ª–∫—É —Å id="itemModal" (—Ç—É, —á—Ç–æ –≤–Ω–∏–∑—É –∏ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –≥–ª–æ–±–∞–ª—å–Ω–æ–π)
  const modals = document.querySelectorAll('#itemModal');
  const modal  = modals[modals.length-1];
  if(!modal) return;

  const q  = (sel) => modal.querySelector(sel);

  const mTitle = q('#mTitle');
  const mDesc  = q('#mDesc');
  const mPrice = q('#mPrice');
  const mImg   = q('#mImg');
  const mBuy   = q('#mBuyBtn');
  const mShare = q('#mShare');

  if(mTitle) mTitle.textContent = item.title || '–¢–æ–≤–∞—Ä';
  if(mDesc)  mDesc.textContent  = item.description || '';
  if(mPrice) mPrice.textContent = (item.price || 0).toFixed(2) + ' EUR';

  if(mImg){
    if(item.image){
      mImg.src = item.image;
      mImg.style.display = 'block';
    }else{
      mImg.style.display = 'none';
    }
  }

  if(mBuy){
    mBuy.onclick = ()=>buy(item.id);
  }

  if(mShare){
    const url = location.origin + location.pathname + '#item/' + item.id;
    mShare.textContent = url;
  }

  // –±–ª–æ–∫ –ø—Ä–æ–¥–∞–≤—Ü–∞ + –∫–Ω–æ–ø–∫–∞ ¬´–û—Ç–∑—ã–≤—ã¬ª
  const sellerCard   = q('#sellerCard');
  const sellerNameEl = q('#sellerName');
  const sellerStats  = q('#sellerStats');
  const dmBtn        = q('#dmSellerBtn');
  const rvBtn        = q('#viewSellerReviews');

  if(sellerCard){
    try{
      const u = await API('/api/users/'+item.sellerId+'/public');
      if(!u.error){
        sellerCard.style.display = 'block';
        const nameHtml = nickHtml(u);
        if(sellerNameEl){
          sellerNameEl.innerHTML = nameHtml + ` ‚Ä¢ –ø—Ä–æ–¥–∞–∂: ${u.stats.salesCompleted}`;
        }
        if(sellerStats){
          sellerStats.textContent = u.stats.ratingCount
            ? `‚òÖ ${u.stats.ratingAvg.toFixed(2)} (${u.stats.ratingCount})`
            : '–Ω–µ—Ç –æ—Ç–∑—ã–≤–æ–≤';
        }
        if(dmBtn) dmBtn.onclick = ()=>openDM(u.id);
        if(rvBtn) rvBtn.onclick = ()=>viewSellerReviews(u.id); // <-- –∫–Ω–æ–ø–∫–∞ ¬´–û—Ç–∑—ã–≤—ã¬ª
      }else{
        sellerCard.style.display = 'none';
      }
    }catch(e){
      sellerCard.style.display = 'none';
    }
  }

  // –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª–∫—É
  modal.style.display = 'flex';
  modal.setAttribute('aria-hidden','false');
}

// –∑–∞–∫—Ä—ã—Ç–∏–µ –∏–º–µ–Ω–Ω–æ —Ç–æ–π –º–æ–¥–∞–ª–∫–∏, –∫–æ—Ç–æ—Ä—É—é –æ—Ç–∫—Ä—ã–≤–∞–ª–∏ (–ø–æ—Å–ª–µ–¥–Ω–µ–π)
function closeModal(){
  const modals = document.querySelectorAll('#itemModal');
  const modal  = modals[modals.length-1] || modals[0];
  if(!modal) return;
  modal.style.display = 'none';
  modal.setAttribute('aria-hidden','true');
}

// ¬´–ü–æ–¥–µ–ª–∏—Ç—å—Å—è¬ª —Ç–æ–∂–µ –Ω–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–π –º–æ–¥–∞–ª–∫–µ
function shareItem(){
  const modals = document.querySelectorAll('#itemModal');
  const modal  = modals[modals.length-1] || modals[0];
  if(!modal) return;
  const mShare = modal.querySelector('#mShare');
  if(!mShare) return;
  navigator.clipboard?.writeText(mShare.textContent);
  notify('–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞',{type:'info'});
}
document.addEventListener('DOMContentLoaded', () => {
  const cardsBox = document.getElementById('cards');
  if (!cardsBox) return;

  cardsBox.addEventListener('click', (e) => {
    const card = e.target.closest('.card-item');
    if (!card) return;

    const id = card.dataset.id;
    if (!id) return;

    openItem(id);
  });
}); 

/* ===== sell wizard helpers ===== */
let WIZ = { catId:null, subId:null };
function wizGo(n){
  [...document.querySelectorAll('.wizard-steps .st')].forEach(x=>x.classList.toggle('active', Number(x.dataset.step)===n));
  for(let i=1;i<=6;i++){ S('#wiz'+i).style.display = (i===n)?'':'none'; }
  if(n===2){ // fill subs
    const subs = ALL_CATS.filter(s=>s.parentId===WIZ.catId).sort((a,b)=>(a.order||0)-(b.order||0));
    S('#wizSubs').innerHTML = subs.map(s=>`<div class="card" onclick="wizPickSub('${s.id}')"><b>${escapeHtml(s.title)}</b></div>`).join('') || '<div class="muted">–ù–µ—Ç –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏–π</div>';
  }
  if(n===6){ // preview
    const title=(S('#sellTitle').value||'').trim();
    const price=Number(S('#sellPrice').value||0);
    const cat = ALL_CATS.find(c=>c.id===WIZ.catId)?.title || '‚Äî';
    const sub = ALL_CATS.find(c=>c.id===WIZ.subId)?.title || '‚Äî';
    S('#publishPreview').innerHTML = `
      <div><b>${escapeHtml(title||'–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è')}</b></div>
      <div class="muted">–ö–∞—Ç–µ–≥–æ—Ä–∏—è: ${escapeHtml(cat)} ‚Ä¢ –ü–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏—è: ${escapeHtml(sub)}</div>
      <div class="badge" style="margin-top:6px">${price?price.toFixed(2):'0.00'} EUR</div>
      <div class="muted" style="margin-top:6px">${escapeHtml((S('#sellDesc').value||'').slice(0,140))}</div>
      <div class="muted" style="margin-top:6px">VIP: ${S('#vipFlag').checked?'–î–∞ (15 ‚ÇΩ)':'–ù–µ—Ç'}</div>
    `;
  }
}
function wizPickCat(id){ WIZ.catId=id; wizGo(2); }
function wizPickSub(id){ WIZ.subId=id; wizGo(3); }
function wizNext(){ // auto go to next visible
  const active = Number(document.querySelector('.wizard-steps .st.active')?.dataset.step||1);
  wizGo(Math.min(6, active+1));
}
function wizBack(){
  const active = Number(document.querySelector('.wizard-steps .st.active')?.dataset.step||1);
  wizGo(Math.max(1, active-1));
}

async function uploadAvatar(){
  const f = S('#meAvatarFile').files?.[0];
  if(!f) return notify('–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª',{type:'error',title:'–ê–≤–∞—Ç–∞—Ä'});
  const b64 = await compressToUnderKB(f,50);
  const r = await API('/api/me/avatar',{method:'POST',body:JSON.stringify({dataUrl:b64})});
  if(r.error) return notify(r.error,{title:'–ê–≤–∞—Ç–∞—Ä',type:'error'});
  notify('–ê–≤–∞—Ç–∞—Ä –æ–±–Ω–æ–≤–ª—ë–Ω',{type:'info'}); S('#meAvatar').src = r.avatar;
}

/* ===== sell (image compress ‚â§50KB) ===== */
S('#sellImage')?.addEventListener('change', async (e)=>{
  const f=e.target.files?.[0]; if(!f) return;
  try{ const data=await compressToUnderKB(f,50); S('#imgInfo').dataset.payload=data; S('#imgInfo').textContent='–§–æ—Ç–æ –≥–æ—Ç–æ–≤–æ ('+((b64Bytes(data)/1024)|0)+' KB)'; }
  catch{ delete S('#imgInfo').dataset.payload; S('#imgInfo').textContent='–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∂–∞—Ç—å ‚â§50KB'; }
});
function readAsDataURL(file){return new Promise((res,rej)=>{const fr=new FileReader();fr.onload=()=>res(fr.result);fr.onerror=rej;fr.readAsDataURL(file);});}
function loadImg(src){return new Promise((res,rej)=>{const i=new Image();i.onload=()=>res(i);i.onerror=rej;i.src=src;});}
function b64Bytes(d){const i=d.indexOf('base64,'); const head=i>0?i+7:0; return Math.ceil((d.length - head)*3/4);}
async function compressToUnderKB(file,limitKB){
  let data=await readAsDataURL(file); let img=await loadImg(data);
  let w=Math.min(img.width,1280),h=Math.round(img.height*(w/img.width));
  const c=document.createElement('canvas'); const ctx=c.getContext('2d'); let q=.82;
  while(true){
    c.width=w; c.height=h; ctx.drawImage(img,0,0,w,h);
    const out=c.toDataURL('image/jpeg',q);
    if(b64Bytes(out) <= limitKB*1024) return out;
    if(q>.35){ q-=.1; continue; }
    w=Math.max(320,(w*.85|0)); h=Math.max(240,(h*.85|0));
    if(w<=320 && h<=240) return out;
  }
}

/* ===== create listing (uses wizard state) ===== */
async function createListing(){
  if(!window.__me) return notify('–í–æ–π–¥–∏—Ç–µ',{title:'–¢—Ä–µ–±—É–µ—Ç—Å—è –≤—Ö–æ–¥',type:'error'});

  const categoryId = WIZ.subId || WIZ.catId || null;
  const title       = S('#sellTitle')?.value.trim() || "";
  const description = S('#sellDesc')?.value.trim() || "";
  const price       = Number(S('#sellPrice')?.value || 0);

  // –∫–∞—Ä—Ç–∏–Ω–∫–∞: –º—ã —Ä–∞–Ω–µ–µ –∫–ª–∞–ª–∏ base64 –≤ data-payload —É #imgInfo
  const image = S('#imgInfo')?.dataset?.payload || null;

  // —Ç–∏–ø + –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ
  const type  = (S('#sellType')?.value || 'single');
  const stock = type === 'stock' ? (Number(S('#sellStock')?.value || 0) | 0) : null;

  // –≤—ã–¥–∞—á–∞
  const delivery    = (document.querySelector('input[name="deliveryType"]:checked')?.value || 'manual');
  const autoPayload = (S('#autoPayload')?.value || "");

  // –¥–æ–ø—ã
  const extra = {
    data1: S('#sellData1')?.value || '',
    data2: S('#sellData2')?.value || '',
    vip:   !!S('#vipFlag')?.checked
  };

  if(!categoryId || !title || !description || !image || !Number.isFinite(price) || price <= 0){
    return notify('–ö–∞—Ç–µ–≥–æ—Ä–∏—è, –Ω–∞–∑–≤–∞–Ω–∏–µ, –æ–ø–∏—Å–∞–Ω–∏–µ, —Ü–µ–Ω–∞ –∏ —Ñ–æ—Ç–æ ‚Äî –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã',{title:'–û—à–∏–±–∫–∞',type:'error'});
  }

  const payload = { categoryId, title, description, price, image, type, stock, delivery, autoPayload, extra };

  const r = await API('/api/listings', { method:'POST', body: JSON.stringify(payload) });
  if(r?.error) return notify(r?.message || r.error, { title:'–û—à–∏–±–∫–∞', type:'error' });

  // VIP
  if(extra.vip){
    await API('/api/listings/'+encodeURIComponent(r.id)+'/vip',{method:'POST'}).catch(()=>{});
  }

  // reset + –ø–µ—Ä–µ—Ö–æ–¥
  S('#sellTitle').value=''; S('#sellDesc').value=''; S('#sellPrice').value='';
  S('#sellImage').value=''; delete S('#imgInfo').dataset.payload;
  S('#imgInfo').textContent='JPEG/PNG ‚Äî –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∂–º—ë–º –¥–æ ‚â§ 50KB';

  notify('–¢–æ–≤–∞—Ä –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω',{title:'–£—Å–ø–µ—Ö'});
  loadCatalog();
  openTab('catalog');
}

// Enter => –æ—Ç–ø—Ä–∞–≤–∏—Ç—å, Shift+Enter => –ø–µ—Ä–µ–Ω–æ—Å —Å—Ç—Ä–æ–∫–∏
document.addEventListener('DOMContentLoaded', ()=>{
  const inp = document.getElementById('chatInput');
  if(!inp) return;
  inp.addEventListener('keydown', (e)=>{
    if(e.key === 'Enter' && !e.shiftKey){
      e.preventDefault();
      sendChat();
    }
  });
});

</script>

<script>
/* ===== orders & deal buttons ===== */
async function buy(listingId){
  if(!window.__me) return notify('–í–æ–π–¥–∏—Ç–µ',{title:'–¢—Ä–µ–±—É–µ—Ç—Å—è –≤—Ö–æ–¥',type:'error'});
  const r=await API('/api/orders',{method:'POST',body:JSON.stringify({listingId})});
  if(r.error) return notify(r.error,{title:'–û—à–∏–±–∫–∞',type:'error'});
  notify('–ó–∞–∫–∞–∑ —Å–æ–∑–¥–∞–Ω: '+r.id,{type:'info'}); openTab('orders'); loadOrders();
}
async function loadOrders(){
  if(!window.__me){ S('#ordersBox').textContent='–í–æ–π–¥–∏—Ç–µ'; return; }
  const q = (S('#ordersSearch')?.value||'').trim();
  const arr = await API('/api/orders'+(q?('?q='+encodeURIComponent(q)):""));
  if(arr.error){ S('#ordersBox').textContent='–û—à–∏–±–∫–∞'; return; }
  S('#ordersBox').innerHTML = arr.map(o=>rowOrder(o)).join('') || '<div class="muted">–ù–µ—Ç —Å–¥–µ–ª–æ–∫</div>';
}
document.querySelector('#ordersSearch')?.addEventListener('input', ()=>loadOrders());

function rowOrder(o){
  const acts=[]; const me=window.__me?.id;
  if(me===o.buyerId){
    if(o.status==='pending') acts.push(btn('–û–ø–ª–∞—Ç–∏—Ç—å',`pay('${o.id}')`));
    if(o.status==='delivered' && o.sellerDone) acts.push(btn('–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –ø–æ–ª—É—á–µ–Ω–∏–µ',`confirmOrder('${o.id}')`));
    if(o.status==='completed' && !o.reviewLeft) acts.push(btn('–û—Å—Ç–∞–≤–∏—Ç—å –æ—Ç–∑—ã–≤',`leaveReview('${o.id}')`));
    acts.push(btnGhost('–ü—Ä–æ–±–ª–µ–º–∞ ‚Üí –ø–æ–¥–¥–µ—Ä–∂–∫–∞',`reportOrder('${o.id}')`));
  }
  if(me===o.sellerId){
    if(['paid','delivered'].includes(o.status)) acts.push(btn('–Ø –∑–∞–≤–µ—Ä—à–∏–ª',`confirmSeller('${o.id}')`));
    if(['paid','delivered'].includes(o.status)) acts.push(btnGhost('–û—Ñ–æ—Ä–º–∏—Ç—å –≤–æ–∑–≤—Ä–∞—Ç',`refundReq('${o.id}')`));
    acts.push(btnGhost('–ü—Ä–æ–±–ª–µ–º–∞ ‚Üí –ø–æ–¥–¥–µ—Ä–∂–∫–∞',`reportOrder('${o.id}')`));
  }
  return `<div class="card">
    <div><b>#${o.id}</b> ‚Äî ${o.price} EUR ‚Äî <span class="badge">${o.status}${o.sellerDone?' ‚úì':''}${o.refundRequested?' (refund?)':''}</span></div>
    <div class="row row-right" style="margin-top:6px">${acts.join(' ')}</div>
    <div class="row" style="gap:6px;margin-top:6px"><button class="btn" onclick="openDealChat('${o.id}')">–û—Ç–∫—Ä—ã—Ç—å —á–∞—Ç —Å–¥–µ–ª–∫–∏</button></div>
  </div>`;
}
function btn(t, on){ return `<button class="btn" onclick="${on}">${t}</button>`; }
function btnGhost(t, on){ return `<button class="btn-ghost" onclick="${on}">${t}</button>`; }

async function pay(id){
  const c=await confirmBox({title:'–û–ø–ª–∞—Ç–∞',text:'–°–ø–∏—Å–∞—Ç—å —Å—Ä–µ–¥—Å—Ç–≤–∞ —Å –±–∞–ª–∞–Ω—Å–∞ –∏ –ø–æ–º–µ—Å—Ç–∏—Ç—å –≤ —Ö–æ–ª–¥?',okText:'–û–ø–ª–∞—Ç–∏—Ç—å'});
  if(!c.ok) return;
  const r=await API('/api/orders/'+id+'/pay',{method:'POST'});
  if(r.error) return notify(r.error,{title:'–û—à–∏–±–∫–∞',type:'error'});
  notify('–û–ø–ª–∞—Ç–∞ –ø—Ä–æ—à–ª–∞'); loadOrders(); renderDealActions(id);
}
async function confirmSeller(id){
  const c=await confirmBox({title:'–ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ',text:'–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞?',okText:'–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å'});
  if(!c.ok) return;
  const r=await API('/api/orders/'+id+'/request-complete',{method:'POST'});
  if(r.error) return notify(r.error,{title:'–û—à–∏–±–∫–∞',type:'error'});
  notify('–û—Ç–º–µ—á–µ–Ω–æ –∫–∞–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ'); loadOrders(); renderDealActions(id);
}
async function refundReq(id){
  const c=await confirmBox({title:'–í–æ–∑–≤—Ä–∞—Ç',text:'–ó–∞–ø—Ä–æ—Å–∏—Ç—å –≤–æ–∑–≤—Ä–∞—Ç –ø–æ –∑–∞–∫–∞–∑—É?',okText:'–ó–∞–ø—Ä–æ—Å–∏—Ç—å'});
  if(!c.ok) return;
  const r=await API('/api/orders/'+id+'/refund-request',{method:'POST'});
  if(r.error) return notify(r.error,{title:'–û—à–∏–±–∫–∞',type:'error'});
  notify('–ó–∞–ø—Ä–æ—Å –Ω–∞ –≤–æ–∑–≤—Ä–∞—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω',{type:'info'}); loadOrders(); renderDealActions(id);
}
async function confirmOrder(id){
  const c=await confirmBox({title:'–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ',text:'–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –ø–æ–ª—É—á–µ–Ω–∏–µ –∏ –∑–∞–≤–µ—Ä—à–∏—Ç—å —Å–¥–µ–ª–∫—É?',okText:'–ó–∞–≤–µ—Ä—à–∏—Ç—å'});
  if(!c.ok) return;
  const r=await API('/api/orders/'+id+'/confirm',{method:'POST'});
  if(r.error) return notify(r.error,{title:'–û—à–∏–±–∫–∞',type:'error'});
  notify('–°–¥–µ–ª–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞'); loadOrders(); renderDealActions(id);
}
async function reportOrder(id){
  const r=await confirmBox({title:'–°–æ–æ–±—â–∏—Ç—å –æ –ø—Ä–æ–±–ª–µ–º–µ',text:'–û–ø–∏—à–∏—Ç–µ –ø—Ä–æ–±–ª–µ–º—É',prompt:true,okText:'–û—Ç–ø—Ä–∞–≤–∏—Ç—å',placeholder:'–ö—Ä–∞—Ç–∫–æ –æ–ø–∏—à–∏, —á—Ç–æ –Ω–µ —Ç–∞–∫'});
  if(!r.ok || !r.value.trim()) return;
  await API('/api/support/report',{method:'POST',body:JSON.stringify({text:r.value.trim(),orderId:id})});
  notify('–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É',{type:'info'});
}
// Paradise pay state
let PP = { uuid: null, timer: null };

async function ppCreate() {
  const amount = Number(S('#ppAmount').value || 0);
  const method = S('#ppMethod')?.value || '';

  if (!amount || amount <= 0) {
    return notify('–£–∫–∞–∂–∏ —Å—É–º–º—É –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è',{title:'–û—à–∏–±–∫–∞', type:'error'});
  }

  try {
    const r = await API('/api/pay/paradise/create', {
      method: 'POST',
      body: JSON.stringify({
        amountRub: amount,
        paymentMethod: method || undefined
      })
    });

    if (!r.ok && r.error) {
      return notify(r.message || r.error, { title:'–û—à–∏–±–∫–∞', type:'error' });
    }

    PP.uuid = r.uuid;

    if (r.redirect_url) {
      window.open(r.redirect_url, '_blank');
    }

    S('#ppStatus').textContent = '–û–∂–∏–¥–∞–µ–º –æ–ø–ª–∞—Ç—É –≤ –Ω–æ–≤–æ–π –≤–∫–ª–∞–¥–∫–µ...';

    // —á–∏—Å—Ç–∏–º —Å—Ç–∞—Ä—ã–π —Ç–∞–π–º–µ—Ä, –µ—Å–ª–∏ –±—ã–ª
    if (PP.timer) clearInterval(PP.timer);

    // –æ–ø—Ä–æ—Å —Ä–∞–∑ –≤ 25 —Å–µ–∫—É–Ω–¥
    PP.timer = setInterval(ppCheckStatus, 25000);
  } catch (e) {
    console.error(e);
    notify('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –ø–ª–∞—Ç–µ–∂–∞',{title:'–û—à–∏–±–∫–∞',type:'error'});
  }
}

async function ppCheckStatus() {
  if (!PP.uuid) return;

  try {
    const r = await API('/api/pay/paradise/status/' + encodeURIComponent(PP.uuid));
    if (!r.ok && r.error) {
      throw new Error(r.message || r.error);
    }

    const status = r.status;
    if (status === 'waiting') {
      S('#ppStatus').textContent = '–ü–ª–∞—Ç—ë–∂ –µ—â—ë –≤ –æ–∂–∏–¥–∞–Ω–∏–∏...';
      return;
    }

    if (status === 'success') {
      clearInterval(PP.timer);
      PP.timer = null;
      S('#ppStatus').textContent = '–û–ø–ª–∞—Ç–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∞';
      notify('–ë–∞–ª–∞–Ω—Å –ø–æ–ø–æ–ª–Ω–µ–Ω',{type:'success'});
      closePayModal();
      await loadWallet();   // —Ç–≤–æ—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∞—è —Ñ—É–Ω–∫—Ü–∏—è
      return;
    }

    if (status === 'error' || status === 'expired') {
      clearInterval(PP.timer);
      PP.timer = null;
      S('#ppStatus').textContent = status === 'expired'
        ? '–°—á—ë—Ç –∏—Å—Ç—ë–∫, —Å–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—ã–π'
        : '–û—à–∏–±–∫–∞ –ø–ª–∞—Ç–µ–∂–∞';
      notify('–ü–ª–∞—Ç—ë–∂ –Ω–µ –ø—Ä–æ—à—ë–ª',{type:'error'});
      return;
    }

    // –Ω–∞ –≤—Å—è–∫–∏–π
    S('#ppStatus').textContent = '–°—Ç–∞—Ç—É—Å: ' + status;
  } catch (e) {
    console.error(e);
    S('#ppStatus').textContent = '–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç—É—Å';
    notify('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ —Å—Ç–∞—Ç—É—Å–∞',{type:'error'});
  }
}

/* ===== reviews ===== */
async function leaveReview(orderId){
  const r1=await confirmBox({title:'–û—Ü–µ–Ω–∫–∞',text:'–ü–æ—Å—Ç–∞–≤—å—Ç–µ –æ—Ü–µ–Ω–∫—É (1-5)',prompt:true,okText:'–î–∞–ª–µ–µ',placeholder:'–ù–∞–ø—Ä. 5'}); if(!r1.ok) return;
  const rating=Math.max(1,Math.min(5,Number(r1.value||0)||0));
  const r2=await confirmBox({title:'–û—Ç–∑—ã–≤',text:'–¢–µ–∫—Å—Ç –æ—Ç–∑—ã–≤–∞ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)',prompt:true,okText:'–û—Ç–ø—Ä–∞–≤–∏—Ç—å',placeholder:'–ö–æ—Ä–æ—Ç–∫–æ –æ –∫–∞—á–µ—Å—Ç–≤–µ'}); if(!r2.ok) return;
  const r=await API('/api/reviews',{method:'POST',body:JSON.stringify({orderId,rating,text:r2.value||''})});
  if(r.error) return notify(r.error,{title:'–û—à–∏–±–∫–∞',type:'error'});
  notify('–°–ø–∞—Å–∏–±–æ! –û—Ç–∑—ã–≤ –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω'); loadOrders(); if(S('#itemModal').style.display==='flex') closeModal();
}
function normalizeArr(x){ if(Array.isArray(x)) return x; if(x && typeof x==='object') return Object.values(x); return []; }

async function viewSellerReviews(sellerId){
  const raw  = await API('/api/reviews?sellerId='+encodeURIComponent(sellerId));
  const list = normalizeArr(raw);
  const box  = document.getElementById('rvList');
  document.getElementById('rvTitle').textContent = '–û—Ç–∑—ã–≤—ã –ø—Ä–æ–¥–∞–≤—Ü–∞';
  box.innerHTML = list.length ? list.map(r=>reviewCardHTML(r)).join('') : '<div class="muted">–ù–µ—Ç –æ—Ç–∑—ã–≤–æ–≤</div>';
  openReviewsModal();
}

function reviewCardHTML(r){
  const date  = new Date(r.ts||Date.now()).toLocaleString();
  const stars = '‚òÖ'.repeat(r.rating) + '‚òÜ'.repeat(5-r.rating);
  const item  = r.item || {};

  const itemHtml = `
    <div class="card" style="margin-top:6px">
      <div class="row" style="gap:8px; align-items:center">
        ${item.image?`<img src="${item.image}" style="width:64px;height:48px;object-fit:cover;border-radius:8px;border:1px solid var(--border)">`:''}
        <div>
          <div><b>${escapeHtml(item.title||'–¢–æ–≤–∞—Ä')}</b></div>
          <div class="muted">${(item.price||0).toFixed(2)} EUR</div>
        </div>
        ${item.listingId ? `<div class="row-right" style="margin-left:auto"><button class="btn-ghost" onclick="openItem('${item.listingId}')">–û—Ç–∫—Ä—ã—Ç—å</button></div>` : ''}
      </div>
    </div>`;

  const canReply = window.__me && window.__me.id === r.sellerId;
  const replyBlock = r.reply ? `
    <div class="card" style="background:#fafaff; border-color:#e9e5ff; margin-top:6px">
      <div class="muted" style="font-size:12px">–û—Ç–≤–µ—Ç –ø—Ä–æ–¥–∞–≤—Ü–∞ ‚Ä¢ ${new Date(r.reply.ts).toLocaleString()}</div>
      <div style="white-space:pre-wrap">${escapeHtml(r.reply.text||'')}</div>
    </div>`
  : (canReply ? `
      <div class="row row-right" style="margin-top:6px">
        <button class="btn-ghost" onclick="replyReviewPrompt('${r.id}')">–û—Ç–≤–µ—Ç–∏—Ç—å</button>
      </div>` : '');

  return `
    <div class="card" style="margin:8px 0">
      <div><b>${stars}</b> <span class="muted" style="margin-left:6px">${date}</span></div>
      <div style="white-space:pre-wrap; margin-top:4px">${escapeHtml(r.text||'')}</div>
      ${itemHtml}
      ${replyBlock}
    </div>`;
}

async function replyReviewPrompt(id){
  const r = await confirmBox({title:'–û—Ç–≤–µ—Ç –Ω–∞ –æ—Ç–∑—ã–≤', text:'–í–∞—à –æ—Ç–≤–µ—Ç', prompt:true, okText:'–û—Ç–ø—Ä–∞–≤–∏—Ç—å', placeholder:'–°–ø–∞—Å–∏–±–æ –∑–∞ –ø–æ–∫—É–ø–∫—É!'});
  if(!r.ok || !r.value.trim()) return;
  const resp = await API('/api/reviews/'+encodeURIComponent(id)+'/reply',{method:'POST', body: JSON.stringify({ text: r.value.trim() })});
  if(resp?.error) return notify(resp.error,{title:'–û—Ç–≤–µ—Ç –Ω–∞ –æ—Ç–∑—ã–≤', type:'error'});
  notify('–û—Ç–≤–µ—Ç –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω',{type:'success'});
  // –ø–µ—Ä–µ—Ä–∏—Å—É–µ–º —Ç–µ–∫—É—â–∏–π –º–æ–¥–∞–ª (—É–∑–Ω–∞—ë–º sellerId –∏–∑ –æ—Ç–≤–µ—Ç–∞)
  const sellerId = resp.review?.sellerId || window.__me?.id;
  if(sellerId) viewSellerReviews(sellerId);
}

function openReviewsModal(){ const m=S('#reviewsModal'); m.style.display='flex'; m.setAttribute('aria-hidden','false'); }
function closeReviewsModal(){ const m=S('#reviewsModal'); m.style.display='none'; m.setAttribute('aria-hidden','true'); }

async function loadMyReviews(){
  if(!window.__me) return; const list=await API('/api/reviews?sellerId='+encodeURIComponent(window.__me.id));
  const avg=list?.length? (list.reduce((s,x)=>s+x.rating,0)/list.length).toFixed(2) : '‚Äî';
  S('#reviewsBox').innerHTML = `–ú–æ–∏ –æ—Ç–∑—ã–≤—ã: ${list?.length||0} ‚Ä¢ —Å—Ä–µ–¥–Ω—è—è: ${avg}`;
}

/* ===== chat: inbox + live + photo upload ===== */
let es=null, currentRoom={type:'global'}, esInbox=null;
function openSupport(){ currentRoom={type:'support'}; connectSSE(); S('#roomTitle').textContent='–ü–æ–¥–¥–µ—Ä–∂–∫–∞'; renderDealActions(); }

async function loadInbox(){
  const list = await API('/api/chat/inbox');
  const box = S('#chatListBox');
  const ids = [];

  (list||[]).forEach(it=>{
    if(it.room.startsWith('dm:')){
      const [,a,b] = it.room.split(':');
      const peer = (a===window.__me?.id ? b : a);
      ids.push(peer);
    }
    if(it.room.startsWith('support:')){
      const uid = it.room.split(':')[1];
      ids.push(uid);
    }
  });
  await lookupUsers(ids);

  box.innerHTML = (list||[]).map(it=>{
    let name = roomTitle(it.room);
    const init = name.charAt(0).toUpperCase();
    let avaHtml = `<div class="avatar">${init}</div>`;

    if(it.room.startsWith('dm:')){
      const [,a,b] = it.room.split(':');
      const peer = (a===window.__me?.id ? b : a);
      const uimg = userCache.get(peer)?.avatar || "https://i.ibb.co/Y4HVSvPV/Group-1-2.png";
      avaHtml = `<img class="avatar" src="${uimg}" alt="">`;
    }

    return `<div class="chatItem" onclick="openRoomById('${it.room}')">
      ${avaHtml}
      <div>
        <div class="title">${escapeHtml(name)}</div>
        <div class="prev">${escapeHtml((it.lastFrom==='system'?'[–°–∏—Å—Ç–µ–º–∞] ':'')+(it.lastText||''))}</div>
      </div>
    </div>`;
  }).join('') || '<div class="muted" style="padding:8px">–ù–µ—Ç –¥–∏–∞–ª–æ–≥–æ–≤</div>';
}

function roomTitle(room){
  if(room==='global') return '–û–±—â–∏–π —á–∞—Ç';
  if(room.startsWith('support:')){ const uid=room.split(':')[1]; const u=userCache.get(uid)||{nickname:uid,verified:false}; return '–ü–æ–¥–¥–µ—Ä–∂–∫–∞ ‚Äî '+(u.nickname||uid); }
  if(room.startsWith('dm:')){ const [,a,b]=room.split(':'); const peer=(a===window.__me?.id?b:a); const u=userCache.get(peer)||{nickname:peer,verified:false}; return '–õ–° '+(u.nickname||peer); }
  if(room.startsWith('order:')) return '–°–¥–µ–ª–∫–∞ '+room.slice(6);
  if(room.startsWith('user:')) return '–°–∏—Å—Ç–µ–º–Ω—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è';
  return room;
}
function openRoomById(room){
  if(room==='global') return openRoom('global');
  if(room.startsWith('support:')){ const uid=room.split(':')[1]; return openSupportRoom(uid); }
  if(room.startsWith('order:')) return openDealChat(room.slice(6));
  if(room.startsWith('dm:')){ const [,a,b]=room.split(':'); const peer=(a===window.__me?.id?b:a); return openDM(peer); }
  if(room.startsWith('user:')){ currentRoom={type:'inbox'}; connectSSE(); S('#roomTitle').textContent='–°–∏—Å—Ç–µ–º–Ω—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è'; renderDealActions(); }
}
function openRoom(type){ currentRoom={type}; connectSSE(); S('#roomTitle').textContent = type==='support'?'–ü–æ–¥–¥–µ—Ä–∂–∫–∞':'–û–±—â–∏–π —á–∞—Ç'; renderDealActions(); }
function openSupportRoom(userId){ currentRoom={type:'support',peerId:userId}; connectSSE(); S('#roomTitle').textContent='–ü–æ–¥–¥–µ—Ä–∂–∫–∞ ‚Äî '+(userCache.get(userId)?.nickname||userId); renderDealActions(); }
function openDM(peerId){ currentRoom={type:'dm',peerId}; connectSSE(); S('#roomTitle').textContent='–õ–∏—á–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è —Å '+(userCache.get(peerId)?.nickname||peerId); renderDealActions(); }
function openDealChat(orderId){ currentRoom={type:'order',orderId}; connectSSE(); S('#roomTitle').textContent='–ß–∞—Ç —Å–¥–µ–ª–∫–∏ #'+orderId; renderDealActions(orderId); }
function currentRoomId(){
  if(currentRoom.type==='global') return 'global';
  if(currentRoom.type==='support') return 'support:'+(currentRoom.peerId||window.__me?.id||'');
  if(currentRoom.type==='dm') return 'dm:'+[window.__me?.id,currentRoom.peerId].sort().join(':');
  if(currentRoom.type==='order') return 'order:'+currentRoom.orderId;
  if(currentRoom.type==='inbox') return 'user:'+window.__me?.id;
  return 'global';
}
function connectSSE(){
  if(es) es.close(); S('#chatBox').innerHTML='';
  const params=new URLSearchParams(); params.set('type',currentRoom.type);
  if(currentRoom.peerId) params.set('peerId',currentRoom.peerId);
  if(currentRoom.orderId) params.set('orderId',currentRoom.orderId);
  es=new EventSource('/api/chat/stream?'+params.toString());
  es.onmessage=(e)=>{
    try{
      const d=JSON.parse(e.data);
      if(d.type==='history') d.items.forEach(it=>appendMsg(it,{silent:true}));
      if(d.type==='message') appendMsg(d.item,{silent:false});
    }catch{}
  };
  bootInboxFeed();
}

function uName(id){ const u=userCache.get(id); return u?u.nickname||id:id; }
function appendMsg(m,{silent=false}={}){
  if(m.fromUserId && !userCache.has(m.fromUserId)) lookupUsers([m.fromUserId]);
  const mine=window.__me && m.fromUserId===window.__me.id;
  const t=new Date(m.ts).toLocaleTimeString();
  let body = escapeHtml(m.text||'');
  if(m.kind==='image' && m.mediaUrl){ body = `[—Ñ–æ—Ç–æ] <a href="${m.mediaUrl}" target="_blank">–û—Ç–∫—Ä—ã—Ç—å</a>`; }
  const pre=m.system?'[–°–∏—Å—Ç–µ–º–∞] ':'';
  const from = m.system?'':(uName(m.fromUserId)+': ');
  S('#chatBox').insertAdjacentHTML('beforeend', `<div class="chatLine ${mine?'mine':''}">[${t}] ${pre}${escapeHtml(from)}${body}</div>`);
  S('#chatBox').scrollTop=S('#chatBox').scrollHeight;

  // –∑–≤—É–∫: —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —ç—Ç–æ –ù–ï –∏—Å—Ç–æ—Ä–∏—è, —Å–æ–æ–±—â–µ–Ω–∏–µ –Ω–µ –º–æ—ë,
  // –∏ –ª–∏–±–æ –æ–Ω–æ —Å–∏—Å—Ç–µ–º–Ω–æ–µ, –ª–∏–±–æ –ø—Ä–∏—à–ª–æ –ù–ï –≤ —Ç–µ–∫—É—â—É—é –∫–æ–º–Ω–∞—Ç—É, –ª–∏–±–æ –≤–∫–ª–∞–¥–∫–∞ —Å–∫—Ä—ã—Ç–∞
  try{
    const inSameRoom = (m.room && m.room===currentRoomId());
    const shouldSound = !silent && !mine && (m.system || !inSameRoom || document.hidden);
    if(shouldSound) playNotifySound();
  }catch{}
}

async function sendChat(){
  const txt=(S('#chatInput').value||'').trim();
  const files = (S('#chatFile').files||[]);
  if(!txt && (!files || files.length===0)) return;

  // text first
  if(txt){
    const body={ type: currentRoom.type, text: txt };
    if(currentRoom.peerId) body.peerId=currentRoom.peerId;
    if(currentRoom.orderId) body.orderId=currentRoom.orderId;
    const r=await API('/api/chat/send',{method:'POST',body:JSON.stringify(body)});
    if(r.error) return notify(r.error,{title:'–û—à–∏–±–∫–∞',type:'error'});
    S('#chatInput').value='';
  }

  // images (only in order room, up to 5 total per deal; server will enforce)
  if(files && files.length){
    if(currentRoom.type!=='order'){ notify('–§–æ—Ç–æ –º–æ–∂–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å —Ç–æ–ª—å–∫–æ –≤ —á–∞—Ç–µ —Å–¥–µ–ª–∫–∏',{title:'–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ',type:'error'}); S('#chatFile').value=''; return; }
    for(let i=0;i<files.length;i++){
      const b64=await compressToUnderKB(files[i],30);
      const r=await API('/api/chat/upload',{method:'POST',body:JSON.stringify({orderId: currentRoom.orderId, dataUrl: b64})});
      if(r.error) { notify(r.error,{title:'–§–æ—Ç–æ',type:'error'}); break; }
    }
    S('#chatFile').value='';
  }
  notify('–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ',{type:'info',timeout:1200});
}
function bootInboxFeed(){
  if(esInbox) return;
  esInbox=new EventSource('/api/chat/stream?type=inbox');
  esInbox.onmessage=(e)=>{ try{ const d=JSON.parse(e.data); if(d.type==='message' && d.item && d.item.fromUserId==='system'){ notify(d.item.text,{title:'–°–∏—Å—Ç–µ–º–∞',type:'info',timeout:4000}); loadInbox(); playNotifySound(); } }catch{} };
}

async function loadMyListings(){
  if(!window.__me){ S('#myListingsBox').textContent='–í–æ–π–¥–∏—Ç–µ'; return; }
  const arr = await API('/api/my/listings');
  if(arr?.error){ S('#myListingsBox').textContent='–û—à–∏–±–∫–∞'; return; }
  if(!arr || !arr.length){ S('#myListingsBox').textContent='–ü–æ–∫–∞ –ø—É—Å—Ç–æ'; return; }
S('#myListingsBox').innerHTML = arr.map(l=>`
  <div class="item-row">
    <div style="flex:1;min-width:0">
      <div><b>${escapeHtml(l.title)}</b></div>
      <div class="muted">
        ${fmtCur(l.price)} ‚Ä¢ ${escapeHtml(l.type||'single')}
        ${l.type==='stock' ? (' ‚Ä¢ –æ—Å—Ç.‚âà ' + Math.max(0,(Number(l.stock||0)-Number(l.sold||0)))) : ''}
        ${(l.status==='moderation'||l.moderation==='pending') ? ' ‚Ä¢ <span class="badge">–Ω–∞ –º–æ–¥–µ—Ä–∞—Ü–∏–∏</span>' : ''}
        ${l.status==='rejected' ? ' ‚Ä¢ <span class="badge">–æ—Ç–∫–ª–æ–Ω—ë–Ω</span>' : ''}
      </div>
    </div>
    <div class="row">
      <button class="btn-ghost" onclick="editListing('${l.id}')">–ò–∑–º.</button>
      <button class="btn-ghost" onclick="deleteListing('${l.id}')">–£–¥–∞–ª–∏—Ç—å</button>
    </div>
  </div>
`).join('');

}
async function deleteListing(id){
  const c=await confirmBox({title:'–£–¥–∞–ª–∏—Ç—å —Ç–æ–≤–∞—Ä?', text:id, okText:'–£–¥–∞–ª–∏—Ç—å'});
  if(!c.ok) return;
  const r=await API('/api/listings/'+encodeURIComponent(id),{method:'DELETE'});
  if(r?.error) return notify(r.error,{title:'–û—à–∏–±–∫–∞',type:'error'});
  notify('–£–¥–∞–ª–µ–Ω–æ'); loadMyListings(); loadCatalog();
}
async function editListing(id){
  // –º–∏–Ω–∏-—Ä–µ–¥–∞–∫—Ç–æ—Ä: —Ü–µ–Ω–∞, —Ç–∏–ø, —Å—Ç–æ–∫
  const p1=await confirmBox({title:'–¶–µ–Ω–∞', text:'–ù–æ–≤–∞—è —Ü–µ–Ω–∞ (RUB)', prompt:true, okText:'–î–∞–ª–µ–µ'});
  if(!p1.ok) return;
  const price = Number(p1.value||0);
  const p2=await confirmBox({title:'–¢–∏–ø', text:'single/multi/stock', prompt:true, okText:'–î–∞–ª–µ–µ', placeholder:'single'});
  if(!p2.ok) return;
  const type = (p2.value||'single').trim();
  let stock=null;
  if(type==='stock'){
    const p3=await confirmBox({title:'–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ', text:'–®—Ç—É–∫ –≤—Å–µ–≥–æ', prompt:true, okText:'–°–æ—Ö—Ä–∞–Ω–∏—Ç—å', placeholder:'10'});
    if(!p3.ok) return; stock = Number(p3.value||0)|0;
  }
  const body = { price, type, stock };
  const r=await API('/api/listings/'+encodeURIComponent(id),{method:'PUT',body:JSON.stringify(body)});
  if(r?.error) return notify(r.error,{title:'–û—à–∏–±–∫–∞',type:'error'});
  notify('–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ'); loadMyListings(); loadCatalog();
}

/* ===== deal contextual buttons in chat ===== */
function renderDealActions(orderId){
  const wrap = S('#dealActions');
  if(!wrap) return;
  wrap.innerHTML = '';

  if(currentRoom.type !== 'order') return;

  const me = window.__me?.id;
  API('/api/orders').then(list=>{
    const o = (list||[]).find(x=>x.id===orderId);
    if(!o) return;

    const buttons = []; // <-- –Ω–µ btns

    if(me === o.sellerId){
      if(['paid','delivered'].includes(o.status)) buttons.push(btn('–Ø –∑–∞–≤–µ—Ä—à–∏–ª', `confirmSeller('${o.id}')`));
      if(['paid','delivered'].includes(o.status)) buttons.push(btnGhost('–û—Ñ–æ—Ä–º–∏—Ç—å –≤–æ–∑–≤—Ä–∞—Ç', `refundReq('${o.id}')`));
      buttons.push(btnGhost('–ü—Ä–æ–±–ª–µ–º–∞ ‚Üí –∞–¥–º–∏–Ω—ã', `reportOrder('${o.id}')`));
    } else if(me === o.buyerId){
      if(o.status==='delivered' && o.sellerDone) buttons.push(btn('–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –ø–æ–ª—É—á–µ–Ω–∏–µ', `confirmOrder('${o.id}')`));
      if(o.status==='completed' && !o.reviewLeft) buttons.push(btn('–û—Å—Ç–∞–≤–∏—Ç—å –æ—Ç–∑—ã–≤', `leaveReview('${o.id}')`));
      buttons.push(btnGhost('–ü—Ä–æ–±–ª–µ–º–∞ ‚Üí –∞–¥–º–∏–Ω—ã', `reportOrder('${o.id}')`));
    }

    wrap.innerHTML = buttons.join('');
  }).catch(()=>{ /* no-op */ });
}

/* ===== support tasks (desk) ===== */
async function loadTasks(){
  const me = window.__me; if(!me) return;
  const isSupport = (me.roles||[]).includes('support') || (me.roles||[]).includes('admin') || (me.nickname||'').toLowerCase()==='mimimitya';
  S('#supportDesk').style.display = isSupport ? '' : 'none';
  if(!isSupport){ S('#tasksBox').textContent='–ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞'; return; }

  const list = await API('/api/support/tasks');
  if(!list || typeof list !== 'object'){ S('#tasksBox').textContent = '–û—à–∏–±–∫–∞'; return; }

  const items = Object.values(list); // ensure –º–∞—Å—Å–∏–≤

  S('#tasksBox').innerHTML = items.map(t=>{
    const createdBy = t.createdBy || t.payload?.userId || '';
    const orderId   = t.payload?.orderId || '';
    // 1) –µ—Å–ª–∏ —ç—Ç–æ –∑–∞–¥–∞—á–∞ –ø–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–º—É –∑–∞–∫–∞–∑—É ‚Äî –≤–µ–¥—ë–º –≤ —á–∞—Ç —Å–¥–µ–ª–∫–∏
    // 2) –∏–Ω–∞—á–µ ‚Äî –≤ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π support-—á–∞—Ç —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º (support:<userId>)
    const chatBtn = orderId
      ? `<button class="btn" onclick="openDealChat('${orderId}')">–í —á–∞—Ç —Å–¥–µ–ª–∫–∏</button>`
      : (createdBy ? `<button class="btn" onclick="openSupportRoom('${createdBy}')">–í —á–∞—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</button>` : '');

    return `
      <div class="card">
        <div><b>#${t.id}</b> ‚Äî ${escapeHtml(t.status)} ‚Äî ${escapeHtml(t.payload?.kind||'‚Äî')}
          ${orderId ? (' (order ' + escapeHtml(orderId) + ')') : ''}</div>
        <div class="muted">${escapeHtml(t.payload?.text || t.payload?.note || '')}</div>
        <div class="row" style="gap:6px;margin-top:6px">
          ${chatBtn}
          ${t.status==='open' ? `<button class="btn" onclick="claimTask('${t.id}')">–í–∑—è—Ç—å</button>` : ''}
          ${t.status!=='resolved' ? `<button class="btn-ghost" onclick="resolveTask('${t.id}')">–ó–∞–∫—Ä—ã—Ç—å</button>` : ''}
        </div>
      </div>
    `;
  }).join('') || '<div class="muted">–ù–µ—Ç –∑–∞–¥–∞—á</div>';
}

async function openTaskChat(id){
  const t = await API('/api/support/tasks/'+encodeURIComponent(id));
  if(t?.payload?.orderId){
    openDealChat(t.payload.orderId);
    openTab('chat');
  } else if (t?.createdBy){
    openSupportRoom(t.createdBy);
    openTab('chat');
  } else {
    notify('–î–ª—è —ç—Ç–æ–π –∑–∞–¥–∞—á–∏ –Ω–µ—Ç –ø—Ä–∏–≤—è–∑–∞–Ω–Ω–æ–≥–æ —á–∞—Ç–∞',{type:'info'});
  }
}

async function hideChat(orderId){
  const r = await API('/api/chat/hide',{method:'POST', body:JSON.stringify({room:'order:'+orderId})});
  if(r?.ok){
    notify('–ß–∞—Ç —Å–∫—Ä—ã—Ç',{type:'info'});
    loadInbox();
    openRoom('global');
  } else {
    notify(r?.error||'–û—à–∏–±–∫–∞',{title:'–û—à–∏–±–∫–∞',type:'error'});
  }
}

async function claimTask(id){ const r=await API('/api/support/tasks/'+id+'/claim',{method:'POST'}); if(r.error) return notify(r.error,{title:'–û—à–∏–±–∫–∞',type:'error'}); notify('–ó–∞–¥–∞—á–∞ –≤–∑—è—Ç–∞'); loadTasks(); }
async function resolveTask(id){ const res=await confirmBox({title:'–†–µ—à–µ–Ω–∏–µ',text:'–û–ø–∏—à–∏ —Ä–µ—à–µ–Ω–∏–µ',prompt:true,okText:'–ó–∞–∫—Ä—ã—Ç—å'}); if(!res.ok) return; const r=await API('/api/support/tasks/'+id+'/resolve',{method:'POST',body:JSON.stringify({resolution:res.value||''})}); if(r.error) return notify(r.error,{title:'–û—à–∏–±–∫–∞',type:'error'}); notify('–ó–∞–¥–∞—á–∞ –∑–∞–∫—Ä—ã—Ç–∞'); loadTasks(); }
async function report(){ const r=await confirmBox({title:'–°–æ–æ–±—â–∏—Ç—å –æ –ø—Ä–æ–±–ª–µ–º–µ',text:'–û–ø–∏—à–∏—Ç–µ –ø—Ä–æ–±–ª–µ–º—É',prompt:true,okText:'–û—Ç–ø—Ä–∞–≤–∏—Ç—å',placeholder:'–ö—Ä–∞—Ç–∫–æ –æ–ø–∏—à–∏, —á—Ç–æ –Ω–µ —Ç–∞–∫'}); if(!r.ok||!r.value.trim()) return; await API('/api/support/report',{method:'POST',body:JSON.stringify({text:r.value.trim()})}); notify('–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É',{type:'info'}); }

async function loadModQueue(){
  const me = window.__me; if(!me) return;
  const isAdmin = (me.roles||[]).includes('admin') || (me.roles||[]).includes('support') || (me.nickname||'').toLowerCase()==='mimimitya';
  if(!isAdmin){ S('#modQueueBox').textContent='–ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞'; return; }

  const list = await API('/api/admin/modqueue');
  S('#modQueueBox').innerHTML = (list||[]).map(l=>`
    <div class="card">
      <div><b>${escapeHtml(l.title)}</b> ‚Ä¢ ${fmtCur(l.price)} ‚Ä¢ –ø—Ä–æ–¥–∞–≤–µ—Ü: ${escapeHtml(l.sellerId)}</div>
      <div class="muted" style="margin-top:6px">${escapeHtml((l.description||'').slice(0,160))}</div>
      <div class="row" style="gap:6px;margin-top:8px">
        <button class="btn" onclick="approveListing('${l.id}')">–û–¥–æ–±—Ä–∏—Ç—å</button>
        <button class="btn-ghost" onclick="rejectListing('${l.id}')">–û—Ç–∫–ª–æ–Ω–∏—Ç—å</button>
      </div>
    </div>
  `).join('') || '<div class="muted">–û—á–µ—Ä–µ–¥—å –ø—É—Å—Ç–∞</div>';
}
async function approveListing(id){
  const r = await API('/api/admin/listings/'+encodeURIComponent(id)+'/moderate',
    {method:'POST', body:JSON.stringify({action:'approve'})});
  if(r?.error) return notify(r.error,{title:'–ú–æ–¥–µ—Ä–∞—Ü–∏—è',type:'error'});
  notify('–û–¥–æ–±—Ä–µ–Ω–æ'); loadModQueue(); loadCatalog();
}
async function rejectListing(id){
  const rr = await confirmBox({title:'–ü—Ä–∏—á–∏–Ω–∞ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è', text:'–£–∫–∞–∂–∏ –ø—Ä–∏—á–∏–Ω—É', prompt:true, okText:'–û—Ç–∫–ª–æ–Ω–∏—Ç—å'});
  if(!rr.ok) return;
  const r = await API('/api/admin/listings/'+encodeURIComponent(id)+'/moderate',
    {method:'POST', body:JSON.stringify({action:'reject', reason: rr.value||''})});
  if(r?.error) return notify(r.error,{title:'–ú–æ–¥–µ—Ä–∞—Ü–∏—è',type:'error'});
  notify('–û—Ç–∫–ª–æ–Ω–µ–Ω–æ'); loadModQueue();
}

/* ===== wallet ===== */
async function loadWallet(){ const r=await API('/api/wallet'); if(r?.error){ S('#walletBox').textContent='–û—à–∏–±–∫–∞'; return;} S('#walletBox').textContent = `–î–æ—Å—Ç—É–ø–Ω–æ: ${(r.available||0).toFixed(2)} ‚Ä¢ –•–æ–ª–¥: ${(r.hold||0).toFixed(2)}`; }
async function depositReq(){ const r1=await confirmBox({title:'–ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ',text:'–°—É–º–º–∞, EUR',prompt:true,okText:'–û—Ç–ø—Ä–∞–≤–∏—Ç—å'}); if(!r1.ok) return; const amount=Number(r1.value||0); if(!amount) return; const r=await API('/api/wallet/deposit-request',{method:'POST',body:JSON.stringify({amount})}); if(r.error) return notify(r.error,{title:'–û—à–∏–±–∫–∞',type:'error'}); notify('–ó–∞—è–≤–∫–∞ –Ω–∞ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏–µ —Å–æ–∑–¥–∞–Ω–∞',{type:'info'}); }
async function withdrawReq(){ const r1=await confirmBox({title:'–í—ã–≤–æ–¥',text:'–°—É–º–º–∞, EUR',prompt:true,okText:'–û—Ç–ø—Ä–∞–≤–∏—Ç—å'}); if(!r1.ok) return; const amount=Number(r1.value||0); if(!amount) return; const r=await API('/api/wallet/withdraw-request',{method:'POST',body:JSON.stringify({amount})}); if(r.error) return notify(r.error,{title:'–û—à–∏–±–∫–∞',type:'error'}); notify('–ó–∞—è–≤–∫–∞ –Ω–∞ –≤—ã–≤–æ–¥ —Å–æ–∑–¥–∞–Ω–∞',{type:'info'}); }

/* ===== ADMIN: join/pay/refund & config sound ===== */
function adminJoinDeal(){ const id=(S('#adminDealId').value||'').trim(); if(!id) return; openDealChat(id); openTab('chat'); }
async function adminPayDeal(){
  const id=(S('#adminDealId').value||'').trim(); if(!id) return;
  const role=S('#adminDealRole').value;
  const r=await API('/api/admin/orders/'+encodeURIComponent(id)+'/pay',{method:'POST',body:JSON.stringify({as:role})});
  if(r.error) return notify(r.error,{title:'–û—à–∏–±–∫–∞',type:'error'}); notify('–û–ø–ª–∞—á–µ–Ω–æ –∞–¥–º–∏–Ω–æ–º',{type:'info'});
}
async function adminRefundDeal(){
  const id=(S('#adminDealId').value||'').trim(); if(!id) return;
  const r=await API('/api/admin/orders/'+encodeURIComponent(id)+'/refund',{method:'POST'});
  if(r.error) return notify(r.error,{title:'–û—à–∏–±–∫–∞',type:'error'}); notify('–í–æ–∑–≤—Ä–∞—Ç –æ—Ñ–æ—Ä–º–ª–µ–Ω',{type:'info'});
}
async function saveNotifySound(){
  const url=(S('#soundUrl').value||'').trim(); const r=await API('/api/admin/config',{method:'POST',body:JSON.stringify({notifySound:url})});
  if(r.error) return notify(r.error,{title:'–û—à–∏–±–∫–∞',type:'error'}); notify('–ó–≤—É–∫ —Å–æ—Ö—Ä–∞–Ω—ë–Ω');
}

/* ===== RuKassa front (calls our server proxy) =====
let RK = { invoiceId:null, cooldown:0, t:null };

function openPayModal(){ const m=S('#payModal'); if(m){ m.style.display='flex'; m.setAttribute('aria-hidden','false'); } }
function closePayModal(){ const m=S('#payModal'); if(m){ m.style.display='none'; m.setAttribute('aria-hidden','true'); } }

function rkStartCooldown(sec){
  RK.cooldown = sec;
  const b1=S('#rkIPaidBtn'), b2=S('#payIPaidBtn');
  const sync = ()=>{
    const txt = RK.cooldown>0?`–Ø –æ–ø–ª–∞—Ç–∏–ª (${RK.cooldown}s)`:'–Ø –æ–ø–ª–∞—Ç–∏–ª';
    [b1,b2].forEach(b=>{ if(b){ b.disabled = RK.cooldown>0; b.textContent = txt; }});
  };
  sync();
  if(RK.t) clearInterval(RK.t);
  RK.t=setInterval(()=>{
    RK.cooldown--; if(RK.cooldown<=0){ clearInterval(RK.t); RK.t=null; }
    sync();
  },1000);
}

async function rkCreate(){
  const amount=Number(S('#rkAmount').value||0);
  const currency=S('#rkCurrency').value||'RUB';
  if(!amount){ notify('–°—É–º–º–∞ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–∞',{title:'–û—à–∏–±–∫–∞',type:'error'}); return; }

  // –¢–≤–æ–π –±—ç–∫–µ–Ω–¥ —Å–æ–∑–¥–∞—ë—Ç —Å—á—ë—Ç –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç payUrl + paymentId/–Ω–æ–º–µ—Ä
  const r = await API('/api/pay/rukassa/create',{method:'POST',body:JSON.stringify({amount,currency})});
  if(r?.error){ notify(r.error,{title:'–û–ø–ª–∞—Ç–∞',type:'error'}); return; }

  RK.invoiceId = r.invoiceId || r.paymentId || r.id;
  if(!RK.invoiceId){ notify('–ù–µ—Ç –Ω–æ–º–µ—Ä–∞ –ø–ª–∞—Ç–µ–∂–∞',{title:'–û–ø–ª–∞—Ç–∞',type:'error'}); return; }

  // –æ—Ç–∫—Ä—ã–≤–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É –æ–ø–ª–∞—Ç—ã –∏ –º–æ–¥–∞–ª–∫—É –æ–∂–∏–¥–∞–Ω–∏—è
  if(r.payUrl) window.open(r.payUrl,'_blank','noopener');
  openPayModal();
  rkStartCooldown(15);

  // —Å—Ç–∞—Ç—É—Å –ø–æ–¥ –ø–æ–ª–µ–º —Ç–æ–∂–µ –ø–æ–∫–∞–∂–µ–º
  if(S('#rkStatus')) S('#rkStatus').textContent = '–°—á—ë—Ç: '+RK.invoiceId;
}

async function rkIPaid(){
  if(!RK.invoiceId){ notify('–°–Ω–∞—á–∞–ª–∞ —Å–æ–∑–¥–∞–π—Ç–µ —Å—á—ë—Ç',{title:'–û–ø–ª–∞—Ç–∞',type:'error'}); return; }

  // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á–µ—Ä–µ–∑ –Ω–∞—à –ø—Ä–æ–∫—Å–∏ –∫ FK /v1/orders
  const resp = await API('/api/pay/fk/status?paymentId='+encodeURIComponent(RK.invoiceId));
  if(resp?.error){ notify(resp.error,{title:'–û–ø–ª–∞—Ç–∞',type:'error'}); return; }

  const paid = resp?.status==='paid';
  const msg = paid ? '–û–ø–ª–∞—Ç–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∞' : '–ü–ª–∞—Ç—ë–∂ –ø–æ–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω';
  if(S('#rkStatus')) S('#rkStatus').textContent = msg;
  if(S('#rkStatusModal')) S('#rkStatusModal').textContent = msg;

  if(paid){
    notify('–ë–∞–ª–∞–Ω—Å –ø–æ–ø–æ–ª–Ω–µ–Ω',{type:'success'});
    closePayModal();
    await loadWallet();
  }else{
    notify('–ü–æ–ø—Ä–æ–±—É–π –µ—â—ë —á–µ—Ä–µ–∑ –ø–∞—Ä—É —Å–µ–∫—É–Ω–¥',{type:'info'});
  }
}

  –°–µ—Ä–≤–µ—Ä —Ö—Ä–∞–Ω–∏—Ç –∫–ª—é—á–∏ –∏ –¥–µ–ª–∞–µ—Ç –∑–∞–ø—Ä–æ—Å—ã –∫ https://lk.rukassa.io/api/v1
*/
let RK = { invoiceId:null, cooldown:0, t:null };
async function rkCreate(){
  const amount=Number(S('#rkAmount').value||0); const currency=S('#rkCurrency').value||'RUB';
  if(!amount) return notify('–°—É–º–º–∞ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–∞',{title:'–û—à–∏–±–∫–∞',type:'error'});
  const r=await API('/api/pay/rukassa/create',{method:'POST',body:JSON.stringify({amount,currency})});
  if(r.error) return notify(r.error,{title:'RuKassa',type:'error'});
  RK.invoiceId = r.invoiceId; S('#rkStatus').textContent='–°—á—ë—Ç —Å–æ–∑–¥–∞–Ω: '+r.invoiceId;
  // –æ—Ç–∫—Ä—ã—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É –æ–ø–ª–∞—Ç—ã
  if(r.payUrl) window.open(r.payUrl,'_blank');
  // –≤–∫–ª—é—á–∏—Ç—å –∫—É–ª–¥–∞—É–Ω 15—Å
  rkStartCooldown(15);
}
function rkStartCooldown(sec){
  RK.cooldown=sec; S('#rkIPaidBtn').disabled=true; S('#rkIPaidBtn').textContent=`–Ø –æ–ø–ª–∞—Ç–∏–ª (${RK.cooldown}s)`;
  if(RK.t) clearInterval(RK.t);
  RK.t=setInterval(()=>{
    RK.cooldown--; if(RK.cooldown<=0){ clearInterval(RK.t); S('#rkIPaidBtn').disabled=false; S('#rkIPaidBtn').textContent='–Ø –æ–ø–ª–∞—Ç–∏–ª'; }
    else S('#rkIPaidBtn').textContent=`–Ø –æ–ø–ª–∞—Ç–∏–ª (${RK.cooldown}s)`;
  },1000);
}
async function rkIPaid(){
  if(!RK.invoiceId) return notify('–°–Ω–∞—á–∞–ª–∞ —Å–æ–∑–¥–∞–π—Ç–µ —Å—á—ë—Ç',{title:'RuKassa',type:'error'});
  const r=await API('/api/pay/rukassa/status?invoiceId='+encodeURIComponent(RK.invoiceId));
  if(r.error) return notify(r.error,{title:'RuKassa',type:'error'});
  S('#rkStatus').textContent='–°—Ç–∞—Ç—É—Å: '+r.status;
  if(r.status==='paid' || r.status==='success'){ notify('–û–ø–ª–∞—Ç–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∞',{type:'success'}); await loadWallet(); }
  else notify('–ü–ª–∞—Ç—ë–∂ –µ—â—ë –Ω–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥—ë–Ω',{type:'info'});
}

/* ===== notification sound ===== */
let notifyAudio=null;
async function loadNotifySound(){
  try{
    const cfg = await API('/api/admin/config'); // –¥–æ—Å—Ç—É–ø–Ω–æ –≤—Å–µ–º, –≤–µ—Ä–Ω—ë—Ç –±–µ–∑ —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã—Ö –ø–æ–ª–µ–π
    if(cfg?.notifySound){ notifyAudio = new Audio(cfg.notifySound); }
  }catch{}
}
function playNotifySound(){ try{ if(notifyAudio){ notifyAudio.currentTime=0; notifyAudio.play().catch(()=>{});} }catch{} }

/* ===== boot ===== */
async function initHome(){ await loadCategories(); await loadCatalog(); await loadOrders(); await loadFee(); await loadNotifySound(); }
function hideDDOnClickOutside(){ document.addEventListener('click', (e)=>{ const dd=S('#catalogDD'); const panel=S('#ddPanel'); if(!dd.contains(e.target)) panel.classList.remove('show'); }); }
document.addEventListener('DOMContentLoaded', async ()=>{
  hideDDOnClickOutside();
  await refreshMe();
  openTab('catalog');
  initHome();
});

/* ===== ADMIN config/fees reused ===== */
async function loadFee(){
  const me=window.__me; if(!me) return;
  const isAdmin=(me.roles||[]).includes('admin')||(me.nickname||'').toLowerCase()==='mimimitya';
  if(!isAdmin){ S('#feeView').textContent='–ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞'; return; }
  const cfg=await API('/api/admin/config'); if(cfg.error){ S('#feeView').textContent='–û—à–∏–±–∫–∞'; return; }
  S('#feeView').textContent='–¢–µ–∫—É—â–∞—è –∫–æ–º–∏—Å—Å–∏—è: '+((cfg.fees?.marketplace||0.08)*100).toFixed(1)+'%';
}
async function saveFee(){ const v=Number(S('#feeInput').value||0)/100; const r=await API('/api/admin/config',{method:'POST',body:JSON.stringify({fees:{marketplace:v}})}); if(r.error) return notify(r.error,{title:'–û—à–∏–±–∫–∞',type:'error'}); notify('–ö–æ–º–∏—Å—Å–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞'); loadFee(); }
async function renderCatsAdmin(){ let cats=await API('/api/categories'); if(!Array.isArray(cats)) cats=[]; S('#catsAdmin').innerHTML = cats.map(c=>`<div class="row" style="justify-content:space-between"><div>${escapeHtml(c.title)} <span class="muted">(${c.id}${c.parentId?(' ‚Üê '+c.parentId):''}${typeof c.order==='number'?(' ‚Ä¢ '+c.order):''})</span></div><div class="row"><button class="btn-ghost" onclick="catEdit('${c.id}')">–ò–∑–º.</button><button class="btn-ghost" onclick="catDel('${c.id}')">–£–¥.</button></div></div>`).join('') || '–ù–µ—Ç –∫–∞—Ç–µ–≥–æ—Ä–∏–π'; }
async function catAdd(){ const title=S('#catTitle').value.trim(); const parentId=(S('#catParent').value.trim()||null)||null; const order=Number(S('#catOrder').value||0)|0; if(!title) return; const r=await API('/api/admin/category',{method:'POST',body:JSON.stringify({title,parentId,order})}); if(r.error) return notify(r.error,{title:'–û—à–∏–±–∫–∞',type:'error'}); S('#catTitle').value=''; S('#catParent').value=''; S('#catOrder').value=''; notify('–ö–∞—Ç–µ–≥–æ—Ä–∏—è –¥–æ–±–∞–≤–ª–µ–Ω–∞'); loadCategories(); renderCatsAdmin(); }
async function catDel(id){ const c=await confirmBox({title:'–£–¥–∞–ª–∏—Ç—å?',text:id}); if(!c.ok) return; const r=await API('/api/admin/category/'+encodeURIComponent(id),{method:'DELETE'}); if(r.error) return notify(r.error,{title:'–û—à–∏–±–∫–∞',type:'error'}); notify('–£–¥–∞–ª–µ–Ω–æ'); renderCatsAdmin(); loadCategories(); }
async function catEdit(id){
  const cats = await API('/api/categories');
  const cur = (Array.isArray(cats)?cats:[]).find(x=>x.id===id);
  if(!cur) return;
  const n1 = await confirmBox({title:'–ù–∞–∑–≤–∞–Ω–∏–µ', text:'–ù–æ–≤–æ–µ –∏–º—è', prompt:true, okText:'–î–∞–ª–µ–µ', placeholder:cur.title});
  if(!n1.ok) return;
  const n2 = await confirmBox({title:'parentId', text:'–ù–æ–≤—ã–π parentId (–ø—É—Å—Ç–æ ‚Äî –≤–µ—Ä—Ö–Ω–∏–π —É—Ä–æ–≤–µ–Ω—å)', prompt:true, okText:'–î–∞–ª–µ–µ', placeholder:cur.parentId||''});
  if(!n2.ok) return;
  const n3 = await confirmBox({title:'–ü–æ—Ä—è–¥–æ–∫', text:'order (—á–∏—Å–ª–æ, —á–µ–º –º–µ–Ω—å—à–µ ‚Äî –≤—ã—à–µ)', prompt:true, okText:'–°–æ—Ö—Ä–∞–Ω–∏—Ç—å', placeholder:String(cur.order||0)});
  if(!n3.ok) return;
  const order = Number(n3.value||0)|0;
  const r = await API('/api/admin/category/'+encodeURIComponent(id), { method:'PUT', body: JSON.stringify({ title: n1.value || cur.title, parentId: (n2.value||'').trim() || null, order })});
  if(r.error) return notify(r.error,{title:'–û—à–∏–±–∫–∞',type:'error'});
  notify('–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ'); renderCatsAdmin(); loadCategories();
}
async function applyRole(){ const id=S('#roleUserId').value.trim(); const [kind,role]=S('#roleAction').value.split(':'); const body=kind==='add'?{add:role}:{remove:role}; const r=await API('/api/admin/users/'+encodeURIComponent(id)+'/role',{method:'POST',body:JSON.stringify(body)}); if(r.error) return notify(r.error,{title:'–û—à–∏–±–∫–∞',type:'error'}); notify('–†–æ–ª–∏: '+(r.roles||[]).join(', ')); }
async function banUser(){ const id=S('#roleUserId').value.trim(); if(!id) return; const r=await API('/api/admin/users/'+id+'/ban',{method:'POST'}); if(r.error) return notify(r.error,{title:'–û—à–∏–±–∫–∞',type:'error'}); notify('BAN ‚úì'); }
async function unbanUser(){ const id=S('#roleUserId').value.trim(); if(!id) return; const r=await API('/api/admin/users/'+id+'/unban',{method:'POST'}); if(r.error) return notify(r.error,{title:'–û—à–∏–±–∫–∞',type:'error'}); notify('UNBAN ‚úì'); }
async function adjustBalance(){ const userId=S('#balUserId').value.trim(); const amount=Number(S('#balAmount').value||0); const reason=S('#balReason').value||'adjustment'; if(!userId||!amount) return notify('userId –∏ —Å—É–º–º–∞',{title:'–û—à–∏–±–∫–∞',type:'error'}); const r=await API('/api/admin/balance/adjust',{method:'POST',body:JSON.stringify({userId,amount,reason})}); if(r.error) return notify(r.error,{title:'–û—à–∏–±–∫–∞',type:'error'}); S('#balResult').textContent='–ë–∞–ª–∞–Ω—Å: '+r.balance.available+' (hold '+r.balance.hold+')'; notify('–û–ø–µ—Ä–∞—Ü–∏—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∞'); }

/* ===== expose for console ===== */
Object.assign(window, {
  openTab, goAuth, login, logout, register,
  toggleCatalogDD, renderCatDD, pickCat, pickSub,
  loadCategories, loadCatalog, openItem, closeModal, shareItem, createListing,
  buy, pay, confirmSeller, refundReq, confirmOrder, renderDealActions,
  loadInbox, openRoom, openSupport, openSupportRoom, openDM, openDealChat, sendChat, report,
  leaveReview, viewSellerReviews,
  depositReq, withdrawReq, loadWallet,
  loadFee, saveFee, catAdd, renderCatsAdmin, catDel, catEdit,
  applyRole, banUser, unbanUser, adjustBalance,
  // admin deal helpers
  adminJoinDeal, adminPayDeal, adminRefundDeal,
  // RuKassa
  rkCreate, rkIPaid, loadMyListings, deleteListing, editListing 
});
</script>

<script>
/* global error handlers ‚Äî –æ—Å—Ç–∞–≤–ª—è–µ–º –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏ */
window.addEventListener('error', e => { alert('JS error: ' + e.message); console.error(e.error||e.message); });
window.addEventListener('unhandledrejection', e => { alert('Promise error: ' + (e.reason?.message || e.reason)); console.error(e.reason); });
</script>
<!-- END PART 2/2 -->

<script>
/* === UX Patch v1: mobile chat focus + split auth pages + no blocking alerts === */
(function(){
  const $ = (s)=>document.querySelector(s);
  const isMobile = ()=> window.matchMedia('(max-width: 880px)').matches;

  /* ---------- CHAT: –º–æ–±–∏–ª—å–Ω—ã–π —Ñ–æ–∫—É—Å-—Ä–µ–∂–∏–º ---------- */
  const chatWrap = ()=>$('.chatWrap');
  const chatHeaderLeft = ()=>$('.chatView .row div:first-child');

  function mobileChatMode(on){
    const wrap = chatWrap(); if(!wrap) return;
    const enable = !!on && isMobile();
    wrap.classList.toggle('mobile-chat', enable);

    // –∫–Ω–æ–ø–∫–∞ "–ù–∞–∑–∞–¥" (—Å–æ–∑–¥–∞—ë–º –æ–¥–∏–Ω —Ä–∞–∑)
    let backBtn = $('#chatBackBtn');
    if(!backBtn){
      const host = chatHeaderLeft();
      if(host){
        backBtn = document.createElement('button');
        backBtn.id = 'chatBackBtn';
        backBtn.className = 'btn-ghost mobile-only chatBack';
        backBtn.textContent = '‚Üê –ù–∞–∑–∞–¥';
        backBtn.onclick = chatBackToList;
        host.prepend(backBtn); // –ø–µ—Ä–µ–¥ –∑–∞–≥–æ–ª–æ–≤–∫–æ–º –∫–æ–º–Ω–∞—Ç—ã
      }
    }

    if(enable){
      // –ø—Ä–æ–∫—Ä—É—Ç–∏—Ç—å –≤–Ω–∏–∑, —á—Ç–æ–±—ã –≤–∏–¥–µ—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è
      setTimeout(()=>{ const box=$('#chatBox'); if(box){ box.scrollTop = box.scrollHeight; } }, 0);
    }
  }
  function chatBackToList(){ mobileChatMode(false); }
  window.chatBackToList = chatBackToList;

  // ‚Äî –ø–∞—Ç—á–∏–º –ø–µ—Ä–µ—Ö–æ–¥—ã, —á—Ç–æ–±—ã –Ω–∞ –º–æ–±–∏–ª–µ —á–∞—Ç –æ—Ç–∫—Ä—ã–≤–∞–ª—Å—è –ø–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω–æ
  const _openDM = window.openDM;
  window.openDM = function(peerId){
    openTab('chat');
    _openDM(peerId);
    if(isMobile()) mobileChatMode(true);
  };
  const _openDealChat = window.openDealChat;
  window.openDealChat = function(orderId){
    openTab('chat');
    _openDealChat(orderId);
    if(isMobile()) mobileChatMode(true);
  };
  const _openSupport = window.openSupport;
  window.openSupport = function(){
    openTab('chat');
    _openSupport();
    if(isMobile()) mobileChatMode(true);
  };
  const _openSupportRoom = window.openSupportRoom;
  window.openSupportRoom = function(uid){
    openTab('chat');
    _openSupportRoom(uid);
    if(isMobile()) mobileChatMode(true);
  };
  const _openRoomById = window.openRoomById;
  window.openRoomById = function(room){
    _openRoomById(room);
    if(isMobile()) mobileChatMode(true);
  };

  // –ø—Ä–∏ —Ä–µ—Å–∞–π–∑–µ –Ω–∞ –¥–µ—Å–∫—Ç–æ–ø ‚Äî –≤—ã—Ö–æ–¥–∏–º –∏–∑ —Ñ–æ–∫—É—Å-—Ä–µ–∂–∏–º–∞
  window.addEventListener('resize', ()=>{ if(!isMobile()) mobileChatMode(false); });

  /* ---------- AUTH: —Ä–∞–∑–Ω–µ—Å—Ç–∏ –í—Ö–æ–¥ / –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é –Ω–∞ –æ—Ç–¥–µ–ª—å–Ω—ã–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã ---------- */
function getAuthNodes(){
  const $ = (s)=>document.querySelector(s);
  const root = $('#screen-auth');
  const reg = $('#regEmail')?.closest('.card');     // –∫–∞—Ä—Ç–∞ "–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è"
  const login = $('#loginEmail')?.closest('.card'); // –∫–∞—Ä—Ç–∞ "–í—Ö–æ–¥"
  const profile = $('#meBox')?.closest('.card');    // –∫–∞—Ä—Ç–∞ "–ü—Ä–æ—Ñ–∏–ª—å"
  const wallet = $('#walletBox')?.closest('.card'); // –∫–∞—Ä—Ç–∞ "–ë–∞–ª–∞–Ω—Å"
  return { root, reg, login, profile, wallet };
}
  function ensureAuthLinks(){
    const { reg, login } = getAuthNodes();
    if(login && !login.querySelector('.auth-switch')){
      const d=document.createElement('div');
      d.className='muted auth-switch'; d.style.marginTop='8px';
      d.innerHTML = `–ù–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞? <a href="#" onclick="openRegister();return false;">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</a>`;
      login.appendChild(d);
    }
    if(reg && !reg.querySelector('.auth-switch')){
      const d=document.createElement('div');
      d.className='muted auth-switch'; d.style.marginTop='8px';
      d.innerHTML = `–£–∂–µ –µ—Å—Ç—å –∞–∫–∫–∞—É–Ω—Ç? <a href="#" onclick="openLogin();return false;">–í–æ–π—Ç–∏</a>`;
      reg.appendChild(d);
    }
  }
function showAuth(sub){ // 'login' | 'register' | 'profile'
  const { reg, login, profile, wallet } = getAuthNodes();
  const me = window.__me;

  // –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –Ω–∏—á–µ–≥–æ –Ω–µ –ª–æ–º–∞–µ–º –≤–Ω—É—Ç—Ä–∏ –∫–∞—Ä—Ç–æ—á–µ–∫ (–≤–ª–æ–∂–µ–Ω–Ω—ã–µ .card –æ—Å—Ç–∞–≤–ª—è–µ–º –∫–∞–∫ –µ—Å—Ç—å)
  if(me){
    if(reg) reg.style.display='none';
    if(login) login.style.display='none';
    if(profile) profile.style.display='';
    if(wallet) wallet.style.display='';
    return;
  }
  // –Ω–µ –∑–∞–ª–æ–≥–∏–Ω–µ–Ω
  if(sub==='register'){
    if(reg) reg.style.display='';
    if(login) login.style.display='none';
  }else{
    if(reg) reg.style.display='none';
    if(login) login.style.display='';
  }
  if(profile) profile.style.display='none';
  if(wallet) wallet.style.display='none';
}
  window.openLogin = function(){ openTab('auth'); showAuth('login'); };
  window.openRegister = function(){ openTab('auth'); showAuth('register'); };

  // –ü–∞—Ç—á–∏–º openTab: –¥–ª—è auth ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω—É–∂–Ω—É—é ¬´—Å—Ç—Ä–∞–Ω–∏—Ü—É¬ª, –¥–ª—è chat ‚Äî —Å–ø–∏—Å–æ–∫ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
// –ø–µ—Ä–µ—Ö–≤–∞—Ç openTab —á—Ç–æ–±—ã –ø–æ–¥—Å–≤–µ—á–∏–≤–∞—Ç—å –∞–∫—Ç–∏–≤–Ω—É—é
const _openTab = window.openTab;
window.openTab = function(k, ...rest){
  _openTab && _openTab(k, ...rest);
  setActiveMobileTab(k);
  // —Å–∫—Ä–æ–ª–ª –∫ –Ω–∞—á–∞–ª—É –¥–ª—è –æ—â—É—â–µ–Ω–∏—è ¬´—ç–∫—Ä–∞–Ω–∞¬ª
  if (window.matchMedia('(max-width: 860px)').matches) {
    window.scrollTo({top: 0, behavior: 'smooth'});
  }
};

  /* ---------- –æ—Ç–∫–ª—é—á–∞–µ–º –±–ª–æ–∫–∏—Ä—É—é—â–∏–µ alert –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º toasts ---------- */
  window.alert = function(msg){ try{ notify(String(msg),{title:'–°–æ–æ–±—â–µ–Ω–∏–µ',type:'info',timeout:3500}); }catch(e){} };
  // –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–æ–¥—Å–∫–∞–∑–∫–∏ –≤ –∫–æ–Ω—Å–æ–ª–∏, –±–µ–∑ –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫:
  window.addEventListener('error', e => { notify(e.message||'–û—à–∏–±–∫–∞',{title:'JS error',type:'error',timeout:4000}); console.error(e.error||e.message); });
  window.addEventListener('unhandledrejection', e => { notify((e.reason?.message||String(e.reason)||'Promise error'),{title:'Promise error',type:'error',timeout:4000}); console.error(e.reason); });

  /* ---------- –ø–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ---------- */
  document.addEventListener('DOMContentLoaded', ()=>{
    // –µ—Å–ª–∏ —Å—Ä–∞–∑—É –æ—Ç–∫—Ä—ã—Ç–∞ –≤–∫–ª–∞–¥–∫–∞ auth ‚Äî —Ä–∞–∑—Ä—É–ª–∏–º –ø–æ–¥—Å—Ç—Ä–∞–Ω–∏—Ü—É
    if(typeof currentTab!=='undefined' && currentTab==='auth'){
      showAuth(window.__me ? 'profile' : 'login');
    }
  });
})();
</script>
<!-- OM_MOBILE_PATCH_v3 ‚Äî paste before </body>. No imports, no modules. -->
<script>
(function(){
  const isMobile = () => window.matchMedia('(max-width: 820px)').matches;

  // –ì–¥–µ —É –Ω–∞—Å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –ø—Ä–æ—Ñ–∏–ª—è? –ü–µ—Ä–µ–±–∏—Ä–∞–µ–º —Ä–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω—ë–Ω–Ω—ã–µ —Å–µ–ª–µ–∫—Ç–æ—Ä—ã.
  const ACCOUNT_SELECTORS = [
    '#account', '[data-tab-content="account"]', '[data-screen="account"]',
    '#tab-account', '.account-page', '#content-account'
  ];

  function qs(sel){ return document.querySelector(sel); }
  function qsa(sel){ return Array.from(document.querySelectorAll(sel)); }

  // –ë–µ–∑–æ–ø–∞—Å–Ω–æ –¥–æ—Å—Ç–∞—Ç—å "—Ç–µ–∫—É—â–µ–≥–æ —é–∑–µ—Ä–∞" –∏–∑ –≥–ª–æ–±–∞–ª–æ–≤
  function getMe(){
    const g = window;
    const me = g.me || g.user || g.state?.me || g.gState?.me || g.appState?.me || {};
    if (!me.id) me.id = me.uid || me.userId || me._id || me.id;
    return me;
  }

  // –ü–æ–¥–≥—Ä—É–∑–∫–∞ –º–æ–∏—Ö —Ç–æ–≤–∞—Ä–æ–≤ (–ø—ã—Ç–∞–µ–º—Å—è –∏–∑ –ø–∞–º—è—Ç–∏; –∏–Ω–∞—á–µ ‚Äî –∏–∑ API)
  async function loadMyProducts(me){
    let list = gList();
    if (list.length){
      return filterMine(list, me);
    }
    try{
      let r = await fetch('/api/my-products', {credentials:'include'});
      if (r.ok){ return await r.json(); }
    }catch(e){}
    try{
      let r = await fetch('/api/products', {credentials:'include'});
      if (r.ok){ let arr = await r.json(); return filterMine(arr, me); }
    }catch(e){}
    return [];
  }
  function gList(){
    const g = window;
    return (g.myProducts || g.products || g.allProducts || g.catalog || []);
  }
  function filterMine(arr, me){
    const id = me.id || me.uid || me.userId;
    return (arr || []).filter(p=>{
      const sellerId = p.sellerId || p.userId || p.ownerId || p.byUser || p.seller?.id;
      return String(sellerId) === String(id);
    });
  }

  // –ú–æ–Ω—Ç–∏—Ä—É–µ–º –Ω–æ–≤—ã–π –º–æ–±–∏–ª—å–Ω—ã–π –ø—Ä–æ—Ñ–∏–ª—å
  async function mountMobileProfile(){
    if (!isMobile()) return;

    // –Ω–∞—Ö–æ–¥–∏–º –∫–æ—Ä–µ–Ω—å ‚Äú—Å—Ç–∞—Ä–æ–≥–æ‚Äù –ø—Ä–æ—Ñ–∏–ª—è
    const host = ACCOUNT_SELECTORS.map(qs).find(Boolean);
    if (!host) return;

    // —Ä–µ–∞–ª—å–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∏ –±–∞–ª–∞–Ω—Å
    const me = getMe();
    const balance = +((me.balance?.available ?? me.balance ?? 0) || 0);
    const hold    = +((me.balance?.hold ?? me.hold ?? 0) || 0);
    const rating  = +((me.ratingAvg ?? me.rating ?? 0) || 0);
    const reviews = +(me.reviewsCount ?? me.reviews ?? 0);
    const avatar  = me.avatar || me.photo || me.picture || '';

    // –ú–æ–∏ —Ç–æ–≤–∞—Ä—ã
    const myItems = await loadMyProducts(me);

    // –ü–æ–º–µ—á–∞–µ–º, —á—Ç–æ –ø–æ–∫–∞–∑–∞–Ω –º–æ–±–∏–ª—å–Ω—ã–π –ø—Ä–æ—Ñ–∏–ª—å (—á—Ç–æ–±—ã —Å–ø—Ä—è—Ç–∞—Ç—å —Å—Ç–∞—Ä—ã–π —á–µ—Ä–µ–∑ CSS)
    document.body.classList.add('m-profile');

    // –û–¥–∏–Ω –∫–æ—Ä–Ω–µ–≤–æ–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –ø–æ–¥ –Ω–æ–≤—ã–π UI
    host.setAttribute('data-profile-root', 'legacy'); // –ø—Ä–∏–≥–æ–¥–∏—Ç—Å—è –¥–ª—è CSS-—Å–∫—Ä—ã—Ç–∏—è
    host.innerHTML =
    `<div id="mobileProfile">
        <div class="card">
          <div class="top">
            <div class="avatar">${avatar ? `<img src="${avatar}" alt="">` : ''}</div>
            <div style="flex:1">
              <div class="balance">
                <div class="v" id="mp-balance">${balance.toLocaleString('ru-RU')} ‚ÇΩ</div>
              </div>
              <div style="opacity:.7;margin-top:2px">
                <span id="mp-rating">${'‚òÖ'.repeat(Math.round(rating)) || '‚Äî'}</span>
                <span style="margin-left:8px">${reviews ? reviews+' –æ—Ç–∑—ã–≤–æ–≤' : '–û—Ç–∑—ã–≤—ã'}</span>
              </div>
            </div>
            <button class="gear" id="mp-gear" aria-label="–ù–∞—Å—Ç—Ä–æ–π–∫–∏">‚öôÔ∏è</button>
          </div>
        </div>

        <div class="card">
          <div class="section-title">–ë–∞–ª–∞–Ω—Å</div>
          <div>–î–æ—Å—Ç—É–ø–Ω–æ: <b id="mp-bal-av">${balance.toLocaleString('ru-RU')} ‚ÇΩ</b> ‚Ä¢ –•–æ–ª–¥: <b id="mp-bal-hold">${hold.toLocaleString('ru-RU')} ‚ÇΩ</b></div>
          <div class="actions">
            <button class="btn primary" id="mp-deposit">–ü–æ–ø–æ–ª–Ω–∏—Ç—å</button>
            <button class="btn secondary" id="mp-withdraw">–í—ã–≤–µ—Å—Ç–∏</button>
          </div>
        </div>

        <div class="card">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div class="section-title">–ú–æ–∏ —Ç–æ–≤–∞—Ä—ã</div>
            <a class="chip-btn secondary" id="mp-all-products">–í—Å–µ</a>
          </div>
          <div class="mini-grid" id="mp-grid"></div>
        </div>
     </div>

     <div id="mpSheet">
       <div class="sheet">
         <div class="line"><b>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</b><button id="mpClose">‚úï</button></div>
         <div class="line"><span>–¢–µ–º–∞</span>
            <div>
              <button data-theme="light">–°–≤–µ—Ç–ª–∞—è</button>
              <button data-theme="dark">–¢—ë–º–Ω–∞—è</button>
              <button data-theme="system">–°–∏—Å—Ç–µ–º–Ω–∞—è</button>
            </div>
         </div>
         <div class="line"><span>–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤ Telegram</span>
            <button id="mpTg">–û—Ç–∫—Ä—ã—Ç—å</button>
         </div>
       </div>
     </div>`;

    // –†–µ–Ω–¥–µ—Ä –ø–ª–∏—Ç–æ–∫ —Ç–æ–≤–∞—Ä–æ–≤ –±–µ–∑ –æ–ø–∏—Å–∞–Ω–∏–π
    const grid = qs('#mp-grid');
    const cut = (s, n) => (s||'').trim().slice(0, n) + ((s||'').length>n?'‚Ä¶':'');
    const priceOf = p => (p.price?.value ?? p.price ?? p.amount ?? 0);
    const currency = p => (p.price?.currency ?? p.currency ?? 'RUB');

    grid.innerHTML = (myItems||[]).slice(0, 12).map(p=>{
      const thumb = p.image || p.img || (p.images && p.images[0]) || '';
      const title = cut(p.title || p.name || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è', 42);
      const pr    = priceOf(p);
      const cur   = currency(p);
      const sAva  = avatar ? `<img src="${avatar}" alt="">` : '';
      return `
        <div class="mini-card" style="position:relative">
          ${thumb?`<img src="${thumb}" style="width:100%;height:180px;object-fit:cover;border-radius:14px">`:''}
          <div class="price">${pr.toLocaleString('ru-RU')} ${cur}</div>
          <div class="title" style="margin-top:10px">${title}</div>
          <div class="seller">${sAva}<div>${me.name || me.login || '–Ø'}</div></div>
          <div style="display:flex;gap:8px;margin-top:10px">
            <a class="chip-btn secondary" href="#p_${p.id || p._id || ''}">–ü–æ–¥—Ä–æ–±–Ω–µ–µ</a>
            <a class="chip-btn" href="#buy_${p.id || p._id || ''}">–ö—É–ø–∏—Ç—å</a>
          </div>
        </div>`;
    }).join('') || `<div style="opacity:.7">–¢–æ–≤–∞—Ä–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç.</div>`;

    // –ö–Ω–æ–ø–∫–∏ –±–∞–ª–∞–Ω—Å–∞ ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏, –µ—Å–ª–∏ –µ—Å—Ç—å
    qs('#mp-deposit')?.addEventListener('click', ()=>{
      (window.openDeposit || window.deposit || window.showDeposit || alert)('–ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ');
    });
    qs('#mp-withdraw')?.addEventListener('click', ()=>{
      (window.openWithdraw || window.withdraw || window.showWithdraw || alert)('–í—ã–≤–æ–¥');
    });
    qs('#mp-all-products')?.addEventListener('click', ()=>{
      (window.openTab && window.openTab('sell')) || (location.hash='#sell');
    });

    // –®–µ—Å—Ç–µ—Ä—ë–Ω–∫–∞ ‚Üí –º–æ–¥–∞–ª–∫–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫
    const sheet = qs('#mpSheet');
    const openSheet = ()=> sheet.style.display='block';
    const closeSheet = ()=> sheet.style.display='none';
    qs('#mp-gear')?.addEventListener('click', openSheet);
    qs('#mpClose')?.addEventListener('click', closeSheet);
    sheet?.addEventListener('click', (e)=>{ if(e.target===sheet) closeSheet(); });

    // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ç–µ–º—ã (–º–∏–Ω–∏–º–∞–ª—å–Ω–æ, —á–µ—Ä–µ–∑ data-theme –Ω–∞ <html>)
    qsa('#mpSheet [data-theme]').forEach(b=>{
      b.addEventListener('click', ()=>{
        document.documentElement.dataset.theme = b.dataset.theme;
        closeSheet();
      });
    });
    // Telegram –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ ‚Äî –≤—ã–∑—ã–≤–∞–µ–º —Ç–æ, —á—Ç–æ —É —Ç–µ–±—è —É–∂–µ –µ—Å—Ç—å
    qs('#mpTg')?.addEventListener('click', ()=>{
      (window.openTelegramBind || window.bindTelegram || alert)('–û—Ç–∫—Ä–æ–π—Ç–µ Telegram-–±–æ—Ç–∞');
    });
  }

  // –ü–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–µ–º –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≤–∫–ª–∞–¥–æ–∫, —á—Ç–æ–±—ã –º–æ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å –Ω–æ–≤—ã–π –ø—Ä–æ—Ñ–∏–ª—å
  // –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π openTab, –µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å
  if (typeof window.openTab === 'function'){
    const originalOpenTab = window.openTab;
    window.openTab = function(tab){
      const res = originalOpenTab.apply(this, arguments);
      if (isMobile() && /account|–∞–∫–∫–∞—É–Ω—Ç|profile|–ø—Ä–æ—Ñ–∏–ª/i.test(String(tab))){
        // –¥–∞—ë–º –æ—Ç—Ä–∏—Å–æ–≤–∞—Ç—å—Å—è —Å—Ç–∞—Ä–æ–º—É, –∑–∞—Ç–µ–º –∑–∞–º–µ–Ω—è–µ–º
        requestAnimationFrame(mountMobileProfile);
      }
      if (isMobile() && /chat|—á–∞—Ç—ã|support|–ø–æ–¥–¥–µ—Ä–∂/i.test(String(tab))){
        requestAnimationFrame(setupChatEnter);
      }
      return res;
    };
  } else {
    // fallback: –µ—Å–ª–∏ –Ω–µ—Ç openTab ‚Äî –ø—Ä–æ–±—É–µ–º –Ω–∞ –∑–∞–≥—Ä—É–∑–∫–µ
    document.addEventListener('DOMContentLoaded', ()=>{
      if (isMobile()) mountMobileProfile();
    });
  }

  // CHAT: –æ—Ç–ø—Ä–∞–≤–∫–∞ –ø–æ Enter, —Å–∫—Ä—ã—Ç—å –∫–Ω–æ–ø–∫—É ¬´–û—Ç–ø—Ä–∞–≤–∏—Ç—å¬ª –Ω–∞ –º–æ–±–∏–ª–µ, –∑–∞–º–µ–Ω–∏—Ç—å –∫–Ω–æ–ø–∫—É —Ñ–∞–π–ª–æ–≤
  const CHAT_INPUT_SELECTORS = [
    'textarea[name="message"]', '#chat-message', 'textarea[data-role="chat-input"]', '.chat-input textarea'
  ];
  const CHAT_SEND_SELECTORS = ['.chat-send-btn', '#send', 'button[data-role="chat-send"]'];
  const CHAT_FILES_SELECTORS = ['.chat-files-btn', 'label[for="file"]', 'button[data-role="chat-files"]'];

  function setupChatEnter(){
    if (!isMobile()) return;
    const input = CHAT_INPUT_SELECTORS.map(qs).find(Boolean);
    if (!input) return;

    // –Ω–∞–≤–µ—à–∏–≤–∞–µ–º –æ–¥–∏–Ω —Ä–∞–∑
    if (!input.dataset._enterBind){
      input.dataset._enterBind = '1';
      input.addEventListener('keydown', (e)=>{
        if (e.key === 'Enter' && !e.shiftKey){
          e.preventDefault();
          const sendBtn = CHAT_SEND_SELECTORS.map(qs).find(Boolean);
          if (sendBtn) sendBtn.click();
        }
      });
    }
    // –æ—Ñ–æ—Ä–º–∏—Ç—å –∫–Ω–æ–ø–∫—É —Ñ–∞–π–ª–æ–≤ –∫–∞–∫ —Å–∫—Ä–µ–ø–∫—É
    const filesBtn = CHAT_FILES_SELECTORS.map(qs).find(Boolean);
    if (filesBtn) filesBtn.classList.add('chat-files-btn');
    const sendBtn = CHAT_SEND_SELECTORS.map(qs).find(Boolean);
    if (sendBtn) sendBtn.classList.add('chat-send-btn'); // —á—Ç–æ–±—ã —Å–ø—Ä—è—Ç–∞–ª—Å—è —á–µ—Ä–µ–∑ CSS
  }

  // –ï—Å–ª–∏ —É–∂–µ –≤ —á–∞—Ç–µ ‚Äî —Å—Ä–∞–∑—É –ø—Ä–∏–º–µ–Ω–∏–º
  document.addEventListener('DOMContentLoaded', setupChatEnter);
})();
</script>
<script>
const catalogState = {
  items: [],
  nextCursor: null,
  fetching: false,
  maxDom: 100
};

async function fetchCatalogPage(){
  if(catalogState.fetching) return;
  catalogState.fetching = true;
  try{
    const q = new URLSearchParams();
    if(catalogState.nextCursor) q.set('cursor', catalogState.nextCursor);
    q.set('limit', 50);
    const r = await fetch('/api/listings?'+q.toString());
    const j = await r.json();
    const page = Array.isArray(j) ? j : (j.items||[]);
    if(Array.isArray(j)) {
      // —Å—Ç–∞—Ä—ã–π –æ—Ç–≤–µ—Ç ‚Äî –æ–¥–∏–Ω —Ä–∞–∑ —Å–∫–æ–Ω–≤–µ—Ä—Ç–∏–º
      catalogState.items = catalogState.items.concat(j);
      catalogState.nextCursor = null;
    } else {
      catalogState.items = catalogState.items.concat(page);
      catalogState.nextCursor = j.nextCursor || null;
    }
    renderCatalogWindow();
  }finally{
    catalogState.fetching = false;
  }
}

function renderCatalogWindow(){
  const box = document.getElementById('cards');
  if(!box) return;

  // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–µ –∫–∞—Ä—Ç–æ—á–∫–∏ –≤ –Ω–∏–∑
  for(const it of catalogState.items.slice(box.children.length)){
    const el = document.createElement('div');
    el.className = 'card card-item';
    el.innerHTML = `
      <img class="media" src="${it.image||''}" alt="">
      <div class="body">
        ${it.isVip ? '<span class="badge">VIP</span>' : ''}
        <div class="title">${escapeHtml(it.title||'')}</div>
        <div class="price">${(it.price||0).toFixed(2)} ‚ÇΩ</div>
        <div class="meta">#${it.id.slice(-6)}</div>
      </div>`;
    box.appendChild(el);
  }

  // –ï—Å–ª–∏ –∫–∞—Ä—Ç–æ—á–µ–∫ > maxDom ‚Äî —É–¥–∞–ª—è–µ–º –≤–µ—Ä—Ö–Ω–∏–µ
  while(box.children.length > catalogState.maxDom){
    box.removeChild(box.firstChild);
  }
}

function escapeHtml(s){return String(s).replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;' }[m]))}

function initCatalogWindow(){
  catalogState.items = [];
  catalogState.nextCursor = null;
  document.getElementById('cards').innerHTML = '';
  fetchCatalogPage();

  // –±–µ—Å–∫–æ–Ω–µ—á–Ω–∞—è –ø–æ–¥–≥—Ä—É–∑–∫–∞
  const sentinel = document.createElement('div');
  sentinel.id = 'catalog-sentinel';
  document.getElementById('cards').after(sentinel);

  const io = new IntersectionObserver((entries)=>{
    if(entries[0].isIntersecting){
      if(catalogState.nextCursor || catalogState.items.length===0){
        fetchCatalogPage();
      }
    }
  },{ rootMargin: '600px' });
  io.observe(sentinel);
}
</script>
<script>
const LS_KEY = "om_pending_topup"; // {invoiceId,provider,payUrl,startedAt,expiresAt}

// –ö–ù–û–ü–ö–£ –ù–ê–°–¢–†–û–ï–ö –ù–ï –¢–†–û–ì–ê–ï–ú ‚Äî –æ–Ω–∞ —É–∂–µ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ onclick="openSettings()"

// –ë–∞–ª–∞–Ω—Å –æ—Ç–∫—Ä—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –∏–∑ –∫–æ–¥–∞ (–ø–æ –≤—ã–∑–æ–≤—É openBalance()), –∞ –Ω–µ —á–µ—Ä–µ–∑ –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π #openBalance
function openBalance(){
  const m = document.getElementById('balanceModal');
  if(!m) return;
  m.style.display='flex';
  loadWalletHistory();
}
function closeBalance(){
  const m = document.getElementById('balanceModal');
  if(!m) return;
  m.style.display='none';
}

async function loadWalletHistory(){
  const bal = await fetch('/api/wallet').then(r=>r.json()).catch(()=>({available:0,hold:0}));
  const balEl = document.getElementById('meBalance');
  if (balEl) balEl.textContent = `${(bal.available||0).toFixed(2)} ‚ÇΩ`;

  const j = await fetch('/api/wallet/history?limit=100')
    .then(r=>r.json())
    .catch(()=>({items:[]}));

  const items = Array.isArray(j.items) ? j.items : [];
  const box = document.getElementById('opsBox');
  if (!box) return;

  box.innerHTML = items.map(x=>`
    <div class="item-row">
      <div><b>${x.type}</b> ${x.amount>0?'+':''}${x.amount} ${x.currency||''}</div>
      <div class="muted">${new Date(x.ts).toLocaleString()}</div>
    </div>
  `).join('') || '<div class="muted">–û–ø–µ—Ä–∞—Ü–∏–π –ø–æ–∫–∞ –Ω–µ—Ç</div>';
}

function openTopup(){ document.getElementById('payMethodModal').style.display='flex'; }
function closePayMethod(){ document.getElementById('payMethodModal').style.display='none'; }

async function startTopup(provider){
  const amount = Number(document.getElementById('amountInput').value||0);
  if(!amount || amount<=0){ alert('–£–∫–∞–∂–∏—Ç–µ —Å—É–º–º—É'); return; }

  let ep = null, body = { amount };
  if(provider==='freekassa'){ ep='/api/pay/rukassa/create'; body.currency='RUB'; }
  if(provider==='stripe'){   ep='/api/pay/stripe/create';   body.currency='USD'; }
  if(provider==='cryptobot'){ ep='/api/pay/cryptobot/create'; body.asset='USDT'; }

  const r = await fetch(ep,{ method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body) });
  const j = await r.json();
  if(!j?.invoiceId || !j?.payUrl){ alert('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –ø–ª–∞—Ç—ë–∂'); return; }

  // –ü–∏—à–µ–º pending –≤ localStorage –Ω–∞ 10 –º–∏–Ω—É—Ç
  const nowTs = Date.now();
  const pending = {
    invoiceId: j.invoiceId, provider, payUrl: j.payUrl,
    startedAt: nowTs, expiresAt: nowTs + 10*60*1000
  };
  localStorage.setItem(LS_KEY, JSON.stringify(pending));

  closePayMethod();
  openWaitModal();
}

let waitTimer = null;
function openWaitModal(){
  const m = document.getElementById('waitModal');
  m.style.display='flex';
  let left = 10;
  document.getElementById('waitText').textContent = `–ß–µ—Ä–µ–∑ ${left} —Å–µ–∫—É–Ω–¥ –≤—ã –±—É–¥–µ—Ç–µ –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω—ã –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –ø–ª–∞—Ç–µ–∂–∞‚Ä¶ –ü–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã –Ω–∞–∂–º–∏—Ç–µ ¬´–Ø –æ–ø–ª–∞—Ç–∏–ª¬ª.`;
  clearInterval(waitTimer);
  waitTimer = setInterval(()=>{
    left--; if(left<=0){ clearInterval(waitTimer); openPaymentTab(); }
    else document.getElementById('waitText').textContent = `–ß–µ—Ä–µ–∑ ${left} —Å–µ–∫—É–Ω–¥ –≤—ã –±—É–¥–µ—Ç–µ –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω—ã –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –ø–ª–∞—Ç–µ–∂–∞‚Ä¶ –ü–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã –Ω–∞–∂–º–∏—Ç–µ ¬´–Ø –æ–ø–ª–∞—Ç–∏–ª¬ª.`;
  }, 1000);
}

function openPaymentTab(){
  const p = getPending(); if(!p) return;
  window.open(p.payUrl, "_blank", "noopener");
}

async function checkPaymentNow(){
  const p = getPending(); if(!p){ alert('–ù–µ—Ç –æ–∂–∏–¥–∞—é—â–µ–≥–æ –ø–ª–∞—Ç–µ–∂–∞'); return; }
  const ep = p.provider==='freekassa' ? '/api/pay/rukassa/status'
    : p.provider==='stripe' ? '/api/pay/stripe/status'
    : '/api/pay/cryptobot/status';
  const q = new URLSearchParams({ invoiceId: p.invoiceId });
  const j = await fetch(ep+'?'+q.toString()).then(r=>r.json()).catch(()=>({status:'pending'}));
  if(j.status==='paid'){
    localStorage.removeItem(LS_KEY);
    document.getElementById('waitModal').style.display='none';
    showSuccess(p);
    loadWalletHistory();
  }else{
    alert('–ü–ª–∞—Ç—ë–∂ –µ—â—ë –Ω–µ –Ω–∞–π–¥–µ–Ω. –ú—ã –ø—Ä–æ–¥–æ–ª–∂–∏–º –ø—Ä–æ–≤–µ—Ä—è—Ç—å —Ä–∞–∑ –≤ –º–∏–Ω—É—Ç—É.');
  }
}

function showSuccess(p){
  const s = document.getElementById('successModal');
  document.getElementById('successInfo').innerHTML =
    `–°–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã: <b>${p.provider}</b><br> ID –æ–ø–ª–∞—Ç—ã: <b>${p.invoiceId}</b>`;
  s.style.display='flex';
}
function closeSuccess(){ document.getElementById('successModal').style.display='none'; }

function getPending(){
  try{ const x = JSON.parse(localStorage.getItem(LS_KEY)||'null'); if(!x) return null; if(Date.now()>x.expiresAt) { localStorage.removeItem(LS_KEY); return null; } return x; }catch{ return null; }
}

// –í–æ–∑–≤—Ä–∞—â–∞–µ–º –º–æ–¥–∞–ª –ø—Ä–∏ –ø–µ—Ä–µ–∑–∞—Ö–æ–¥–µ –≤ —Ç–µ—á–µ–Ω–∏–µ 10 –º–∏–Ω—É—Ç
function restorePendingModal(){
  const p = getPending();
  if(!p) return;
  openWaitModal(); // —Å—Ä–∞–∑—É –æ—Ç–∫—Ä—ã–≤–∞–µ–º –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ
}
// –ê–≤—Ç–æ–ø—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–∑ –≤ –º–∏–Ω—É—Ç—É
setInterval(()=>{
  const p = getPending();
  if(!p) return;
  checkPaymentNow();
}, 60*1000);

// –ü—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
document.addEventListener('DOMContentLoaded', ()=>{
  restorePendingModal();
});
</script>
<script>
const catalog = {
  items: [],
  nextCursor: null,
  busy: false,
  maxDom: 100,
  container: null,
  sentinel: null,
  placeholder: 'data:image/svg+xml;utf8,' + encodeURIComponent(`<svg xmlns="http://www.w3.org/2000/svg" width="640" height="480"><rect width="100%" height="100%" fill="#0b0f14"/><text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" fill="#9fb0c0" font-family="sans-serif" font-size="22">no image</text></svg>`)
};

function ensureCardsContainer(){
  let box = document.getElementById('cards');
  if(!box){
    box = document.createElement('div');
    box.id = 'cards';
    (document.querySelector('#catalog') || document.body).appendChild(box);
  }
  catalog.container = box;

  // sentinel –¥–ª—è infinite scroll
  if(!catalog.sentinel){
    const s = document.createElement('div');
    s.id = 'catalog-sentinel';
    s.style.height = '1px';
    box.after(s);
    catalog.sentinel = s;
  }
}

function renderSkeletons(n=8){
  const box = catalog.container; if(!box) return;
  for(let i=0;i<n;i++){
    const sk = document.createElement('div');
    sk.className='card-item skel';
    sk.style.aspectRatio='4/3';
    box.appendChild(sk);
  }
}

function clearSkeletons(){
  const box = catalog.container; if(!box) return;
  [...box.querySelectorAll('.skel')].forEach(n=>n.remove());
}

async function fetchPage(){
  if(catalog.busy) return;
  catalog.busy = true;
  try{
    const q = new URLSearchParams({ limit: '50' });
    if(catalog.nextCursor) q.set('cursor', String(catalog.nextCursor));

    const res = await fetch('/api/listings?'+q.toString(), { credentials:'include' });
    if(!res.ok) throw new Error('HTTP '+res.status);
    const j = await res.json();

    const page = Array.isArray(j) ? j : (j?.items || []);
    const next = Array.isArray(j) ? null : (j?.nextCursor ?? null);

    // –∞–ø–ø–µ–Ω–¥–∏–º
    catalog.items = catalog.items.concat(page);
    catalog.nextCursor = next;

    renderNew(page);
  }catch(err){
    console.error('catalog fetch error', err);
    showCatalogError('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ç–æ–≤–∞—Ä—ã. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É.');
  }finally{
    catalog.busy = false;
    clearSkeletons();
  }
}

function showCatalogError(msg){
  const box = catalog.container; if(!box) return;
  if(!box.querySelector('.catalog-error')){
    const e = document.createElement('div');
    e.className='card catalog-error';
    e.style.padding='14px';
    e.textContent = msg;
    box.appendChild(e);
  }
}

function renderNew(newItems){
  const box = catalog.container; if(!box) return;

  for(const it of newItems){
    const el = document.createElement('div');
    el.className = 'card-item';
    el.dataset.id = it.id;                // üîß –í–ê–ñ–ù–û: –ø—Ä–∏–≤—è–∑—ã–≤–∞–µ–º id —Ç–æ–≤–∞—Ä–∞

    const price = Number(it.price||0);
    el.innerHTML = `
      <img class="media" alt="" loading="lazy" src="${it.image||''}">
      <div class="body">
        ${it.isVip ? '<span class="badge">VIP</span>' : ''}
        <div class="title">${escapeHtml(it.title||'–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è')}</div>
        <div class="price">${isNaN(price)?'‚Äî':price.toFixed(2)} ‚ÇΩ</div>
        <div class="meta">#${String(it.id||'').slice(-6)}</div>
      </div>`;

    const img = el.querySelector('img');
    // ... —Ç–≤–æ–π lazy-loading –∏ —Ç.–ø.
    img.addEventListener('error', ()=>{ img.src = catalog.placeholder; img.onerror=null; });
    box.appendChild(el);
  }

  while(box.children.length > catalog.maxDom){
    box.removeChild(box.firstChild);
  }
}

function escapeHtml(s){return String(s).replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;' }[m]))}

function startInfiniteScroll(){
  const io = new IntersectionObserver((entries)=>{
    if(entries[0].isIntersecting){
      if(catalog.nextCursor !== null || catalog.items.length===0){
        renderSkeletons(6);
        fetchPage();
      }
    }
  }, { rootMargin:'800px' });
  io.observe(catalog.sentinel);
}

function initCatalogWindow(){
  ensureCardsContainer();
  catalog.items = [];
  catalog.nextCursor = null;
  catalog.container.innerHTML = '';
  renderSkeletons(8);
  fetchPage();
  startInfiniteScroll();
}

// –∞–≤—Ç–æ–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è (–∏–ª–∏ –≤—ã–∑–æ–≤–∏ —Å–∞–º –ø—Ä–∏ –ø–µ—Ä–µ—Ö–æ–¥–µ –Ω–∞ –∫–∞—Ç–∞–ª–æ–≥)
document.addEventListener('DOMContentLoaded', ()=>{
  // –µ—Å–ª–∏ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ –µ—Å—Ç—å #cards ‚Äî —Å—Ç–∞—Ä—Ç—É–µ–º
  if(document.getElementById('cards')) initCatalogWindow();
});
</script>



<script>
(function(){
  const btn = document.getElementById('themeBtn');
  const root = document.documentElement;
  // –ø—Ä–æ—á–∏—Ç–∞—Ç—å —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—É—é —Ç–µ–º—É
  const saved = localStorage.getItem('om_theme');
  if(saved==='dark') root.setAttribute('data-theme','dark');
  if(btn){
    btn.addEventListener('click', ()=>{
      const dark = root.getAttribute('data-theme')==='dark';
      if(dark){ root.removeAttribute('data-theme'); localStorage.setItem('om_theme','light'); }
      else    { root.setAttribute('data-theme','dark'); localStorage.setItem('om_theme','dark'); }
    });
  }
})();
</script>

<script>
(function(){
  // –§–û–õ–ë–≠–ö —Ç–æ—Å—Ç–∞ (–µ—Å–ª–∏ —Å–≤–æ–µ–≥–æ –Ω–µ—Ç)
  window.toast = window.toast || function(msg,type='info'){
    let wrap = document.querySelector('.toast-wrap');
    if(!wrap){ wrap=document.createElement('div'); wrap.className='toast-wrap'; document.body.appendChild(wrap); }
    const t = document.createElement('div'); t.className='toast '+type;
    t.innerHTML = `<div class="t-title">${type==='success'?'–ì–æ—Ç–æ–≤–æ':'–°–æ–æ–±—â–µ–Ω–∏–µ'}</div><div class="t-msg">${msg}</div>`;
    wrap.appendChild(t); setTimeout(()=>t.remove(), 3200);
  };

  const modal   = document.getElementById('listingModal');
const mClose  = document.getElementById('lmClose');
  const lmImg   = document.getElementById('lmImg');
  const lmTitle = document.getElementById('lmTitle');
  const lmPrice = document.getElementById('lmPrice');
  const lmMeta  = document.getElementById('lmMeta');
  const lmDesc  = document.getElementById('lmDesc');
  const lmBuy   = document.getElementById('lmBuy');

  // –î–µ–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –∫–∞—Ç–∞–ª–æ–≥–∞
  const cardsBox = document.getElementById('cards');

  // –í–ê–ñ–ù–û: –ø—Ä–∏ –æ—Ç—Ä–∏—Å–æ–≤–∫–µ –∫–∞–∂–¥–æ–π –∫–∞—Ä—Ç–æ—á–∫–∏ –¥–æ–±–∞–≤—å data-id –Ω–∞ –∫–æ—Ä–Ω–µ–≤–æ–π —ç–ª–µ–º–µ–Ω—Ç –∫–∞—Ä—Ç–æ—á–∫–∏!
  // –ü—Ä–∏–º–µ—Ä:
  // el.className = 'card-item'; el.dataset.id = item.id;

  if(cardsBox){
    cardsBox.addEventListener('click', (e)=>{
      const root = e.target.closest('[data-id]'); // —Å—Ä–∞–±–æ—Ç–∞–µ—Ç –∏ –¥–ª—è .card-item, –∏ –¥–ª—è .card
      if(!root || !cardsBox.contains(root)) return;
      const id = root.dataset.id;
      if(id) openListingModal(id);
    });
  }

  mClose?.addEventListener('click', closeModal);
  modal?.addEventListener('click', (e)=>{ if(e.target===modal) closeModal(); });
  document.addEventListener('keydown', (e)=>{ if(e.key==='Escape' && modal?.style.display==='flex') closeModal(); });

  function openModal(){ modal.style.display='flex'; document.body.style.overflow='hidden'; }
  function closeModal(){ modal.style.display='none'; document.body.style.overflow=''; }

  async function openListingModal(id){
    try{
      const r = await fetch('/api/listings/'+encodeURIComponent(id), { credentials:'include' });
      if(!r.ok) throw new Error('HTTP '+r.status);
      const l = await r.json();

      lmTitle.textContent = l.title || '–¢–æ–≤–∞—Ä';
      if(l.image){ lmImg.src = l.image; lmImg.style.display='block'; } else { lmImg.style.display='none'; }
      lmPrice.textContent = (Number(l.price||0).toFixed(2))+' ‚ÇΩ';
      lmMeta.textContent  = '#'+String(l.id||'').slice(-6);
      lmDesc.textContent  = l.description || '';

      lmBuy.onclick = async ()=>{
        const rr = await fetch('/api/orders', {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          credentials:'include',
          body: JSON.stringify({ listingId: l.id })
        });
        if(rr.ok){
          toast('–ó–∞–∫–∞–∑ —Å–æ–∑–¥–∞–Ω', 'success');
          closeModal();
          // —Ç—É—Ç –ø–æ –∂–µ–ª–∞–Ω–∏—é: –ø–µ—Ä–µ–∫–ª—é—á–∏—Ç—å –Ω–∞ –≤–∫–ª–∞–¥–∫—É ¬´–°–¥–µ–ª–∫–∏¬ª
          // openTab && openTab('orders');
        }else{
          const e = await rr.json().catch(()=>({}));
          toast(e?.message || e?.error || '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –∑–∞–∫–∞–∑', 'error');
        }
      };

      openModal();
    }catch(e){
      console.error(e);
      toast('–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–∫—Ä—ã—Ç—å –∫–∞—Ä—Ç–æ—á–∫—É', 'error');
    }
  }
})();
</script>


<script>
(function(){
  const modal   = document.getElementById('payModal');
  if (!modal) return; // –µ—Å–ª–∏ –º–æ–¥–∞–ª–∫–∏ –Ω–µ—Ç ‚Äî –≤—ã—Ö–æ–¥–∏–º —Ç–∏—Ö–æ, –Ω–µ –ª–æ–º–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É

  const btnClose= document.getElementById('payClose');
  const btnStart= document.getElementById('payStart');
  const btnIPaid= document.getElementById('payIpaid');
  const amountI = document.getElementById('payAmount');
  const countdown = document.getElementById('payCountdown');
  const cdn   = document.getElementById('cdn');

  let selectedMethod = null;
  let pending = null;
  let timerId = null;
  let openWin = null;

  window.openPayModal = function(presetAmount){
    resetState();
    if (amountI) amountI.value = Math.max(1, Number(presetAmount || 0)) || '';
    openModal();
  };

  function openModal(){
    modal.style.display='flex';
    document.body.style.overflow='hidden';
  }
  function closeModal(){
    modal.style.display='none';
    document.body.style.overflow='';
    selectedMethod = null;
    stopCountdown();
  }

  btnClose && btnClose.addEventListener('click', closeModal);
  modal.addEventListener('click', (e)=>{ if(e.target===modal) closeModal(); });
  document.addEventListener('keydown', (e)=>{ if(e.key==='Escape' && modal.style.display==='flex') closeModal(); });

  document.querySelectorAll('.pay-method').forEach(b=>{
    b.addEventListener('click', ()=>{
      document.querySelectorAll('.pay-method').forEach(x=>x.classList.remove('is-active'));
      b.classList.add('is-active');
      selectedMethod = { code:b.dataset.method, wallet:b.dataset.wallet||null };
    });
  });

  btnStart && btnStart.addEventListener('click', async ()=>{
    const amt = Math.floor(Number(amountI?.value || 0));
    if(!selectedMethod){ return toast('–í—ã–±–µ—Ä–∏ —Å–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã','error'); }
    if(!(amt>0)){ return toast('–ù–µ–≤–µ—Ä–Ω–∞—è —Å—É–º–º–∞','error'); }

    try{
      const r = await fetch('/api/payments/create', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        credentials:'include',
        body: JSON.stringify({ amount: amt, gateway: selectedMethod.code, wallet: selectedMethod.wallet })
      });
      if(!r.ok) throw new Error('HTTP '+r.status);
      const data = await r.json();

      pending = {
        id: data.id,
        gateway: data.gateway,
        redirectUrl: data.redirectUrl,
        openAt: Date.now(),
        expiresAt: Date.now() + 10*60*1000
      };
      localStorage.setItem('pendingPayment', JSON.stringify(pending));
      startCountdown(10, ()=>{
        if(modal.style.display!=='flex') return;
        try{ openWin = window.open(pending.redirectUrl, '_blank', 'noopener'); }catch(e){}
      });
    }catch(e){
      console.error(e);
      toast('–ù–µ —É–¥–∞–ª–æ—Å—å –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –ø–ª–∞—Ç—ë–∂','error');
    }
  });

  btnIPaid && btnIPaid.addEventListener('click', async ()=>{
    if(!pending){ return toast('–ü–ª–∞—Ç—ë–∂ –Ω–µ –Ω–∞–π–¥–µ–Ω','error'); }
    try{
      const r = await fetch(`/api/payments/${encodeURIComponent(pending.id)}/status`, { credentials:'include' });
      const data = await r.json();
      if(data.status==='succeeded'){
        successModal?.(data.method, data.external_id);
        clearPending();
        closeModal();
      }else if(data.status==='processing'){
        toast('–ü–ª–∞—Ç—ë–∂ –µ—â—ë –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è, –ø–æ–¥–æ–∂–¥–∏—Ç–µ','info');
      }else{
        toast('–ü–ª–∞—Ç—ë–∂ –Ω–µ –Ω–∞–π–¥–µ–Ω –∏–ª–∏ –æ—Ç–∫–ª–æ–Ω—ë–Ω','error');
      }
    }catch(e){
      toast('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Ç–∞—Ç—É—Å–∞','error');
    }
  });

  function resetState(){
    pending = null;
    selectedMethod = null;
    stopCountdown();
    countdown && (countdown.textContent = '');
  }
  function clearPending(){
    pending = null;
    localStorage.removeItem('pendingPayment');
    stopCountdown();
  }
  function startCountdown(sec, onDone){
    stopCountdown();
    let left = sec;
    if(countdown) countdown.textContent = left + ' c';
    timerId = setInterval(()=>{
      left--;
      if(left<=0){
        stopCountdown();
        if(countdown) countdown.textContent = '';
        onDone && onDone();
      }else{
        if(countdown) countdown.textContent = left + ' c';
      }
    }, 1000);
  }
  function stopCountdown(){
    if(timerId){
      clearInterval(timerId);
      timerId = null;
    }
  }
})();
</script>




<script>
// ====== –ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ —á–µ—Ä–µ–∑ —Ä–∞–∑–Ω—ã–µ —à–ª—é–∑—ã ======
async function depositReq() {
  const modal = document.createElement('div');
  modal.className = 'modal';
  modal.style.display = 'flex';
  modal.innerHTML = `
    <div class="sheet" style="max-width:400px">
      <h3>–í—ã–±–µ—Ä–∏—Ç–µ —Å–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã</h3>
      <div class="row" style="flex-wrap:wrap;gap:12px;margin:16px 0">
        <button class="btn" onclick="startStripe()">Stripe</button>
        <button class="btn" onclick="startCrypto()">CryptoBot</button>
        <button class="btn" onclick="startFrekassa()">FreKassa</button>
      </div>
      <button class="btn-ghost" onclick="this.closest('.modal').remove()">–û—Ç–º–µ–Ω–∞</button>
    </div>
  `;
  document.body.appendChild(modal);
}

// Stripe
async function startStripe() {
  const r = await fetch("/api/stripe/create-link", { method: "POST" });
  const d = await r.json();
  if (d.url) window.open(d.url, "_blank");
  else alert("–û—à–∏–±–∫–∞ Stripe");
}

// CryptoBot
async function startCrypto() {
  const r = await fetch("/api/crypto/create-invoice", { method: "POST" });
  const d = await r.json();
  if (d.ok && d.result?.bot_invoice_url) window.open(d.result.bot_invoice_url, "_blank");
  else alert("–û—à–∏–±–∫–∞ CryptoBot");
}

// FreKassa
async function startFrekassa() {
  const r = await fetch("/api/frekassa/create", { method: "POST" });
  const d = await r.json();
  if (d.url) window.open(d.url, "_blank");
  else alert("–û—à–∏–±–∫–∞ FreKassa");
}
</script>
<script>
// =============== 1. –£—Ç–∏–ª–∏—Ç—ã ===============
const $ = (sel) => document.querySelector(sel);
const $$ = (sel) => document.querySelectorAll(sel);

function safeBind(el, ev, fn) {
  if (el) el.addEventListener(ev, fn);
}

function toast(msg, type = "info") {
  console.log(`[${type}] ${msg}`);
}

// =============== 2. –ú–æ–¥–∞–ª–∫–∞ —Ç–æ–≤–∞—Ä–∞ ===============
(function () {
  if (window.__boundItemModal) return;
  window.__boundItemModal = true;

  const modalCfgs = [
    { root: "#listingModal", title: "#lmTitle", img: "#lmImg", desc: "#lmDesc", price: "#lmPrice", buy: "#lmBuy", close: "#lmClose" },
    { root: "#itemModal",    title: "#mTitle",  img: "#mImg",  desc: "#mDesc",  price: "#mPrice", buy: "#mBuyBtn", close: "#mClose" },
  ];

  const cfg = modalCfgs.find(c => $(c.root));
  if (!cfg) return;

  const modal = $(cfg.root);
  const title = $(cfg.title);
  const img   = $(cfg.img);
  const desc  = $(cfg.desc);
  const price = $(cfg.price);
  const buy   = $(cfg.buy);
  const close = $(cfg.close);

  const cardsBox = $("#cards") || $(".cards") || $(".grid-cards") || document.body;

  safeBind(cardsBox, "click", async (e) => {
    const card = e.target.closest(".card, .product, [data-id]");
    if (!card) return;

    const id = card.dataset.id;
    try {
      const r = await fetch(`/api/listings/${id}`);
      if (!r.ok) throw new Error("HTTP " + r.status);
      const data = await r.json();

      title && (title.textContent = data.title || "–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è");
      desc && (desc.textContent = data.description || "");
      price && (price.textContent = data.price ? data.price + " ‚ÇΩ" : "");
      img && (img.src = data.image || "/placeholder.png");

      modal.style.display = "flex";
      document.body.style.overflow = "hidden";

      safeBind(close, "click", closeModal);
      safeBind(modal, "click", (ev) => ev.target === modal && closeModal());
      safeBind(document, "keydown", (ev) => ev.key === "Escape" && closeModal());
      safeBind(buy, "click", () => openPayModal(data.price));

      function closeModal() {
        modal.style.display = "none";
        document.body.style.overflow = "";
      }
    } catch (e) {
      console.error(e);
      toast("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–æ–≤–∞—Ä–∞", "error");
    }
  });
})();

// =============== 3. –ú–æ–¥–∞–ª–∫–∞ –æ–ø–ª–∞—Ç—ã ===============
(function () {
  const modal = $("#payModal");
  if (!modal) return;

  const btnClose = $("#payClose");
  const btnStart = $("#payStart");
  const btnIPaid = $("#payIpaid");
  const amountI  = $("#payAmount");
  const countdown = $("#payCountdown");

  let selectedMethod = null;
  let pending = null;
  let timerId = null;

  window.openPayModal = function (presetAmount = 0) {
    reset();
    if (amountI) amountI.value = Math.max(1, Number(presetAmount)) || "";
    open();
  };

  function open() {
    modal.style.display = "flex";
    document.body.style.overflow = "hidden";
  }

  function close() {
    modal.style.display = "none";
    document.body.style.overflow = "";
    stopCountdown();
    selectedMethod = null;
  }

  safeBind(btnClose, "click", close);
  safeBind(modal, "click", (e) => e.target === modal && close());
  safeBind(document, "keydown", (e) => e.key === "Escape" && close());

  $$(".pay-method").forEach((btn) => {
    btn.addEventListener("click", () => {
      $$(".pay-method").forEach((x) => x.classList.remove("is-active"));
      btn.classList.add("is-active");
      selectedMethod = { code: btn.dataset.method, wallet: btn.dataset.wallet || null };
    });
  });

  safeBind(btnStart, "click", async () => {
    const amt = Math.floor(Number(amountI?.value || 0));
    if (!selectedMethod) return toast("–í—ã–±–µ—Ä–∏ —Å–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã", "error");
    if (!(amt > 0)) return toast("–ù–µ–≤–µ—Ä–Ω–∞—è —Å—É–º–º–∞", "error");

    try {
      const r = await fetch("/api/payments/create", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        credentials: "include",
        body: JSON.stringify({ amount: amt, gateway: selectedMethod.code, wallet: selectedMethod.wallet }),
      });
      if (!r.ok) throw new Error("HTTP " + r.status);
      const data = await r.json();

      pending = { id: data.id, redirectUrl: data.redirectUrl };
      localStorage.setItem("pendingPayment", JSON.stringify(pending));

      startCountdown(10, () => window.open(pending.redirectUrl, "_blank"));
    } catch (e) {
      console.error(e);
      toast("–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –ø–ª–∞—Ç–µ–∂–∞", "error");
    }
  });

  safeBind(btnIPaid, "click", async () => {
    if (!pending) return toast("–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –ø–ª–∞—Ç–µ–∂–∞", "error");
    try {
      const r = await fetch(`/api/payments/${encodeURIComponent(pending.id)}/status`, { credentials: "include" });
      const data = await r.json();
      if (data.status === "succeeded") {
        toast("–ü–ª–∞—Ç—ë–∂ –ø—Ä–æ—à—ë–ª —É—Å–ø–µ—à–Ω–æ!", "success");
        close();
      } else {
        toast("–ü–ª–∞—Ç—ë–∂ –µ—â—ë –Ω–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥—ë–Ω", "info");
      }
    } catch (e) {
      toast("–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Ç–∞—Ç—É—Å–∞", "error");
    }
  });

  function startCountdown(sec, cb) {
    stopCountdown();
    let left = sec;
    if (countdown) countdown.textContent = `${left}s`;
    timerId = setInterval(() => {
      left--;
      if (left <= 0) {
        stopCountdown();
        cb && cb();
      } else {
        if (countdown) countdown.textContent = `${left}s`;
      }
    }, 1000);
  }

  function stopCountdown() {
    if (timerId) clearInterval(timerId);
    timerId = null;
  }

  function reset() {
    selectedMethod = null;
    pending = null;
    stopCountdown();
    if (countdown) countdown.textContent = "";
  }
})();
</script>
<script>
document.addEventListener('DOMContentLoaded', function(){
  const btn   = document.querySelector('#walletTopupBtn');
  const modal = document.querySelector('#walletTopupModal');

  if (btn && modal) {
    btn.addEventListener('click', function(){
      modal.style.display = 'flex';
      document.body.style.overflow = 'hidden';
    });
  }
});

function closePayModal(){
  const modal = document.querySelector('#walletTopupModal');
  if (!modal) return;
  modal.style.display = 'none';
  document.body.style.overflow = '';
}
</script>
