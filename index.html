
<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Only Market</title>
  <style>
    :root{
      --bg0:#070812;
      --bg1:#0b1024;
      --card:rgba(255,255,255,.06);
      --card2:rgba(255,255,255,.09);
      --stroke:rgba(255,255,255,.10);
      --text:#e9ecff;
      --muted:rgba(233,236,255,.72);
      --muted2:rgba(233,236,255,.55);
      --shadow: 0 18px 50px rgba(0,0,0,.45);
      --radius:18px;
      --accent:#7c5cff;
      --accent2:#22c1ff;
      --danger:#ff4d6d;
      --ok:#22c55e;
      --warn:#f59e0b;
      --chip:rgba(255,255,255,.08);
      --focus: 0 0 0 3px rgba(124,92,255,.25);
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }
    [data-theme="light"]{
      --bg0:#f5f6ff;
      --bg1:#ffffff;
      --card:rgba(0,0,0,.04);
      --card2:rgba(0,0,0,.06);
      --stroke:rgba(0,0,0,.10);
      --text:#0b1024;
      --muted:rgba(11,16,36,.70);
      --muted2:rgba(11,16,36,.55);
      --shadow: 0 18px 50px rgba(8,11,22,.16);
      --chip:rgba(0,0,0,.05);
      --focus: 0 0 0 3px rgba(124,92,255,.20);
    }
    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      color:var(--text);
      background:
        radial-gradient(1200px 700px at 20% -10%, rgba(124,92,255,.35), transparent 55%),
        radial-gradient(900px 600px at 90% 10%, rgba(34,193,255,.24), transparent 55%),
        radial-gradient(1100px 700px at 60% 120%, rgba(255,77,109,.14), transparent 55%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      overflow-x:hidden;
    }
    a{ color:inherit; }
    .wrap{ max-width:1200px; margin:0 auto; padding:22px 16px 40px; }
    .topbar{
      position:sticky; top:0; z-index:30;
      backdrop-filter: blur(14px);
      background: linear-gradient(180deg, rgba(0,0,0,.35), rgba(0,0,0,0));
      border-bottom:1px solid var(--stroke);
    }
    [data-theme="light"] .topbar{
      background: linear-gradient(180deg, rgba(255,255,255,.82), rgba(255,255,255,.35));
    }
    .topbar .row{ max-width:1200px; margin:0 auto; padding:14px 16px; display:flex; gap:12px; align-items:center; }
    .brand{ display:flex; align-items:center; gap:10px; min-width:200px; }
    .logo{
      width:34px;height:34px;border-radius:12px;
      background:
        radial-gradient(18px 18px at 30% 30%, rgba(255,255,255,.35), rgba(255,255,255,0) 60%),
        linear-gradient(135deg, var(--accent), var(--accent2));
      box-shadow: 0 10px 30px rgba(124,92,255,.25);
      border:1px solid rgba(255,255,255,.16);
    }
    [data-theme="light"] .logo{ border-color: rgba(0,0,0,.10); }
    .brand h1{ font-size:14px; margin:0; letter-spacing:.3px; }
    .brand .sub{ font-size:12px; color:var(--muted2); margin-top:2px; }
    .spacer{ flex:1; }
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:10px 12px;
      border:1px solid var(--stroke);
      background: var(--card);
      border-radius:999px;
      box-shadow: 0 10px 30px rgba(0,0,0,.18);
    }
    [data-theme="light"] .pill{ box-shadow: 0 10px 30px rgba(8,11,22,.08); }
    .pill input{
      background:transparent; border:0; outline:none; color:var(--text);
      width: 260px; max-width: 42vw;
      font-size: 14px;
    }
    .btn{
      border:1px solid var(--stroke);
      background: var(--card);
      color:var(--text);
      border-radius:12px;
      padding:10px 12px;
      cursor:pointer;
      transition: transform .08s ease, background .2s ease, border-color .2s ease;
      display:inline-flex; align-items:center; justify-content:center;
      gap:8px; user-select:none;
    }
    .btn:hover{ transform: translateY(-1px); border-color: rgba(255,255,255,.18); background: var(--card2); }
    .btn:active{ transform: translateY(0px); }
    .btn:focus{ outline:none; box-shadow: var(--focus); }
    .btn.primary{
      border-color: rgba(124,92,255,.45);
      background: linear-gradient(135deg, rgba(124,92,255,.95), rgba(34,193,255,.80));
      color:white;
    }
    .btn.primary:hover{ border-color: rgba(124,92,255,.70); }
    .btn.danger{ border-color: rgba(255,77,109,.55); background: rgba(255,77,109,.12); }
    .btn.ghost{ background: transparent; }
    .chip{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 10px; border:1px solid var(--stroke);
      background: var(--chip); border-radius:999px;
      font-size:12px; color: var(--muted);
      user-select:none;
    }
    .grid{
      display:grid;
      grid-template-columns: 320px 1fr;
      gap:16px;
      align-items:start;
      margin-top: 18px;
    }
    @media (max-width: 980px){
      .grid{ grid-template-columns:1fr; }
      .brand{ min-width: unset; }
      .pill input{ width: 40vw; }
    }
    .card{
      border:1px solid var(--stroke);
      background: var(--card);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card .hd{
      padding:14px 14px 12px;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      border-bottom:1px solid var(--stroke);
    }
    .card .hd h2{ margin:0; font-size:14px; letter-spacing:.2px; }
    .card .bd{ padding:14px; }
    .nav{
      display:flex; flex-direction:column; gap:8px;
    }
    .nav .item{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding:12px 12px;
      border-radius:14px;
      border:1px solid transparent;
      background: transparent;
      cursor:pointer;
      color: var(--muted);
    }
    .nav .item:hover{ background: var(--card2); color:var(--text); }
    .nav .item.active{
      background: linear-gradient(135deg, rgba(124,92,255,.20), rgba(34,193,255,.12));
      border-color: rgba(124,92,255,.22);
      color: var(--text);
    }
    .nav .badge{
      font-size:11px; padding:4px 8px; border-radius:999px;
      border:1px solid var(--stroke);
      background: var(--chip);
      color: var(--muted);
    }
    .kpi{
      display:grid; grid-template-columns:1fr 1fr; gap:10px;
    }
    .kpi .box{
      border:1px solid var(--stroke);
      background: var(--card2);
      border-radius:14px;
      padding:12px;
    }
    .kpi .box .t{ font-size:11px; color:var(--muted2); }
    .kpi .box .v{ font-size:18px; margin-top:6px; font-weight:700; }
    .kpi .box .v small{ font-size:12px; color:var(--muted2); font-weight:600; }
    .hr{ height:1px; background: var(--stroke); margin:12px 0; }
    .two{
      display:grid;
      grid-template-columns: 1.2fr .8fr;
      gap:14px;
    }
    @media (max-width: 980px){
      .two{ grid-template-columns:1fr; }
    }
    .list{
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap:12px;
    }
    @media (max-width: 980px){
      .list{ grid-template-columns: repeat(2, 1fr); }
    }
    @media (max-width: 540px){
      .list{ grid-template-columns:1fr; }
    }
    .tile{
      border:1px solid var(--stroke);
      background: var(--card2);
      border-radius: 16px;
      overflow:hidden;
      cursor:pointer;
      transition: transform .08s ease, border-color .2s ease, background .2s ease;
      display:flex; flex-direction:column;
      min-height: 280px;
    }
    .tile:hover{ transform: translateY(-1px); border-color: rgba(255,255,255,.18); }
    .tile .img{
      height: 148px;
      background:
        radial-gradient(280px 160px at 30% 20%, rgba(124,92,255,.35), rgba(124,92,255,0) 60%),
        radial-gradient(260px 160px at 80% 30%, rgba(34,193,255,.22), rgba(34,193,255,0) 60%),
        linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.03));
      display:flex; align-items:center; justify-content:center;
      position:relative;
      border-bottom:1px solid var(--stroke);
    }
    .tile img{
      width:100%; height:100%;
      object-fit: cover;
      display:block;
    }
    .tile .vip{
      position:absolute; top:10px; left:10px;
      padding:6px 10px;
      border-radius:999px;
      font-size:11px;
      background: rgba(124,92,255,.18);
      border:1px solid rgba(124,92,255,.35);
      color: var(--text);
      backdrop-filter: blur(10px);
    }
    .tile .ct{
      padding:12px;
      display:flex; flex-direction:column; gap:8px;
      flex:1;
    }
    .tile .title{ font-weight:700; font-size:14px; line-height:1.25; }
    .tile .desc{ color:var(--muted); font-size:12px; line-height:1.35; height: 46px; overflow:hidden; }
    .tile .meta{ display:flex; align-items:center; justify-content:space-between; gap:10px; margin-top:auto; }
    .price{ font-weight:800; }
    .muted{ color:var(--muted); }
    .row2{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .field{ display:flex; flex-direction:column; gap:6px; }
    .field label{ font-size:12px; color:var(--muted2); }
    .input, .select, .textarea{
      border:1px solid var(--stroke);
      background: rgba(0,0,0,.10);
      color:var(--text);
      border-radius: 12px;
      padding: 10px 12px;
      outline:none;
      font-size:14px;
      width:100%;
    }
    [data-theme="light"] .input, [data-theme="light"] .select, [data-theme="light"] .textarea{ background: rgba(255,255,255,.60); }
    .textarea{ min-height: 96px; resize: vertical; }
    .input:focus, .select:focus, .textarea:focus{ box-shadow: var(--focus); }
    .hint{ font-size:12px; color:var(--muted2); line-height:1.35; }
    .mono{ font-family: var(--mono); }
    /* modal */
    .overlay{
      position:fixed; inset:0; z-index:60;
      display:none; place-items:center;
      background: rgba(0,0,0,.55);
      padding: 18px;
    }
    [data-theme="light"] .overlay{ background: rgba(11,16,36,.35); }
    .modal{
      width:min(760px, 100%);
      border:1px solid var(--stroke);
      background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.04));
      border-radius: 20px;
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .modal .mh{ padding:14px 14px 12px; display:flex; align-items:center; justify-content:space-between; gap:10px; border-bottom:1px solid var(--stroke); }
    .modal .mh b{ font-size:14px; }
    .modal .mb{ padding:14px; }
    .modal .mf{ padding:14px; border-top:1px solid var(--stroke); display:flex; gap:10px; justify-content:flex-end; flex-wrap:wrap; }
    .x{ width:36px; height:36px; border-radius:12px; }
    /* toasts */
    .toasts{ position: fixed; right: 14px; bottom: 14px; z-index: 80; display:flex; flex-direction:column; gap:10px; }
    .toast{
      min-width: 260px; max-width: 360px;
      border:1px solid var(--stroke);
      background: rgba(0,0,0,.30);
      border-radius: 16px;
      padding: 10px 12px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(12px);
      transform: translateY(0);
      opacity: 1;
      transition: opacity .2s ease, transform .2s ease;
    }
    [data-theme="light"] .toast{ background: rgba(255,255,255,.78); }
    .toast .t{ display:flex; align-items:center; gap:10px; font-weight:700; font-size:13px; }
    .toast .m{ margin-top:6px; color: var(--muted); font-size:12px; line-height:1.35; }
    .dot{ width:10px; height:10px; border-radius:999px; background: var(--ok); }
    .toast.warn .dot{ background: var(--warn); }
    .toast.bad .dot{ background: var(--danger); }
    /* chat */
    .chat{
      display:grid;
      grid-template-columns: 320px 1fr;
      gap: 12px;
      min-height: 520px;
    }
    @media (max-width: 980px){
      .chat{ grid-template-columns:1fr; }
    }
    .rooms{
      border:1px solid var(--stroke);
      background: var(--card2);
      border-radius: 16px;
      overflow:hidden;
    }
    .roomItem{
      padding:12px;
      border-bottom:1px solid var(--stroke);
      cursor:pointer;
    }
    .roomItem:hover{ background: rgba(255,255,255,.04); }
    .roomItem.active{ background: linear-gradient(135deg, rgba(124,92,255,.18), rgba(34,193,255,.10)); }
    .roomItem .top{ display:flex; align-items:center; justify-content:space-between; gap:10px; }
    .roomItem .name{ font-weight:800; font-size:13px; }
    .roomItem .time{ font-size:11px; color:var(--muted2); }
    .roomItem .last{ font-size:12px; color:var(--muted); margin-top:6px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .msgs{
      border:1px solid var(--stroke);
      background: var(--card2);
      border-radius: 16px;
      overflow:hidden;
      display:flex;
      flex-direction:column;
    }
    .msgs .head{
      padding:12px;
      border-bottom:1px solid var(--stroke);
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .msgs .body{
      padding:12px;
      overflow:auto;
      flex:1;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .bubble{
      max-width: 86%;
      padding:10px 12px;
      border:1px solid var(--stroke);
      border-radius: 16px;
      background: rgba(0,0,0,.18);
    }
    [data-theme="light"] .bubble{ background: rgba(255,255,255,.68); }
    .bubble.me{
      margin-left:auto;
      border-color: rgba(124,92,255,.35);
      background: rgba(124,92,255,.14);
    }
    .bubble .meta{ font-size:11px; color:var(--muted2); display:flex; justify-content:space-between; gap:10px; margin-bottom:6px; }
    .bubble .text{ font-size:13px; line-height:1.35; white-space:pre-wrap; word-break:break-word; }
    .bubble img{ max-width:100%; border-radius:12px; border:1px solid var(--stroke); display:block; }
    .composer{
      padding:12px; border-top:1px solid var(--stroke);
      display:flex; gap:10px; align-items:flex-end;
    }
    .composer textarea{
      flex:1; min-height:44px; max-height:120px;
    }
    .small{ font-size:11px; color:var(--muted2); }
    .debugBox{ display:none; margin-top:10px; }
    .debugBox pre{
      margin:0;
      padding:12px;
      border-radius: 14px;
      border:1px solid var(--stroke);
      background: rgba(0,0,0,.22);
      overflow:auto;
      max-height: 260px;
      font-size: 12px;
      color: rgba(233,236,255,.85);
    }
    [data-theme="light"] .debugBox pre{ background: rgba(255,255,255,.70); color: rgba(11,16,36,.88); }
  </style>
</head>
<body>
  <div class="topbar">
    <div class="row">
      <div class="brand">
        <div class="logo"></div>
        <div>
          <h1>Only Market</h1>
          <div class="sub" id="netStatus">–ø–æ–¥–∫–ª—é—á–∞–µ–º—Å—è‚Ä¶</div>
        </div>
      </div>

      <div class="pill" title="–ü–æ–∏—Å–∫ –ø–æ —Ç–æ–≤–∞—Ä–∞–º">
        <span class="chip">‚åï</span>
        <input id="q" placeholder="–ü–æ–∏—Å–∫ —Ç–æ–≤–∞—Ä–æ–≤ / –ø—Ä–æ–¥–∞–≤—Ü–æ–≤ / ID‚Ä¶" />
      </div>

      <div class="spacer"></div>

      <button class="btn" id="themeBtn" title="–°–º–µ–Ω–∏—Ç—å —Ç–µ–º—É">üåô</button>
      <button class="btn" id="debugBtn" title="Debug API">‚öóÔ∏é</button>
      <button class="btn primary" id="authBtn">–í–æ–π—Ç–∏</button>
    </div>
  </div>

  <div class="wrap">
    <div class="grid">
      <div class="card">
        <div class="hd">
          <h2>–ù–∞–≤–∏–≥–∞—Ü–∏—è</h2>
          <span class="chip" id="meChip">–ì–æ—Å—Ç—å</span>
        </div>
        <div class="bd">
          <div class="nav" id="nav">
            <div class="item active" data-view="market"><span>üõí –ú–∞—Ä–∫–µ—Ç</span><span class="badge" id="badgeMarket">‚Äî</span></div>
            <div class="item" data-view="sell"><span>‚ûï –ü—Ä–æ–¥–∞—Ç—å</span><span class="badge">—Ç–æ–≤–∞—Ä</span></div>
            <div class="item" data-view="deals"><span>ü§ù –°–¥–µ–ª–∫–∏</span><span class="badge" id="badgeDeals">‚Äî</span></div>
            <div class="item" data-view="chat"><span>üí¨ –ß–∞—Ç—ã</span><span class="badge" id="badgeChats">‚Äî</span></div>
            <div class="item" data-view="wallet"><span>üí≥ –ö–æ—à–µ–ª—ë–∫</span><span class="badge" id="badgeWallet">‚Äî</span></div>
            <div class="item" data-view="profile"><span>üë§ –ü—Ä–æ—Ñ–∏–ª—å</span><span class="badge">–Ω–∞—Å—Ç—Ä–æ–π–∫–∏</span></div>
          </div>
          <div class="hr"></div>
          <div class="kpi">
            <div class="box">
              <div class="t">–ë–∞–ª–∞–Ω—Å –¥–æ—Å—Ç—É–ø–Ω–æ</div>
              <div class="v" id="kpiAvail">‚Äî <small>‚ÇΩ</small></div>
            </div>
            <div class="box">
              <div class="t">–í —Ö–æ–ª–¥–µ</div>
              <div class="v" id="kpiHold">‚Äî <small>‚ÇΩ</small></div>
            </div>
          </div>

          <div class="debugBox" id="debugBox">
            <div class="hr"></div>
            <div class="small">Debug: –ø–æ—Å–ª–µ–¥–Ω–∏–π –æ—Ç–≤–µ—Ç API</div>
            <pre id="debugPre"></pre>
          </div>
        </div>
      </div>

      <div id="view"></div>
    </div>
  </div>

  <div class="overlay" id="overlay" aria-hidden="true">
    <div class="modal">
      <div class="mh">
        <b id="mTitle">–û–∫–Ω–æ</b>
        <button class="btn x" id="mClose" title="–ó–∞–∫—Ä—ã—Ç—å">‚úï</button>
      </div>
      <div class="mb" id="mBody"></div>
      <div class="mf" id="mFoot"></div>
    </div>
  </div>

  <div class="toasts" id="toasts"></div>

<script>
(function(){
  // ---------------- utils ----------------
  function $(sel, root){ return (root||document).querySelector(sel); }
  function $all(sel, root){ return Array.prototype.slice.call((root||document).querySelectorAll(sel)); }
  function esc(s){
    s = String(s == null ? "" : s);
    s = s.split("&").join("&amp;");
    s = s.split("<").join("&lt;");
    s = s.split(">").join("&gt;");
    s = s.split('"').join("&quot;");
    s = s.split("'").join("&#039;");
    return s;
  }
  function fmtRub(n){
    var x = Number(n||0);
    if (!isFinite(x)) x = 0;
    try{ return x.toLocaleString("ru-RU"); }catch(e){ return String(x); }
  }
  function timeAgo(ts){
    var t = Number(ts||0);
    if(!t) return "";
    var d = Date.now() - t;
    if(d < 60*1000) return "—Ç–æ–ª—å–∫–æ —á—Ç–æ";
    if(d < 60*60*1000) return Math.floor(d/60000) + "–º";
    if(d < 24*60*60*1000) return Math.floor(d/3600000) + "—á";
    return new Date(t).toLocaleDateString("ru-RU");
  }
  function toast(title, msg, kind){
    msg = msg || "";
    kind = kind || "ok";
    var wrap = $("#toasts");
    var el = document.createElement("div");
    el.className = "toast " + (kind === "bad" ? "bad" : (kind === "warn" ? "warn" : "ok"));
    el.innerHTML = '<div class="t"><span class="dot"></span><span>'+esc(title)+'</span></div>' + (msg ? '<div class="m">'+esc(msg)+'</div>' : '');
    wrap.appendChild(el);
    setTimeout(function(){ el.style.opacity="0"; el.style.transform="translateY(8px)"; }, 3200);
    setTimeout(function(){ try{ el.remove(); }catch(e){} }, 3600);
  }

  // ---------------- theme ----------------
  var LS = { theme:"om_theme", token:"om_token" };
  function applyTheme(t){
    t = (t === "light") ? "light" : "dark";
    document.documentElement.setAttribute("data-theme", t);
    localStorage.setItem(LS.theme, t);
    $("#themeBtn").textContent = (t === "light") ? "‚òÄÔ∏è" : "üåô";
  }
  applyTheme(localStorage.getItem(LS.theme) || "dark");
  $("#themeBtn").addEventListener("click", function(){
    var cur = document.documentElement.getAttribute("data-theme");
    applyTheme(cur === "dark" ? "light" : "dark");
  });

  // ---------------- debug ----------------
  var debugOn = false;
  function setDebug(v){
    debugOn = !!v;
    $("#debugBox").style.display = debugOn ? "block" : "none";
  }
  $("#debugBtn").addEventListener("click", function(){
    setDebug(!debugOn);
    toast("Debug " + (debugOn ? "ON" : "OFF"), "", debugOn ? "ok" : "warn");
  });
  function debugDump(obj){
    if(!debugOn) return;
    try{ $("#debugPre").textContent = JSON.stringify(obj, null, 2); }catch(e){ $("#debugPre").textContent = String(obj); }
  }

  // ---------------- modal ----------------
  var overlay = $("#overlay");
  $("#mClose").addEventListener("click", closeModal);
  overlay.addEventListener("click", function(e){ if(e.target === overlay) closeModal(); });
  function openModal(title, bodyHtml, buttons){
    $("#mTitle").textContent = title || "–û–∫–Ω–æ";
    $("#mBody").innerHTML = bodyHtml || "";
    var foot = $("#mFoot");
    foot.innerHTML = "";
    (buttons||[]).forEach(function(b){
      var btn = document.createElement("button");
      btn.className = "btn " + (b.kind||"");
      btn.textContent = b.label || "OK";
      btn.addEventListener("click", function(){
        if(b.onClick) b.onClick();
      });
      foot.appendChild(btn);
    });
    overlay.style.display = "grid";
    overlay.setAttribute("aria-hidden","false");
    document.body.style.overflow = "hidden";
  }
  function closeModal(){
    overlay.style.display = "none";
    overlay.setAttribute("aria-hidden","true");
    document.body.style.overflow = "";
  }

  // ---------------- API ----------------
  async function api(path, opts){
    opts = opts || {};
    opts.method = opts.method || "GET";
    opts.headers = opts.headers || {};
    if(opts.body && typeof opts.body === "object" && !(opts.body instanceof FormData)){
      opts.headers["Content-Type"] = "application/json";
      opts.body = JSON.stringify(opts.body);
    }
    if(!("credentials" in opts)) opts.credentials = "include";
    var r = await fetch(path, opts);
    var txt = await r.text();
    var json = null;
    try{ json = txt ? JSON.parse(txt) : null; }catch(e){ json = { _raw: txt }; }
    debugDump({ path:path, status:r.status, ok:r.ok, body: json });
    if(!r.ok){
      var err = (json && (json.error || json.message)) ? (json.error || json.message) : ("HTTP_" + r.status);
      throw new Error(err);
    }
    return json;
  }

  // ---------------- state ----------------
  var state = {
    me: null,
    categories: [],
    listings: [],
    listingsCursor: null,
    selectedListing: null,
    orders: [],
    rooms: [],
    activeRoom: null,
    es: null
  };

  function isAuthed(){ return !!state.me; }
  function setMe(u){
    state.me = u || null;
    $("#meChip").textContent = state.me ? ("@" + (state.me.nickname || state.me.email || "user")) : "–ì–æ—Å—Ç—å";
    $("#authBtn").textContent = state.me ? "–í—ã–π—Ç–∏" : "–í–æ–π—Ç–∏";
  }

  // ---------------- initial health ----------------
  (async function(){
    try{
      var h = await api("/api/health");
      $("#netStatus").textContent = "—Å–µ—Ä–≤–µ—Ä –æ–Ω–ª–∞–π–Ω";
      $("#netStatus").style.color = "";
      if(h && h.version){ $("#netStatus").textContent = "—Å–µ—Ä–≤–µ—Ä –æ–Ω–ª–∞–π–Ω ‚Ä¢ v" + h.version; }
    }catch(e){
      $("#netStatus").textContent = "—Å–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω";
      $("#netStatus").style.color = "var(--danger)";
      toast("–°–µ—Ä–≤–µ—Ä –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç", "–ü—Ä–æ–≤–µ—Ä—å –ø–æ—Ä—Ç/–ø—Ä–æ–∫—Å–∏ –∏ —á—Ç–æ node server.js –∑–∞–ø—É—â–µ–Ω", "bad");
    }
    await refreshMe();
    await preload();
    render();
  })();

  async function refreshMe(){
    try{
      var me = await api("/api/me");
      setMe(me);
    }catch(e){
      setMe(null);
    }
  }

  async function preload(){
    await loadCategories();
    if(isAuthed()){
      await loadWallet();
      await loadOrders();
      await loadInbox();
    }else{
      setKpi("-", "-");
    }
    await loadListings(true);
  }

  // ---------------- data loaders ----------------
  async function loadCategories(){
    try{
      var cats = await api("/api/categories");
      state.categories = Array.isArray(cats) ? cats : (cats.items || []);
    }catch(e){
      state.categories = [];
    }
  }

  async function loadListings(reset){
    reset = !!reset;
    try{
      var q = $("#q").value || "";
      var path = "/api/listings?limit=60";
      if(!reset && state.listingsCursor){ path += "&cursor=" + encodeURIComponent(state.listingsCursor); }
      if(q){ path += "&q=" + encodeURIComponent(q); } // –µ—Å–ª–∏ –±—ç–∫ –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç ‚Äî –ø—Ä–æ—Å—Ç–æ –∏–≥–Ω–æ—Ä
      var r = await api(path);
      var items = Array.isArray(r) ? r : (r.items || []);
      var next = r && r.nextCursor ? r.nextCursor : null;
      if(reset){
        state.listings = items;
      }else{
        state.listings = state.listings.concat(items);
      }
      state.listingsCursor = next;
      $("#badgeMarket").textContent = String(state.listings.length);
    }catch(e){
      toast("–ú–∞—Ä–∫–µ—Ç –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª—Å—è", String(e.message||e), "bad");
    }
  }

  async function loadWallet(){
    try{
      var w = await api("/api/wallet");
      setKpi(w.available, w.hold);
      $("#badgeWallet").textContent = fmtRub(w.available||0) + "‚ÇΩ";
    }catch(e){
      setKpi("-", "-");
      $("#badgeWallet").textContent = "‚Äî";
    }
  }
  function setKpi(av, hold){
    $("#kpiAvail").innerHTML = esc(fmtRub(av)) + " <small>‚ÇΩ</small>";
    $("#kpiHold").innerHTML  = esc(fmtRub(hold)) + " <small>‚ÇΩ</small>";
  }

  async function loadOrders(){
    try{
      var arr = await api("/api/orders");
      state.orders = Array.isArray(arr) ? arr : [];
      $("#badgeDeals").textContent = String(state.orders.length);
    }catch(e){
      state.orders = [];
      $("#badgeDeals").textContent = "‚Äî";
    }
  }

  async function loadInbox(){
    try{
      var arr = await api("/api/chat/inbox");
      state.rooms = Array.isArray(arr) ? arr : [];
      $("#badgeChats").textContent = String(state.rooms.length);
    }catch(e){
      state.rooms = [];
      $("#badgeChats").textContent = "‚Äî";
    }
  }

  // ---------------- nav / view ----------------
  var currentView = "market";
  function setView(v){
    currentView = v;
    $all("#nav .item").forEach(function(el){
      el.classList.toggle("active", el.getAttribute("data-view") === v);
    });
    render();
  }
  $("#nav").addEventListener("click", function(e){
    var it = e.target.closest(".item");
    if(!it) return;
    var v = it.getAttribute("data-view");
    if(v) setView(v);
  });

  // search
  var qTimer = null;
  $("#q").addEventListener("input", function(){
    clearTimeout(qTimer);
    qTimer = setTimeout(async function(){
      await loadListings(true);
      render();
    }, 240);
  });

  // auth button
  $("#authBtn").addEventListener("click", function(){
    if(state.me){
      doLogout();
    }else{
      openAuth();
    }
  });

  async function doLogout(){
    try{ await api("/api/auth/logout", { method:"POST" }); }catch(e){}
    setMe(null);
    toast("–í—ã –≤—ã—à–ª–∏", "", "ok");
    await preload();
    render();
  }

  function openAuth(){
    var html = ''
      + '<div class="two">'
      + '  <div>'
      + '    <div class="field"><label>Email</label><input class="input" id="aEmail" placeholder="you@mail.com"/></div>'
      + '    <div style="height:10px"></div>'
      + '    <div class="field"><label>–ü–∞—Ä–æ–ª—å</label><input class="input" id="aPass" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"/></div>'
      + '    <div class="hr"></div>'
      + '    <div class="hint">–í–∞–∂–Ω–æ: –Ω–∞ —ç—Ç–æ–º —Å–µ—Ä–≤–µ—Ä–µ –≤—Ö–æ–¥ –º–æ–∂–µ—Ç —Ç—Ä–µ–±–æ–≤–∞—Ç—å <b>–ø—Ä–∏–≤—è–∑–∫—É Telegram</b> –∏/–∏–ª–∏ <b>–∫–æ–¥ –∏–∑ Telegram</b> ‚Äî —è —ç—Ç–æ –æ–±—Ä–∞–±–æ—Ç–∞—é –≤ —Å–ª–µ–¥—É—é—â–∏—Ö —à–∞–≥–∞—Ö.</div>'
      + '  </div>'
      + '  <div>'
      + '    <div class="field"><label>–ù–∏–∫–Ω–µ–π–º (–¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏)</label><input class="input" id="aNick" placeholder="nickname"/></div>'
      + '    <div style="height:10px"></div>'
      + '    <div class="hint">–ï—Å–ª–∏ —Ç—ã —É–∂–µ —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–ª—Å—è ‚Äî –ø—Ä–æ—Å—Ç–æ –≤—Ö–æ–¥–∏.</div>'
      + '  </div>'
      + '</div>';
    openModal("–í—Ö–æ–¥ / –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è", html, [
      { label:"–û—Ç–º–µ–Ω–∞", kind:"ghost", onClick: closeModal },
      { label:"–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è", kind:"", onClick: doRegisterFromModal },
      { label:"–í–æ–π—Ç–∏", kind:"primary", onClick: doLoginFromModal }
    ]);
    setTimeout(function(){ $("#aEmail").focus(); }, 40);
  }

  async function doRegisterFromModal(){
    var email = ($("#aEmail").value||"").trim();
    var pass  = ($("#aPass").value||"").trim();
    var nick  = ($("#aNick").value||"").trim();
    if(!email || !pass || !nick){ toast("–ó–∞–ø–æ–ª–Ω–∏ email/–ø–∞—Ä–æ–ª—å/–Ω–∏–∫", "", "warn"); return; }
    try{
      var r = await api("/api/auth/register", { method:"POST", body:{ email:email, password:pass, nickname:nick } });
      closeModal();
      toast("–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞", "–¢—ã –≤–æ—à—ë–ª –≤ –∞–∫–∫–∞—É–Ω—Ç", "ok");
      await refreshMe();
      await preload();
      render();
    }catch(e){
      toast("–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –Ω–µ —É–¥–∞–ª–∞—Å—å", String(e.message||e), "bad");
    }
  }

  async function doLoginFromModal(){
    var email = ($("#aEmail").value||"").trim();
    var pass  = ($("#aPass").value||"").trim();
    if(!email || !pass){ toast("–ó–∞–ø–æ–ª–Ω–∏ email –∏ –ø–∞—Ä–æ–ª—å", "", "warn"); return; }
    try{
      var r = await api("/api/auth/login", { method:"POST", body:{ email:email, password:pass } });

      // 1) —Ç—Ä–µ–±—É–µ—Ç—Å—è –ø—Ä–∏–≤—è–∑–∫–∞ TG
      if(r && r.requireTgLink){
        openTgLinkStep(r.tgBot, r.linkCode, email, pass);
        return;
      }
      // 2) —Ç—Ä–µ–±—É–µ—Ç—Å—è –∫–æ–¥ –∏–∑ TG (challengeId)
      if(r && r.requiresTgCode){
        openTgCodeStep(r.challengeId, email, pass);
        return;
      }

      closeModal();
      toast("–í—Ö–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω", "", "ok");
      await refreshMe();
      await preload();
      render();
    }catch(e){
      toast("–ù–µ —É–¥–∞–ª–æ—Å—å –≤–æ–π—Ç–∏", String(e.message||e), "bad");
    }
  }

  function openTgLinkStep(bot, code, email, pass){
    var b = bot || "@onlymarket_marketplace_bot";
    var body = ''
      + '<div class="field"><label>–®–∞–≥ 1: –ø—Ä–∏–≤—è–∂–∏ Telegram</label>'
      + '<div class="hint">–û—Ç–∫—Ä–æ–π –±–æ—Ç–∞ <b>'+esc(b)+'</b> –∏ –æ—Ç–ø—Ä–∞–≤—å –µ–º—É –∫–æ–¥:</div>'
      + '<div style="margin-top:10px" class="chip mono">CODE: '+esc(code)+'</div>'
      + '<div class="hint" style="margin-top:10px">–ü–æ—Å–ª–µ –ø—Ä–∏–≤—è–∑–∫–∏ –Ω–∞–∂–º–∏ ¬´–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å¬ª ‚Äî —è –ø–æ–≤—Ç–æ—Ä—é –≤—Ö–æ–¥.</div>'
      + '</div>';
    openModal("–¢—Ä–µ–±—É–µ—Ç—Å—è Telegram", body, [
      { label:"–ù–∞–∑–∞–¥", kind:"ghost", onClick: openAuth },
      { label:"–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å (—è –ø—Ä–∏–≤—è–∑–∞–ª)", kind:"primary", onClick: async function(){
          // –ø—Ä–æ—Å—Ç–æ –ø–æ–≤—Ç–æ—Ä—è–µ–º –ª–æ–≥–∏–Ω ‚Äî –µ—Å–ª–∏ TG –ø—Ä–∏–≤—è–∑–∞–Ω, —Å–µ—Ä–≤–µ—Ä –≤–µ—Ä–Ω—ë—Ç —Å–ª–µ–¥—É—é—â–∏–π —à–∞–≥
          try{
            var r = await api("/api/auth/login", { method:"POST", body:{ email:email, password:pass } });
            if(r && r.requiresTgCode){
              openTgCodeStep(r.challengeId, email, pass);
              return;
            }
            if(r && r.requireTgLink){
              toast("–ü–æ—Ö–æ–∂–µ, –µ—â—ë –Ω–µ –ø—Ä–∏–≤—è–∑–∞–Ω–æ", "–ü—Ä–æ–≤–µ—Ä—å, —á—Ç–æ —Ç—ã –æ—Ç–ø—Ä–∞–≤–∏–ª –∫–æ–¥ –±–æ—Ç—É –∏ –æ–Ω –æ—Ç–≤–µ—Ç–∏–ª", "warn");
              return;
            }
            closeModal();
            toast("–í—Ö–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω", "", "ok");
            await refreshMe();
            await preload();
            render();
          }catch(e){
            toast("–ù–µ —É–¥–∞–ª–æ—Å—å –≤–æ–π—Ç–∏", String(e.message||e), "bad");
          }
      }}
    ]);
  }

  function openTgCodeStep(challengeId, email, pass){
    var body = ''
      + '<div class="field"><label>–®–∞–≥ 2: –∫–æ–¥ –∏–∑ Telegram</label>'
      + '<div class="hint">–°–µ—Ä–≤–µ—Ä –æ—Ç–ø—Ä–∞–≤–∏–ª –∫–æ–¥ –≤—Ö–æ–¥–∞ –≤ Telegram. –í–≤–µ–¥–∏ –µ–≥–æ —Å—é–¥–∞.</div>'
      + '<div style="height:10px"></div>'
      + '<input class="input mono" id="tgCode" placeholder="123456" />'
      + '<div class="hint" style="margin-top:10px">challengeId: <span class="mono">'+esc(challengeId)+'</span></div>'
      + '</div>';
    openModal("–ö–æ–¥ –≤—Ö–æ–¥–∞", body, [
      { label:"–û—Ç–º–µ–Ω–∞", kind:"ghost", onClick: closeModal },
      { label:"–ü—Ä–æ–≤–µ—Ä–∏—Ç—å", kind:"primary", onClick: async function(){
          var code = ($("#tgCode").value||"").trim();
          if(!code){ toast("–í–≤–µ–¥–∏ –∫–æ–¥", "", "warn"); return; }
          try{
            await api("/api/auth/tg-verify", { method:"POST", body:{ challengeId:challengeId, code:code } });
            closeModal();
            toast("–í—Ö–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω", "", "ok");
            await refreshMe();
            await preload();
            render();
          }catch(e){
            toast("–ö–æ–¥ –Ω–µ–≤–µ—Ä–Ω—ã–π", String(e.message||e), "bad");
          }
      }}
    ]);
    setTimeout(function(){ $("#tgCode").focus(); }, 40);
  }

  // ---------------- render ----------------
  function render(){
    if(currentView === "market") renderMarket();
    else if(currentView === "sell") renderSell();
    else if(currentView === "deals") renderDeals();
    else if(currentView === "chat") renderChat();
    else if(currentView === "wallet") renderWallet();
    else if(currentView === "profile") renderProfile();
  }

  function viewCard(title, rightHtml, bodyHtml){
    rightHtml = rightHtml || "";
    bodyHtml = bodyHtml || "";
    return ''
      + '<div class="card">'
      + ' <div class="hd"><h2>'+esc(title)+'</h2><div class="row2">'+rightHtml+'</div></div>'
      + ' <div class="bd">'+bodyHtml+'</div>'
      + '</div>';
  }

  function renderMarket(){
    var right = ''
      + '<span class="chip">VIP —Å–≤–µ—Ä—Ö—É</span>'
      + '<button class="btn" id="reloadMarket">–û–±–Ω–æ–≤–∏—Ç—å</button>';
    var body = '';
    if(!state.listings.length){
      body += '<div class="hint">–ü–æ–∫–∞ –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö —Ç–æ–≤–∞—Ä–æ–≤ ‚Äî –∏–ª–∏ —Å–µ—Ä–≤–µ—Ä –Ω–µ –≤–µ—Ä–Ω—É–ª items.</div>';
    }else{
      body += '<div class="list">';
      state.listings.forEach(function(l){
        var img = l.image ? '<img src="'+esc(l.image)+'" alt=""/>' : '';
        var vip = l.isVip ? '<div class="vip">VIP</div>' : '';
        var cat = catName(l.categoryId);
        body += ''
          + '<div class="tile" data-id="'+esc(l.id)+'">'
          +   '<div class="img">'+vip+ (img || '<div class="hint">–±–µ–∑ —Ñ–æ—Ç–æ</div>') +'</div>'
          +   '<div class="ct">'
          +     '<div class="title">'+esc(l.title||"")+'</div>'
          +     '<div class="desc">'+esc(l.description||"")+'</div>'
          +     '<div class="meta">'
          +       '<div class="chip">'+esc(cat||"–∫–∞—Ç–µ–≥–æ—Ä–∏—è")+'</div>'
          +       '<div class="price">'+esc(fmtRub(l.price))+' ‚ÇΩ</div>'
          +     '</div>'
          +   '</div>'
          + '</div>';
      });
      body += '</div>';
      if(state.listingsCursor){
        body += '<div style="margin-top:12px; display:flex; justify-content:center;"><button class="btn" id="moreMarket">–ü–æ–∫–∞–∑–∞—Ç—å –µ—â—ë</button></div>';
      }
    }
    $("#view").innerHTML = viewCard("–ú–∞—Ä–∫–µ—Ç", right, body);
    $("#reloadMarket").addEventListener("click", async function(){
      await loadListings(true);
      render();
    });
    var more = $("#moreMarket");
    if(more){
      more.addEventListener("click", async function(){
        await loadListings(false);
        render();
      });
    }
    $all(".tile").forEach(function(t){
      t.addEventListener("click", function(){
        var id = t.getAttribute("data-id");
        openListing(id);
      });
    });
  }

  function catName(id){
    if(!id) return "";
    for(var i=0;i<state.categories.length;i++){
      if(String(state.categories[i].id) === String(id)) return state.categories[i].title || state.categories[i].name || state.categories[i].id;
    }
    return String(id);
  }

  async function openListing(id){
    try{
      var l = await api("/api/listings/" + encodeURIComponent(id));
      state.selectedListing = l;
    }catch(e){
      toast("–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–∫—Ä—ã—Ç—å —Ç–æ–≤–∞—Ä", String(e.message||e), "bad");
      return;
    }
    var l = state.selectedListing;
    var img = l.image ? '<img src="'+esc(l.image)+'" alt="" style="width:100%; border-radius:16px; border:1px solid var(--stroke);"/>' : '';
    var info = ''
      + '<div class="two">'
      + ' <div>'
      +   (img || '<div class="hint">–§–æ—Ç–æ –Ω–µ –ø—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω–æ</div>')
      + ' </div>'
      + ' <div>'
      + '   <div class="chip">'+esc(catName(l.categoryId))+'</div>'
      + '   <div style="height:10px"></div>'
      + '   <div style="font-weight:900; font-size:20px; line-height:1.2">'+esc(l.title||"")+'</div>'
      + '   <div style="height:10px"></div>'
      + '   <div class="hint">'+esc(l.description||"")+'</div>'
      + '   <div class="hr"></div>'
      + '   <div class="row2">'
      + '     <div class="chip">–¶–µ–Ω–∞: <b>'+esc(fmtRub(l.price))+' ‚ÇΩ</b></div>'
      + '     <div class="chip">–¢–∏–ø: <b>'+esc(l.type||"single")+'</b></div>'
      + (l.type === "stock" ? ('<div class="chip">–û—Å—Ç–∞—Ç–æ–∫: <b>'+esc(l.stock)+'</b></div>') : '')
      + '   </div>'
      + '   <div style="height:12px"></div>'
      + '   <div class="hint">–ü–æ–∫—É–ø–∫–∞ —Å–æ–∑–¥–∞—ë—Ç —Å–¥–µ–ª–∫—É (order) –∏ —á–∞—Ç –ø–æ —Å–¥–µ–ª–∫–µ.</div>'
      + ' </div>'
      + '</div>';
    openModal("–¢–æ–≤–∞—Ä", info, [
      { label:"–ó–∞–∫—Ä—ã—Ç—å", kind:"ghost", onClick: closeModal },
      { label:"–ö—É–ø–∏—Ç—å", kind:"primary", onClick: function(){ buyListing(l.id); } }
    ]);
  }

  async function buyListing(listingId){
    if(!isAuthed()){
      toast("–ù—É–∂–Ω–æ –≤–æ–π—Ç–∏", "–°–Ω–∞—á–∞–ª–∞ –∞–≤—Ç–æ—Ä–∏–∑—É–π—Å—è", "warn");
      return;
    }
    try{
      var o = await api("/api/orders", { method:"POST", body:{ listingId: listingId } });
      closeModal();
      toast("–°–¥–µ–ª–∫–∞ —Å–æ–∑–¥–∞–Ω–∞", "Order " + o.id, "ok");
      await loadOrders();
      await loadInbox();
      setView("deals");
    }catch(e){
      toast("–ü–æ–∫—É–ø–∫–∞ –Ω–µ —É–¥–∞–ª–∞—Å—å", String(e.message||e), "bad");
    }
  }

  // ---------------- sell ----------------
  function renderSell(){
    var right = '<span class="chip">–§–æ—Ç–æ ‚â§ 50 KB</span>';
    if(!isAuthed()){
      $("#view").innerHTML = viewCard("–ü—Ä–æ–¥–∞—Ç—å", right, '<div class="hint">–ù—É–∂–Ω–æ –≤–æ–π—Ç–∏, —á—Ç–æ–±—ã —Å–æ–∑–¥–∞–≤–∞—Ç—å —Ç–æ–≤–∞—Ä—ã.</div>');
      return;
    }
    var opts = '<option value="">–í—ã–±–µ—Ä–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏—é</option>';
    state.categories.forEach(function(c){
      opts += '<option value="'+esc(c.id)+'">'+esc(c.title||c.name||c.id)+'</option>';
    });
    var body = ''
      + '<div class="two">'
      + ' <div>'
      + '   <div class="field"><label>–ù–∞–∑–≤–∞–Ω–∏–µ</label><input class="input" id="sTitle" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: Netflix Premium 1 –º–µ—Å—è—Ü"/></div>'
      + '   <div style="height:10px"></div>'
      + '   <div class="field"><label>–û–ø–∏—Å–∞–Ω–∏–µ</label><textarea class="textarea" id="sDesc" placeholder="–ß—Ç–æ –ø–æ–∫—É–ø–∞—Ç–µ–ª—å –ø–æ–ª—É—á–∏—Ç, —Å—Ä–æ–∫–∏, –Ω—é–∞–Ω—Å—ã‚Ä¶"></textarea></div>'
      + '   <div style="height:10px"></div>'
      + '   <div class="row2">'
      + '     <div class="field" style="flex:1"><label>–¶–µ–Ω–∞ (‚ÇΩ)</label><input class="input" id="sPrice" inputmode="decimal" placeholder="199"/></div>'
      + '     <div class="field" style="flex:1"><label>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</label><select class="select" id="sCat">'+opts+'</select></div>'
      + '   </div>'
      + '   <div style="height:10px"></div>'
      + '   <div class="row2">'
      + '     <div class="field" style="flex:1"><label>–¢–∏–ø</label>'
      + '       <select class="select" id="sType">'
      + '         <option value="single">Single (1 —Ä–∞–∑)</option>'
      + '         <option value="stock">Stock (–æ—Å—Ç–∞—Ç–æ–∫)</option>'
      + '         <option value="multi">Multi</option>'
      + '       </select>'
      + '     </div>'
      + '     <div class="field" style="flex:1"><label>–û—Å—Ç–∞—Ç–æ–∫ (–¥–ª—è Stock)</label><input class="input" id="sStock" inputmode="numeric" placeholder="10"/></div>'
      + '   </div>'
      + '   <div style="height:10px"></div>'
      + '   <div class="row2">'
      + '     <div class="field" style="flex:1"><label>–î–æ—Å—Ç–∞–≤–∫–∞</label>'
      + '       <select class="select" id="sDelivery">'
      + '         <option value="manual">Manual (—Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–µ)</option>'
      + '         <option value="auto">Auto (–º–æ–¥–µ—Ä–∞—Ü–∏—è + –∞–≤—Ç–æ-–ø–µ–π–ª–æ–∞–¥)</option>'
      + '       </select>'
      + '     </div>'
      + '   </div>'
      + '   <div style="height:10px"></div>'
      + '   <div class="field"><label>Auto payload (–µ—Å–ª–∏ delivery=auto)</label><textarea class="textarea" id="sPayload" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –∫–ª—é—á, –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è, —Å—Å—ã–ª–∫–∞‚Ä¶"></textarea></div>'
      + ' </div>'
      + ' <div>'
      + '   <div class="field"><label>–§–æ—Ç–æ —Ç–æ–≤–∞—Ä–∞</label>'
      + '     <input class="input" type="file" id="sFile" accept="image/*"/>'
      + '     <div class="hint" style="margin-top:10px">–§–æ—Ç–æ –±—É–¥–µ—Ç —Å–∂–∞—Ç–æ –¥–æ –ª–∏–º–∏—Ç–∞ —Å–µ—Ä–≤–µ—Ä–∞. –ï—Å–ª–∏ –Ω–µ –≤—ã—Ö–æ–¥–∏—Ç ‚Äî –ø–æ–ø—Ä–æ–±—É–π –¥—Ä—É–≥–æ–µ —Ñ–æ—Ç–æ –∏–ª–∏ —É–º–µ–Ω—å—à–∏—Ç—å –¥–µ—Ç–∞–ª–∏.</div>'
      + '     <div style="height:10px"></div>'
      + '     <div id="sPreview" class="card" style="padding:10px; border-radius:16px; background:var(--card2); border:1px solid var(--stroke)"><div class="hint">–ø—Ä–µ–≤—å—é –ø–æ—è–≤–∏—Ç—Å—è —Ç—É—Ç</div></div>'
      + '   </div>'
      + '   <div class="hr"></div>'
      + '   <button class="btn primary" id="sCreate" style="width:100%">–°–æ–∑–¥–∞—Ç—å —Ç–æ–≤–∞—Ä</button>'
      + ' </div>'
      + '</div>';
    $("#view").innerHTML = viewCard("–ü—Ä–æ–¥–∞—Ç—å", right, body);

    var dataUrl = null;
    $("#sFile").addEventListener("change", async function(){
      var f = $("#sFile").files && $("#sFile").files[0];
      if(!f){ dataUrl = null; $("#sPreview").innerHTML = '<div class="hint">–ø—Ä–µ–≤—å—é –ø–æ—è–≤–∏—Ç—Å—è —Ç—É—Ç</div>'; return; }
      try{
        dataUrl = await compressToDataUrl(f, 50*1024);
        $("#sPreview").innerHTML = '<img src="'+esc(dataUrl)+'" style="width:100%; border-radius:12px; border:1px solid var(--stroke)"/><div class="small" style="margin-top:8px">–†–∞–∑–º–µ—Ä: '+Math.round(dataUrl.length/1024)+' KB (dataUrl)</div>';
      }catch(e){
        dataUrl = null;
        $("#sPreview").innerHTML = '<div class="hint">–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∂–∞—Ç—å —Ñ–æ—Ç–æ –ø–æ–¥ –ª–∏–º–∏—Ç.</div>';
        toast("–§–æ—Ç–æ —Å–ª–∏—à–∫–æ–º —Ç—è–∂—ë–ª–æ–µ", "–í—ã–±–µ—Ä–∏ –¥—Ä—É–≥–æ–µ –∏–ª–∏ —É–º–µ–Ω—å—à–∞–π –∫–∞—á–µ—Å—Ç–≤–æ/—Ä–∞–∑–º–µ—Ä", "bad");
      }
    });

    $("#sCreate").addEventListener("click", async function(){
      var title = ($("#sTitle").value||"").trim();
      var description = ($("#sDesc").value||"").trim();
      var price = Number($("#sPrice").value||0);
      var categoryId = ($("#sCat").value||"").trim();
      var type = ($("#sType").value||"single").trim();
      var stock = Number($("#sStock").value||0);
      var delivery = ($("#sDelivery").value||"manual").trim();
      var autoPayload = ($("#sPayload").value||"").trim();

      if(!title || !description || !categoryId || !price || price<=0){
        toast("–ü—Ä–æ–≤–µ—Ä—å –ø–æ–ª—è", "–ù–∞–∑–≤–∞–Ω–∏–µ/–æ–ø–∏—Å–∞–Ω–∏–µ/—Ü–µ–Ω–∞/–∫–∞—Ç–µ–≥–æ—Ä–∏—è –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã", "warn");
        return;
      }
      try{
        var payload = { title:title, description:description, price:price, categoryId:categoryId, type:type, stock:stock, delivery:delivery, autoPayload:autoPayload, image: dataUrl };
        var l = await api("/api/listings", { method:"POST", body: payload });
        toast("–¢–æ–≤–∞—Ä —Å–æ–∑–¥–∞–Ω", l.id, "ok");
        await loadListings(true);
        setView("market");
      }catch(e){
        toast("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å —Ç–æ–≤–∞—Ä", String(e.message||e), "bad");
      }
    });
  }

  async function compressToDataUrl(file, maxBytes){
    maxBytes = maxBytes || 50000;
    var img = await fileToImage(file);
    var canvas = document.createElement("canvas");
    var ctx = canvas.getContext("2d");
    var maxSide = 820;
    var w = img.width, h = img.height;
    var s = Math.min(1, maxSide / Math.max(w,h));
    w = Math.max(1, Math.round(w*s));
    h = Math.max(1, Math.round(h*s));
    canvas.width = w; canvas.height = h;
    ctx.drawImage(img, 0, 0, w, h);

    // try jpeg qualities
    var q = 0.78;
    var dataUrl = canvas.toDataURL("image/jpeg", q);
    var tries = 0;
    while(dataUrl.length > maxBytes*1.37 && tries < 10){
      q = q - 0.08;
      if(q < 0.25) break;
      dataUrl = canvas.toDataURL("image/jpeg", q);
      tries++;
    }
    // if still too big, downscale a bit
    while(dataUrl.length > maxBytes*1.37 && tries < 18){
      w = Math.max(1, Math.round(w*0.88));
      h = Math.max(1, Math.round(h*0.88));
      canvas.width = w; canvas.height = h;
      ctx.drawImage(img, 0, 0, w, h);
      dataUrl = canvas.toDataURL("image/jpeg", Math.max(0.28, q));
      tries++;
    }
    if(dataUrl.length > maxBytes*1.37) throw new Error("TOO_BIG");
    return dataUrl;
  }
  function fileToImage(file){
    return new Promise(function(resolve, reject){
      var fr = new FileReader();
      fr.onerror = function(){ reject(new Error("READ_FAIL")); };
      fr.onload = function(){
        var img = new Image();
        img.onload = function(){ resolve(img); };
        img.onerror = function(){ reject(new Error("IMG_FAIL")); };
        img.src = String(fr.result||"");
      };
      fr.readAsDataURL(file);
    });
  }

  // ---------------- deals ----------------
  function renderDeals(){
    if(!isAuthed()){
      $("#view").innerHTML = viewCard("–°–¥–µ–ª–∫–∏", "", '<div class="hint">–ù—É–∂–Ω–æ –≤–æ–π—Ç–∏, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å —Å–¥–µ–ª–∫–∏.</div>');
      return;
    }
    var right = '<button class="btn" id="reloadDeals">–û–±–Ω–æ–≤–∏—Ç—å</button>';
    var body = '';
    if(!state.orders.length){
      body += '<div class="hint">–°–¥–µ–ª–æ–∫ –ø–æ–∫–∞ –Ω–µ—Ç. –ö—É–ø–∏ —Ç–æ–≤–∞—Ä ‚Äî –ø–æ—è–≤–∏—Ç—Å—è order –∏ —á–∞—Ç –ø–æ —Å–¥–µ–ª–∫–µ.</div>';
    }else{
      body += '<div style="display:flex; flex-direction:column; gap:10px;">';
      state.orders.forEach(function(o){
        var st = o.status || "pending";
        var chip = '<span class="chip">#'+esc(o.id)+'</span> <span class="chip">—Å—Ç–∞—Ç—É—Å: <b>'+esc(st)+'</b></span> <span class="chip">—Ü–µ–Ω–∞: <b>'+esc(fmtRub(o.price))+' ‚ÇΩ</b></span>';
        body += '<div class="card" style="box-shadow:none; background:var(--card2); border-radius:16px;">'
          + '<div class="bd">'
          + '<div class="row2" style="justify-content:space-between">'
          + '<div style="display:flex; gap:8px; flex-wrap:wrap">'+chip+'</div>'
          + '<div style="display:flex; gap:8px; flex-wrap:wrap">'
          + '  <button class="btn" data-act="openChat" data-id="'+esc(o.id)+'">–ß–∞—Ç</button>'
          + '  <button class="btn primary" data-act="pay" data-id="'+esc(o.id)+'">–û–ø–ª–∞—Ç–∏—Ç—å</button>'
          + '</div>'
          + '</div>'
          + '<div class="small" style="margin-top:10px">listingId: <span class="mono">'+esc(o.listingId)+'</span> ‚Ä¢ '+new Date(o.createdAt||0).toLocaleString("ru-RU")+'</div>'
          + '</div></div>';
      });
      body += '</div>';
    }
    $("#view").innerHTML = viewCard("–°–¥–µ–ª–∫–∏", right, body);
    $("#reloadDeals").addEventListener("click", async function(){
      await loadOrders();
      await loadInbox();
      render();
    });
    $all("button[data-act]").forEach(function(btn){
      btn.addEventListener("click", function(){
        var act = btn.getAttribute("data-act");
        var id  = btn.getAttribute("data-id");
        if(act === "openChat"){
          openOrderChat(id);
        }else if(act === "pay"){
          payOrder(id);
        }
      });
    });
  }

  async function payOrder(orderId){
    try{
      await api("/api/orders/" + encodeURIComponent(orderId) + "/pay", { method:"POST" });
      toast("–û–ø–ª–∞—Ç–∞ –∏–Ω–∏—Ü–∏–∏—Ä–æ–≤–∞–Ω–∞", "Order " + orderId, "ok");
      await loadOrders();
      await loadWallet();
      render();
    }catch(e){
      toast("–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø–ª–∞—Ç–∏—Ç—å", String(e.message||e), "bad");
    }
  }

  function openOrderChat(orderId){
    setView("chat");
    // Ensure room exists in list; we can add pseudo-room
    var roomKey = "order:" + orderId;
    if(!state.rooms.some(function(r){ return r.room === roomKey; })){
      state.rooms.unshift({ room: roomKey, lastText: "–°–∏—Å—Ç–µ–º–Ω–æ–µ: —á–∞—Ç —Å–¥–µ–ª–∫–∏", ts: Date.now(), lastFrom: "" });
      $("#badgeChats").textContent = String(state.rooms.length);
    }
    state.activeRoom = roomKey;
    renderChat();
    connectRoom(roomKey);
  }

  // ---------------- chat ----------------
  function renderChat(){
    if(!isAuthed()){
      $("#view").innerHTML = viewCard("–ß–∞—Ç—ã", "", '<div class="hint">–ù—É–∂–Ω–æ –≤–æ–π—Ç–∏, —á—Ç–æ–±—ã —á–∞—Ç—ã —Ä–∞–±–æ—Ç–∞–ª–∏ (–≤ —ç—Ç–æ–º –ø—Ä–æ–µ–∫—Ç–µ —á–∞—Ç ‚Äî —á–µ—Ä–µ–∑ SSE /api/chat/stream).</div>');
      return;
    }
    var right = '<button class="btn" id="reloadChat">–û–±–Ω–æ–≤–∏—Ç—å</button>';
    var body = ''
      + '<div class="chat">'
      + ' <div class="rooms" id="rooms"></div>'
      + ' <div class="msgs">'
      + '   <div class="head"><div><b id="chatTitle">–í—ã–±–µ—Ä–∏ —á–∞—Ç</b><div class="small" id="chatSub">inbox</div></div><div class="row2"><button class="btn" id="closeStream">–û—Ç–∫–ª—é—á–∏—Ç—å</button></div></div>'
      + '   <div class="body" id="chatBody"><div class="hint">–°–ª–µ–≤–∞ —Å–ø–∏—Å–æ–∫ —á–∞—Ç–æ–≤. –ò—Å—Ç–æ—Ä–∏—è –ø–æ–¥–≥—Ä—É–∂–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ SSE.</div></div>'
      + '   <div class="composer">'
      + '     <textarea class="textarea" id="chatText" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ‚Ä¶"></textarea>'
      + '     <button class="btn primary" id="sendMsg">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>'
      + '   </div>'
      + ' </div>'
      + '</div>';
    $("#view").innerHTML = viewCard("–ß–∞—Ç—ã", right, body);

    $("#reloadChat").addEventListener("click", async function(){
      await loadInbox();
      renderChat();
    });
    $("#closeStream").addEventListener("click", function(){ disconnectRoom(); toast("SSE –æ—Ç–∫–ª—é—á—ë–Ω", "", "warn"); });

    renderRooms();
    $("#sendMsg").addEventListener("click", sendCurrentMessage);
    $("#chatText").addEventListener("keydown", function(e){
      if(e.key === "Enter" && (e.ctrlKey || e.metaKey)){
        sendCurrentMessage();
      }
    });

    if(state.activeRoom){
      connectRoom(state.activeRoom);
    }
  }

  function renderRooms(){
    var box = $("#rooms");
    if(!box) return;
    var html = "";
    if(!state.rooms.length){
      html = '<div style="padding:12px"><div class="hint">–ü–æ–∫–∞ –ø—É—Å—Ç–æ. –ì–ª–æ–±–∞–ª—å–Ω—ã–π —á–∞—Ç –ø–æ—è–≤–∏—Ç—Å—è –ø–æ—Å–ª–µ –ø–µ—Ä–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è. –ß–∞—Ç—ã —Å–¥–µ–ª–æ–∫ –ø–æ—è–≤—è—Ç—Å—è –ø–æ—Å–ª–µ –ø–æ–∫—É–ø–æ–∫.</div></div>';
    }else{
      state.rooms.forEach(function(r){
        var active = (state.activeRoom === r.room) ? " active" : "";
        html += ''
          + '<div class="roomItem'+active+'" data-room="'+esc(r.room)+'">'
          + '  <div class="top"><div class="name">'+esc(roomTitle(r.room))+'</div><div class="time">'+esc(timeAgo(r.ts))+'</div></div>'
          + '  <div class="last">'+esc(r.lastText || "")+'</div>'
          + '</div>';
      });
    }
    box.innerHTML = html;
    $all(".roomItem", box).forEach(function(el){
      el.addEventListener("click", function(){
        var room = el.getAttribute("data-room");
        state.activeRoom = room;
        renderRooms();
        connectRoom(room);
      });
    });
  }

  function roomTitle(room){
    room = String(room||"");
    if(room === "global") return "üåç Global";
    if(room.indexOf("support:") === 0) return "üõü Support";
    if(room.indexOf("order:") === 0) return "ü§ù Deal " + room.slice(6);
    if(room.indexOf("dm:") === 0) return "‚úâÔ∏è DM";
    if(room.indexOf("user:") === 0) return "üîî Inbox";
    return room;
  }

  function disconnectRoom(){
    try{ if(state.es){ state.es.close(); } }catch(e){}
    state.es = null;
  }

  function connectRoom(room){
    if(!room) return;
    disconnectRoom();
    var params = mapRoomToStream(room);
    if(!params){
      $("#chatTitle").textContent = roomTitle(room);
      $("#chatSub").textContent = "unsupported room";
      $("#chatBody").innerHTML = '<div class="hint">–≠—Ç–æ—Ç —Ç–∏–ø –∫–æ–º–Ω–∞—Ç—ã –Ω–µ —Å—Ç—Ä–∏–º–∏—Ç—Å—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ.</div>';
      return;
    }
    $("#chatTitle").textContent = roomTitle(room);
    $("#chatSub").textContent = "SSE: " + params.url;

    $("#chatBody").innerHTML = '<div class="hint">–ó–∞–≥—Ä—É–∑–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏‚Ä¶</div>';

    var es = new EventSource(params.url, { withCredentials: true });
    state.es = es;

    var items = [];
    function renderMessages(){
      var body = $("#chatBody");
      if(!body) return;
      var h = "";
      items.forEach(function(m){
        var isMe = state.me && (String(m.fromUserId) === String(state.me.id));
        var meta = '<div class="meta"><span>'+esc(m.fromNickname || m.from || m.fromUserId || "system")+'</span><span>'+esc(new Date(m.ts||0).toLocaleString("ru-RU"))+'</span></div>';
        var content = '';
        if(m.kind === "image" && m.url){
          content = '<img src="'+esc(m.url)+'" alt="image"/>';
        }else{
          content = '<div class="text">'+esc(m.text||"")+'</div>';
        }
        h += '<div class="bubble'+(isMe?' me':'')+'">'+meta+content+'</div>';
      });
      body.innerHTML = h || '<div class="hint">–ü–æ–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π –Ω–µ—Ç.</div>';
      body.scrollTop = body.scrollHeight;
    }

    es.onmessage = function(ev){
      try{
        var j = JSON.parse(ev.data);
        if(j.type === "history" && Array.isArray(j.items)){
          items = j.items.slice();
          renderMessages();
        }else if(j.type === "message" && j.item){
          items.push(j.item);
          if(items.length > 80) items = items.slice(-80);
          renderMessages();
          // refresh inbox preview
          loadInbox().then(function(){ renderRooms(); });
        }
      }catch(e){
        // ignore
      }
    };
    es.onerror = function(){
      toast("–ß–∞—Ç: —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É–ø–∞–ª–æ", "–ü—Ä–æ–≤–µ—Ä—å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é –∏–ª–∏ –ø—Ä–æ–∫—Å–∏", "warn");
      try{ es.close(); }catch(e){}
      state.es = null;
    };
  }

  function mapRoomToStream(room){
    room = String(room||"");
    if(room === "global") return { url: "/api/chat/stream?type=global" };
    if(room.indexOf("support:") === 0) return { url: "/api/chat/stream?type=support" };
    if(room.indexOf("order:") === 0) return { url: "/api/chat/stream?type=order&orderId=" + encodeURIComponent(room.slice(6)) };
    if(room.indexOf("dm:") === 0){
      // dm:<a>:<b> ‚Äî –Ω—É–∂–µ–Ω peerId (–≤—Ç–æ—Ä–æ–π —É—á–∞—Å—Ç–Ω–∏–∫)
      var parts = room.split(":");
      if(parts.length >= 3 && state.me){
        var a = parts[1], b = parts[2];
        var peer = (String(a) === String(state.me.id)) ? b : a;
        return { url: "/api/chat/stream?type=dm&peerId=" + encodeURIComponent(peer), peerId: peer };
      }
    }
    return null;
  }

  async function sendCurrentMessage(){
    var room = state.activeRoom;
    if(!room){ toast("–í—ã–±–µ—Ä–∏ —á–∞—Ç", "", "warn"); return; }
    var txt = ($("#chatText").value||"").trim();
    if(!txt){ toast("–ü—É—Å—Ç–æ", "–ù–∞–ø–∏—à–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ", "warn"); return; }
    var stream = mapRoomToStream(room);
    if(!stream){ toast("–ù–µ–ª—å–∑—è –æ—Ç–ø—Ä–∞–≤–∏—Ç—å", "–≠—Ç–æ—Ç —á–∞—Ç –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è", "bad"); return; }

    var body = { text: txt };
    if(room === "global") body.type = "global";
    else if(room.indexOf("support:")===0) body.type = "support";
    else if(room.indexOf("order:")===0){ body.type="order"; body.orderId = room.slice(6); }
    else if(room.indexOf("dm:")===0){ body.type="dm"; body.peerId = stream.peerId; }

    try{
      await api("/api/chat/send", { method:"POST", body: body });
      $("#chatText").value = "";
    }catch(e){
      toast("–ù–µ –æ—Ç–ø—Ä–∞–≤–∏–ª–æ—Å—å", String(e.message||e), "bad");
    }
  }

  // ---------------- wallet ----------------
  function renderWallet(){
    if(!isAuthed()){
      $("#view").innerHTML = viewCard("–ö–æ—à–µ–ª—ë–∫", "", '<div class="hint">–ù—É–∂–Ω–æ –≤–æ–π—Ç–∏, —á—Ç–æ–±—ã –ø–æ–ø–æ–ª–Ω—è—Ç—å –∏ –≤–∏–¥–µ—Ç—å –∏—Å—Ç–æ—Ä–∏—é.</div>');
      return;
    }
    var right = '<button class="btn" id="reloadWallet">–û–±–Ω–æ–≤–∏—Ç—å</button>';
    var body = ''
      + '<div class="two">'
      + ' <div>'
      + '   <div class="chip">–î–æ—Å—Ç—É–ø–Ω–æ: <b>'+esc($("#kpiAvail").textContent.replace("‚ÇΩ","").trim())+' ‚ÇΩ</b></div>'
      + '   <div style="height:10px"></div>'
      + '   <div class="field"><label>–°—É–º–º–∞ (‚ÇΩ)</label><input class="input" id="wAmt" inputmode="decimal" placeholder="500"/></div>'
      + '   <div style="height:10px"></div>'
      + '   <div class="field"><label>–°–ø–æ—Å–æ–±</label>'
      + '     <select class="select" id="wMethod">'
      + '       <option value="paradise_sbp">Paradise ‚Ä¢ –°–ë–ü</option>'
      + '       <option value="rukassa">RuKassa</option>'
      + '       <option value="cryptobot">CryptoBot</option>'
      + '       <option value="stripe">Stripe</option>'
      + '     </select>'
      + '   </div>'
      + '   <div class="hr"></div>'
      + '   <button class="btn primary" id="wPay">–ü–æ–ø–æ–ª–Ω–∏—Ç—å</button>'
      + '   <div class="hint" style="margin-top:10px">Paradise –Ω–∞ —ç—Ç–æ–º —Å–µ—Ä–≤–µ—Ä–µ –ø—Ä–∏–Ω–∏–º–∞–µ—Ç <span class="mono">{amountRub, paymentMethod}</span>. –û—Å—Ç–∞–ª—å–Ω—ã–µ ‚Äî —Å–≤–æ–∏ –ø–æ–ª—è. –Ø —É–∂–µ –æ—Ç–ø—Ä–∞–≤–ª—è—é –ø—Ä–∞–≤–∏–ª—å–Ω–æ.</div>'
      + ' </div>'
      + ' <div>'
      + '   <div class="field"><label>–ò—Å—Ç–æ—Ä–∏—è</label><div id="wHist" class="hint">–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</div></div>'
      + ' </div>'
      + '</div>';
    $("#view").innerHTML = viewCard("–ö–æ—à–µ–ª—ë–∫", right, body);

    $("#reloadWallet").addEventListener("click", async function(){
      await loadWallet();
      await renderWalletHistory();
    });
    $("#wPay").addEventListener("click", startTopup);
    renderWalletHistory();
  }

  async function renderWalletHistory(){
    try{
      var r = await api("/api/wallet/history?limit=50&offset=0");
      var items = (r && r.items) ? r.items : [];
      if(!items.length){ $("#wHist").innerHTML = '<div class="hint">–ò—Å—Ç–æ—Ä–∏—è –ø—É—Å—Ç–∞—è.</div>'; return; }
      var h = '<div style="display:flex; flex-direction:column; gap:10px;">';
      items.forEach(function(it){
        h += '<div class="card" style="box-shadow:none; background:var(--card2); border-radius:16px;"><div class="bd">'
          + '<div class="row2" style="justify-content:space-between"><div class="chip">'+esc(it.kind||"")+'</div><div class="chip"><b>'+esc(fmtRub(it.amount||0))+' ‚ÇΩ</b></div></div>'
          + '<div class="small" style="margin-top:10px">'+esc(new Date(it.ts||0).toLocaleString("ru-RU"))+'</div>'
          + '</div></div>';
      });
      h += '</div>';
      $("#wHist").innerHTML = h;
    }catch(e){
      $("#wHist").innerHTML = '<div class="hint">–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é: '+esc(String(e.message||e))+'</div>';
    }
  }

  async function startTopup(){
    var amt = Number($("#wAmt").value||0);
    var method = $("#wMethod").value;
    if(!isFinite(amt) || amt<=0){ toast("–ù–µ–≤–µ—Ä–Ω–∞—è —Å—É–º–º–∞", "", "warn"); return; }

    try{
      var r = null;

      if(method === "paradise_sbp"){
        // server expects { amountRub, paymentMethod }
        r = await api("/api/pay/paradise/create", { method:"POST", body:{ amountRub: amt, paymentMethod: "sbp" } });
        if(r && r.redirect_url){ window.open(r.redirect_url, "_blank"); }
        toast("–°–æ–∑–¥–∞–Ω –ø–ª–∞—Ç—ë–∂ (Paradise)", "–û—Ç–∫—Ä—ã–ª —Å—Å—ã–ª–∫—É –≤ –Ω–æ–≤–æ–π –≤–∫–ª–∞–¥–∫–µ", "ok");
      }else if(method === "rukassa"){
        r = await api("/api/pay/rukassa/create", { method:"POST", body:{ amount: amt, currency:"RUB", email: (state.me && state.me.email) ? state.me.email : "" } });
        if(r && r.form && r.form.url){
          // open form in new tab
          openPayForm(r.form.url, r.form.params);
        }else if(r && r.redirectUrl){
          window.open(r.redirectUrl, "_blank");
        }
        toast("–°–æ–∑–¥–∞–Ω –ø–ª–∞—Ç—ë–∂ (RuKassa)", "–û—Ç–∫—Ä—ã–ª –æ–ø–ª–∞—Ç—É", "ok");
      }else if(method === "cryptobot"){
        r = await api("/api/pay/cryptobot/create", { method:"POST", body:{ amount: amt, fiat:"RUB", accepted_assets:"USDT,TON,BTC,ETH" } });
        if(r && r.pay_url){ window.open(r.pay_url, "_blank"); }
        toast("–°–æ–∑–¥–∞–Ω –∏–Ω–≤–æ–π—Å (CryptoBot)", "–û—Ç–∫—Ä—ã–ª –æ–ø–ª–∞—Ç—É", "ok");
      }else if(method === "stripe"){
        r = await api("/api/pay/stripe/create", { method:"POST", body:{ amount: amt } });
        if(r && r.url){ window.open(r.url, "_blank"); }
        toast("–°–æ–∑–¥–∞–Ω –ø–ª–∞—Ç—ë–∂ (Stripe)", "–û—Ç–∫—Ä—ã–ª –æ–ø–ª–∞—Ç—É", "ok");
      }

      await loadWallet();
      await renderWalletHistory();
    }catch(e){
      toast("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –ø–ª–∞—Ç—ë–∂", String(e.message||e), "bad");
    }
  }

  function openPayForm(url, params){
    // Create & submit a form to new tab
    var form = document.createElement("form");
    form.action = url;
    form.method = "POST";
    form.target = "_blank";
    params = params || {};
    Object.keys(params).forEach(function(k){
      var inp = document.createElement("input");
      inp.type = "hidden";
      inp.name = k;
      inp.value = String(params[k]);
      form.appendChild(inp);
    });
    document.body.appendChild(form);
    form.submit();
    setTimeout(function(){ try{ form.remove(); }catch(e){} }, 1000);
  }

  // ---------------- profile ----------------
  function renderProfile(){
    var right = '<button class="btn" id="reloadProfile">–û–±–Ω–æ–≤–∏—Ç—å</button>';
    var body = '';
    if(!isAuthed()){
      body += '<div class="hint">–¢—ã –≥–æ—Å—Ç—å. –ù–∞–∂–º–∏ ‚Äú–í–æ–π—Ç–∏‚Äù.</div>';
      $("#view").innerHTML = viewCard("–ü—Ä–æ—Ñ–∏–ª—å", right, body);
      $("#reloadProfile").addEventListener("click", async function(){ await refreshMe(); await preload(); render(); });
      return;
    }
    body += ''
      + '<div class="two">'
      + ' <div>'
      + '   <div class="chip">ID: <span class="mono">'+esc(state.me.id)+'</span></div>'
      + '   <div style="height:10px"></div>'
      + '   <div class="chip">Email: <b>'+esc(state.me.email||"")+'</b></div>'
      + '   <div style="height:10px"></div>'
      + '   <div class="chip">Nickname: <b>@'+esc(state.me.nickname||"")+'</b></div>'
      + '   <div class="hr"></div>'
      + '   <div class="hint">–ü—Ä–∏–≤—è–∑–∫–∞ Telegram –¥–µ–ª–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ –±–æ—Ç–∞. –ï—Å–ª–∏ –≤—Ö–æ–¥ –ø–∏—à–µ—Ç ‚ÄúrequireTgLink‚Äù ‚Äî –∑–∞–π–¥–∏ –≤ –±–æ—Ç–∞ –∏ –æ—Ç–ø—Ä–∞–≤—å –∫–æ–¥.</div>'
      + ' </div>'
      + ' <div>'
      + '   <div class="field"><label>Telegram</label>'
      + '     <button class="btn" id="tgReq">–ó–∞–ø—Ä–æ—Å–∏—Ç—å –∫–æ–¥ –ø—Ä–∏–≤—è–∑–∫–∏</button>'
      + '     <div class="hint" id="tgInfo" style="margin-top:10px">–ü–æ—Å–ª–µ –∑–∞–ø—Ä–æ—Å–∞ ‚Äî –æ—Ç–ø—Ä–∞–≤—å –∫–æ–¥ –±–æ—Ç—É.</div>'
      + '   </div>'
      + ' </div>'
      + '</div>';
    $("#view").innerHTML = viewCard("–ü—Ä–æ—Ñ–∏–ª—å", right, body);

    $("#reloadProfile").addEventListener("click", async function(){
      await refreshMe(); await preload(); render();
    });
    $("#tgReq").addEventListener("click", async function(){
      try{
        var r = await api("/api/telegram/request-code", { method:"POST" });
        var bot = (r && r.tgBot) ? r.tgBot : "@onlymarket_marketplace_bot";
        var code = (r && r.code) ? r.code : "";
        $("#tgInfo").innerHTML = '–û—Ç–∫—Ä–æ–π –±–æ—Ç–∞ <b>'+esc(bot)+'</b> –∏ –æ—Ç–ø—Ä–∞–≤—å –∫–æ–¥: <span class="chip mono">'+esc(code)+'</span>';
        toast("–ö–æ–¥ Telegram —Å–æ–∑–¥–∞–Ω", "–û—Ç–ø—Ä–∞–≤—å –µ–≥–æ –±–æ—Ç—É", "ok");
      }catch(e){
        toast("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø—Ä–æ—Å–∏—Ç—å –∫–æ–¥", String(e.message||e), "bad");
      }
    });
  }

})();</script>
</body>
</html>
